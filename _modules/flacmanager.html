

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>flacmanager &mdash; FLAC Manager 0.7.2 documentation</title>
  

  
  

  

  
  
    
      <link rel="search" type="application/opensearchdescription+xml" title="Search within FLAC Manager 0.7.2 documentation" href="../_static/opensearch.xml"/>
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="FLAC Manager 0.7.2 documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> FLAC Manager
          

          
          </a>

          
            
            
              <div class="version">
                0.7.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../prerequisites.html">Prerequisites for running FLAC Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../whats-new.html">What&#8217;s new in FLAC Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Using FLAC Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-ref.html">FLAC Manager API reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">FLAC Manager</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Module code</a> &raquo;</li>
      
    <li>flacmanager</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for flacmanager</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: UTF-8 -*-</span>

<span class="c1"># FLAC Manager -- an audio metadata aggregator and FLAC+MP3 encoder</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2013 - 2014 Matthew Zipay &lt;mattz@ninthtest.net&gt;</span>
<span class="c1"># http://www.ninthtest.net/flac-mp3-audio-manager/</span>
<span class="c1">#</span>
<span class="c1"># Permission is hereby granted, free of charge, to any person obtaining</span>
<span class="c1"># a copy of this software and associated documentation files (the</span>
<span class="c1"># &quot;Software&quot;), to deal in the Software without restriction, including</span>
<span class="c1"># without limitation the rights to use, copy, modify, merge, publish,</span>
<span class="c1"># distribute, sublicense, and/or sell copies of the Software, and to</span>
<span class="c1"># permit persons to whom the Software is furnished to do so, subject to</span>
<span class="c1"># the following conditions:</span>
<span class="c1">#</span>
<span class="c1"># The above copyright notice and this permission notice shall be</span>
<span class="c1"># included in all copies or substantial portions of the Software.</span>
<span class="c1">#</span>
<span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="c1"># EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="c1"># MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.</span>
<span class="c1"># IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY</span>
<span class="c1"># CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,</span>
<span class="c1"># TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE</span>
<span class="c1"># SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Matthew Zipay &lt;mattz@ninthtest.net&gt;&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.7.2&quot;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Please read the following articles before using FLAC Manager!</span>

<span class="sd">http://www.ninthtest.net/flac-mp3-audio-manager/prerequisites.html</span>
<span class="sd">http://www.ninthtest.net/flac-mp3-audio-manager/whats-new.html</span>
<span class="sd">http://www.ninthtest.net/flac-mp3-audio-manager/usage.html</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">cgi</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">configparser</span> <span class="k">import</span> <span class="n">ConfigParser</span>
<span class="kn">import</span> <span class="nn">ctypes</span> <span class="k">as</span> <span class="nn">C</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">total_ordering</span>
<span class="kn">from</span> <span class="nn">http.client</span> <span class="k">import</span> <span class="n">HTTPConnection</span><span class="p">,</span> <span class="n">HTTPSConnection</span>
<span class="kn">import</span> <span class="nn">imghdr</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">BytesIO</span><span class="p">,</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">plistlib</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">ssl</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="k">import</span> <span class="n">mkstemp</span><span class="p">,</span> <span class="n">TemporaryDirectory</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">tkinter</span> <span class="k">as</span> <span class="nn">tk</span>
<span class="kn">import</span> <span class="nn">tkinter.filedialog</span> <span class="k">as</span> <span class="nn">filedialog</span>
<span class="kn">import</span> <span class="nn">tkinter.font</span> <span class="k">as</span> <span class="nn">tkfont</span>
<span class="kn">import</span> <span class="nn">tkinter.messagebox</span> <span class="k">as</span> <span class="nn">messagebox</span>
<span class="kn">import</span> <span class="nn">tkinter.scrolledtext</span> <span class="k">as</span> <span class="nn">scrolledtext</span>
<span class="kn">import</span> <span class="nn">tkinter.simpledialog</span> <span class="k">as</span> <span class="nn">simpledialog</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="k">import</span> <span class="n">urlparse</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="k">import</span> <span class="n">urlopen</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;QUEUE_GET_NOWAIT_AFTER&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get_disc_info&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DiscCheck&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TOC&quot;</span><span class="p">,</span>
    <span class="s2">&quot;read_disc_toc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get_config&quot;</span><span class="p">,</span>
    <span class="s2">&quot;save_config&quot;</span><span class="p">,</span>
    <span class="s2">&quot;make_tempfile&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FLACManagerError&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FLACManager&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TrackState&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRACK_EXCLUDED&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRACK_PENDING&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRACK_ENCODING_FLAC&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRACK_DECODING_WAV&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRACK_ENCODING_MP3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRACK_FAILED&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRACK_COMPLETE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TrackEncodingStatus&quot;</span><span class="p">,</span>
    <span class="s2">&quot;generate_flac_dirname&quot;</span><span class="p">,</span>
    <span class="s2">&quot;generate_flac_basename&quot;</span><span class="p">,</span>
    <span class="s2">&quot;generate_mp3_dirname&quot;</span><span class="p">,</span>
    <span class="s2">&quot;generate_mp3_basename&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PrerequisitesDialog&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AboutDialog&quot;</span><span class="p">,</span>
    <span class="s2">&quot;EditConfigurationDialog&quot;</span><span class="p">,</span>
    <span class="s2">&quot;resolve_path&quot;</span><span class="p">,</span>
    <span class="s2">&quot;encode_flac&quot;</span><span class="p">,</span>
    <span class="s2">&quot;decode_wav&quot;</span><span class="p">,</span>
    <span class="s2">&quot;encode_mp3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;make_vorbis_comments&quot;</span><span class="p">,</span>
    <span class="s2">&quot;make_id3v2_tags&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FLACEncoder&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MP3Encoder&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MetadataError&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MetadataCollector&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GracenoteCDDBMetadataCollector&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MusicBrainzMetadataCollector&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MetadataPersistence&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MetadataAggregator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get_lame_genres&quot;</span><span class="p">,</span>
    <span class="s2">&quot;show_exception_dialog&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1">#: The module-level logger.</span>
<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">logged</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorate *cls* to provide a logger.</span>

<span class="sd">    :param class cls: a class abject</span>
<span class="sd">    :return: *cls* with a provided ``__logger`` member</span>
<span class="sd">    :rtype: class</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">__logger&quot;</span> <span class="o">%</span> <span class="n">cls</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">cls</span>


<span class="c1">#: The amount of time (in milliseconds) to wait before attempting</span>
<span class="c1">#: another call to any :meth:`queue.Queue.get_nowait` method.</span>
<span class="n">QUEUE_GET_NOWAIT_AFTER</span> <span class="o">=</span> <span class="mi">625</span>


<div class="viewcode-block" id="get_disc_info"><a class="viewcode-back" href="../disc-info.html#flacmanager.get_disc_info">[docs]</a><span class="k">def</span> <span class="nf">get_disc_info</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return a CD-DA disc&#39;s device name and mount point.</span>

<span class="sd">    :return: the 2-tuple ``(device-name, mount-point)``, or ``None``</span>
<span class="sd">    :rtype: :obj:`tuple`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># minimal tracing/logging here - can be called repeatedly (indefinitely) by</span>
    <span class="c1"># a DiscCheck thread</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s2">&quot;diskutil&quot;</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span><span class="p">],</span>
                                     <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">())</span>

    <span class="n">device</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">is_cd_partition_scheme</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_cd_da</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/dev/&quot;</span><span class="p">)):</span>
            <span class="n">device</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;CD_partition_scheme&quot;</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">):</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="n">is_cd_partition_scheme</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;CD_DA&quot;</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">):</span>
            <span class="n">is_cd_da</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">is_cd_partition_scheme</span> <span class="ow">and</span> <span class="n">is_cd_da</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s2">&quot;diskutil&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">],</span>
                                         <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">r&quot;\s+Mount Point:\s+(.*?)$&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">mountpoint</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">mountpoint</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;expected to find a mountpoint for device </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">device</span><span class="p">)</span></div>


<span class="c1">#: Used to pass data between a :class:`DiscCheck` thread and the main thread.</span>
<span class="n">_DISC_QUEUE</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="nd">@logged</span>
<div class="viewcode-block" id="DiscCheck"><a class="viewcode-back" href="../disc-info.html#flacmanager.DiscCheck">[docs]</a><span class="k">class</span> <span class="nc">DiscCheck</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A thread that checks for the presence of a CD-DA disc.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="c1"># kill this thread if the program exits</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="DiscCheck.run"><a class="viewcode-back" href="../disc-info.html#flacmanager.DiscCheck.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check for a disc until one is found or an exception occurs.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">disc_info</span> <span class="o">=</span> <span class="n">get_disc_info</span><span class="p">()</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">disc_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">disc_info</span> <span class="o">=</span> <span class="n">get_disc_info</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">_DISC_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">disc_info</span><span class="p">)</span>
            <span class="n">_DISC_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">disc_info</span><span class="p">)</span></div></div>


<span class="c1">#: Represents a disc table-of-contents (TOC), as read from a</span>
<span class="c1">#: *.TOC.plist* file.</span>
<span class="n">TOC</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;TOC&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;first_track_number&quot;</span><span class="p">,</span> <span class="s2">&quot;last_track_number&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;track_offsets&quot;</span><span class="p">,</span> <span class="s2">&quot;leadout_track_offset&quot;</span><span class="p">])</span>


<div class="viewcode-block" id="read_disc_toc"><a class="viewcode-back" href="../disc-info.html#flacmanager.read_disc_toc">[docs]</a><span class="k">def</span> <span class="nf">read_disc_toc</span><span class="p">(</span><span class="n">mountpoint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the :obj:`TOC` for the currently mounted disc.</span>

<span class="sd">    :param str mountpoint: the mount point of an inserted CD-DA disc</span>
<span class="sd">    :return: a populated TOC for the inserted CD-DA disc</span>
<span class="sd">    :rtype: :obj:`TOC`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE mountpoint = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mountpoint</span><span class="p">)</span>
    <span class="n">toc_plist_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mountpoint</span><span class="p">,</span> <span class="s2">&quot;.TOC.plist&quot;</span><span class="p">)</span>
    <span class="n">toc_plist</span> <span class="o">=</span> <span class="n">plistlib</span><span class="o">.</span><span class="n">readPlist</span><span class="p">(</span><span class="n">toc_plist_filename</span><span class="p">)</span>

    <span class="n">first_track_number</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">last_track_number</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">track_offsets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">leadout_track_offset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">toc_plist</span><span class="p">[</span><span class="s2">&quot;Sessions&quot;</span><span class="p">]:</span>
        <span class="c1"># Session Type 0 is CD-DA</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;Session Type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">first_track_number</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;First Track&quot;</span><span class="p">]</span>
            <span class="n">last_track_number</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;Last Track&quot;</span><span class="p">]</span>
            <span class="n">leadout_track_offset</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;Leadout Block&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;Track Array&quot;</span><span class="p">]:</span>
                <span class="n">track_offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;Start Block&quot;</span><span class="p">])</span>
            <span class="c1"># don&#39;t need to process any more sessions</span>
            <span class="k">break</span>

    <span class="n">toc</span> <span class="o">=</span> <span class="n">TOC</span><span class="p">(</span><span class="n">first_track_number</span><span class="p">,</span> <span class="n">last_track_number</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">track_offsets</span><span class="p">),</span>
              <span class="n">leadout_track_offset</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">toc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">toc</span></div>


<span class="c1">#: The global :class:`configparser.ConfigParser` object.</span>
<span class="n">_config</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1">#: Used to synchronize access to the global configuration object.</span>
<span class="n">_CONFIG_LOCK</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>


<div class="viewcode-block" id="get_config"><a class="viewcode-back" href="../miscellaneous.html#flacmanager.get_config">[docs]</a><span class="k">def</span> <span class="nf">get_config</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return the configuration settings.</span>

<span class="sd">    :return: settings read from *flacmanager.ini*</span>
<span class="sd">    :rtype: :class:`configparser.ConfigParser`</span>

<span class="sd">    The configuration is initialized with default/empty values and saved</span>
<span class="sd">    to disk if it does not exist.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">_config</span>
    <span class="k">with</span> <span class="n">_CONFIG_LOCK</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;initializing configuration&quot;</span><span class="p">)</span>
            <span class="n">_config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;flacmanager.ini&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="p">[</span><span class="s2">&quot;flacmanager.ini&quot;</span><span class="p">]):</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;flacmanager.ini not read; creating&quot;</span><span class="p">)</span>
                <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;Logging&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">level</span><span class="o">=</span><span class="s2">&quot;WARNING&quot;</span><span class="p">,</span>
                    <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;flacmanager.log&quot;</span><span class="p">,</span>
                    <span class="n">filemode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span>
                    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%%</span><span class="s2">(asctime)s </span><span class="si">%%</span><span class="s2">(levelname)s </span><span class="si">%%</span><span class="s2">(threadName)s &quot;</span>
                           <span class="s2">&quot;</span><span class="si">%%</span><span class="s2">(name)s </span><span class="si">%%</span><span class="s2">(funcName)s </span><span class="si">%%</span><span class="s2">(message)s&quot;</span><span class="p">)</span>
                <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;HTTP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">debuglevel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">client_id</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;MusicBrainz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">contact_url_or_email</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">libdiscid_location</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="c1">#_config[&quot;Discogs&quot;] = dict(</span>
                <span class="c1">#    contact_url_or_email=&quot;&quot;,</span>
                <span class="c1">#    oauth_consumer_key=&quot;&quot;,</span>
                <span class="c1">#    oauth_consumer_secret=&quot;&quot;,</span>
                <span class="c1">#    oauth_token=&quot;&quot;,</span>
                <span class="c1">#    oauth_token_secret=&quot;&quot;)</span>
                <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;FLAC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">library_root</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">flac_encode_options</span><span class="o">=</span>
                        <span class="s2">&quot;--force --keep-foreign-metadata --verify&quot;</span><span class="p">,</span>
                    <span class="n">flac_decode_options</span><span class="o">=</span><span class="s2">&quot;--force&quot;</span><span class="p">)</span>
                <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;MP3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">library_root</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">lame_encode_options</span><span class="o">=</span>
                        <span class="s2">&quot;--replaygain-accurate --clipdetect -q 2 -V2 -b 224&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;flacmanager.ini&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">_config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">_config</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_config</span></div>


<div class="viewcode-block" id="save_config"><a class="viewcode-back" href="../miscellaneous.html#flacmanager.save_config">[docs]</a><span class="k">def</span> <span class="nf">save_config</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Write the configuration settings to an INI-style file.&quot;&quot;&quot;</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_CONFIG_LOCK</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;flacmanager.ini&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="make_tempfile"><a class="viewcode-back" href="../miscellaneous.html#flacmanager.make_tempfile">[docs]</a><span class="k">def</span> <span class="nf">make_tempfile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.tmp&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;fm&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a temporary file.</span>

<span class="sd">    :keyword str suffix: the default file extenstion</span>
<span class="sd">    :keyword str prefix: prepended to the beginning of the filename</span>
<span class="sd">    :return: the temporary file name</span>
<span class="sd">    :rtype: :obj:`str`</span>

<span class="sd">    The temporary file will be deleted automatically when the program exits.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="o">=</span> <span class="n">mkstemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
    <span class="c1"># close the file descriptor; it isn&#39;t inherited by child processes</span>
    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
    <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filename</span></div>


<div class="viewcode-block" id="FLACManagerError"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManagerError">[docs]</a><span class="k">class</span> <span class="nc">FLACManagerError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The type of exception raised when FLAC Manager operations fail.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">context_hint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param str message: error message for logging or display</span>
<span class="sd">        :keyword context_hint: describes the error context</span>
<span class="sd">        :keyword Exception cause: the exception that caused this error</span>

<span class="sd">        The optional *context_hint* is not part of the message, and may</span>
<span class="sd">        take any type or form. Exception handlers that catch</span>
<span class="sd">        ``FLACManagerError`` may choose to do something with the context</span>
<span class="sd">        hint, or may ignore it.</span>

<span class="sd">        The optional *cause* is the (caught) exception that caused this</span>
<span class="sd">        ``FLACManagerError``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_hint</span> <span class="o">=</span> <span class="n">context_hint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cause</span> <span class="o">=</span> <span class="n">cause</span></div>


<span class="nd">@logged</span>
<div class="viewcode-block" id="FLACManager"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager">[docs]</a><span class="k">class</span> <span class="nc">FLACManager</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The FLAC Manager user interface.&quot;&quot;&quot;</span>

    <span class="c1">#: The user-friendly application name.</span>
    <span class="n">TITLE</span> <span class="o">=</span> <span class="s2">&quot;FLAC Manager&quot;</span>

    <span class="c1">#: Any HTTP(S) request issued by FLAC Manager uses this value for the HTTP</span>
    <span class="c1">#: User-Agent header value.</span>
    <span class="n">USER_AGENT</span> <span class="o">=</span> <span class="s2">&quot;FLACManager/</span><span class="si">%s</span><span class="s2"> Python/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">__version__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">need_config</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :keyword master: the parent object of this frame</span>
<span class="sd">        :keyword bool need_config:\</span>
<span class="sd">           ``True`` if *flacmanager.ini* is missing</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE master = </span><span class="si">%r</span><span class="s2">, need_config = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">master</span><span class="p">,</span>
                           <span class="n">need_config</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">YES</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_create_menu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_disc_status</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_editor_status</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding_status_frame</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">need_config</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_do_disc_check</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edit_config</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retry_disc_check_button</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the FLAC Manager menu bar.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">menubar</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Menu</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">config_menu</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Menu</span><span class="p">(</span><span class="n">menubar</span><span class="p">,</span> <span class="n">tearoff</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NO</span><span class="p">)</span>
        <span class="n">config_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Edit configuration settings&quot;</span><span class="p">,</span>
                                <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edit_config</span><span class="p">)</span>
        <span class="n">config_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Refresh logging configuration&quot;</span><span class="p">,</span>
                                <span class="n">command</span><span class="o">=</span><span class="n">configure_logging</span><span class="p">)</span>

        <span class="n">help_menu</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Menu</span><span class="p">(</span><span class="n">menubar</span><span class="p">,</span> <span class="n">tearoff</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NO</span><span class="p">)</span>
        <span class="n">help_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Prequisites&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prerequisites</span><span class="p">)</span>
        <span class="n">help_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;About&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">about</span><span class="p">)</span>

        <span class="n">menubar</span><span class="o">.</span><span class="n">add_cascade</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Configuration&quot;</span><span class="p">,</span> <span class="n">menu</span><span class="o">=</span><span class="n">config_menu</span><span class="p">)</span>
        <span class="n">menubar</span><span class="o">.</span><span class="n">add_cascade</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Help&quot;</span><span class="p">,</span> <span class="n">menu</span><span class="o">=</span><span class="n">help_menu</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">menu</span><span class="o">=</span><span class="n">menubar</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_disc_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the disc status frame.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">disc_status_group</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">LabelFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Disc status&quot;</span><span class="p">)</span>
        <span class="n">disc_status_group</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">disc_eject_button</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">disc_status_group</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Eject&quot;</span><span class="p">,</span>
                                           <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_eject_disc</span><span class="p">,</span>
                                           <span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">disc_status_message</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span>
            <span class="n">disc_status_group</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Waiting for a disc to be inserted</span><span class="se">\u2026</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disc_status_message</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">retry_disc_check_button</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">disc_status_group</span><span class="p">,</span>
                                                 <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Retry disc check&quot;</span><span class="p">,</span>
                                                 <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_do_disc_check</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rip_and_tag_button</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">disc_status_group</span><span class="p">,</span>
                                            <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Rip and tag&quot;</span><span class="p">,</span>
                                            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rip_and_tag</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_editor_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the labels and buttons that communicate editor status.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_message_var</span> <span class="o">=</span> \
            <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;Aggregating metadata</span><span class="se">\u2026</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_message</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">status_message_var</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retry_aggregation_button</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Retry metadata aggregation&quot;</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_do_metadata_aggregation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit_offline_button</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Edit metadata offline&quot;</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_edit_offline</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_edit_offline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the metadata editor without info from a CDDB.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retry_aggregation_button</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit_offline_button</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_metadata_editor</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;failed to create metadata editor&quot;</span><span class="p">)</span>
            <span class="n">show_exception_dialog</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retry_aggregation_button</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edit_offline_button</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_create_metadata_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the metadata editor.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_current_track_number</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># tracks indexing is 1-based</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_total_tracks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">track_offsets</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_editor</span> <span class="o">=</span> <span class="n">metadata_editor</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">album_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_album_metadata</span>
        <span class="n">album_editor</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">metadata_editor</span><span class="p">)</span>
        <span class="n">album_title_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_album_title_editor</span><span class="p">(</span>
            <span class="n">album_editor</span><span class="p">,</span> <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">])</span>
        <span class="n">album_title_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">album_artist_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_album_artist_editor</span><span class="p">(</span>
            <span class="n">album_editor</span><span class="p">,</span> <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">])</span>
        <span class="n">album_artist_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">album_performer_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_album_performer_editor</span><span class="p">(</span>
            <span class="n">album_editor</span><span class="p">,</span> <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;performer&quot;</span><span class="p">])</span>
        <span class="n">album_performer_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">album_genre_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_album_genre_editor</span><span class="p">(</span>
            <span class="n">album_editor</span><span class="p">,</span> <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;genre&quot;</span><span class="p">])</span>
        <span class="n">album_genre_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">year_disc_cover_row</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">album_editor</span><span class="p">)</span>
        <span class="n">album_year_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_album_year_editor</span><span class="p">(</span>
            <span class="n">year_disc_cover_row</span><span class="p">,</span> <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">])</span>
        <span class="n">album_year_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="n">album_disc_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_album_disc_editor</span><span class="p">(</span>
            <span class="n">year_disc_cover_row</span><span class="p">,</span> <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;disc_number&quot;</span><span class="p">],</span>
            <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;disc_total&quot;</span><span class="p">])</span>
        <span class="n">album_cover_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_album_cover_editor</span><span class="p">(</span>
            <span class="n">year_disc_cover_row</span><span class="p">,</span> <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;cover&quot;</span><span class="p">])</span>
        <span class="n">album_cover_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">)</span>
        <span class="n">album_disc_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
        <span class="n">year_disc_cover_row</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">album_compilation_frame</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_album_compilation_editor</span><span class="p">(</span>
                <span class="n">album_editor</span><span class="p">,</span> <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;is_compilation&quot;</span><span class="p">])</span>
        <span class="n">album_compilation_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">album_editor</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">)</span>

        <span class="n">tracks_editor</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">metadata_editor</span><span class="p">,</span> <span class="n">borderwidth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                 <span class="n">relief</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">RAISED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_track_vars</span><span class="p">()</span>
        <span class="n">first_track</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tracks_metadata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">track_editor</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">tracks_editor</span><span class="p">)</span>

        <span class="n">controls</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">track_editor</span><span class="p">)</span>
        <span class="n">track_nav_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_track_navigator</span><span class="p">(</span><span class="n">controls</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">_total_tracks</span><span class="p">)</span>
        <span class="n">track_nav_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="n">track_include_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_track_include_editor</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
        <span class="n">track_include_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">29</span><span class="p">)</span>
        <span class="n">controls</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

        <span class="n">track_title_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_track_title_editor</span><span class="p">(</span>
            <span class="n">track_editor</span><span class="p">,</span> <span class="n">first_track</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">])</span>
        <span class="n">track_title_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">track_artist_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_track_artist_editor</span><span class="p">(</span>
            <span class="n">track_editor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_choices</span><span class="p">(</span><span class="n">first_track</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">],</span>
                                                <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">]))</span>
        <span class="n">track_artist_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">track_performer_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_track_performer_editor</span><span class="p">(</span>
            <span class="n">track_editor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_choices</span><span class="p">(</span><span class="n">first_track</span><span class="p">[</span><span class="s2">&quot;performer&quot;</span><span class="p">],</span>
                                                <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;performer&quot;</span><span class="p">]))</span>
        <span class="n">track_performer_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">track_genre_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_track_genre_editor</span><span class="p">(</span>
            <span class="n">track_editor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_choices</span><span class="p">(</span><span class="n">first_track</span><span class="p">[</span><span class="s2">&quot;genre&quot;</span><span class="p">],</span>
                                                <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;genre&quot;</span><span class="p">]))</span>
        <span class="n">track_genre_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">track_year_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_track_year_editor</span><span class="p">(</span>
            <span class="n">track_editor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_choices</span><span class="p">(</span><span class="n">first_track</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
                                                <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]))</span>
        <span class="n">track_year_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="n">track_editor</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>
        <span class="n">tracks_editor</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">29</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracks_editor</span> <span class="o">=</span> <span class="n">tracks_editor</span>

        <span class="c1"># see comments in _initialize_track_vars!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_track_vars</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>
        <span class="n">metadata_editor</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">YES</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_editor</span> <span class="o">=</span> <span class="n">metadata_editor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rip_and_tag_button</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># if persisted data was restored, manually select the cover image so</span>
        <span class="c1"># that it opens in Preview automatically</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_persistence</span><span class="o">.</span><span class="n">restored</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_album_covers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="c1"># first cover is always &quot;--none--&quot;</span>
            <span class="n">preferred_album_cover</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_album_covers</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">choose_cover_image</span><span class="p">(</span><span class="n">preferred_album_cover</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_track_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create metadata variables for each track.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">track_vars</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;include&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span>
            <span class="s2">&quot;artist&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span>
            <span class="s2">&quot;performer&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span>
            <span class="s2">&quot;genre&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span>
            <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">track_metadata</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tracks_metadata</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;include&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">tk</span><span class="o">.</span><span class="n">BooleanVar</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;include&quot;</span><span class="p">]))</span>
            <span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">())</span>
            <span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">())</span>
            <span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;performer&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">())</span>
            <span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;genre&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">())</span>
            <span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">track_vars</span>

    <span class="k">def</span> <span class="nf">_initialize_track_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set default values for all track variables.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="c1"># use the tracks Spinbox as a convenient way to make sure all track</span>
        <span class="c1"># editors have valid values; but make sure this method is only called</span>
        <span class="c1"># BEFORE the metadata editor is packed, otherwise the user will be very</span>
        <span class="c1"># confused ;)</span>
        <span class="k">while</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_spinner</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_tracks</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">track_spinner</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&quot;buttonup&quot;</span><span class="p">)</span>
        <span class="c1"># now &quot;reset&quot; the spinner back to track #1</span>
        <span class="k">while</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_spinner</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">track_spinner</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&quot;buttondown&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_choices_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">59</span><span class="p">,</span>
                               <span class="n">var</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the UI to allow a value to be selected from a list of</span>
<span class="sd">        choices or entered directly.</span>

<span class="sd">        :param master: the parent object of the editor frame</span>
<span class="sd">        :param str name: the label for the entry and option menu</span>
<span class="sd">        :param list choices: a list of choices for the metadata field</span>
<span class="sd">        :keyword int width: the default width of the entry box</span>
<span class="sd">        :keyword tkinter.StringVar var:\</span>
<span class="sd">           the variable that stores the metadata field value</span>
<span class="sd">        :return: the 4-tuple (label, var, entry, option_menu)</span>
<span class="sd">        :rtype: obj:`tuple` of (:class:`tkinter.Label`, \</span>
<span class="sd">           :class:`tkinter.Variable`, :class:`tkinter.Entry`, \</span>
<span class="sd">           :class:`tkinter.OptionMenu`)</span>

<span class="sd">        The optional *var* is created as a :class:`tkinter.StringVar`</span>
<span class="sd">        if it is not provided.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">choices</span><span class="p">):</span>
            <span class="n">var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># this is just so that the OptionMenu can be created; but if this</span>
            <span class="c1"># happens, the optionmenu won&#39;t be packed</span>
            <span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">exportselection</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NO</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
                         <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
        <span class="n">optionmenu</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">OptionMenu</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="o">*</span><span class="n">choices</span><span class="p">,</span>
                                   <span class="n">command</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">optionmenu</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_refresh_choices_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">var</span><span class="p">:</span> <span class="s2">&quot;:class:`tkinter.Variable` for a metadata field&quot;</span><span class="p">,</span>
            <span class="n">entry</span><span class="p">:</span> <span class="s2">&quot;:class:`tkinter.Entry` for a metadata field&quot;</span><span class="p">,</span>
            <span class="n">optionmenu</span><span class="p">:</span> <span class="s2">&quot;:class:`tkinter.OptionMenu` for a metadata field&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="p">:</span> <span class="s2">&quot;list of new choices for the metadata field&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;a new :class:`tkinter.OptionMenu` for the metadata field&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update the values for the given editor controls.</span>

<span class="sd">        If *choices* is empty, the caller will not pack the newly-created</span>
<span class="sd">        :class:`tkinter.OptionMenu` returned by this method.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">master</span> <span class="o">=</span> <span class="n">optionmenu</span><span class="o">.</span><span class="n">master</span>
        <span class="n">optionmenu</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
        <span class="n">optionmenu</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># always prefer the current value if it&#39;s not empty</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">()):</span>
            <span class="n">var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">choices</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">choices</span><span class="p">):</span>
            <span class="c1"># this is just so that the OptionMenu can be created; but if this</span>
            <span class="c1"># happens, the new_optionmenu won&#39;t be packed</span>
            <span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">()]</span>

        <span class="n">entry</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">textvariable</span><span class="o">=</span><span class="n">var</span><span class="p">)</span>
        <span class="n">new_optionmenu</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">OptionMenu</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="o">*</span><span class="n">choices</span><span class="p">,</span>
                                       <span class="n">command</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">new_optionmenu</span>

    <span class="k">def</span> <span class="nf">_create_album_title_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;parent obejct of the editor frame&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="p">:</span> <span class="s2">&quot;list of aggregated values for the album title&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;the album title editor :class:`tkinter.Frame`&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create the UI editing controls for the album title.&quot;&quot;&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>
        <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">album_title_var</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">optionmenu</span><span class="p">)</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_choices_editor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="s2">&quot;Album&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">optionmenu</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frame</span>

    <span class="k">def</span> <span class="nf">_create_album_artist_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;parent obejct of the editor frame&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="p">:</span> <span class="s2">&quot;list of aggregated values for the album artist&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;the album artist editor :class:`tkinter.Frame`&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create the UI editing controls for the album title.&quot;&quot;&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>
        <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">album_artist_var</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">optionmenu</span><span class="p">)</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_choices_editor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="s2">&quot;Artist&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="p">)</span>
        <span class="n">button</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Apply to all tracks&quot;</span><span class="p">,</span>
                           <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_album_artist_to_tracks</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">optionmenu</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="n">button</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frame</span>

<div class="viewcode-block" id="FLACManager.apply_album_artist_to_tracks"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.apply_album_artist_to_tracks">[docs]</a>    <span class="k">def</span> <span class="nf">apply_album_artist_to_tracks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set each track artist to the album artist.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">album_artist_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">album_artist_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">track_artist_var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">track_artist_var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">album_artist_value</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_create_album_performer_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;parent obejct of the editor frame&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="p">:</span> <span class="s2">&quot;list of aggregated values for the album performer&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;the album performer editor :class:`tkinter.Frame`&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create the UI editing controls for the album performer.&quot;&quot;&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>
        <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">album_performer_var</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">optionmenu</span><span class="p">)</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_choices_editor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="s2">&quot;Performer&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="p">)</span>
        <span class="n">button</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span>
            <span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Apply to all tracks&quot;</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_album_performer_to_tracks</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">optionmenu</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="n">button</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frame</span>

<div class="viewcode-block" id="FLACManager.apply_album_performer_to_tracks"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.apply_album_performer_to_tracks">[docs]</a>    <span class="k">def</span> <span class="nf">apply_album_performer_to_tracks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set each track performer to the album performer.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">album_performer_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">album_performer_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">track_performer_var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span><span class="p">[</span><span class="s2">&quot;performer&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">track_performer_var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">album_performer_value</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_create_album_genre_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;parent obejct of the editor frame&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="p">:</span> <span class="s2">&quot;list of aggregated values for the album genre&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;the album genre editor :class:`tkinter.Frame`&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create the UI editing controls for the album genre.&quot;&quot;&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>
        <span class="n">genres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_genres</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>
        <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">album_genre_var</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">optionmenu</span><span class="p">)</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_choices_editor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="s2">&quot;Genre&quot;</span><span class="p">,</span> <span class="n">genres</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">29</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_lame_genres_menu</span><span class="p">(</span><span class="n">optionmenu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">album_genre_var</span><span class="p">,</span> <span class="n">genres</span><span class="p">)</span>
        <span class="n">button</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Apply to all tracks&quot;</span><span class="p">,</span>
                           <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_album_genre_to_tracks</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">optionmenu</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="n">button</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frame</span>

    <span class="k">def</span> <span class="nf">_combine_genres</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">choices</span><span class="p">:</span> <span class="s2">&quot;list of aggregated values for the album genre&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;customized list of values for the album genre&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a custom genre list from a list of aggregated genres.</span>

<span class="sd">        If a genre choice has been restored from persisted data, it will</span>
<span class="sd">        always remain in place as the *first* choice.</span>

<span class="sd">        If *choices* is empty, add &quot;Other&quot; to the list.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE choices = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="p">)</span>
        <span class="n">genres</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">choice</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">single_genre</span> <span class="ow">in</span> <span class="p">[</span><span class="n">genre</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">choice</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">single_genre</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">genres</span><span class="p">):</span>
                    <span class="n">genres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_genre</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">genres</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">genres</span><span class="p">)</span>
            <span class="n">genres</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">combined</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">genres</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">genres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Other&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_persistence</span><span class="o">.</span><span class="n">restored</span> <span class="ow">and</span> <span class="n">choices</span> <span class="ow">and</span>
                <span class="p">(</span><span class="n">genres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">genres</span><span class="p">):</span>
                <span class="n">genres</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">genres</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">genres</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">genres</span>

    <span class="k">def</span> <span class="nf">_add_lame_genres_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">optionmenu</span><span class="p">:</span> <span class="s2">&quot;:class:`tkinter.OptionMenu` of genre choices&quot;</span><span class="p">,</span>
            <span class="n">var</span><span class="p">:</span> <span class="s2">&quot;:class:`tkinter.StringVar` for the selected genre&quot;</span><span class="p">,</span>
            <span class="n">excludes</span><span class="p">:</span> <span class="s2">&quot;list of LAME genres to exclude from the submenu&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a submenu to *optionmenu* that contains the LAME genres.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE excludes = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">excludes</span><span class="p">)</span>
        <span class="n">optionmenu</span><span class="p">[</span><span class="s2">&quot;menu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add_separator</span><span class="p">()</span>
        <span class="n">menu</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Menu</span><span class="p">(</span><span class="n">optionmenu</span><span class="p">[</span><span class="s2">&quot;menu&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">get_lame_genres</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">genre</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excludes</span><span class="p">):</span>
                <span class="n">menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">genre</span><span class="p">,</span>
                                 <span class="n">command</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">genre</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
        <span class="n">optionmenu</span><span class="p">[</span><span class="s2">&quot;menu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add_cascade</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;LAME&quot;</span><span class="p">,</span> <span class="n">menu</span><span class="o">=</span><span class="n">menu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="FLACManager.apply_album_genre_to_tracks"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.apply_album_genre_to_tracks">[docs]</a>    <span class="k">def</span> <span class="nf">apply_album_genre_to_tracks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set each track genre to the album genre.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">album_genre_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">album_genre_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">track_genre_var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span><span class="p">[</span><span class="s2">&quot;genre&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">track_genre_var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">album_genre_value</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_create_album_year_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;parent obejct of the editor frame&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="p">:</span> <span class="s2">&quot;list of aggregated values for the album year&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;the album genre editor :class:`tkinter.Frame`&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create the UI editing controls for the album year.&quot;&quot;&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>
        <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">album_year_var</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">optionmenu</span><span class="p">)</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_choices_editor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">button</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Apply to all tracks&quot;</span><span class="p">,</span>
                           <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_album_year_to_tracks</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">optionmenu</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="n">button</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frame</span>

<div class="viewcode-block" id="FLACManager.apply_album_year_to_tracks"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.apply_album_year_to_tracks">[docs]</a>    <span class="k">def</span> <span class="nf">apply_album_year_to_tracks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set each track genre to the album genre.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">album_year_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">album_year_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">track_year_var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">track_year_var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">album_year_value</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_create_album_disc_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;parent obejct of the editor frame&quot;</span><span class="p">,</span>
            <span class="n">number</span><span class="p">:</span> <span class="s2">&quot;int default disc number&quot;</span><span class="p">,</span>
            <span class="n">total</span><span class="p">:</span> <span class="s2">&quot;int default disc total&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;the album disc number/total editor :class:`tkinter.Frame`&quot;</span><span class="p">:</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>
        <span class="n">number_label</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Disc&quot;</span><span class="p">)</span>
        <span class="n">number_label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">album_disc_number_var</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">))</span>
        <span class="n">number_entry</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">exportselection</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NO</span><span class="p">,</span>
                                <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">album_disc_number_var</span><span class="p">,</span>
                                <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">number_entry</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">total_label</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;of&quot;</span><span class="p">)</span>
        <span class="n">total_label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">album_disc_total_var</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">total</span><span class="p">))</span>
        <span class="n">total_entry</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">exportselection</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NO</span><span class="p">,</span>
                               <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">album_disc_total_var</span><span class="p">,</span>
                               <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">total_entry</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frame</span>

    <span class="k">def</span> <span class="nf">_create_album_cover_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;parent obejct of the editor frame&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="p">:</span> <span class="s2">&quot;list of aggregated values for the album cover&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;the album cover editor :class:`tkinter.Frame`&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create the UI editing controls for the album cover.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_album_covers</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_album_covers</span><span class="p">[</span><span class="s2">&quot;--none--&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">image_data</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_cover_image</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span>

        <span class="n">frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Cover&quot;</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">album_cover_var</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;--none--&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_covers_optionmenu</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">OptionMenu</span><span class="p">(</span>
            <span class="n">frame</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">album_cover_var</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_album_covers</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">choose_cover_image</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_covers_optionmenu</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">url_button</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Add URL&quot;</span><span class="p">,</span>
                               <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">choose_cover_image_from_url</span><span class="p">)</span>
        <span class="n">url_button</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">file_button</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Add file&quot;</span><span class="p">,</span>
                                <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">choose_cover_image_from_file</span><span class="p">)</span>
        <span class="n">file_button</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frame</span>

    <span class="k">def</span> <span class="nf">_create_album_compilation_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;parent obejct of the editor frame&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="p">:</span> <span class="s2">&quot;boolean initial value of the checkbox&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a checkbox to indicate that the album is a compilation.&quot;&quot;&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">album_compilation_var</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">BooleanVar</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
        <span class="n">checkbutton</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Checkbutton</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Compilation&quot;</span><span class="p">,</span>
                                     <span class="n">variable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">album_compilation_var</span><span class="p">,</span>
                                     <span class="n">onvalue</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">offvalue</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">checkbutton</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frame</span>

    <span class="k">def</span> <span class="nf">_save_cover_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_data</span><span class="p">:</span> <span class="s2">&quot;bytes of image data&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;2-tuple (string label, string filename)&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save raw image bytes to a temporary file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">image_type</span> <span class="o">=</span> <span class="n">imghdr</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="s2">&quot;_ignored_&quot;</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">image_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span><span class="s2">&quot;Unrecognized image type.&quot;</span><span class="p">,</span>
                                <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;Save image&quot;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Cover #</span><span class="si">%d</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_album_covers</span><span class="p">),</span> <span class="n">image_type</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">make_tempfile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">image_type</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_album_covers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

<div class="viewcode-block" id="FLACManager.choose_cover_image"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.choose_cover_image">[docs]</a>    <span class="k">def</span> <span class="nf">choose_cover_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select the named cover image and open in Mac OS X Preview.</span>

<span class="sd">        :param str name: label for the image</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE name = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_album_covers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s2">&quot;open&quot;</span><span class="p">,</span> <span class="s2">&quot;-a&quot;</span><span class="p">,</span> <span class="s2">&quot;Preview&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">album_cover_var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;exit status </span><span class="si">%d</span><span class="s2"> attempting to preview </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">status</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># should never happen</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> is not mapped to a filename&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">messagebox</span><span class="o">.</span><span class="n">showwarning</span><span class="p">(</span><span class="s2">&quot;Invalid image choice&quot;</span><span class="p">,</span>
                                   <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not a valid image choice!&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="FLACManager.choose_cover_image_from_url"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.choose_cover_image_from_url">[docs]</a>    <span class="k">def</span> <span class="nf">choose_cover_image_from_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Download a cover image from a user-provided URL and open in</span>
<span class="sd">        Mac OS X Preview.</span>

<span class="sd">        The downloaded cover image is made available in the cover image</span>
<span class="sd">        dropdown.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_covers_optionmenu</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">simpledialog</span><span class="o">.</span><span class="n">askstring</span><span class="p">(</span><span class="s2">&quot;Add a cover image from a URL&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;Enter the image URL:&quot;</span><span class="p">,</span>
                                     <span class="n">initialvalue</span><span class="o">=</span><span class="s2">&quot;http://&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">url</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_covers_optionmenu</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;url = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;HTTP&quot;</span><span class="p">,</span>
                                                                  <span class="s2">&quot;timeout&quot;</span><span class="p">))</span>
            <span class="n">image_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;HTTP </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                   <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>
            <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_cover_image</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;failed to obtain image from </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
            <span class="n">messagebox</span><span class="o">.</span><span class="n">showerror</span><span class="p">(</span><span class="s2">&quot;Image download failure&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;An unexpected error occurred while &quot;</span>
                                    <span class="s2">&quot;downloading the image from </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_album_cover_option</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">messagebox</span><span class="o">.</span><span class="n">showinfo</span><span class="p">(</span><span class="s2">&quot;Cover image added&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has been added to the available covers.&quot;</span> <span class="o">%</span>
                                    <span class="n">name</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_covers_optionmenu</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">choose_cover_image</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_add_album_cover_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add *name* to the cover image dropdown menu.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE name = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_covers_optionmenu</span><span class="p">[</span><span class="s2">&quot;menu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="k">lambda</span> <span class="n">f</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">choose_cover_image</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">name</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

<div class="viewcode-block" id="FLACManager.choose_cover_image_from_file"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.choose_cover_image_from_file">[docs]</a>    <span class="k">def</span> <span class="nf">choose_cover_image_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open a user-defined cover image in Mac OS X Preview.</span>

<span class="sd">        The cover image is made available in the cover image dropdown.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_covers_optionmenu</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filedialog</span><span class="o">.</span><span class="n">askopenfilename</span><span class="p">(</span>
                    <span class="n">defaultextension</span><span class="o">=</span><span class="s2">&quot;.jpg&quot;</span><span class="p">,</span>
                    <span class="n">filetypes</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;JPEG&quot;</span><span class="p">,</span> <span class="s2">&quot;*.jpg&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;JPEG&quot;</span><span class="p">,</span> <span class="s2">&quot;*.jpeg&quot;</span><span class="p">),</span>
                               <span class="p">(</span><span class="s2">&quot;PNG&quot;</span><span class="p">,</span> <span class="s2">&quot;*.png&quot;</span><span class="p">)],</span>
                    <span class="n">initialdir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/Pictures&quot;</span><span class="p">),</span>
                    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Choose a JPEG or PNG file&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">filename</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_covers_optionmenu</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;filename = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">image_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">image_type</span> <span class="o">=</span> <span class="n">imghdr</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="s2">&quot;_ignored_&quot;</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">image_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">image_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">messagebox</span><span class="o">.</span><span class="n">showwarning</span><span class="p">(</span><span class="s2">&quot;Image add failure&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;Type of </span><span class="si">%s</span><span class="s2"> is not recognized!&quot;</span> <span class="o">%</span>
                                           <span class="n">filename</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_covers_optionmenu</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Cover #</span><span class="si">%d</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_album_covers</span><span class="p">),</span>
                                       <span class="n">image_type</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_album_covers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_album_cover_option</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">messagebox</span><span class="o">.</span><span class="n">showinfo</span><span class="p">(</span><span class="s2">&quot;Cover image added&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has been added to the available covers.&quot;</span> <span class="o">%</span>
                                    <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;file not found: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">messagebox</span><span class="o">.</span><span class="n">showerror</span><span class="p">(</span><span class="s2">&quot;Image add failure&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;File not found: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_covers_optionmenu</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">choose_cover_image</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_create_track_navigator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;parent object of the navigation frame&quot;</span><span class="p">,</span>
            <span class="n">total_tracks</span><span class="p">:</span> <span class="s2">&quot;int number of tracks on the album&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;:class:`tkinter.Frame` containing navigation controls&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create the UI controls for navigating between tracks.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>
        <span class="n">track_label</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Track&quot;</span><span class="p">)</span>
        <span class="n">track_label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_spinner</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Spinbox</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">from_</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="n">total_tracks</span><span class="p">,</span>
                                        <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                        <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refresh_track_editors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_spinner</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">of_label</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;of </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">total_tracks</span><span class="p">)</span>
        <span class="n">of_label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frame</span>

    <span class="k">def</span> <span class="nf">_create_track_include_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;parent object of the editor frame&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;:class:`tkinter.Frame` containing the track include editor&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create the UI controls for including/excluding a track.&quot;&quot;&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_include_checkbox</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Checkbutton</span><span class="p">(</span>
            <span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Include this track&quot;</span><span class="p">,</span>
            <span class="n">variable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span><span class="p">[</span><span class="s2">&quot;include&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">onvalue</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">offvalue</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_track_editors_states</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_include_checkbox</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
        <span class="n">button</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Apply to all tracks&quot;</span><span class="p">,</span>
                           <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_include_to_tracks</span><span class="p">)</span>
        <span class="n">button</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frame</span>

<div class="viewcode-block" id="FLACManager.apply_include_to_tracks"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.apply_include_to_tracks">[docs]</a>    <span class="k">def</span> <span class="nf">apply_include_to_tracks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set each track to be included/excluded based on the current</span>
<span class="sd">        track&#39;s include/exclude state.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">include_value</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span><span class="p">[</span><span class="s2">&quot;include&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_track_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">track_include_var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span><span class="p">[</span><span class="s2">&quot;include&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">track_include_var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">include_value</span><span class="p">)</span></div>

<div class="viewcode-block" id="FLACManager.toggle_track_editors_states"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.toggle_track_editors_states">[docs]</a>    <span class="k">def</span> <span class="nf">toggle_track_editors_states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enable/disable editors for the current track based on whether</span>
<span class="sd">        it is include or excluded, respectively.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span><span class="p">[</span><span class="s2">&quot;include&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_track_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;disabling track editors for track </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">track_spinner</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">track_title_entry</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_title_optionmenu</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">track_artist_entry</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_artist_optionmenu</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">track_performer_entry</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_performer_optionmenu</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">track_genre_entry</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_genre_optionmenu</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">track_year_entry</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_year_optionmenu</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;enabling track editors for track </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">track_spinner</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">track_title_entry</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_title_optionmenu</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">track_artist_entry</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_artist_optionmenu</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">track_performer_entry</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_performer_optionmenu</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">track_genre_entry</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_genre_optionmenu</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">track_year_entry</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_year_optionmenu</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_create_track_title_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;parent obejct of the editor frame&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="p">:</span> <span class="s2">&quot;list of aggregated values for the track title&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;the track title editor :class:`tkinter.Frame`&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create the UI editing controls for the track title.&quot;&quot;&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>
        <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_title_entry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_title_optionmenu</span><span class="p">)</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_choices_editor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="s2">&quot;Title&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span>
                                        <span class="n">var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_title_entry</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_title_optionmenu</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frame</span>

    <span class="k">def</span> <span class="nf">_create_track_artist_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;parent obejct of the editor frame&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="p">:</span> <span class="s2">&quot;list of aggregated values for the track artist&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;the track artist editor :class:`tkinter.Frame`&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create the UI editing controls for the track artist.&quot;&quot;&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>
        <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_artist_entry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_artist_optionmenu</span><span class="p">)</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_choices_editor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="s2">&quot;Artist&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span>
                                        <span class="n">var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_artist_entry</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_artist_optionmenu</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frame</span>

    <span class="k">def</span> <span class="nf">_create_track_performer_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;parent obejct of the editor frame&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="p">:</span> <span class="s2">&quot;list of aggregated values for the track performer&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;the track performer editor :class:`tkinter.Frame`&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create the UI editing controls for the track performer.&quot;&quot;&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>
        <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_performer_entry</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_track_performer_optionmenu</span><span class="p">)</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_choices_editor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="s2">&quot;Performer&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span>
                                        <span class="n">var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span><span class="p">[</span><span class="s2">&quot;performer&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_performer_entry</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_performer_optionmenu</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frame</span>

    <span class="k">def</span> <span class="nf">_create_track_genre_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;parent obejct of the editor frame&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="p">:</span> <span class="s2">&quot;list of aggregated values for the track genre&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;the track genre editor :class:`tkinter.Frame`&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create the UI editing controls for the track genre.&quot;&quot;&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>
        <span class="n">genres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_genres</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>
        <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_genre_entry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_genre_optionmenu</span><span class="p">)</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_choices_editor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="s2">&quot;Genre&quot;</span><span class="p">,</span> <span class="n">genres</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">29</span><span class="p">,</span>
                                        <span class="n">var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span><span class="p">[</span><span class="s2">&quot;genre&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_lame_genres_menu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_track_genre_optionmenu</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">track_genre_entry</span><span class="p">,</span> <span class="n">genres</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_genre_entry</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_genre_optionmenu</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frame</span>

    <span class="k">def</span> <span class="nf">_create_track_year_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;parent obejct of the editor frame&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="p">:</span> <span class="s2">&quot;list of aggregated values for the track year&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;the track year editor :class:`tkinter.Frame`&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create the UI editing controls for the track year.&quot;&quot;&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>
        <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_year_entry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_year_optionmenu</span><span class="p">)</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_choices_editor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                        <span class="n">var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_year_entry</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_year_optionmenu</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frame</span>

<div class="viewcode-block" id="FLACManager.refresh_track_editors"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.refresh_track_editors">[docs]</a>    <span class="k">def</span> <span class="nf">refresh_track_editors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate track editors with metadata for the current track.</span>

<span class="sd">        This method is called when navigating to another track. If</span>
<span class="sd">        navigation is at either end of the track list already (i.e.</span>
<span class="sd">        navigating &quot;down&quot; from track 1 or &quot;up&quot; from the last track),</span>
<span class="sd">        then this method is a no-op.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">track_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_spinner</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_track_number</span> <span class="o">==</span> <span class="n">track_number</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_current_track_number</span> <span class="o">=</span> <span class="n">track_number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_track_editors_states</span><span class="p">()</span>
        <span class="n">track_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tracks_metadata</span><span class="p">[</span><span class="n">track_number</span><span class="p">]</span>

        <span class="n">track_include_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span><span class="p">[</span><span class="s2">&quot;include&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span>
        <span class="n">track_title_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span>
        <span class="n">track_artist_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span>
        <span class="n">track_performer_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span><span class="p">[</span><span class="s2">&quot;performer&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span>
        <span class="n">track_genre_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span><span class="p">[</span><span class="s2">&quot;genre&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span>
        <span class="n">track_year_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">track_include_checkbox</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">variable</span><span class="o">=</span><span class="n">track_include_var</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_track_title_optionmenu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_choices_editor</span><span class="p">(</span>
            <span class="n">track_title_var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_title_entry</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_title_optionmenu</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_title_optionmenu</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>

        <span class="n">choices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_choices</span><span class="p">(</span><span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">],</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_album_metadata</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_artist_optionmenu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_choices_editor</span><span class="p">(</span>
            <span class="n">track_artist_var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_artist_entry</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_artist_optionmenu</span><span class="p">,</span> <span class="n">choices</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_artist_optionmenu</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>

        <span class="n">choices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_choices</span><span class="p">(</span><span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;performer&quot;</span><span class="p">],</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_album_metadata</span><span class="p">[</span><span class="s2">&quot;performer&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_performer_optionmenu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_choices_editor</span><span class="p">(</span>
            <span class="n">track_performer_var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_performer_entry</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_performer_optionmenu</span><span class="p">,</span> <span class="n">choices</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_performer_optionmenu</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>

        <span class="n">choices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_choices</span><span class="p">(</span><span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;genre&quot;</span><span class="p">],</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_album_metadata</span><span class="p">[</span><span class="s2">&quot;genre&quot;</span><span class="p">])</span>
        <span class="n">genres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_genres</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_genre_optionmenu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_choices_editor</span><span class="p">(</span>
            <span class="n">track_genre_var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_genre_entry</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_genre_optionmenu</span><span class="p">,</span> <span class="n">genres</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_genre_optionmenu</span><span class="p">[</span><span class="s2">&quot;menu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add_separator</span><span class="p">()</span>
        <span class="n">menu</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Menu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_track_genre_optionmenu</span><span class="p">[</span><span class="s2">&quot;menu&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">get_lame_genres</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">genre</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">genres</span><span class="p">):</span>
                <span class="n">menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">genre</span><span class="p">,</span>
                    <span class="n">command</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="o">=</span><span class="n">track_genre_var</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">genre</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_genre_optionmenu</span><span class="p">[</span><span class="s2">&quot;menu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add_cascade</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;LAME&quot;</span><span class="p">,</span>
                                                         <span class="n">menu</span><span class="o">=</span><span class="n">menu</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_genre_optionmenu</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>

        <span class="n">choices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_choices</span><span class="p">(</span><span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_album_metadata</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_year_optionmenu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_choices_editor</span><span class="p">(</span>
            <span class="n">track_year_var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_year_entry</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_year_optionmenu</span><span class="p">,</span> <span class="n">choices</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_year_optionmenu</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_combine_choices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preferred</span><span class="p">,</span> <span class="n">additional</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;list of choices, the union of preferred and additional&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Combine two lists of values.</span>

<span class="sd">        A new list is always returned. All items from *preferred* are</span>
<span class="sd">        added to the new list. Only items from *additional* that</span>
<span class="sd">        are **not** already in *preferred* are added to the new list.</span>
<span class="sd">        The order of preferred/additional choices is maintained.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">preferred</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">choice</span> <span class="ow">in</span> <span class="n">additional</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">choice</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">combined</span><span class="p">):</span>
                <span class="n">combined</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">choice</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">combined</span>

    <span class="k">def</span> <span class="nf">_persist_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store the current metadata field/value pairs.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">number_of_tracks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">track_offsets</span><span class="p">)</span>
        <span class="n">album_metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">album_title_var</span><span class="o">.</span><span class="n">get</span><span class="p">()]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">album_title_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">else</span> <span class="p">[],</span>
            <span class="s2">&quot;artist&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">album_artist_var</span><span class="o">.</span><span class="n">get</span><span class="p">()]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">album_artist_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">else</span> <span class="p">[],</span>
            <span class="s2">&quot;performer&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">album_performer_var</span><span class="o">.</span><span class="n">get</span><span class="p">()]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">album_performer_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">else</span> <span class="p">[],</span>
            <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">album_year_var</span><span class="o">.</span><span class="n">get</span><span class="p">()]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">album_year_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">else</span> <span class="p">[],</span>
            <span class="s2">&quot;genre&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">album_genre_var</span><span class="o">.</span><span class="n">get</span><span class="p">()]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">album_genre_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">else</span> <span class="p">[],</span>
            <span class="s2">&quot;cover&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_album_covers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">album_cover_var</span><span class="o">.</span><span class="n">get</span><span class="p">())]</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">album_cover_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;--none--&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="p">[],</span>
            <span class="s2">&quot;number_of_tracks&quot;</span><span class="p">:</span> <span class="n">number_of_tracks</span><span class="p">,</span>
            <span class="s2">&quot;is_compilation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">album_compilation_var</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
            <span class="s2">&quot;disc_number&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">album_disc_number_var</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">album_disc_number_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;disc_total&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">album_disc_total_var</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">album_disc_total_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># for persistence, replace temporary cover filenames with raw image</span>
        <span class="c1"># data (byte strings)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;cover&quot;</span><span class="p">])):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;cover&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;cover&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">track_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span>
        <span class="c1"># 1-based indexing for tracks</span>
        <span class="n">tracks_metadata</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_tracks</span><span class="p">):</span>
            <span class="n">track_number</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">tracks_metadata</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;include&quot;</span><span class="p">:</span> <span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;include&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="n">track_number</span><span class="p">,</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()]</span>
                    <span class="k">if</span> <span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">else</span> <span class="p">[],</span>
                <span class="s2">&quot;artist&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()]</span>
                    <span class="k">if</span> <span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">else</span> <span class="p">[],</span>
                <span class="s2">&quot;performer&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;performer&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()]</span>
                    <span class="k">if</span> <span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;performer&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">else</span> <span class="p">[],</span>
                <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()]</span>
                    <span class="k">if</span> <span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">else</span> <span class="p">[],</span>
                <span class="s2">&quot;genre&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;genre&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()]</span>
                    <span class="k">if</span> <span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;genre&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">else</span> <span class="p">[],</span>
            <span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_persistence</span><span class="o">.</span><span class="n">store</span><span class="p">({</span>
            <span class="s2">&quot;album&quot;</span><span class="p">:</span> <span class="n">album_metadata</span><span class="p">,</span>
            <span class="s2">&quot;tracks&quot;</span><span class="p">:</span> <span class="n">tracks_metadata</span><span class="p">,</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">_prepare_tagging_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;list of dicts of track tagging metadata&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Build the track-centric data structure that contains the</span>
<span class="sd">        final metadata values to be used for tagging.</span>

<span class="sd">        Any tracks that are &quot;excluded&quot; are not processed, and ``None``</span>
<span class="sd">        is added to the returned list instead of a dict.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>

        <span class="c1"># not set from metadata collectors, so set it now</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_album_metadata</span><span class="p">[</span><span class="s2">&quot;is_compilation&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">album_compilation_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="c1"># metadata per track will be initialized with a copy of this</span>
        <span class="c1"># mapping</span>
        <span class="n">album_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">album_title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">album_title_var</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
            <span class="n">album_artist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">album_artist_var</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
            <span class="n">album_performer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">album_performer_var</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
            <span class="n">album_genre</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">album_genre_var</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
            <span class="n">album_year</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">album_year_var</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
            <span class="n">disc_number</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">album_disc_number_var</span><span class="o">.</span><span class="n">get</span><span class="p">()),</span>
            <span class="n">disc_total</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">album_disc_total_var</span><span class="o">.</span><span class="n">get</span><span class="p">()),</span>
            <span class="n">album_cover</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_album_covers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">album_cover_var</span><span class="o">.</span><span class="n">get</span><span class="p">()),</span>
            <span class="n">is_compilation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">album_compilation_var</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
            <span class="n">track_total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">track_offsets</span><span class="p">))</span>

        <span class="n">track_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span>
        <span class="n">tagging_metadata</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;track_total&quot;</span><span class="p">]):</span>
            <span class="n">track_number</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;include&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()):</span>
                <span class="n">track_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">album_metadata</span><span class="p">)</span>
                <span class="n">track_metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">track_number</span><span class="o">=</span><span class="n">track_number</span><span class="p">,</span>
                    <span class="n">track_title</span><span class="o">=</span><span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                    <span class="n">track_artist</span><span class="o">=</span><span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                    <span class="n">track_performer</span><span class="o">=</span>
                        <span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;performer&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                    <span class="n">track_genre</span><span class="o">=</span><span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;genre&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                    <span class="n">track_year</span><span class="o">=</span><span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()))</span>
                <span class="n">tagging_metadata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">track_metadata</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;track </span><span class="si">%d</span><span class="s2"> is excluded&quot;</span><span class="p">,</span> <span class="n">track_number</span><span class="p">)</span>
                <span class="n">tagging_metadata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tagging_metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tagging_metadata</span>

    <span class="k">def</span> <span class="nf">_create_encoder_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;parent object of the encoding status widgets frame&quot;</span><span class="p">,</span>
            <span class="n">max_visible_tracks</span><span class="p">:</span> <span class="s2">&quot;int number of tracks before scrolling&quot;</span> <span class="o">=</span><span class="mi">29</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;:class:`tkinter.Frame` containing encoding status widgets&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create UI widgets that communicate encoding status to the user.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">encoding_status_frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">LabelFrame</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Encoding status&quot;</span><span class="p">)</span>

        <span class="n">track_titles</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%02d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                             <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">track_titles</span><span class="p">)]</span>
        <span class="n">track_include_flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                               <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span><span class="p">[</span><span class="s2">&quot;include&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_track_encoding_statuses</span><span class="p">(</span><span class="n">track_include_flags</span><span class="p">)</span>

        <span class="n">track_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">track_offsets</span><span class="p">)</span>
        <span class="n">list_frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">encoding_status_frame</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">track_total</span> <span class="o">&gt;</span> <span class="n">max_visible_tracks</span><span class="p">):</span>
            <span class="n">visible_tracks</span> <span class="o">=</span> <span class="n">max_visible_tracks</span>
            <span class="n">vscrollbar</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Scrollbar</span><span class="p">(</span><span class="n">list_frame</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
            <span class="n">vscrollbar</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;yscrollcommand&quot;</span><span class="p">:</span> <span class="n">vscrollbar</span><span class="o">.</span><span class="n">set</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">visible_tracks</span> <span class="o">=</span> <span class="n">track_total</span>
            <span class="n">vscrollbar</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoding_status_list</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Listbox</span><span class="p">(</span>
            <span class="n">list_frame</span><span class="p">,</span> <span class="n">exportselection</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NO</span><span class="p">,</span> <span class="n">activestyle</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span>
            <span class="n">selectmode</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">SINGLE</span><span class="p">,</span> <span class="n">bd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">visible_tracks</span><span class="p">,</span>
            <span class="n">listvariable</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="n">track_encoding_status</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
                               <span class="k">for</span> <span class="n">track_encoding_status</span> <span class="ow">in</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_track_encoding_statuses</span><span class="p">)),</span>
            <span class="o">**</span><span class="n">cfg</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">vscrollbar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">vscrollbar</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding_status_list</span><span class="o">.</span><span class="n">yview</span><span class="p">)</span>
        <span class="n">list_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">track_total</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">track_include_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_encoding_status_list</span><span class="o">.</span><span class="n">itemconfig</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;fg&quot;</span><span class="p">:</span> <span class="s2">&quot;gray79&quot;</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_encoding_status_list</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">encoding_status_frame</span>

    <span class="k">def</span> <span class="nf">_initialize_track_encoding_statuses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">track_include_flags</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the state machines for each track&#39;s encoding status.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_encoding_statuses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_labels</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_encoding_statuses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">TrackEncodingStatus</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">pending</span><span class="o">=</span><span class="n">track_include_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

<div class="viewcode-block" id="FLACManager.rip_and_tag"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.rip_and_tag">[docs]</a>    <span class="k">def</span> <span class="nf">rip_and_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create tagged FLAC and MP3 files of all included tracks.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding_status_frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encoding_status_frame</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encoding_status_frame</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disc_eject_button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rip_and_tag_button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_persist_metadata</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">encoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_encoder</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;failed to initialize the encoder&quot;</span><span class="p">)</span>
            <span class="n">show_exception_dialog</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disc_eject_button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rip_and_tag_button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">encoder</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_encoding_progress</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_prepare_encoder</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;a populated :class:`FLACEncoder` object&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Populate a :class:`FLACEncoder` object for the album.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>

        <span class="n">disc_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mountpoint</span><span class="p">)</span>
                          <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span> <span class="ow">and</span>
                            <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span>
                                <span class="p">[</span><span class="s2">&quot;.aiff&quot;</span><span class="p">,</span> <span class="s2">&quot;aif&quot;</span><span class="p">,</span> <span class="s2">&quot;.aifc&quot;</span><span class="p">,</span> <span class="s2">&quot;.cdda&quot;</span><span class="p">,</span> <span class="s2">&quot;.cda&quot;</span><span class="p">]))]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">disc_filenames</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">track_offsets</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">FLACManagerError</span><span class="p">(</span>
                <span class="s2">&quot;Disc TOC reported </span><span class="si">%d</span><span class="s2"> tracks, but </span><span class="si">%d</span><span class="s2"> files were found at &quot;</span>
                    <span class="s2">&quot;mount point </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">track_offsets</span><span class="p">),</span>
                                        <span class="nb">len</span><span class="p">(</span><span class="n">trackfiles</span><span class="p">),</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_mountpoint</span><span class="p">),</span>
                <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;FLAC ripping&quot;</span><span class="p">)</span>

        <span class="n">flac_library_root</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;library_root&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flac_library_root</span> <span class="o">=</span> <span class="n">resolve_path</span><span class="p">(</span><span class="n">flac_library_root</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FLACManagerError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot use FLAC library root </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">flac_library_root</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span>
                <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;FLAC ripping&quot;</span><span class="p">,</span>
                <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>

        <span class="n">mp3_library_root</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;library_root&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mp3_library_root</span> <span class="o">=</span> <span class="n">resolve_path</span><span class="p">(</span><span class="n">mp3_library_root</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FLACManagerError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot use MP3 library root </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mp3_library_root</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span>
                <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;MP3 encoding&quot;</span><span class="p">,</span>
                <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encoding_status_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_encoder_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_editor</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding_status_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span>
                                        <span class="n">expand</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">YES</span><span class="p">)</span>

        <span class="n">encoder</span> <span class="o">=</span> <span class="n">FLACEncoder</span><span class="p">()</span>
        <span class="n">tracks_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_tagging_metadata</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tracks_metadata</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">cdda_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mountpoint</span><span class="p">,</span>
                                         <span class="n">disc_filenames</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

            <span class="n">flac_dirname</span> <span class="o">=</span> <span class="n">generate_flac_dirname</span><span class="p">(</span><span class="n">flac_library_root</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
            <span class="n">flac_basename</span> <span class="o">=</span> <span class="n">generate_flac_basename</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
            <span class="n">flac_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flac_dirname</span><span class="p">,</span> <span class="n">flac_basename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cdda_filename</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">)</span>

            <span class="n">mp3_dirname</span> <span class="o">=</span> <span class="n">generate_mp3_dirname</span><span class="p">(</span><span class="n">mp3_library_root</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
            <span class="n">mp3_basename</span> <span class="o">=</span> <span class="n">generate_mp3_basename</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
            <span class="n">mp3_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mp3_dirname</span><span class="p">,</span> <span class="n">mp3_basename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">,</span> <span class="n">mp3_filename</span><span class="p">)</span>

            <span class="n">encoder</span><span class="o">.</span><span class="n">add_instruction</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">cdda_filename</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">,</span>
                                    <span class="n">mp3_filename</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoder</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">encoder</span>

    <span class="k">def</span> <span class="nf">_monitor_encoding_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the UI as tracks are ripped.&quot;&quot;&quot;</span>
        <span class="c1"># don&#39;t log entry into this method - it is called repeatedly until all</span>
        <span class="c1"># tracks are ripped</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span> <span class="o">=</span> <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="n">QUEUE_GET_NOWAIT_AFTER</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_encoding_progress</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;dequeued </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>

            <span class="p">(</span><span class="n">track_index</span><span class="p">,</span> <span class="n">cdda_fn</span><span class="p">,</span> <span class="n">flac_fn</span><span class="p">,</span> <span class="n">stdout_fn</span><span class="p">,</span> <span class="n">target_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">status</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">target_state</span> <span class="o">==</span> <span class="s2">&quot;FINISHED&quot;</span><span class="p">):</span>
                <span class="c1"># all tracks have been processed</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;finished; discarding </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                                            <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">())</span>
                    <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">disc_eject_button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rip_and_tag_button</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rip_and_tag_button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">bell</span><span class="p">()</span>
                <span class="c1"># break out of the monitoring loop</span>
                <span class="k">return</span>

            <span class="n">track_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_labels</span><span class="p">[</span><span class="n">track_index</span><span class="p">]</span>
            <span class="n">track_encoding_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_encoding_statuses</span><span class="p">[</span><span class="n">track_index</span><span class="p">]</span>

            <span class="c1"># only process &quot;expected&quot; state transitions</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">track_encoding_status</span><span class="o">.</span><span class="n">transition_to</span><span class="p">(</span><span class="n">target_state</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">track_encoding_status</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">TRACK_FAILED</span><span class="p">):</span>
                    <span class="n">status_message</span> <span class="o">=</span> <span class="n">track_encoding_status</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target_state</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                                             <span class="n">target_state</span><span class="p">)</span>
                                 <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_state</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span>
                                 <span class="k">else</span> <span class="kc">None</span><span class="p">))</span>
                    <span class="n">item_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fg&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">}</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">track_encoding_status</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">TRACK_ENCODING_FLAC</span><span class="p">):</span>
                    <span class="c1"># ensure that the currently-ripping track is always visible</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_encoding_status_list</span><span class="o">.</span><span class="n">see</span><span class="p">(</span><span class="n">track_index</span><span class="p">)</span>
                    <span class="c1"># read encoding interval status from flac&#39;s stdout</span>
                    <span class="n">cdda_basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cdda_fn</span><span class="p">)</span>
                    <span class="n">stdout_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_current_status</span><span class="p">(</span><span class="n">cdda_basename</span><span class="p">,</span>
                                                               <span class="n">stdout_fn</span><span class="p">)</span>
                    <span class="n">status_message</span> <span class="o">=</span> <span class="n">track_encoding_status</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="n">stdout_message</span> <span class="k">if</span> <span class="n">stdout_message</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">item_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fg&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">}</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">track_encoding_status</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">(</span><span class="n">TRACK_DECODING_WAV</span><span class="p">,</span>
                                                      <span class="n">TRACK_ENCODING_MP3</span><span class="p">)):</span>
                    <span class="n">status_message</span> <span class="o">=</span> <span class="n">track_encoding_status</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
                    <span class="n">item_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fg&quot;</span><span class="p">:</span> <span class="s2">&quot;dark violet&quot;</span><span class="p">}</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">track_encoding_status</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">TRACK_COMPLETE</span><span class="p">):</span>
                    <span class="n">status_message</span> <span class="o">=</span> <span class="n">flac_fn</span>
                    <span class="n">item_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fg&quot;</span><span class="p">:</span> <span class="s2">&quot;dark green&quot;</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>   <span class="c1"># unexpected state</span>
                    <span class="n">status_message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (unexpected target state </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">track_encoding_status</span><span class="o">.</span><span class="n">describe</span><span class="p">(),</span>
                                        <span class="n">target_state</span><span class="p">)</span>
                    <span class="n">item_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fg&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">}</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_encoding_status_list</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">track_index</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_encoding_status_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">track_index</span><span class="p">,</span> <span class="n">status_message</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_encoding_status_list</span><span class="o">.</span><span class="n">itemconfig</span><span class="p">(</span><span class="n">track_index</span><span class="p">,</span> <span class="n">item_config</span><span class="p">)</span>
                <span class="c1"># ensure that last track is always visible after delete/insert</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">track_index</span> <span class="o">==</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoding_status_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">END</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_encoding_status_list</span><span class="o">.</span><span class="n">see</span><span class="p">(</span><span class="n">track_index</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="n">QUEUE_GET_NOWAIT_AFTER</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_encoding_progress</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_current_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">cdda_basename</span><span class="p">:</span> <span class="s2">&quot;string, basically a grep pattern for *stdout_fn*&quot;</span><span class="p">,</span>
            <span class="n">stdout_fn</span><span class="p">:</span> <span class="s2">&quot;filename to which stdout has been redirected&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;string line of update text from a redirected stdout file&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Extract the most recent FLAC encoding update from *stdout_fn*.&quot;&quot;&quot;</span>
        <span class="c1"># do not log entry; called from a recursive method</span>
        <span class="n">status_line</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: &quot;</span> <span class="o">%</span> <span class="n">cdda_basename</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">stdout_fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)):</span>
                    <span class="c1"># remove the prefix, then split on ASCII BS (Backspace) and</span>
                    <span class="c1"># take the last component</span>
                    <span class="c1">#</span>
                    <span class="c1"># output line looks like this:</span>
                    <span class="c1">#   ${prefix}${status1}(BS)+${status2}(BS)+..${statusN}</span>
                    <span class="n">status_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x08</span><span class="s1">&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">status_line</span>

    <span class="k">def</span> <span class="nf">_destroy_metadata_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cleanup up UI resources created for the metadata editor.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_editor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata_editor</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_editor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_persistence</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_album_metadata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tracks_metadata</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">album_title_var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">album_artist_var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">album_performer_var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">album_genre_var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">album_year_var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">album_disc_number_var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">album_disc_total_var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">album_cover_var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_album_covers</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">track_title_entry</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_title_optionmenu</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_artist_entry</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_artist_optionmenu</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_performer_entry</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_performer_optionmenu</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_genre_entry</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_genre_optionmenu</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_year_entry</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_year_optionmenu</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_vars</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_do_disc_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Spawn the :class:`DiscCheck` thread.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retry_disc_check_button</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>
        <span class="n">DiscCheck</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_disc</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_check_for_disc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the UI if a CD-DA disc is present.</span>

<span class="sd">        If a disc is **not** present, set a UI timer to check again.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># don&#39;t log entry into this method - it is called repeatedly until a</span>
        <span class="c1"># disc is found</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">disc_info</span> <span class="o">=</span> <span class="n">_DISC_QUEUE</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="n">QUEUE_GET_NOWAIT_AFTER</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_disc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_DISC_QUEUE</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;dequeued </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">disc_info</span><span class="p">)</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_disk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mountpoint</span><span class="p">)</span> <span class="o">=</span> <span class="n">disc_info</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">disc_info</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;dequeued </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">disc_info</span><span class="p">)</span>
                <span class="n">show_exception_dialog</span><span class="p">(</span><span class="n">disc_info</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">retry_disc_check_button</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                                                  <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">disc_status_message</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disc_status_message</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mountpoint</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disc_eject_button</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disc_status_message</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">toc</span> <span class="o">=</span> <span class="n">read_disc_toc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mountpoint</span><span class="p">)</span>
            <span class="c1"># once we have the TOC, it&#39;s ok for the disc to be ejected (though,</span>
            <span class="c1"># of course, if it&#39;s ejected immediately it can&#39;t be ripped)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disc_eject_button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_do_metadata_aggregation</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_do_metadata_aggregation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Spawn the :classs:`MetadataAggregator` thread.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">MetadataAggregator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;failed to start metadata aggregator&quot;</span><span class="p">)</span>
            <span class="n">show_exception_dialog</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retry_aggregation_button</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edit_offline_button</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retry_aggregation_button</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edit_offline_button</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_aggregator</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_check_for_aggregator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the UI if aggregated metadata is ready.</span>

<span class="sd">        If aggregated metadata is **not** ready, set a UI timer to check</span>
<span class="sd">        again.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># don&#39;t log entry into this method - it calls itself recursively until</span>
        <span class="c1"># the aggregated metadata is ready</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">aggregator</span> <span class="o">=</span> <span class="n">_AGGREGATOR_QUEUE</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_aggregator</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;dequeued </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">aggregator</span><span class="p">)</span>
            <span class="n">_AGGREGATOR_QUEUE</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

            <span class="c1"># set these whether an error occurred or not - they&#39;re needed by</span>
            <span class="c1"># offline editing mode as well</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_persistence</span> <span class="o">=</span> <span class="n">aggregator</span><span class="o">.</span><span class="n">persistence</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_album_metadata</span> <span class="o">=</span> <span class="n">aggregator</span><span class="o">.</span><span class="n">album</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tracks_metadata</span> <span class="o">=</span> <span class="n">aggregator</span><span class="o">.</span><span class="n">tracks</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">aggregator</span><span class="o">.</span><span class="n">exception</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_create_metadata_editor</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;failed to create metadata editor&quot;</span><span class="p">)</span>
                    <span class="n">show_exception_dialog</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">retry_aggregation_button</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">edit_offline_button</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">show_exception_dialog</span><span class="p">(</span><span class="n">aggregator</span><span class="o">.</span><span class="n">exception</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">retry_aggregation_button</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">edit_offline_button</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">_eject_disc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Eject the current CD-DA disc and update the UI.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s2">&quot;diskutil&quot;</span><span class="p">,</span> <span class="s2">&quot;eject&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disk</span><span class="p">],</span>
                                 <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
                                 <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ejected </span><span class="si">%s</span><span class="s2"> mounted at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">_disk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mountpoint</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rip_and_tag_button</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_destroy_metadata_editor</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding_status_frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">encoding_status_frame</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">encoding_status_frame</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_encoding_status_list</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_encoding_status_list</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mountpoint</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disc_eject_button</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retry_aggregation_button</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edit_offline_button</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toc</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disc_status_message</span><span class="o">.</span><span class="n">config</span><span class="p">(</span>
                <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Waiting for a disc to be inserted</span><span class="se">\u2026</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">padx</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

            <span class="n">DiscCheck</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_disc</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;unable to eject </span><span class="si">%s</span><span class="s2"> mounted at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_disk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mountpoint</span><span class="p">)</span>
            <span class="n">messagebox</span><span class="o">.</span><span class="n">showerror</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Disk eject failure&quot;</span><span class="p">,</span>
                                 <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Unable to eject </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_mountpoint</span><span class="p">)</span>

<div class="viewcode-block" id="FLACManager.edit_config"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.edit_config">[docs]</a>    <span class="k">def</span> <span class="nf">edit_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the configuration editor dialog.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">EditConfigurationDialog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Edit flacmanager.ini&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="FLACManager.prerequisites"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.prerequisites">[docs]</a>    <span class="k">def</span> <span class="nf">prerequisites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the prerequisites information dialog.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">PrerequisitesDialog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> prerequisites&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">TITLE</span><span class="p">)</span></div>

<div class="viewcode-block" id="FLACManager.about"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.about">[docs]</a>    <span class="k">def</span> <span class="nf">about</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the application description dialog.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">AboutDialog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;About </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">TITLE</span><span class="p">)</span></div></div>


<span class="nd">@total_ordering</span>
<div class="viewcode-block" id="TrackState"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.TrackState">[docs]</a><span class="k">class</span> <span class="nc">TrackState</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents the state of a single track at any given time during</span>
<span class="sd">    the rip-and-tag operation.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ordinal</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param int ordinal: this state&#39;s relative value</span>
<span class="sd">        :param str key: uniquely identifies this state</span>
<span class="sd">        :param str text: a short description of this state</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ordinal</span> <span class="o">=</span> <span class="n">ordinal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_text</span> <span class="o">=</span> <span class="n">text</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The track-independent short description of this state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text</span>

    <span class="k">def</span> <span class="nf">__int__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the relative (ordinal) value of this state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ordinal</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the unique identifier for this state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string that is unique for this track state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%d</span><span class="s2">, </span><span class="si">%r</span><span class="s2">, </span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ordinal</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return ``True`` if this state&#39;s ordinal value is less than</span>
<span class="sd">        *other* state&#39;s ordinal value, otherwise ``False``.</span>

<span class="sd">        :param flacmanager.TrackState other: the state being compared</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return ``True`` if this state&#39;s ordinal value and key are</span>
<span class="sd">        equal to *other* state&#39;s ordinal value and key, otherwise</span>
<span class="sd">        ``False``.</span>

<span class="sd">        :param flacmanager.TrackState other: the state being compared</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span> <span class="ow">and</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ordinal</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_ordinal</span><span class="p">)</span> <span class="ow">and</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_key</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>


<span class="c1">#: Indicates that a track is excluded from the rip-and-tag operation.</span>
<span class="n">TRACK_EXCLUDED</span> <span class="o">=</span> <span class="n">TrackState</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;EXCLUDED&quot;</span><span class="p">,</span> <span class="s2">&quot;excluded&quot;</span><span class="p">)</span>

<span class="c1">#: Indicates that the rip-and-tag process has not yet begun for a track.</span>
<span class="n">TRACK_PENDING</span> <span class="o">=</span> <span class="n">TrackState</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;PENDING&quot;</span><span class="p">,</span> <span class="s2">&quot;pending</span><span class="se">\u2026</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1">#: Indicates that a track is being encoded from CDDA to FLAC format.</span>
<span class="n">TRACK_ENCODING_FLAC</span> <span class="o">=</span> <span class="n">TrackState</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;ENCODING_FLAC&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;encoding CDDA to FLAC</span><span class="se">\u2026</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1">#: Indicates that a track is being decoded from FLAC to WAV format.</span>
<span class="n">TRACK_DECODING_WAV</span> <span class="o">=</span> <span class="n">TrackState</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;DECODING_WAV&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;decoding FLAC to WAV</span><span class="se">\u2026</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1">#: Indicates that a track is being encoded from WAV to MP3 format.</span>
<span class="n">TRACK_ENCODING_MP3</span> <span class="o">=</span> <span class="n">TrackState</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;ENCODING_MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;encoding WAV to MP3</span><span class="se">\u2026</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1">#: Indicates that an error occurred while processing a track.</span>
<span class="n">TRACK_FAILED</span> <span class="o">=</span> <span class="n">TrackState</span><span class="p">(</span><span class="mi">99</span><span class="p">,</span> <span class="s2">&quot;FAILED&quot;</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">)</span>

<span class="c1">#: Indicates that the rip-and-tag process has finished for a track.</span>
<span class="n">TRACK_COMPLETE</span> <span class="o">=</span> <span class="n">TrackState</span><span class="p">(</span><span class="mi">99</span><span class="p">,</span> <span class="s2">&quot;COMPLETE&quot;</span><span class="p">,</span> <span class="s2">&quot;complete&quot;</span><span class="p">)</span>


<span class="nd">@logged</span>
<div class="viewcode-block" id="TrackEncodingStatus"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.TrackEncodingStatus">[docs]</a><span class="k">class</span> <span class="nc">TrackEncodingStatus</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A simple state machine for a single track&#39;s encoding status.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">track_label</span><span class="p">,</span> <span class="n">pending</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param str track_label: the track&#39;s display label</span>
<span class="sd">        :keyword bool pending:\</span>
<span class="sd">           the default ``True`` initializes status as\</span>
<span class="sd">           :data:`TRACK_PENDING`; set to ``False`` to initialize status\</span>
<span class="sd">           as :data:`TRACK_EXCLUDED`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_label</span> <span class="o">=</span> <span class="n">track_label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__state</span> <span class="o">=</span> <span class="n">TRACK_PENDING</span> <span class="k">if</span> <span class="n">pending</span> <span class="k">else</span> <span class="n">TRACK_EXCLUDED</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The current state of encoding for this track.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__state</span>

<div class="viewcode-block" id="TrackEncodingStatus.transition_to"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.TrackEncodingStatus.transition_to">[docs]</a>    <span class="k">def</span> <span class="nf">transition_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Advance this track&#39;s encoding state from its current state to</span>
<span class="sd">        *to_state*, if permitted.</span>

<span class="sd">        :param to_state: the target encoding state, or any\</span>
<span class="sd">                         :class:`Exception` to transition to\</span>
<span class="sd">                         :data:`TRACK_FAILED`</span>
<span class="sd">        :return: ``True`` if the transition is successful,\</span>
<span class="sd">                 otherwise ``False``</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">from_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__state</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">to_state</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)):</span>
            <span class="n">to_state</span> <span class="o">=</span> <span class="n">TRACK_FAILED</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">from_state</span> <span class="ow">in</span> <span class="p">(</span><span class="n">TRACK_EXCLUDED</span><span class="p">,</span> <span class="n">TRACK_FAILED</span><span class="p">,</span> <span class="n">TRACK_COMPLETE</span><span class="p">))</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">to_state</span> <span class="o">&lt;</span> <span class="n">from_state</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: illegal transition from </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">track_label</span><span class="p">,</span> <span class="n">from_state</span><span class="p">,</span> <span class="n">to_state</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__state</span> <span class="o">=</span> <span class="n">to_state</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="TrackEncodingStatus.describe"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.TrackEncodingStatus.describe">[docs]</a>    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a short display string for this track and its current</span>
<span class="sd">        status.</span>

<span class="sd">        :param str message: short piece of text to use with the track\</span>
<span class="sd">                            label (instead of the default message for\</span>
<span class="sd">                            the current state)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_label</span><span class="p">,</span> <span class="n">message</span> <span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
                                             <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">__state</span><span class="o">.</span><span class="n">text</span><span class="p">)</span></div></div>


<span class="c1">#: A list of format strings for individual folder names that, joined, make up</span>
<span class="c1">#: the *library_root*-relative directory path for a FLAC file.</span>
<span class="n">FLAC_FOLDERS_TEMPLATE</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%(album_artist)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%(album_title)s</span><span class="s2">&quot;</span><span class="p">]</span>

<span class="c1">#: A list of format strings for individual folder names that, joined, make up</span>
<span class="c1">#: the *library_root*-relative directory path for a FLAC file that is part of a</span>
<span class="c1">#: compilation.</span>
<span class="n">FLAC_FOLDERS_COMPILATION_TEMPLATE</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_COMPILATIONS_&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%(album_title)s</span><span class="s2">&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="generate_flac_dirname"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.generate_flac_dirname">[docs]</a><span class="k">def</span> <span class="nf">generate_flac_dirname</span><span class="p">(</span><span class="n">library_root</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build the directory for a track&#39;s FLAC file.</span>

<span class="sd">    :param str library_root: the FLAC library directory</span>
<span class="sd">    :param dict metadata: the finalized metadata for a single track</span>
<span class="sd">    :return: an absolute directory path</span>
<span class="sd">    :rtype: :obj:`str`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE library_root = </span><span class="si">%r</span><span class="s2">, metadata = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                  <span class="n">library_root</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
    <span class="n">folders_template</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">FLAC_FOLDERS_TEMPLATE</span> <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_compilation&quot;</span><span class="p">])</span>
        <span class="k">else</span> <span class="n">FLAC_FOLDERS_COMPILATION_TEMPLATE</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;using template </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">folders_template</span><span class="p">)</span>
    <span class="n">folders</span> <span class="o">=</span> <span class="p">[</span><span class="n">format_string</span> <span class="o">%</span> <span class="n">metadata</span>
               <span class="k">for</span> <span class="n">format_string</span> <span class="ow">in</span> <span class="n">folders_template</span><span class="p">]</span>
    <span class="n">folders</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">r&quot;[</span><span class="se">\\</span><span class="s2">/:*?</span><span class="se">\&quot;</span><span class="s2">&lt;&gt;|]&quot;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">]</span>
    <span class="n">folders_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folders</span><span class="p">)</span>
    <span class="n">album_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">library_root</span><span class="p">,</span> <span class="n">folders_path</span><span class="p">)</span>
    <span class="c1"># doesn&#39;t work as expected for external media</span>
    <span class="c1">#os.makedirs(album_path, exist_ok=True)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s2">&quot;mkdir&quot;</span><span class="p">,</span> <span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="n">album_path</span><span class="p">])</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">album_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">album_path</span></div>


<span class="c1">#: The format string for a FLAC filename.</span>
<span class="n">FLAC_FILENAME_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(track_number)02d</span><span class="s2"> </span><span class="si">%(track_title)s</span><span class="s2">.flac&quot;</span>

<span class="c1">#: The format string for a FLAC filename that is part of a compilation.</span>
<span class="n">FLAC_FILENAME_COMPILATION_TEMPLATE</span> <span class="o">=</span> \
    <span class="s2">&quot;</span><span class="si">%(track_number)02d</span><span class="s2"> </span><span class="si">%(track_title)s</span><span class="s2"> (</span><span class="si">%(track_artist)s</span><span class="s2">).flac&quot;</span>

<span class="c1">#: The format string for a FLAC filename on an album of 2+ discs.</span>
<span class="n">FLAC_FILENAME_DISCN_TEMPLATE</span> <span class="o">=</span> \
    <span class="s2">&quot;</span><span class="si">%(disc_number)02d</span><span class="s2">-</span><span class="si">%(track_number)02d</span><span class="s2"> </span><span class="si">%(track_title)s</span><span class="s2">.flac&quot;</span>

<span class="c1">#: The format string for a FLAC filename that is part of a compilation</span>
<span class="c1">#: spanning 2+ discs.</span>
<span class="n">FLAC_FILENAME_DISCN_COMPILATION_TEMPLATE</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;</span><span class="si">%(disc_number)02d</span><span class="s2">-</span><span class="si">%(track_number)02d</span><span class="s2"> &quot;</span>
    <span class="s2">&quot;</span><span class="si">%(track_title)s</span><span class="s2"> (</span><span class="si">%(track_artist)s</span><span class="s2">).flac&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="generate_flac_basename"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.generate_flac_basename">[docs]</a><span class="k">def</span> <span class="nf">generate_flac_basename</span><span class="p">(</span><span class="n">metadata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build the filename for a track&#39;s FLAC file.</span>

<span class="sd">    :param dict metadata: the finalized metadata for a single track</span>
<span class="sd">    :return: a relative file name</span>
<span class="sd">    :rtype: :obj:`str`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE metadata = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
    <span class="n">format_string</span> <span class="o">=</span> <span class="n">FLAC_FILENAME_TEMPLATE</span>
    <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_compilation&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;disc_total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="c1"># the most common case</span>
        <span class="n">format_string</span> <span class="o">=</span> <span class="n">FLAC_FILENAME_TEMPLATE</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_compilation&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;disc_total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="n">format_string</span> <span class="o">=</span> <span class="n">FLAC_FILENAME_COMPILATION_TEMPLATE</span>
    <span class="k">elif</span> <span class="p">((</span><span class="ow">not</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_compilation&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;disc_total&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="n">format_string</span> <span class="o">=</span> <span class="n">FLAC_FILENAME_DISCN_TEMPLATE</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># is_compilation and disc_total &gt; 1</span>
        <span class="n">format_string</span> <span class="o">=</span> <span class="n">FLAC_FILENAME_DISCN_COMPILATION_TEMPLATE</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;using template </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">format_string</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">format_string</span> <span class="o">%</span> <span class="n">metadata</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">r&quot;[</span><span class="se">\\</span><span class="s2">/:*?</span><span class="se">\&quot;</span><span class="s2">&lt;&gt;|]&quot;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filename</span></div>


<span class="c1">#: A list of format strings for individual folder names that, joined, make up</span>
<span class="c1">#: the *library_root*-relative directory path for an MP3 file.</span>
<span class="n">MP3_FOLDERS_TEMPLATE</span> <span class="o">=</span> <span class="n">FLAC_FOLDERS_TEMPLATE</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1">#: A list of format strings for individual folder names that, joined, make up</span>
<span class="c1">#: the *library_root*-relative directory path for an MP3 file that is part of a</span>
<span class="c1">#: compilation.</span>
<span class="n">MP3_FOLDERS_COMPILATION_TEMPLATE</span> <span class="o">=</span> <span class="n">FLAC_FOLDERS_COMPILATION_TEMPLATE</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


<div class="viewcode-block" id="generate_mp3_dirname"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.generate_mp3_dirname">[docs]</a><span class="k">def</span> <span class="nf">generate_mp3_dirname</span><span class="p">(</span><span class="n">library_root</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build the directory for a track&#39;s MP3 file.</span>

<span class="sd">    :param str library_root: the MP3 library directory</span>
<span class="sd">    :param dict metadata: the finalized metadata for a single track</span>
<span class="sd">    :return: an absolute directory path</span>
<span class="sd">    :rtype: :obj:`str`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE library_root = </span><span class="si">%r</span><span class="s2">, metadata = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                  <span class="n">library_root</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
    <span class="n">folders_template</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">MP3_FOLDERS_TEMPLATE</span> <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_compilation&quot;</span><span class="p">])</span>
        <span class="k">else</span> <span class="n">MP3_FOLDERS_COMPILATION_TEMPLATE</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;using template </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">folders_template</span><span class="p">)</span>
    <span class="n">folders</span> <span class="o">=</span> <span class="p">[</span><span class="n">format_string</span> <span class="o">%</span> <span class="n">metadata</span>
               <span class="k">for</span> <span class="n">format_string</span> <span class="ow">in</span> <span class="n">folders_template</span><span class="p">]</span>
    <span class="n">folders</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">r&quot;[</span><span class="se">\\</span><span class="s2">/:*?</span><span class="se">\&quot;</span><span class="s2">&lt;&gt;|]&quot;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">]</span>
    <span class="n">folders_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folders</span><span class="p">)</span>
    <span class="n">album_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">library_root</span><span class="p">,</span> <span class="n">folders_path</span><span class="p">)</span>
    <span class="c1"># doesn&#39;t work as expected for external media</span>
    <span class="c1">#os.makedirs(album_path, exist_ok=True)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s2">&quot;mkdir&quot;</span><span class="p">,</span> <span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="n">album_path</span><span class="p">])</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">album_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">album_path</span></div>


<span class="c1">#: The format string for an MP3 filename.</span>
<span class="n">MP3_FILENAME_TEMPLATE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">FLAC_FILENAME_TEMPLATE</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.mp3&quot;</span>

<span class="c1">#: The format string for an MP3 filename that is part of a compilation.</span>
<span class="n">MP3_FILENAME_COMPILATION_TEMPLATE</span> <span class="o">=</span> \
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">FLAC_FILENAME_COMPILATION_TEMPLATE</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.mp3&quot;</span>

<span class="c1">#: The format string for an MP3 filename on an album of 2+ discs.</span>
<span class="n">MP3_FILENAME_DISCN_TEMPLATE</span> <span class="o">=</span> \
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">FLAC_FILENAME_DISCN_TEMPLATE</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.mp3&quot;</span>

<span class="c1">#: The format string for an MP3 filename that is part of a compilation</span>
<span class="c1">#: spanning 2+ discs.</span>
<span class="n">MP3_FILENAME_DISCN_COMPILATION_TEMPLATE</span> <span class="o">=</span> \
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">FLAC_FILENAME_DISCN_COMPILATION_TEMPLATE</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.mp3&quot;</span>


<div class="viewcode-block" id="generate_mp3_basename"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.generate_mp3_basename">[docs]</a><span class="k">def</span> <span class="nf">generate_mp3_basename</span><span class="p">(</span><span class="n">metadata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build the filename for a track&#39;s MP3 file.</span>

<span class="sd">    :param dict metadata: the finalized metadata for a single track</span>
<span class="sd">    :return: a relative file name</span>
<span class="sd">    :rtype: :obj:`str`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE metadata = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
    <span class="n">format_string</span> <span class="o">=</span> <span class="n">MP3_FILENAME_TEMPLATE</span>
    <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_compilation&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;disc_total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="c1"># the most common case</span>
        <span class="n">format_string</span> <span class="o">=</span> <span class="n">MP3_FILENAME_TEMPLATE</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_compilation&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;disc_total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="n">format_string</span> <span class="o">=</span> <span class="n">MP3_FILENAME_COMPILATION_TEMPLATE</span>
    <span class="k">elif</span> <span class="p">((</span><span class="ow">not</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;is_compilation&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;disc_total&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="n">format_string</span> <span class="o">=</span> <span class="n">MP3_FILENAME_DISCN_TEMPLATE</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># is_compilation and disc_total &gt; 1</span>
        <span class="n">format_string</span> <span class="o">=</span> <span class="n">MP3_FILENAME_DISCN_COMPILATION_TEMPLATE</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;using template </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">format_string</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">format_string</span> <span class="o">%</span> <span class="n">metadata</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">r&quot;[</span><span class="se">\\</span><span class="s2">/:*?</span><span class="se">\&quot;</span><span class="s2">&lt;&gt;|]&quot;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filename</span></div>


<span class="k">def</span> <span class="nf">_font</span><span class="p">(</span><span class="n">widget</span><span class="p">:</span> <span class="s2">&quot;a :class:`tkinter.Widget`&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Proxy *widget*&#39;s font so that it can be configured.</span>

<span class="sd">    This is a helper function to allow the following shorthand:</span>

<span class="sd">    &gt;&gt;&gt; _font(widget).config(**keywords)</span>

<span class="sd">    Updates to a :class:`tkinter.font.Font` done in this way affect</span>
<span class="sd">    **only** the *widget*.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">font</span> <span class="o">=</span> <span class="n">tkfont</span><span class="o">.</span><span class="n">Font</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">widget</span><span class="p">[</span><span class="s2">&quot;font&quot;</span><span class="p">])</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">font</span>


<div class="viewcode-block" id="PrerequisitesDialog"><a class="viewcode-back" href="../user-interface.html#flacmanager.PrerequisitesDialog">[docs]</a><span class="k">class</span> <span class="nc">PrerequisitesDialog</span><span class="p">(</span><span class="n">simpledialog</span><span class="o">.</span><span class="n">Dialog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dialog that describes all FLAC Manager prerequisites.&quot;&quot;&quot;</span>

    <span class="c1">#: The content of the dialog.</span>
    <span class="n">TEXT</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">%(title)s</span><span class="s2"> runs on Python 3.3+.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;</span><span class="si">%(title)s</span><span class="s2"> requires the following external software components:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;* libdiscid (http://musicbrainz.org/doc/libdiscid)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;* flac (http://flac.sourceforge.net/)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;* lame (http://lame.sourceforge.net/)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;The flac and lame command-line binaries must exist on your $PATH. &quot;</span>
        <span class="s2">&quot;Each of these components is also available through MacPorts &quot;</span>
        <span class="s2">&quot;(http://www.macports.org/).</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;In addition to the software listed above, </span><span class="si">%(title)s</span><span class="s2"> relies on the &quot;</span>
        <span class="s2">&quot;following Mac OS X command line utilties:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;* diskutil</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;* open</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;* mkdir</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;You must register for a Gracenote developer account &quot;</span>
        <span class="s2">&quot;(https://developer.gracenote.com/) in order for </span><span class="si">%(title)s</span><span class="s2">&#39;s metadata &quot;</span>
        <span class="s2">&quot;aggregation to function properly:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;1. Create your Gracenote developer account.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;2. Create an app named </span><span class="se">\&quot;</span><span class="si">%(title)s</span><span class="s2">.</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;3. Save your Gracenote Client ID in </span><span class="si">%(title)s</span><span class="s2">&#39;s configuration file.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;</span><span class="si">%(title)s</span><span class="s2"> will automatically obtain and store the Gracenote User &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;ID in the flacmanager.ini file.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
    <span class="p">)</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">FLACManager</span><span class="o">.</span><span class="n">TITLE</span><span class="p">)</span>

<div class="viewcode-block" id="PrerequisitesDialog.body"><a class="viewcode-back" href="../user-interface.html#flacmanager.PrerequisitesDialog.body">[docs]</a>    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the content of the dialog.&quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">scrolledtext</span><span class="o">.</span><span class="n">ScrolledText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">bd</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">relief</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">FLAT</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">WORD</span><span class="p">)</span>
        <span class="n">text</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEXT</span><span class="p">)</span>
        <span class="n">text</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
        <span class="n">text</span><span class="o">.</span><span class="n">focus_set</span><span class="p">()</span></div>

<div class="viewcode-block" id="PrerequisitesDialog.buttonbox"><a class="viewcode-back" href="../user-interface.html#flacmanager.PrerequisitesDialog.buttonbox">[docs]</a>    <span class="k">def</span> <span class="nf">buttonbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the button to dismiss the dialog.&quot;&quot;&quot;</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">,</span>
                  <span class="n">default</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Return&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">)</span>
        <span class="n">box</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="AboutDialog"><a class="viewcode-back" href="../user-interface.html#flacmanager.AboutDialog">[docs]</a><span class="k">class</span> <span class="nc">AboutDialog</span><span class="p">(</span><span class="n">simpledialog</span><span class="o">.</span><span class="n">Dialog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dialog that describes FLAC Manager.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="AboutDialog.body"><a class="viewcode-back" href="../user-interface.html#flacmanager.AboutDialog.body">[docs]</a>    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the content of the dialog.&quot;&quot;&quot;</span>
        <span class="n">title_label</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> v</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">FLACManager</span><span class="o">.</span><span class="n">TITLE</span><span class="p">,</span> <span class="n">__version__</span><span class="p">),</span>
            <span class="n">fg</span><span class="o">=</span><span class="s2">&quot;DarkOrange2&quot;</span><span class="p">)</span>
        <span class="n">_font</span><span class="p">(</span><span class="n">title_label</span><span class="p">)</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">tkfont</span><span class="o">.</span><span class="n">BOLD</span><span class="p">)</span>
        <span class="n">title_label</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">scrolledtext</span><span class="o">.</span><span class="n">ScrolledText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">bd</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">relief</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">FLAT</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;LICENSE.txt&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">text</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">text</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
        <span class="n">text</span><span class="o">.</span><span class="n">focus_set</span><span class="p">()</span></div>

<div class="viewcode-block" id="AboutDialog.buttonbox"><a class="viewcode-back" href="../user-interface.html#flacmanager.AboutDialog.buttonbox">[docs]</a>    <span class="k">def</span> <span class="nf">buttonbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the button to dismiss the dialog.&quot;&quot;&quot;</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">,</span>
                  <span class="n">default</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Return&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">)</span>
        <span class="n">box</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="EditConfigurationDialog"><a class="viewcode-back" href="../user-interface.html#flacmanager.EditConfigurationDialog">[docs]</a><span class="k">class</span> <span class="nc">EditConfigurationDialog</span><span class="p">(</span><span class="n">simpledialog</span><span class="o">.</span><span class="n">Dialog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dialog that allows the user to edit the *flacmanager.ini* file.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="EditConfigurationDialog.body"><a class="viewcode-back" href="../user-interface.html#flacmanager.EditConfigurationDialog.body">[docs]</a>    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the content of the dialog.&quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>

        <span class="n">logging_label</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Logging&quot;</span><span class="p">)</span>
        <span class="n">_font</span><span class="p">(</span><span class="n">logging_label</span><span class="p">)</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">tkfont</span><span class="o">.</span><span class="n">BOLD</span><span class="p">)</span>
        <span class="n">logging_label</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;level&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;OFF&quot;</span><span class="p">,</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span> <span class="s2">&quot;WARNING&quot;</span><span class="p">,</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">,</span> <span class="s2">&quot;CRITICAL&quot;</span><span class="p">]</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Logging&quot;</span><span class="p">,</span> <span class="s2">&quot;level&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logging_level</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">value</span><span class="o">=</span><span class="n">level</span> <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;OFF&quot;</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">OptionMenu</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logging_level</span><span class="p">,</span>
                      <span class="o">*</span><span class="n">levels</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;filename&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logging_filename</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                    <span class="n">value</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Logging&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">))</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logging_filename</span><span class="p">,</span>
                 <span class="n">width</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;filemode&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logging_filemode</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                    <span class="n">value</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Logging&quot;</span><span class="p">,</span> <span class="s2">&quot;filemode&quot;</span><span class="p">))</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logging_filemode</span><span class="p">,</span>
                 <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;format&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logging_format</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Logging&quot;</span><span class="p">,</span> <span class="s2">&quot;format&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logging_format</span><span class="p">,</span>
                 <span class="n">width</span><span class="o">=</span><span class="mi">79</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>

        <span class="n">http_label</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;HTTP&quot;</span><span class="p">)</span>
        <span class="n">_font</span><span class="p">(</span><span class="n">http_label</span><span class="p">)</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">tkfont</span><span class="o">.</span><span class="n">BOLD</span><span class="p">)</span>
        <span class="n">http_label</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;debuglevel&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">http_debuglevel</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">IntVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;HTTP&quot;</span><span class="p">,</span> <span class="s2">&quot;debuglevel&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Checkbutton</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">http_debuglevel</span><span class="p">,</span> <span class="n">onvalue</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">offvalue</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;timeout&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">http_timeout</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">DoubleVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">value</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;HTTP&quot;</span><span class="p">,</span> <span class="s2">&quot;timeout&quot;</span><span class="p">))</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">http_timeout</span><span class="p">,</span>
                 <span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>

        <span class="n">gracenote_label</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">)</span>
        <span class="n">_font</span><span class="p">(</span><span class="n">gracenote_label</span><span class="p">)</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">tkfont</span><span class="o">.</span><span class="n">BOLD</span><span class="p">)</span>
        <span class="n">gracenote_label</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;client_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gracenote_client_id</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                    <span class="n">value</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">,</span> <span class="s2">&quot;client_id&quot;</span><span class="p">))</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gracenote_client_id</span><span class="p">,</span>
                 <span class="n">width</span><span class="o">=</span><span class="mi">53</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gracenote_user_id</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                    <span class="n">value</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">))</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gracenote_user_id</span><span class="p">,</span>
                 <span class="n">width</span><span class="o">=</span><span class="mi">53</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>

        <span class="n">musicbrainz_label</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;MusicBrainz&quot;</span><span class="p">)</span>
        <span class="n">_font</span><span class="p">(</span><span class="n">musicbrainz_label</span><span class="p">)</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">tkfont</span><span class="o">.</span><span class="n">BOLD</span><span class="p">)</span>
        <span class="n">musicbrainz_label</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;contact_url_or_email&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">musicbrainz_contact_url_or_email</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MusicBrainz&quot;</span><span class="p">,</span> <span class="s2">&quot;contact_url_or_email&quot;</span><span class="p">))</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">musicbrainz_contact_url_or_email</span><span class="p">,</span>
                 <span class="n">width</span><span class="o">=</span><span class="mi">37</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;libdiscid_location&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">musicbrainz_libdiscid_location</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MusicBrainz&quot;</span><span class="p">,</span> <span class="s2">&quot;libdiscid_location&quot;</span><span class="p">))</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">musicbrainz_libdiscid_location</span><span class="p">,</span>
                 <span class="n">width</span><span class="o">=</span><span class="mi">47</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>

        <span class="n">flac_label</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;FLAC&quot;</span><span class="p">)</span>
        <span class="n">_font</span><span class="p">(</span><span class="n">flac_label</span><span class="p">)</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">tkfont</span><span class="o">.</span><span class="n">BOLD</span><span class="p">)</span>
        <span class="n">flac_label</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;library_root&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flac_library_root</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                    <span class="n">value</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;library_root&quot;</span><span class="p">))</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flac_library_root</span><span class="p">,</span>
                 <span class="n">width</span><span class="o">=</span><span class="mi">47</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;flac_encode_options&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flac_encode_options</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;flac_encode_options&quot;</span><span class="p">))</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flac_encode_options</span><span class="p">,</span>
                 <span class="n">width</span><span class="o">=</span><span class="mi">59</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;flac_decode_options&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flac_decode_options</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;flac_decode_options&quot;</span><span class="p">))</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flac_decode_options</span><span class="p">,</span>
                 <span class="n">width</span><span class="o">=</span><span class="mi">59</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>

        <span class="n">mp3_label</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;MP3&quot;</span><span class="p">)</span>
        <span class="n">_font</span><span class="p">(</span><span class="n">mp3_label</span><span class="p">)</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">tkfont</span><span class="o">.</span><span class="n">BOLD</span><span class="p">)</span>
        <span class="n">mp3_label</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;library_root&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mp3_library_root</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                    <span class="n">value</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;library_root&quot;</span><span class="p">))</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mp3_library_root</span><span class="p">,</span>
                 <span class="n">width</span><span class="o">=</span><span class="mi">47</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;lame_encode_options&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mp3_lame_encode_options</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;lame_encode_options&quot;</span><span class="p">))</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mp3_lame_encode_options</span><span class="p">,</span>
                 <span class="n">width</span><span class="o">=</span><span class="mi">59</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">W</span><span class="p">)</span></div>

<div class="viewcode-block" id="EditConfigurationDialog.buttonbox"><a class="viewcode-back" href="../user-interface.html#flacmanager.EditConfigurationDialog.buttonbox">[docs]</a>    <span class="k">def</span> <span class="nf">buttonbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the buttons to save and/or dismiss the dialog.&quot;&quot;&quot;</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Save&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">,</span>
                  <span class="n">default</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Cancel&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                  <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cancel</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Return&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Escape&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancel</span><span class="p">)</span>
        <span class="n">box</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span></div>

<div class="viewcode-block" id="EditConfigurationDialog.apply"><a class="viewcode-back" href="../user-interface.html#flacmanager.EditConfigurationDialog.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save changes to the *flacmanager.ini* file.&quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>

        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;Logging&quot;</span><span class="p">,</span> <span class="s2">&quot;level&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logging_level</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;Logging&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logging_filename</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;Logging&quot;</span><span class="p">,</span> <span class="s2">&quot;filemode&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logging_filemode</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;Logging&quot;</span><span class="p">,</span> <span class="s2">&quot;format&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logging_format</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;HTTP&quot;</span><span class="p">,</span> <span class="s2">&quot;debuglevel&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_debuglevel</span><span class="o">.</span><span class="n">get</span><span class="p">()))</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;HTTP&quot;</span><span class="p">,</span> <span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_timeout</span><span class="o">.</span><span class="n">get</span><span class="p">()))</span>

        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">,</span> <span class="s2">&quot;client_id&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gracenote_client_id</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gracenote_user_id</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;MusicBrainz&quot;</span><span class="p">,</span> <span class="s2">&quot;contact_url_or_email&quot;</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">musicbrainz_contact_url_or_email</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;MusicBrainz&quot;</span><span class="p">,</span> <span class="s2">&quot;libdiscid_location&quot;</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">musicbrainz_libdiscid_location</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;library_root&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flac_library_root</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;flac_encode_options&quot;</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">flac_encode_options</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;flac_decode_options&quot;</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">flac_decode_options</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;library_root&quot;</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">mp3_library_root</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;lame_encode_options&quot;</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">mp3_lame_encode_options</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

        <span class="n">save_config</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="resolve_path"><a class="viewcode-back" href="../miscellaneous.html#flacmanager.resolve_path">[docs]</a><span class="k">def</span> <span class="nf">resolve_path</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Evaluate all variables in *spec* and make sure it&#39;s absolute.</span>

<span class="sd">    :param str spec: a directory or file path template</span>
<span class="sd">    :return: a valid, absolute file system path</span>
<span class="sd">    :rtype: :obj:`str`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE spec = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
    <span class="n">resolved_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">spec</span><span class="p">))))</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">resolved_path</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;not a directory!&quot;</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">resolved_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resolved_path</span></div>


<div class="viewcode-block" id="encode_flac"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.encode_flac">[docs]</a><span class="k">def</span> <span class="nf">encode_flac</span><span class="p">(</span><span class="n">cdda_filename</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">,</span>
                <span class="n">stdout_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rip a CDDA file to a tagged FLAC file.</span>

<span class="sd">    :param str cdda_filename: absolute CD-DA file name</span>
<span class="sd">    :param str flac_filename: absolute *.flac* file name</span>
<span class="sd">    :param dict track_metadata: tagging fields for this track</span>
<span class="sd">    :keyword str stdout_filename:\</span>
<span class="sd">       absolute file name for redirected stdout</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;TRACE cdda_filename = </span><span class="si">%r</span><span class="s2">, flac_filename = </span><span class="si">%r</span><span class="s2">, track_metadata = </span><span class="si">%r</span><span class="s2">, &quot;</span>
            <span class="s2">&quot;stdout_filename = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">cdda_filename</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">,</span> <span class="n">stdout_filename</span><span class="p">)</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;flac&quot;</span><span class="p">]</span>
    <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;flac_encode_options&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]):</span>
        <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--picture=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">])</span>
    <span class="n">vorbis_comments</span> <span class="o">=</span> <span class="n">make_vorbis_comments</span><span class="p">(</span><span class="n">track_metadata</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">vorbis_comments</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--tag=</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--tag=</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--output-name=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">flac_filename</span><span class="p">)</span>
    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cdda_filename</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;command = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">stdout_filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">stdout_filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
                                  <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="decode_wav"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.decode_wav">[docs]</a><span class="k">def</span> <span class="nf">decode_wav</span><span class="p">(</span><span class="n">flac_filename</span><span class="p">,</span> <span class="n">wav_filename</span><span class="p">,</span> <span class="n">stdout_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a FLAC file to a WAV file.</span>

<span class="sd">    :param str flac_filename: absolute *.flac* file name</span>
<span class="sd">    :param str wav_filename: absolute *.wav* file name</span>
<span class="sd">    :keyword str stdout_filename:\</span>
<span class="sd">       absolute file name for redirected stdout</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;TRACE flac_filename = </span><span class="si">%r</span><span class="s2">, wav_filename = </span><span class="si">%r</span><span class="s2">, stdout_filename = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">flac_filename</span><span class="p">,</span> <span class="n">wav_filename</span><span class="p">,</span> <span class="n">stdout_filename</span><span class="p">)</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;flac&quot;</span><span class="p">,</span> <span class="s2">&quot;--decode&quot;</span><span class="p">]</span>
    <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;flac_decode_options&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--output-name=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">wav_filename</span><span class="p">)</span>
    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flac_filename</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;command = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">stdout_filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">stdout_filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
                                  <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="encode_mp3"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.encode_mp3">[docs]</a><span class="k">def</span> <span class="nf">encode_mp3</span><span class="p">(</span><span class="n">wav_filename</span><span class="p">,</span> <span class="n">mp3_filename</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">,</span>
               <span class="n">stdout_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a WAV file to an MP3 file.</span>

<span class="sd">    :param str wav_filename: absolute *.wav* file name</span>
<span class="sd">    :param str mp3_filename: absolute *.mp3* file name</span>
<span class="sd">    :param dict track_metadata: tagging fields for this track</span>
<span class="sd">    :keyword str stdout_filename:\</span>
<span class="sd">       absolute file name for redirected stdout</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;TRACE wav_filename = </span><span class="si">%r</span><span class="s2">, mp3_filename = </span><span class="si">%r</span><span class="s2">, track_metadata = </span><span class="si">%r</span><span class="s2">, &quot;</span>
            <span class="s2">&quot;stdout_filename = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">wav_filename</span><span class="p">,</span> <span class="n">mp3_filename</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">,</span> <span class="n">stdout_filename</span><span class="p">)</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lame&quot;</span><span class="p">]</span>
    <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;lame_encode_options&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--id3v2-only&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]):</span>
        <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--ti&quot;</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]])</span>
    <span class="n">id3v2_tags</span> <span class="o">=</span> <span class="n">make_id3v2_tags</span><span class="p">(</span><span class="n">track_metadata</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">id3v2_tags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="c1"># ID3v2 spec calls for &#39;/&#39; separator, but iTunes only handles &#39;,&#39;</span>
            <span class="c1"># separator correctly</span>
            <span class="n">combined_value</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--tv&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">combined_value</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--tv&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)])</span>
    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wav_filename</span><span class="p">)</span>
    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mp3_filename</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;command = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">stdout_filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">stdout_filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
                                  <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="make_vorbis_comments"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.make_vorbis_comments">[docs]</a><span class="k">def</span> <span class="nf">make_vorbis_comments</span><span class="p">(</span><span class="n">metadata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create Vorbis comments for tagging from *metadata*.</span>

<span class="sd">    :param dict metadata: the metadata for a single track</span>
<span class="sd">    :return: Vorbis comment name/value pairs</span>
<span class="sd">    :rtype: :obj:`dict`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE metadata = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
    <span class="c1"># see http://www.xiph.org/vorbis/doc/v-comment.html</span>
    <span class="n">vorbis_comments</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">ALBUM</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_title&quot;</span><span class="p">],</span>
        <span class="n">DISCNUMBER</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;disc_number&quot;</span><span class="p">],</span>
        <span class="n">DISCTOTAL</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;disc_total&quot;</span><span class="p">],</span>
        <span class="n">TRACKNUMBER</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;track_number&quot;</span><span class="p">],</span>
        <span class="n">TRACKTOTAL</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;track_total&quot;</span><span class="p">],</span>
        <span class="n">TITLE</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;track_title&quot;</span><span class="p">],</span>
        <span class="n">ARTIST</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;track_artist&quot;</span><span class="p">],</span>
        <span class="n">PERFORMER</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;track_performer&quot;</span><span class="p">],</span>
        <span class="n">GENRE</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">r&quot;\s*,\s*&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;track_genre&quot;</span><span class="p">]),</span>
        <span class="n">DATE</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;track_year&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">vorbis_comments</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vorbis_comments</span></div>


<div class="viewcode-block" id="make_id3v2_tags"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.make_id3v2_tags">[docs]</a><span class="k">def</span> <span class="nf">make_id3v2_tags</span><span class="p">(</span><span class="n">metadata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create ID3v2 frames for tagging from *metadata*.</span>

<span class="sd">    :param dict metadata: the metadata for a single track</span>
<span class="sd">    :return: ID3v2 frame name/value pairs</span>
<span class="sd">    :rtype: :obj:`dict`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE metadata = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
    <span class="c1"># see http://id3.org/id3v2.3.0</span>
    <span class="n">id3v2_tags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">TALB</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_title&quot;</span><span class="p">],</span>
        <span class="n">TPOS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;disc_number&quot;</span><span class="p">],</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;disc_total&quot;</span><span class="p">]),</span>
        <span class="n">TRCK</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;track_number&quot;</span><span class="p">],</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;track_total&quot;</span><span class="p">]),</span>
        <span class="n">TIT2</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;track_title&quot;</span><span class="p">],</span>
        <span class="n">TPE1</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;track_artist&quot;</span><span class="p">],</span>
        <span class="n">TPE2</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;track_performer&quot;</span><span class="p">],</span>
        <span class="n">TCON</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">r&quot;\s*,\s*&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;track_genre&quot;</span><span class="p">]),</span>
        <span class="n">TYER</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;track_year&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">id3v2_tags</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">id3v2_tags</span></div>


<span class="c1">#: Used to pass data between a :class:`FLACEncoder` thread and the main thread.</span>
<span class="n">_ENCODING_QUEUE</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">PriorityQueue</span><span class="p">()</span>


<span class="nd">@logged</span>
<div class="viewcode-block" id="FLACEncoder"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.FLACEncoder">[docs]</a><span class="k">class</span> <span class="nc">FLACEncoder</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A thread that rips CD-DA tracks to FLAC.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instructions</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="FLACEncoder.add_instruction"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.FLACEncoder.add_instruction">[docs]</a>    <span class="k">def</span> <span class="nf">add_instruction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">track_index</span><span class="p">,</span> <span class="n">cdda_filename</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">,</span>
                        <span class="n">mp3_filename</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Schedule a track for FLAC encoding.</span>

<span class="sd">        :param int track_index: index (not ordinal) of the track</span>
<span class="sd">        :param str cdda_filename: absolute CD-DA file name</span>
<span class="sd">        :param str flac_filename: absolute *.flac* file name</span>
<span class="sd">        :param str mp3_filename: absolute *.mp3* file name</span>
<span class="sd">        :param dict track_metadata: tagging fields for this track</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;TRACE track_index = </span><span class="si">%r</span><span class="s2">, cdda_filename = </span><span class="si">%r</span><span class="s2">, flac_filename = </span><span class="si">%r</span><span class="s2">, &quot;</span>
                <span class="s2">&quot;mp3_filename = </span><span class="si">%r</span><span class="s2">, track_metadata = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">track_index</span><span class="p">,</span> <span class="n">cdda_filename</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">,</span> <span class="n">mp3_filename</span><span class="p">,</span>
            <span class="n">track_metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instructions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">track_index</span><span class="p">,</span> <span class="n">cdda_filename</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">,</span>
                                   <span class="n">mp3_filename</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">))</span></div>

<div class="viewcode-block" id="FLACEncoder.run"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.FLACEncoder.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rip CD-DA tracks to FLAC.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">mp3_encoder_threads</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">cdda_fn</span><span class="p">,</span> <span class="n">flac_fn</span><span class="p">,</span> <span class="n">mp3_fn</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instructions</span><span class="p">:</span>
            <span class="n">stdout_fn</span> <span class="o">=</span> <span class="n">make_tempfile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.out&quot;</span><span class="p">)</span>

            <span class="c1"># the FLAC encoding must block because it needs exclusive access to</span>
            <span class="c1"># the drive; so run the status updates in a separate thread</span>
            <span class="n">status_interval_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_enqueue_status_interval</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">cdda_fn</span><span class="p">,</span> <span class="n">flac_fn</span><span class="p">,</span> <span class="n">stdout_fn</span><span class="p">),</span>
                <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">status_interval_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="n">flac_encoding_error</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">encode_flac</span><span class="p">(</span><span class="n">cdda_fn</span><span class="p">,</span> <span class="n">flac_fn</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
                            <span class="n">stdout_filename</span><span class="o">=</span><span class="n">stdout_fn</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">flac_encoding_error</span> <span class="o">=</span> <span class="n">e</span>

            <span class="c1"># (see _enqueue_status_interval)</span>
            <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.done&quot;</span> <span class="o">%</span> <span class="n">stdout_fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c1"># block until the status updates thread exits</span>
            <span class="n">status_interval_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">flac_encoding_error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># run the MP3 encoding in a separate thread so we can move on</span>
                <span class="c1"># to the next CD-DA -&gt; FLAC encoding; the MP3 encoder will</span>
                <span class="c1"># enqueue the &quot;TRACK_COMPLETE&quot; state when it&#39;s finished</span>
                <span class="n">mp3_encoder</span> <span class="o">=</span> <span class="n">MP3Encoder</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">cdda_fn</span><span class="p">,</span> <span class="n">flac_fn</span><span class="p">,</span> <span class="n">mp3_fn</span><span class="p">,</span>
                                         <span class="n">stdout_fn</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
                <span class="n">mp3_encoder</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">mp3_encoder_threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mp3_encoder</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">cdda_fn</span><span class="p">,</span> <span class="n">flac_fn</span><span class="p">,</span> <span class="n">stdout_fn</span><span class="p">,</span>
                          <span class="n">flac_encoding_error</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
                <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>

        <span class="c1"># make sure all MP3 encoders are done before enqueueing &quot;FINISHED&quot;</span>
        <span class="k">for</span> <span class="n">mp3_encoder_thread</span> <span class="ow">in</span> <span class="n">mp3_encoder_threads</span><span class="p">:</span>
            <span class="n">mp3_encoder_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">cdda_fn</span><span class="p">,</span> <span class="n">flac_fn</span><span class="p">,</span> <span class="n">stdout_fn</span><span class="p">,</span> <span class="s2">&quot;FINISHED&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="mi">13</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
        <span class="c1"># do not terminate until &quot;FINISHED&quot; status has been processed</span>
        <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_enqueue_status_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">track_index</span><span class="p">:</span> <span class="s2">&quot;int index (not ordinal) of the track&quot;</span><span class="p">,</span>
            <span class="n">cdda_filename</span><span class="p">:</span> <span class="s2">&quot;str absolute CD-DA file name&quot;</span><span class="p">,</span>
            <span class="n">flac_filename</span><span class="p">:</span> <span class="s2">&quot;str absolute .flac file name&quot;</span><span class="p">,</span>
            <span class="n">stdout_filename</span><span class="p">:</span>
                <span class="s2">&quot;str absolute file name for redirected stdout&quot;</span> <span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enqueue a status update notification on an interval.</span>

<span class="sd">        This method is run in a separate thread (see :meth:`run`).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># enqueueing this status causes UI to read latest status line from the</span>
        <span class="c1"># stdout file</span>
        <span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">track_index</span><span class="p">,</span> <span class="n">cdda_filename</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">,</span> <span class="n">stdout_filename</span><span class="p">,</span>
                  <span class="n">TRACK_ENCODING_FLAC</span><span class="p">)</span>

        <span class="c1"># when the FLAC encoding is complete, this file will be created whether</span>
        <span class="c1"># an error occurred or not</span>
        <span class="n">done_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.done&quot;</span> <span class="o">%</span> <span class="n">stdout_filename</span>

        <span class="n">interval</span> <span class="o">=</span> <span class="mf">1.25</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2"> every </span><span class="si">%s</span><span class="s2"> seconds...&quot;</span><span class="p">,</span>
                          <span class="n">status</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>

        <span class="c1"># as long as the &quot;.done&quot; file doesn&#39;t exist, keep telling the UI to</span>
        <span class="c1"># read a status update from the stdout file</span>
        <span class="k">while</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">done_filename</span><span class="p">)):</span>
            <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="mi">7</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span></div>


<span class="nd">@logged</span>
<div class="viewcode-block" id="MP3Encoder"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.MP3Encoder">[docs]</a><span class="k">class</span> <span class="nc">MP3Encoder</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A thread that converts WAV files to MP3 files.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">track_index</span><span class="p">,</span> <span class="n">cdda_filename</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">,</span> <span class="n">mp3_filename</span><span class="p">,</span>
                 <span class="n">stdout_filename</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param int track_index: index (not ordinal) of the track</span>
<span class="sd">        :param str cdda_filename: absolute CD-DA file name</span>
<span class="sd">        :param str flac_filename: absolute *.flac* file name</span>
<span class="sd">        :param str stdout_filename:\</span>
<span class="sd">           absolute file name for redirected stdout</span>
<span class="sd">        :param dict track_metadata: tagging fields for this track</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;TRACE track_index = </span><span class="si">%r</span><span class="s2">, cdda_filename = </span><span class="si">%r</span><span class="s2">, flac_filename = </span><span class="si">%r</span><span class="s2">, &quot;</span>
                <span class="s2">&quot;mp3_filename = </span><span class="si">%r</span><span class="s2">, stdout_filename = </span><span class="si">%r</span><span class="s2">, track_metadata = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">track_index</span><span class="p">,</span> <span class="n">cdda_filename</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">,</span> <span class="n">mp3_filename</span><span class="p">,</span>
            <span class="n">stdout_filename</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_index</span> <span class="o">=</span> <span class="n">track_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cdda_filename</span> <span class="o">=</span> <span class="n">cdda_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flac_filename</span> <span class="o">=</span> <span class="n">flac_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mp3_filename</span> <span class="o">=</span> <span class="n">mp3_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout_filename</span> <span class="o">=</span> <span class="n">stdout_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_metadata</span> <span class="o">=</span> <span class="n">track_metadata</span>

<div class="viewcode-block" id="MP3Encoder.run"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.MP3Encoder.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Decode FLAC to WAV, then encode WAV to MP3.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">flac_basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flac_filename</span><span class="p">)</span>
        <span class="n">wav_tempdir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;fm&quot;</span><span class="p">)</span>
        <span class="n">wav_basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">flac_basename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.wav&quot;</span>
        <span class="n">wav_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wav_tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">wav_basename</span><span class="p">)</span>

        <span class="c1"># make sure the UI gets a status update for decoding FLAC to WAV</span>
        <span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdda_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flac_filename</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">stdout_filename</span><span class="p">,</span> <span class="n">TRACK_DECODING_WAV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">decode_wav</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flac_filename</span><span class="p">,</span> <span class="n">wav_filename</span><span class="p">,</span>
                       <span class="n">stdout_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout_filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">wav_tempdir</span>
            <span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdda_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flac_filename</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">stdout_filename</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
            <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># make sure the UI gets a status update for encoding WAV to MP3</span>
        <span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdda_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flac_filename</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">stdout_filename</span><span class="p">,</span> <span class="n">TRACK_ENCODING_MP3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">encode_mp3</span><span class="p">(</span><span class="n">wav_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp3_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_metadata</span><span class="p">,</span>
                       <span class="n">stdout_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout_filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdda_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flac_filename</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">stdout_filename</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
            <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdda_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flac_filename</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">stdout_filename</span><span class="p">,</span> <span class="n">TRACK_COMPLETE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
            <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="mi">11</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">wav_tempdir</span></div></div>


<div class="viewcode-block" id="MetadataError"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataError">[docs]</a><span class="k">class</span> <span class="nc">MetadataError</span><span class="p">(</span><span class="n">FLACManagerError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The type of exception raised when metadata operations fail.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="MetadataCollector"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataCollector">[docs]</a><span class="k">class</span> <span class="nc">MetadataCollector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class for collecting album and track metadata.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param flacmanager.TOC toc: a disc&#39;s table of contents</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toc</span> <span class="o">=</span> <span class="n">toc</span>

<div class="viewcode-block" id="MetadataCollector.reset"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataCollector.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize all collection fields to default (empty).&quot;&quot;&quot;</span>
        <span class="n">number_of_tracks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">track_offsets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">album</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;artist&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;performer&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;genre&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;cover&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;number_of_tracks&quot;</span><span class="p">:</span> <span class="n">number_of_tracks</span><span class="p">,</span>
            <span class="s2">&quot;is_compilation&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;disc_number&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;disc_total&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># 1-based indexing</span>
        <span class="n">tracks</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_tracks</span><span class="p">):</span>
            <span class="n">tracks</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;include&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;artist&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;performer&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;genre&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracks</span> <span class="o">=</span> <span class="n">tracks</span></div>

<div class="viewcode-block" id="MetadataCollector.collect"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataCollector.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch metadata from a service.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span></div></div>


<span class="nd">@logged</span>
<div class="viewcode-block" id="GracenoteCDDBMetadataCollector"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.GracenoteCDDBMetadataCollector">[docs]</a><span class="k">class</span> <span class="nc">GracenoteCDDBMetadataCollector</span><span class="p">(</span><span class="n">MetadataCollector</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A Gracenote CDDB client that populates album and track metadata</span>
<span class="sd">    choices for a disc identified by its offsets.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: Host name format string for Gracenote.</span>
    <span class="n">API_HOST_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;c</span><span class="si">%s</span><span class="s2">.web.cddbp.net&quot;</span>

    <span class="c1">#: Request path for Gracenote service calls.</span>
    <span class="n">API_PATH</span> <span class="o">=</span> <span class="s2">&quot;/webapi/xml/1.0/&quot;</span>

    <span class="c1">#: Request body for a Gracenote User ID.</span>
    <span class="n">REGISTER_XML</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;&lt;QUERIES&gt;&#39;</span>
            <span class="s1">&#39;&lt;QUERY CMD=&quot;REGISTER&quot;&gt;&#39;</span>
                <span class="s1">&#39;&lt;CLIENT&gt;</span><span class="si">%s</span><span class="s1">&lt;/CLIENT&gt;&#39;</span>
            <span class="s1">&#39;&lt;/QUERY&gt;&#39;</span>
        <span class="s1">&#39;&lt;/QUERIES&gt;&#39;</span>
    <span class="p">)</span>

    <span class="c1">#: Request body for Gracenote Album summary metadata.</span>
    <span class="n">ALBUM_TOC_XML</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;&lt;QUERIES&gt;&#39;</span>
            <span class="s1">&#39;&lt;AUTH&gt;&#39;</span>
                <span class="s1">&#39;&lt;CLIENT&gt;</span><span class="si">%s</span><span class="s1">&lt;/CLIENT&gt;&#39;</span>
                <span class="s1">&#39;&lt;USER&gt;</span><span class="si">%s</span><span class="s1">&lt;/USER&gt;&#39;</span>
            <span class="s1">&#39;&lt;/AUTH&gt;&#39;</span>
            <span class="s1">&#39;&lt;LANG&gt;eng&lt;/LANG&gt;&#39;</span>
            <span class="s1">&#39;&lt;COUNTRY&gt;usa&lt;/COUNTRY&gt;&#39;</span>
            <span class="s1">&#39;&lt;QUERY CMD=&quot;ALBUM_TOC&quot;&gt;&#39;</span>
                <span class="s1">&#39;&lt;TOC&gt;&#39;</span>
                    <span class="s1">&#39;&lt;OFFSETS&gt;</span><span class="si">%s</span><span class="s1">&lt;/OFFSETS&gt;&#39;</span>
                <span class="s1">&#39;&lt;/TOC&gt;&#39;</span>
            <span class="s1">&#39;&lt;/QUERY&gt;&#39;</span>
        <span class="s1">&#39;&lt;/QUERIES&gt;&#39;</span>
    <span class="p">)</span>

    <span class="c1">#: Request body for Gracenote Album and Track detail metadata.</span>
    <span class="n">ALBUM_FETCH_XML</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;&lt;QUERIES&gt;&#39;</span>
            <span class="s1">&#39;&lt;AUTH&gt;&#39;</span>
                <span class="s1">&#39;&lt;CLIENT&gt;</span><span class="si">%s</span><span class="s1">&lt;/CLIENT&gt;&#39;</span>
                <span class="s1">&#39;&lt;USER&gt;</span><span class="si">%s</span><span class="s1">&lt;/USER&gt;&#39;</span>
            <span class="s1">&#39;&lt;/AUTH&gt;&#39;</span>
            <span class="s1">&#39;&lt;LANG&gt;eng&lt;/LANG&gt;&#39;</span>
            <span class="s1">&#39;&lt;COUNTRY&gt;usa&lt;/COUNTRY&gt;&#39;</span>
            <span class="s1">&#39;&lt;QUERY CMD=&quot;ALBUM_FETCH&quot;&gt;&#39;</span>
                <span class="s1">&#39;&lt;GN_ID&gt;</span><span class="si">%s</span><span class="s1">&lt;/GN_ID&gt;&#39;</span>
                <span class="s1">&#39;&lt;OPTION&gt;&#39;</span>
                    <span class="s1">&#39;&lt;PARAMETER&gt;SELECT_EXTENDED&lt;/PARAMETER&gt;&#39;</span>
                    <span class="s1">&#39;&lt;VALUE&gt;COVER&lt;/VALUE&gt;&#39;</span>
                <span class="s1">&#39;&lt;/OPTION&gt;&#39;</span>
                <span class="s1">&#39;&lt;OPTION&gt;&#39;</span>
                    <span class="s1">&#39;&lt;PARAMETER&gt;COVER_SIZE&lt;/PARAMETER&gt;&#39;</span>
                    <span class="s1">&#39;&lt;VALUE&gt;MEDIUM,LARGE,SMALL,THUMBNAIL,XLARGE&lt;/VALUE&gt;&#39;</span>
                <span class="s1">&#39;&lt;/OPTION&gt;&#39;</span>
                <span class="s1">&#39;&lt;OPTION&gt;&#39;</span>
                    <span class="s1">&#39;&lt;PARAMETER&gt;SELECT_DETAIL&lt;/PARAMETER&gt;&#39;</span>
                    <span class="s1">&#39;&lt;VALUE&gt;GENRE:3LEVEL&lt;/VALUE&gt;&#39;</span>
                <span class="s1">&#39;&lt;/OPTION&gt;&#39;</span>
            <span class="s1">&#39;&lt;/QUERY&gt;&#39;</span>
        <span class="s1">&#39;&lt;/QUERIES&gt;&#39;</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param flacmanager.TOC toc: a disc&#39;s table of contents</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE toc = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">toc</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">toc</span><span class="p">)</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Gracenote config = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client_id</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">,</span> <span class="s2">&quot;client_id&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_id</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span>
                    <span class="s2">&quot;Gracenote client_id must be defined in flacmanager.ini!&quot;</span><span class="p">,</span>
                    <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;Gracenote configuration&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">)</span>

        <span class="n">api_host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">API_HOST_TEMPLATE</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;HTTP&quot;</span><span class="p">,</span> <span class="s2">&quot;timeout&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ssl_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ssl_context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ssl_context</span><span class="o">.</span><span class="n">set_default_verify_paths</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conx</span> <span class="o">=</span> <span class="n">HTTPSConnection</span><span class="p">(</span><span class="n">api_host</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ssl_context</span><span class="p">,</span>
                                     <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_register</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register this client with the Gracenote Web API.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">gn_queries</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">REGISTER_XML</span><span class="p">)</span>
        <span class="n">gn_queries</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;QUERY/CLIENT&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_id</span>

        <span class="n">gn_responses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_response</span><span class="p">(</span><span class="n">gn_queries</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">gn_responses</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;RESPONSE/USER&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;user_id = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span><span class="p">)</span>

        <span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span><span class="p">)</span>
        <span class="n">save_config</span><span class="p">()</span>

<div class="viewcode-block" id="GracenoteCDDBMetadataCollector.collect"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.GracenoteCDDBMetadataCollector.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate all Gracenote album metadata choices.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_register</span><span class="p">()</span>

        <span class="n">gn_queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_gn_queries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ALBUM_TOC_XML</span><span class="p">)</span>
        <span class="n">toc_offsets</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">track_offsets</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">leadout_track_offset</span><span class="p">)</span>
        <span class="n">gn_queries</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;QUERY/TOC/OFFSETS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">toc_offsets</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">gn_responses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_response</span><span class="p">(</span><span class="n">gn_queries</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MetadataError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;NO_MATCH&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;album not recognized by Gracenote&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">raise</span>
        <span class="n">last_album_ord</span> <span class="o">=</span> \
            <span class="nb">int</span><span class="p">(</span><span class="n">gn_responses</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;RESPONSE/ALBUM[last()]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ORD&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1"># when this equals last_album_ord, we&#39;ll send &quot;Connection: close&quot; in</span>
        <span class="c1"># the HTTP headers</span>
        <span class="n">album_ord</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">album_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">album</span>
        <span class="n">tracks_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracks</span>
        <span class="k">for</span> <span class="n">gn_album_summary</span> <span class="ow">in</span> <span class="n">gn_responses</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;RESPONSE/ALBUM&quot;</span><span class="p">):</span>
            <span class="n">gn_id</span> <span class="o">=</span> <span class="n">gn_album_summary</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;GN_ID&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="n">gn_album_detail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_album</span><span class="p">(</span><span class="n">gn_id</span><span class="p">,</span>
                                                <span class="n">album_ord</span> <span class="o">==</span> <span class="n">last_album_ord</span><span class="p">)</span>

            <span class="n">num_tracks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gn_album_detail</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;TRACK_COUNT&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">num_tracks</span> <span class="o">!=</span> <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;number_of_tracks&quot;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;discarding </span><span class="si">%r</span><span class="s2">; expected </span><span class="si">%d</span><span class="s2"> tracks but found </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">gn_id</span><span class="p">,</span> <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;number_of_tracks&quot;</span><span class="p">],</span> <span class="n">num_tracks</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">title</span> <span class="o">=</span> <span class="n">gn_album_detail</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;TITLE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">title</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]):</span>
                <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="n">artist</span> <span class="o">=</span> <span class="n">gn_album_detail</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ARTIST&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">artist</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">]):</span>
                <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">artist</span><span class="p">)</span>
            <span class="n">gn_date</span> <span class="o">=</span> <span class="n">gn_album_detail</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;DATE&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">gn_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">gn_date</span><span class="o">.</span><span class="n">text</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">])):</span>
                <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gn_date</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">gn_genre</span> <span class="ow">in</span> <span class="n">gn_album_detail</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;GENRE&quot;</span><span class="p">):</span>
                <span class="n">genre</span> <span class="o">=</span> <span class="n">gn_genre</span><span class="o">.</span><span class="n">text</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">genre</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;genre&quot;</span><span class="p">]):</span>
                    <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;genre&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">genre</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">gn_url_coverart</span> <span class="ow">in</span> \
                    <span class="n">gn_album_detail</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;URL[@TYPE=&#39;COVERART&#39;]&quot;</span><span class="p">):</span>
                <span class="n">cover_art</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cover_image</span><span class="p">(</span><span class="n">gn_url_coverart</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cover_art</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cover_art</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;cover&quot;</span><span class="p">])):</span>
                    <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;cover&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cover_art</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">gn_track</span> <span class="ow">in</span> <span class="n">gn_album_detail</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;TRACK&quot;</span><span class="p">):</span>
                <span class="n">track_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gn_track</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;TRACK_NUM&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="n">track_metadata</span> <span class="o">=</span> <span class="n">tracks_metadata</span><span class="p">[</span><span class="n">track_number</span><span class="p">]</span>

                <span class="n">title</span> <span class="o">=</span> <span class="n">gn_track</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;TITLE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">title</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]):</span>
                    <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
                <span class="n">gn_artist</span> <span class="o">=</span> <span class="n">gn_track</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ARTIST&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">gn_artist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="p">(</span><span class="n">gn_artist</span><span class="o">.</span><span class="n">text</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">])):</span>
                    <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gn_artist</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">gn_genre</span> <span class="ow">in</span> <span class="n">gn_track</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;GENRE&quot;</span><span class="p">):</span>
                    <span class="n">genre</span> <span class="o">=</span> <span class="n">gn_genre</span><span class="o">.</span><span class="n">text</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">genre</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;genre&quot;</span><span class="p">]):</span>
                        <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;genre&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">genre</span><span class="p">)</span>

            <span class="n">album_ord</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># TODO: does Gracenote have a distinction between artist/performer or</span>
        <span class="c1"># composer/artist?</span>
        <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;performer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">track_metadata</span> <span class="ow">in</span> <span class="n">tracks_metadata</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;performer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">_fetch_album</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">gn_id</span><span class="p">:</span> <span class="s2">&quot;the Gracenote ID of an album&quot;</span><span class="p">,</span>
            <span class="n">is_last_album</span><span class="p">:</span> <span class="s2">&quot;False if this is the last album to fetch&quot;</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;:class:`xml.etree.ElementTree.Element` &lt;ALBUM&gt;&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Make a Gracenote &#39;ALBUM_FETCH&#39; request.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE gn_id = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">gn_id</span><span class="p">)</span>
        <span class="n">gn_queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_gn_queries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ALBUM_FETCH_XML</span><span class="p">)</span>
        <span class="n">gn_queries</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;QUERY/GN_ID&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">gn_id</span>

        <span class="n">gn_responses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_response</span><span class="p">(</span><span class="n">gn_queries</span><span class="p">,</span>
                                          <span class="n">http_keep_alive</span><span class="o">=</span><span class="n">is_last_album</span><span class="p">)</span>
        <span class="n">gn_album</span> <span class="o">=</span> <span class="n">gn_responses</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;RESPONSE/ALBUM&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">gn_album</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gn_album</span>

    <span class="k">def</span> <span class="nf">_get_cover_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="s2">&quot;str URL for a Gracenote album cover&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;bytes raw image data&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE url = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">parse_result</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">parse_result</span><span class="o">.</span><span class="n">netloc</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">parse_result</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span><span class="p">):</span>
            <span class="n">conx</span> <span class="o">=</span> <span class="n">HTTPSConnection</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ssl_context</span><span class="p">,</span>
                                   <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">parse_result</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;http&quot;</span><span class="p">):</span>
            <span class="n">conx</span> <span class="o">=</span> <span class="n">HTTPConnection</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;don&#39;t know how to request an image over </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                  <span class="n">parse_result</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">conx</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">?</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parse_result</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">parse_result</span><span class="o">.</span><span class="n">query</span><span class="p">))</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">conx</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">301</span><span class="p">,</span> <span class="mi">302</span><span class="p">,</span> <span class="mi">307</span><span class="p">]):</span>
            <span class="n">response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">netloc</span> <span class="o">!=</span> <span class="n">host</span><span class="p">):</span>
                <span class="n">conx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span><span class="p">):</span>
                    <span class="n">conx</span> <span class="o">=</span> <span class="n">HTTPSConnection</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span>
                                           <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ssl_context</span><span class="p">,</span>
                                           <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">conx</span> <span class="o">=</span> <span class="n">HTTPConnection</span><span class="p">(</span><span class="n">parse_result</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">path</span> <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">query</span><span class="p">)</span> \
                    <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">?</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">url</span><span class="o">.</span><span class="n">query</span><span class="p">))</span>
            <span class="n">conx</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">conx</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">conx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">):</span>
                <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">=</span> \
                    <span class="n">cgi</span><span class="o">.</span><span class="n">parse_header</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">])</span>
                <span class="n">encoding</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;charset&quot;</span><span class="p">,</span> <span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">encoding</span> <span class="o">=</span> <span class="s2">&quot;UTF-8&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;unable to get cover art from </span><span class="si">%r</span><span class="s2"> (HTTP </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_prepare_gn_queries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">xml</span><span class="p">:</span> <span class="s2">&quot;an XML template string for a Gracenote &lt;QUERIES&gt; document&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;:class:`xml.etree.ElementTree.Element` &lt;QUERIES&gt;&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a request object with authentication.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE xml = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">xml</span><span class="p">)</span>
        <span class="n">gn_queries</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
        <span class="n">gn_queries</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;AUTH/CLIENT&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_id</span>
        <span class="n">gn_queries</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;AUTH/USER&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">gn_queries</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gn_queries</span>

    <span class="k">def</span> <span class="nf">_get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">gn_queries</span><span class="p">:</span> <span class="s2">&quot;:class:`xml.etree.ElementTree.Element` &lt;QUERIES&gt;&quot;</span><span class="p">,</span>
            <span class="n">http_keep_alive</span><span class="p">:</span> <span class="s2">&quot;False to close server connection&quot;</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;:class:`xml.etree.ElementTree.Element` &lt;RESPONSES&gt;&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;POST the *request* and return the response.</span>

<span class="sd">        If this method returns, then /RESPONSES/RESPONSE[@STATUS=&quot;OK&quot;]</span>
<span class="sd">        is guaranteed to exist; otherwise, a ``MetadataError`` with an</span>
<span class="sd">        appropriate message is rasied.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE gn_queries = </span><span class="si">%r</span><span class="s2">, http_keep_alive = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">gn_queries</span><span class="p">,</span> <span class="n">http_keep_alive</span><span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">ET</span><span class="o">.</span><span class="n">ElementTree</span><span class="p">(</span><span class="n">gn_queries</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">,</span>
                                         <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">gn_queries_bytes</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;gn_queries_bytes = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">gn_queries_bytes</span><span class="p">)</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Connection&quot;</span><span class="p">:</span> <span class="s2">&quot;keep-alive&quot;</span> <span class="k">if</span> <span class="n">http_keep_alive</span> <span class="k">else</span> <span class="s2">&quot;close&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conx</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">API_PATH</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">gn_queries_bytes</span><span class="p">,</span>
                           <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conx</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>
        <span class="n">response_bytes</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">response_bytes = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
                            <span class="n">response_bytes</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">http_keep_alive</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">gn_queries</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;QUERY&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CMD&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span>
                    <span class="s2">&quot;HTTP </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">),</span>
                    <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;Gracenote </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>

        <span class="n">gn_responses</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">response_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">))</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">gn_responses</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;RESPONSE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;STATUS&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;OK&quot;</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">gn_queries</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;QUERY&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CMD&quot;</span><span class="p">)</span>
            <span class="n">gn_message</span> <span class="o">=</span> <span class="n">gn_responses</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;MESSAGE&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">gn_message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">gn_message</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">status</span>
            <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;Gracenote </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">gn_responses</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gn_responses</span></div>


<span class="nd">@logged</span>
<div class="viewcode-block" id="MusicBrainzMetadataCollector"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MusicBrainzMetadataCollector">[docs]</a><span class="k">class</span> <span class="nc">MusicBrainzMetadataCollector</span><span class="p">(</span><span class="n">MetadataCollector</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A MusicBrainz client that populates album and track metadata</span>
<span class="sd">    choices for a disc identified by its MusicBrainz ID.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: Host name for all MusicBrainz service calls.</span>
    <span class="n">API_HOST</span> <span class="o">=</span> <span class="s2">&quot;musicbrainz.org&quot;</span>

    <span class="c1">#: Request path prefix for all MusicBrainz service calls.</span>
    <span class="n">API_PATH_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;/ws/2&quot;</span>

    <span class="c1">#: URL format string for cover image requests.</span>
    <span class="n">COVERART_URL_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;http://coverartarchive.org/release/</span><span class="si">%s</span><span class="s2">/front-500&quot;</span>

    <span class="c1">#: HTTP User-Agent format string for MusicBrainz requests.</span>
    <span class="n">USER_AGENT_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> ( </span><span class="si">%%</span><span class="s2">s )&quot;</span> <span class="o">%</span> <span class="n">FLACManager</span><span class="o">.</span><span class="n">USER_AGENT</span>

    <span class="c1">#: XML namespace mapping for parsing MusicBrainz responses.</span>
    <span class="n">NAMESPACES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;mb&quot;</span><span class="p">:</span> <span class="s2">&quot;http://musicbrainz.org/ns/mmd-2.0#&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1">#: A reference to the ``libdiscid`` shared library.</span>
    <span class="n">_LIBDISCID</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="MusicBrainzMetadataCollector.initialize_libdiscid"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MusicBrainzMetadataCollector.initialize_libdiscid">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_libdiscid</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load the ``libdiscid`` shared library.&quot;&quot;&quot;</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">libdiscid_location</span> <span class="o">=</span> <span class="n">resolve_path</span><span class="p">(</span>
                <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MusicBrainz&quot;</span><span class="p">,</span> <span class="s2">&quot;libdiscid_location&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span>
                <span class="s2">&quot;MusicBrainz libdiscid_location is not valid in &quot;</span>
                    <span class="s2">&quot;flacmanager.ini&quot;</span><span class="p">,</span>
                <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;MusicBrainz configuration&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># http://jonnyjd.github.com/libdiscid/discid_8h.html</span>
            <span class="n">libdiscid</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="n">libdiscid_location</span><span class="p">)</span>

            <span class="c1"># Return a handle for a new DiscId object.</span>
            <span class="n">libdiscid</span><span class="o">.</span><span class="n">discid_new</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">()</span>
            <span class="n">libdiscid</span><span class="o">.</span><span class="n">discid_new</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">c_void_p</span>

            <span class="c1"># Provides the TOC of a known CD.</span>
            <span class="n">libdiscid</span><span class="o">.</span><span class="n">discid_put</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span>
                                             <span class="n">C</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">)</span>
            <span class="n">libdiscid</span><span class="o">.</span><span class="n">discid_put</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">c_int</span>

            <span class="c1"># Return a MusicBrainz DiscID.</span>
            <span class="n">libdiscid</span><span class="o">.</span><span class="n">discid_get_id</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,)</span>
            <span class="n">libdiscid</span><span class="o">.</span><span class="n">discid_get_id</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">c_char_p</span>

            <span class="c1"># Release the memory allocated for the DiscId object.</span>
            <span class="n">libdiscid</span><span class="o">.</span><span class="n">discid_free</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,)</span>
            <span class="n">libdiscid</span><span class="o">.</span><span class="n">discid_free</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">cls</span><span class="o">.</span><span class="n">_LIBDISCID</span> <span class="o">=</span> <span class="n">libdiscid</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                                <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;libdiscid initialization&quot;</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="MusicBrainzMetadataCollector.calculate_disc_id"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MusicBrainzMetadataCollector.calculate_disc_id">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_disc_id</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">toc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the MusicBrainz Disc ID for the disc *toc*.</span>

<span class="sd">        :param flacmanager.TOC toc: a disc&#39;s table of contents</span>
<span class="sd">        :return: a MusicBrainz Disc ID for *toc*</span>
<span class="sd">        :rtype: :obj:`str`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE toc = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">toc</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">_LIBDISCID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">initialize_libdiscid</span><span class="p">()</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">_LIBDISCID</span><span class="o">.</span><span class="n">discid_new</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span>
                        <span class="s2">&quot;Failed to create a new libdiscid DiscId handle!&quot;</span><span class="p">,</span>
                        <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;MusicBrainz libdiscid&quot;</span><span class="p">)</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">toc</span><span class="o">.</span><span class="n">leadout_track_offset</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">toc</span><span class="o">.</span><span class="n">track_offsets</span><span class="p">)</span>
            <span class="n">c_int_array</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">c_int</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span>
            <span class="n">c_offsets</span> <span class="o">=</span> <span class="n">c_int_array</span><span class="p">(</span><span class="o">*</span><span class="n">offsets</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_LIBDISCID</span><span class="o">.</span><span class="n">discid_put</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span>
                                            <span class="n">toc</span><span class="o">.</span><span class="n">first_track_number</span><span class="p">,</span>
                                            <span class="n">toc</span><span class="o">.</span><span class="n">last_track_number</span><span class="p">,</span>
                                            <span class="n">c_offsets</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> return from libdiscid.discid_put(handle, </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">, </span><span class="si">%r</span><span class="s2">)&quot;</span><span class="p">,</span>
                    <span class="n">res</span><span class="p">,</span> <span class="n">toc</span><span class="o">.</span><span class="n">first_track_number</span><span class="p">,</span> <span class="n">toc</span><span class="o">.</span><span class="n">last_track_number</span><span class="p">,</span>
                    <span class="n">offsets</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span>
                        <span class="s2">&quot;libdiscid.discid_put returned </span><span class="si">%d</span><span class="s2"> (expected 1)&quot;</span> <span class="o">%</span> <span class="n">res</span><span class="p">,</span>
                        <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;MusicBrainz libdiscid&quot;</span><span class="p">)</span>
            <span class="n">disc_id</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_LIBDISCID</span><span class="o">.</span><span class="n">discid_get_id</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

            <span class="n">disc_id</span> <span class="o">=</span> <span class="n">disc_id</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;us-ascii&quot;</span><span class="p">)</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">disc_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">disc_id</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">_LIBDISCID</span><span class="o">.</span><span class="n">discid_free</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
                <span class="n">handle</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param flacmanager.TOC toc: a disc&#39;s table of contents</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE toc = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">toc</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">toc</span><span class="p">)</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;MusicBrainz config = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;MusicBrainz&quot;</span><span class="p">]))</span>

        <span class="n">contact_url_or_email</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MusicBrainz&quot;</span><span class="p">,</span> <span class="s2">&quot;contact_url_or_email&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">contact_url_or_email</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span>
                    <span class="s2">&quot;MusicBrainz contact_url_or_email must be defined in &quot;</span>
                        <span class="s2">&quot;flacmanager.ini!&quot;</span><span class="p">,</span>
                    <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;MusicBrainz configuration&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">USER_AGENT_TEMPLATE</span> <span class="o">%</span> <span class="n">contact_url_or_email</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;HTTP&quot;</span><span class="p">,</span> <span class="s2">&quot;timeout&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conx</span> <span class="o">=</span> <span class="n">HTTPConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">API_HOST</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>

<div class="viewcode-block" id="MusicBrainzMetadataCollector.collect"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MusicBrainzMetadataCollector.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate all MusicBrainz album metadata choices.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="n">nsmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAMESPACES</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;using namespace map </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nsmap</span><span class="p">)</span>

        <span class="n">disc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_disc_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="p">)</span>
        <span class="n">discid_request_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_discid_request</span><span class="p">(</span><span class="n">disc_id</span><span class="p">)</span>
        <span class="n">mb_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_response</span><span class="p">(</span><span class="n">discid_request_path</span><span class="p">,</span> <span class="n">nsmap</span><span class="p">,</span>
                                         <span class="n">http_keep_alive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># If there was an exact disc ID match, then the root element is &lt;disc&gt;.</span>
        <span class="c1"># Otherwise, if there was a &quot;fuzzy&quot; TOC match, then the root element is</span>
        <span class="c1"># &lt;release-list&gt;.</span>
        <span class="n">mb_release_list</span> <span class="o">=</span> <span class="n">mb_metadata</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;mb:disc/mb:release-list&quot;</span><span class="p">,</span>
                                           <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mb_release_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">mb_release_list</span> <span class="o">=</span> <span class="n">mb_metadata</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;mb:release-list&quot;</span><span class="p">,</span>
                                               <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mb_release_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span><span class="s2">&quot;No release list for disc ID </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">disc_id</span><span class="p">,</span>
                                    <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;MusicBrainz API&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;fuzzy TOC match for disc_id </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                                      <span class="n">disc_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;exact match for disc_id </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">disc_id</span><span class="p">)</span>

        <span class="n">album_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">album</span>
        <span class="n">tracks_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracks</span>
        <span class="k">for</span> <span class="n">mb_release</span> <span class="ow">in</span> <span class="n">mb_release_list</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;mb:release&quot;</span><span class="p">,</span>
                                                  <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">):</span>
            <span class="c1"># ElementTree does not use QNames for attributes in the default</span>
            <span class="c1"># namespace. This is fortunate, albeit incorrect, because there&#39;s</span>
            <span class="c1"># no way to pass the namespaces map to get(), and subbing in the</span>
            <span class="c1"># default namespace URI for every attribute get would be a PITA.</span>
            <span class="n">release_mbid</span> <span class="o">=</span> <span class="n">mb_release</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;processing release </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">release_mbid</span><span class="p">)</span>

            <span class="n">title</span> <span class="o">=</span> <span class="n">mb_release</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;mb:title&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">title</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]):</span>
                <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="n">mb_name</span> <span class="o">=</span> <span class="n">mb_release</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                        <span class="s2">&quot;mb:artist-credit/mb:name-credit/mb:artist/mb:name&quot;</span><span class="p">,</span>
                        <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">mb_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">mb_name</span><span class="o">.</span><span class="n">text</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">])):</span>
                <span class="n">album_artist</span> <span class="o">=</span> <span class="n">mb_name</span><span class="o">.</span><span class="n">text</span>
                <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">album_artist</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">album_artist</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">mb_date</span> <span class="o">=</span> <span class="n">mb_release</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;mb:date&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mb_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">year</span> <span class="o">=</span> <span class="n">mb_date</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">year</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">])):</span>
                    <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
            <span class="c1"># NOTE: MusicBrainz does not support genre information.</span>
            <span class="n">cover_art_front</span> <span class="o">=</span> <span class="n">mb_release</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                <span class="s2">&quot;mb:cover-art-archive/mb:front&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cover_art_front</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">):</span>
                <span class="n">cover_art</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cover_image</span><span class="p">(</span><span class="n">release_mbid</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cover_art</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cover_art</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;cover&quot;</span><span class="p">])):</span>
                    <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;cover&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cover_art</span><span class="p">)</span>

            <span class="c1"># For a multi-CD release (e.g. any Global Underground), MusicBrainz</span>
            <span class="c1"># returns both discs (and track lists) in &lt;metadata&gt;. So when we</span>
            <span class="c1"># encounter any &lt;medium-list&gt; with @count &gt; 1, match the disc ID</span>
            <span class="c1"># in the &lt;disc-list&gt; explicitly, and only use the associated</span>
            <span class="c1"># &lt;track-list&gt;.</span>
            <span class="c1"># NOTE: The above only works when &lt;metadata&gt; is the result of an</span>
            <span class="c1"># exact disc ID match. If &lt;metadata&gt; is the result of a fuzzy TOC</span>
            <span class="c1"># match, then any release with medium-list/@count &gt; 1 won&#39;t have</span>
            <span class="c1"># its track list processed.</span>
            <span class="n">mb_medium_list</span> <span class="o">=</span> <span class="n">mb_release</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;mb:medium-list&quot;</span><span class="p">,</span>
                                             <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>
            <span class="n">medium_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mb_medium_list</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">))</span>
            <span class="n">mb_track_list</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">medium_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">mb_track_list</span> <span class="o">=</span> <span class="n">mb_medium_list</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;mb:medium/mb:track-list&quot;</span><span class="p">,</span>
                                                    <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;disc_total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">medium_count</span>
                <span class="n">disc_path</span> <span class="o">=</span> \
                    <span class="s2">&quot;mb:medium/mb:disc-list/mb:disc[@id=&#39;</span><span class="si">%s</span><span class="s2">&#39;]&quot;</span> <span class="o">%</span> <span class="n">disc_id</span>
                <span class="n">mb_disc</span> <span class="o">=</span> <span class="n">mb_medium_list</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">disc_path</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mb_disc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="c1"># XXX: ElementTree can&#39;t handle this?</span>
                    <span class="c1">#mb_position = mb_disc.find(&quot;../../mb:position&quot;,</span>
                    <span class="c1">#                           namespaces=nsmap)</span>
                    <span class="n">mb_position</span> <span class="o">=</span> <span class="n">mb_medium_list</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                        <span class="n">disc_path</span> <span class="o">+</span> <span class="s2">&quot;/../../mb:position&quot;</span><span class="p">,</span>
                        <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>
                    <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;disc_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mb_position</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                    <span class="c1"># XXX: ElementTree can&#39;t handle this?</span>
                    <span class="c1">#mb_track_list = mb_disc.find(&quot;../../mb:track-list&quot;,</span>
                    <span class="c1">#                             namespaces=nsmap)</span>
                    <span class="n">mb_track_list</span> <span class="o">=</span> <span class="n">mb_medium_list</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                            <span class="n">disc_path</span> <span class="o">+</span> <span class="s2">&quot;/../../mb:track-list&quot;</span><span class="p">,</span>
                            <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">mb_track_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;unable to find a suitable track list for release </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">release_mbid</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">track_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mb_track_list</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">track_count</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">track_offsets</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;skipping track list (expected </span><span class="si">%d</span><span class="s2"> tracks, found </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">track_offsets</span><span class="p">),</span> <span class="n">track_count</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">mb_track</span> <span class="ow">in</span> <span class="n">mb_track_list</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;mb:track&quot;</span><span class="p">,</span>
                                                  <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">):</span>
                <span class="n">track_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                    <span class="n">mb_track</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;mb:number&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="n">track_metadata</span> <span class="o">=</span> <span class="n">tracks_metadata</span><span class="p">[</span><span class="n">track_number</span><span class="p">]</span>

                <span class="n">title</span> <span class="o">=</span> <span class="n">mb_track</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                            <span class="s2">&quot;mb:recording/mb:title&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">title</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]):</span>
                    <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
                <span class="n">mb_name</span> <span class="o">=</span> <span class="n">mb_track</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                    <span class="s2">&quot;mb:recording/mb:artist-credit/mb:name-credit/mb:artist/&quot;</span>
                        <span class="s2">&quot;mb:name&quot;</span><span class="p">,</span>
                    <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>
                <span class="c1"># MusicBrainz doesn&#39;t suppress the artist name even if it&#39;s the</span>
                <span class="c1"># same as the release&#39;s artist name</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">mb_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="p">(</span><span class="n">mb_name</span><span class="o">.</span><span class="n">text</span> <span class="o">!=</span> <span class="n">album_artist</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="p">(</span><span class="n">mb_name</span><span class="o">.</span><span class="n">text</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">])):</span>
                    <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mb_name</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="c1"># NOTE: MusicBrainz does not support genre information.</span>
        <span class="c1"># TODO: does MusicBrainz recognize a distinction between</span>
        <span class="c1"># artist/performer/composer?</span>
        <span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;performer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">album_metadata</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">track_metadata</span> <span class="ow">in</span> <span class="n">tracks_metadata</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;performer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">_prepare_discid_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">disc_id</span><span class="p">:</span> <span class="s2">&quot;str MusicBrainz Disc ID&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;str full MusicBrainz request path&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Build a full MusicBrainz &#39;/discid&#39; request path.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE disc_id = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">disc_id</span><span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/discid/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">API_PATH_PREFIX</span><span class="p">,</span> <span class="n">disc_id</span><span class="p">))</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;?toc=</span><span class="si">%d</span><span class="s2">+</span><span class="si">%d</span><span class="s2">+</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">first_track_number</span><span class="p">,</span>
                                     <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">track_offsets</span><span class="p">),</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">leadout_track_offset</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">track_offset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">track_offsets</span><span class="p">:</span>
            <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;+</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">track_offset</span><span class="p">)</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;cdstubs=no&amp;inc=artist-credits+recordings&quot;</span><span class="p">)</span>
        <span class="n">request_path</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">request_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request_path</span>

    <span class="k">def</span> <span class="nf">_get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">request_path</span><span class="p">:</span> <span class="s2">&quot;a MusicBrainz HTTP request path&quot;</span><span class="p">,</span>
            <span class="n">nsmap</span><span class="p">:</span> <span class="s2">&quot;map of namespace prefixes to URIs&quot;</span><span class="p">,</span>
            <span class="n">http_keep_alive</span><span class="p">:</span> <span class="s2">&quot;False to close server connection&quot;</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;:class:`xml.etree.ElementTree.Element` &lt;metadata&gt;&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;GET the *request_path* and return the response.</span>

<span class="sd">        If this method returns, then /metadata is guaranteed to exist;</span>
<span class="sd">        otherwise, a ``MetadataError`` with an appropriate message is</span>
<span class="sd">        rasied.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;TRACE request_path = </span><span class="si">%r</span><span class="s2">, nsmap = </span><span class="si">%r</span><span class="s2">, http_keep_alive = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">request_path</span><span class="p">,</span> <span class="n">nsmap</span><span class="p">,</span> <span class="n">http_keep_alive</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_agent</span><span class="p">,</span>
            <span class="s2">&quot;Connection&quot;</span><span class="p">:</span> <span class="s2">&quot;keep-alive&quot;</span> <span class="k">if</span> <span class="n">http_keep_alive</span> <span class="k">else</span> <span class="s2">&quot;close&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conx</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">request_path</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conx</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>
        <span class="n">response_bytes</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">response_bytes = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                           <span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
                           <span class="n">response_bytes</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">http_keep_alive</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span>
                    <span class="s2">&quot;HTTP </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">),</span>
                    <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;MusicBrainz API&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">):</span>
            <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">parse_header</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">])</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;charset&quot;</span><span class="p">,</span> <span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="s2">&quot;UTF-8&quot;</span>

        <span class="n">mb_response</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">response_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">mb_response</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">mb_response</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}metadata&quot;</span> <span class="o">%</span> <span class="n">nsmap</span><span class="p">[</span><span class="s2">&quot;mb&quot;</span><span class="p">])):</span>
            <span class="n">mb_text</span> <span class="o">=</span> <span class="n">mb_response</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mb_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">mb_text</span><span class="o">.</span><span class="n">text</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Unexpected response root element </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">%</span>
                            <span class="n">mb_response</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;MusicBrainz API&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mb_response</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mb_response</span>

    <span class="k">def</span> <span class="nf">_get_cover_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">release_mbid</span><span class="p">:</span> <span class="s2">&quot;str MusicBrainz ID of a release&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;bytes raw image data&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Download a cover image.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE release_mbid = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">release_mbid</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">COVERART_URL_TEMPLATE</span> <span class="o">%</span> <span class="n">release_mbid</span><span class="p">)</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">netloc</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">path</span> <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">query</span><span class="p">)</span> \
                <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">?</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">url</span><span class="o">.</span><span class="n">query</span><span class="p">))</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_agent</span><span class="p">}</span>

        <span class="n">conx</span> <span class="o">=</span> <span class="n">HTTPConnection</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">conx</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">conx</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">301</span><span class="p">,</span> <span class="mi">302</span><span class="p">,</span> <span class="mi">307</span><span class="p">]):</span>
            <span class="n">response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">netloc</span> <span class="o">!=</span> <span class="n">host</span><span class="p">):</span>
                <span class="n">conx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">conx</span> <span class="o">=</span> <span class="n">HTTPConnection</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">path</span> <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">query</span><span class="p">)</span> \
                    <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">?</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">url</span><span class="o">.</span><span class="n">query</span><span class="p">))</span>
            <span class="n">conx</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">conx</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">conx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">):</span>
                <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">=</span> \
                    <span class="n">cgi</span><span class="o">.</span><span class="n">parse_header</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">])</span>
                <span class="n">encoding</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;charset&quot;</span><span class="p">,</span> <span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">encoding</span> <span class="o">=</span> <span class="s2">&quot;UTF-8&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;unable to get cover art for mbid </span><span class="si">%r</span><span class="s2"> (HTTP </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="n">release_mbid</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span>
                <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">))</span></div>


<span class="nd">@logged</span>
<div class="viewcode-block" id="MetadataPersistence"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataPersistence">[docs]</a><span class="k">class</span> <span class="nc">MetadataPersistence</span><span class="p">(</span><span class="n">MetadataCollector</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A pseudo-client that populates **persisted** album and track</span>
<span class="sd">    metadata choices for a disc.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param flacmanager.TOC toc: a disc&#39;s table of contents</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE toc = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">toc</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">toc</span><span class="p">)</span>

        <span class="n">flac_library_root</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;library_root&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flac_library_root</span> <span class="o">=</span> <span class="n">resolve_path</span><span class="p">(</span><span class="n">flac_library_root</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot use FLAC library root </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">flac_library_root</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span>
                <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;Metadata persistence&quot;</span><span class="p">,</span>
                <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_persistence_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flac_library_root</span><span class="p">,</span>
                                                      <span class="s2">&quot;.metadata&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disc_id</span> <span class="o">=</span> <span class="n">MusicBrainzMetadataCollector</span><span class="o">.</span><span class="n">calculate_disc_id</span><span class="p">(</span><span class="n">toc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.json&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_persistence_root</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">metadata_filename</span><span class="p">)</span>

<div class="viewcode-block" id="MetadataPersistence.reset"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataPersistence.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize all collection fields to default (empty).&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restored</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="MetadataPersistence.collect"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataPersistence.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate metadata choices from persisted data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;found </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">disc_metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="c1"># convert album cover to byte string (raw image data) by encoding</span>
            <span class="c1"># the string to &quot;Latin-1&quot;</span>
            <span class="c1"># (see comment in the _convert_to_json_serializable(obj) method)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;album&quot;</span><span class="p">][</span><span class="s2">&quot;cover&quot;</span><span class="p">])):</span>
                <span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;album&quot;</span><span class="p">][</span><span class="s2">&quot;cover&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;album&quot;</span><span class="p">][</span><span class="s2">&quot;cover&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;Latin-1&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">album</span> <span class="o">=</span> <span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;album&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tracks</span> <span class="o">=</span> <span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;tracks&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restored</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;restored metadata for DiscId </span><span class="si">%s</span><span class="s2"> from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">disc_id</span><span class="p">,</span> <span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;did not find </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="MetadataPersistence.store"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataPersistence.store">[docs]</a>    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Persist a disc&#39;s metadata field values.</span>

<span class="sd">        :param dict metadata: the finalized metadata for a disc</span>

<span class="sd">        Persisting the metadata field values allows for easy error</span>
<span class="sd">        recovery in the event that ripping/encoding fails (i.e. the user</span>
<span class="sd">        will not need to re-choose and/or re-enter values).</span>

<span class="sd">        .. note::</span>
<span class="sd">           The presence of persisted metadata for a disc does *not*</span>
<span class="sd">           prevent metadata aggregation. Metadata is still aggregated,</span>
<span class="sd">           but any persisted values take precedence.</span>

<span class="sd">        .. warning::</span>
<span class="sd">           Only the **first** value (i.e. the **entered** or</span>
<span class="sd">           **selected** value) for each metadata field is persisted.</span>
<span class="sd">           This value is assumed to be the preferred/intended value for</span>
<span class="sd">           the field.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE metadata = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_persistence_root</span><span class="p">)):</span>
            <span class="c1"># doesn&#39;t work as expected for external media</span>
            <span class="c1">#os.makedirs(metadata_persistence_root, exist_ok=True)</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s2">&quot;mkdir&quot;</span><span class="p">,</span> <span class="s2">&quot;-p&quot;</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">metadata_persistence_root</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;created </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_persistence_root</span><span class="p">)</span>

        <span class="n">ordered_metadata</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">ordered_metadata</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="n">ordered_metadata</span><span class="p">[</span><span class="s2">&quot;TOC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">toc</span>
        <span class="n">ordered_metadata</span><span class="p">[</span><span class="s2">&quot;album&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album&quot;</span><span class="p">]</span>
        <span class="n">ordered_metadata</span><span class="p">[</span><span class="s2">&quot;tracks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;tracks&quot;</span><span class="p">]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">ordered_metadata</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">),</span>
                      <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_json_serializable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;wrote </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_convert_to_json_serializable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">obj</span><span class="p">:</span> <span class="s2">&quot;object to be converted into a serializable JSON value&quot;</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="s2">&quot;str a JSON-serializable representation of `obj`&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return a JSON-serializable representation of `obj`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="c1"># JSON does not directly support binary data, so instead use the</span>
            <span class="c1"># Latin-1-decoded value, which will be properly converted to use</span>
            <span class="c1"># Unicode escape sequences by the json library.</span>
            <span class="c1"># (Unicode code points 0-255 are identical to the Latin-1 values.)</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;Latin-1&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; is not JSON serializable&quot;</span><span class="p">)</span></div>


<span class="c1">#: Used to pass data between a :class:`MetadataAggregator` thread and the main</span>
<span class="c1">#: thread.</span>
<span class="n">_AGGREGATOR_QUEUE</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="nd">@logged</span>
<div class="viewcode-block" id="MetadataAggregator"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataAggregator">[docs]</a><span class="k">class</span> <span class="nc">MetadataAggregator</span><span class="p">(</span><span class="n">MetadataCollector</span><span class="p">,</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param flacmanager.TOC toc: a disc&#39;s table of contents</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE toc = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">toc</span><span class="p">)</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">MetadataCollector</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span> <span class="o">=</span> <span class="n">MetadataPersistence</span><span class="p">(</span><span class="n">toc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collectors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span><span class="p">,</span> <span class="c1"># must be first</span>
            <span class="n">GracenoteCDDBMetadataCollector</span><span class="p">(</span><span class="n">toc</span><span class="p">),</span>
            <span class="n">MusicBrainzMetadataCollector</span><span class="p">(</span><span class="n">toc</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="MetadataAggregator.run"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataAggregator.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the :meth:`collect` method in another thread.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;aggregation error: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">_AGGREGATOR_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="MetadataAggregator.collect"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataAggregator.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate metadata from all music databases.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
        <span class="n">MetadataCollector</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">collector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collectors</span><span class="p">:</span>
                <span class="n">collector</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_merge_metadata</span><span class="p">([</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;artist&quot;</span><span class="p">,</span> <span class="s2">&quot;performer&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span>
                                      <span class="s2">&quot;genre&quot;</span><span class="p">,</span> <span class="s2">&quot;cover&quot;</span><span class="p">],</span>
                                     <span class="n">collector</span><span class="o">.</span><span class="n">album</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">album</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;disc_number&quot;</span><span class="p">,</span> <span class="s2">&quot;disc_total&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">collector</span><span class="o">.</span><span class="n">album</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">album</span><span class="p">[</span><span class="n">field</span><span class="p">]):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">album</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">collector</span><span class="o">.</span><span class="n">album</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>

                <span class="n">track_ordinal</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">track_metadata</span> <span class="ow">in</span> <span class="n">collector</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_merge_metadata</span><span class="p">([</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;artist&quot;</span><span class="p">,</span> <span class="s2">&quot;performer&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span>
                                          <span class="s2">&quot;genre&quot;</span><span class="p">],</span>
                                         <span class="n">track_metadata</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">track_ordinal</span><span class="p">])</span>
                    <span class="n">track_ordinal</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># persisted metadata takes precedence</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">restored</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">album</span><span class="p">[</span><span class="s2">&quot;disc_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">album</span><span class="p">[</span><span class="s2">&quot;disc_number&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">album</span><span class="p">[</span><span class="s2">&quot;disc_total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">album</span><span class="p">[</span><span class="s2">&quot;disc_total&quot;</span><span class="p">]</span>
                <span class="c1"># persisted data stores the &quot;include&quot; flag for tracks</span>
                <span class="c1"># (regular collectors do not)</span>
                <span class="n">track_ordinal</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">track_metadata</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">track_ordinal</span><span class="p">][</span><span class="s2">&quot;include&quot;</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">track_ordinal</span><span class="p">][</span><span class="s2">&quot;include&quot;</span><span class="p">]</span>
                    <span class="n">track_ordinal</span> <span class="o">+=</span> <span class="mi">1</span></div>

    <span class="k">def</span> <span class="nf">_merge_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">fields</span><span class="p">:</span> <span class="s2">&quot;list of metadata field names&quot;</span><span class="p">,</span>
            <span class="n">source</span><span class="p">:</span> <span class="s2">&quot;dict metadata being merged from&quot;</span><span class="p">,</span>
            <span class="n">target</span><span class="p">:</span> <span class="s2">&quot;dict metadata being merged into&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE fields = </span><span class="si">%r</span><span class="s2">, source = </span><span class="si">%r</span><span class="s2">, target = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">fields</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">source</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target</span><span class="p">[</span><span class="n">field</span><span class="p">]):</span>
                    <span class="n">target</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_lame_genres"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.get_lame_genres">[docs]</a><span class="k">def</span> <span class="nf">get_lame_genres</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return the list of genres recognized by LAME.&quot;&quot;&quot;</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>
    <span class="c1"># simple memo</span>
    <span class="n">genres</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">get_lame_genres</span><span class="p">,</span> <span class="s2">&quot;_fm_cached_genres&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">genres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;cache miss&quot;</span><span class="p">)</span>
        <span class="n">genres</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># lame writes the genre list to stderr!?</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s2">&quot;lame&quot;</span><span class="p">,</span> <span class="s2">&quot;--genre-list&quot;</span><span class="p">],</span>
                                         <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">())):</span>
            <span class="p">(</span><span class="n">genre_number</span><span class="p">,</span> <span class="n">genre_label</span><span class="p">)</span> <span class="o">=</span> <span class="n">genre</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">genres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">genre_label</span><span class="p">)</span>
        <span class="n">get_lame_genres</span><span class="o">.</span><span class="n">_fm_cached_genres</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">genres</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RETURN </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">genres</span><span class="p">)</span>
    <span class="c1"># always return a copy so that the list can be modified without changing</span>
    <span class="c1"># the cached value</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">genres</span><span class="p">)</span></div>


<div class="viewcode-block" id="show_exception_dialog"><a class="viewcode-back" href="../user-interface.html#flacmanager.show_exception_dialog">[docs]</a><span class="k">def</span> <span class="nf">show_exception_dialog</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">aborting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Open a dialog to display exception information.</span>

<span class="sd">    :param Exception e: a caught exception</span>
<span class="sd">    :keyword bool aborting: ``True`` if the application will terminate</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
    <span class="n">message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">FLACManagerError</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">context_hint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> error&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">context_hint</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">cause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n\n</span><span class="s2">(caused by </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">message</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">cause</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aborting</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n\n</span><span class="s2">WARNING! </span><span class="si">%s</span><span class="s2"> will abort after this message is dismissed!&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">FLACManager</span><span class="o">.</span><span class="n">TITLE</span><span class="p">))</span>
    <span class="n">messagebox</span><span class="o">.</span><span class="n">showerror</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span></div>


<span class="k">def</span> <span class="nf">configure_logging</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Perform basic configuration of :mod:`logging`.</span>

<span class="sd">    This function uses the options from *flacmanager.ini*&#39;s [Logging]</span>
<span class="sd">    section to configure the logging module.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Logging config = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Logging&quot;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Logging&quot;</span><span class="p">,</span> <span class="s2">&quot;level&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;OFF&quot;</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Logging&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># effectively turns logging off</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">FATAL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>


<span class="k">if</span> <span class="p">(</span><span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;flacmanager.py&quot;</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please run flacmanager.py from within its directory.&quot;</span><span class="p">,</span>
              <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">config_is_missing</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;flacmanager.ini&quot;</span><span class="p">))</span>

    <span class="n">configure_logging</span><span class="p">()</span>

    <span class="c1"># will affect HTTPSConnection as well</span>
    <span class="n">HTTPConnection</span><span class="o">.</span><span class="n">debuglevel</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;HTTP&quot;</span><span class="p">,</span> <span class="s2">&quot;debuglevel&quot;</span><span class="p">)</span>

    <span class="n">root</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
    <span class="n">root</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">FLACManager</span><span class="o">.</span><span class="n">TITLE</span><span class="p">)</span>
    <span class="n">root</span><span class="o">.</span><span class="n">minsize</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">FLACManager</span><span class="p">(</span><span class="n">master</span><span class="o">=</span><span class="n">root</span><span class="p">,</span> <span class="n">need_config</span><span class="o">=</span><span class="n">config_is_missing</span><span class="p">)</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;aborting&quot;</span><span class="p">)</span>
        <span class="n">show_exception_dialog</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">aborting</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013 - 2016, Matthew Zipay.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.7.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>