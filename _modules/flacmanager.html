

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>flacmanager &mdash; FLAC Manager 0.8.1 documentation</title>
  

  
  

  

  
  
    
      <link rel="search" type="application/opensearchdescription+xml" title="Search within FLAC Manager 0.8.1 documentation" href="../_static/opensearch.xml"/>
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="FLAC Manager 0.8.1 documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> FLAC Manager
          

          
          </a>

          
            
            
              <div class="version">
                0.8.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../prerequisites.html">Prerequisites for running FLACManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../whats-new.html">What&#8217;s new in FLACManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Using FLACManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-ref.html">FLACManager API reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">FLAC Manager</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Module code</a> &raquo;</li>
      
    <li>flacmanager</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for flacmanager</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: UTF-8 -*-</span>

<span class="sd">&quot;&quot;&quot;FLACManager is an audio metadata aggregator and FLAC+MP3</span>
<span class="sd">at-once tagger/encoder.</span>

<span class="sd">Audio metadata is aggregated from the Gracenote CDDB and</span>
<span class="sd">MusicBrainz services and presented to the user for acceptance,</span>
<span class="sd">selection and/or modification.</span>

<span class="sd">The file system folder and file names for ripped albums are</span>
<span class="sd">fully configurable via the flacmanager.ini configuration file.</span>

<span class="sd">Vorbis comments for FLAC files and ID3v2 tags for MP3 files are</span>
<span class="sd">also fully configurable.  In the default configuration, ID3v2</span>
<span class="sd">tags are compatible with both the iTunes application and the</span>
<span class="sd">Google Play Music service.  Custom Vorbis comments and ID3v2 tags</span>
<span class="sd">can also be defined on a per-album and/or per-track basis.</span>

<span class="sd">Immediately before tracks are encoded/tagged, FLACManager saves</span>
<span class="sd">all chosen metadata fields and custom Vorbis/ID3v2 tagging data</span>
<span class="sd">to a special file that is unique for that disc.  If the same disc</span>
<span class="sd">is inserted again, the saved information is restored in the UI</span>
<span class="sd">(including the chosen album art).  This provivdes for easy</span>
<span class="sd">recovery from failed encoding operations, or the ability to</span>
<span class="sd">re-encode/re-tag albums without needing to re-edit all metadata.</span>

<span class="sd">FLAC and MP3 encoding options are fully configurable via the</span>
<span class="sd">flacmanager.ini configuration file. By default, FLACManager</span>
<span class="sd">detects clipping in MP3s and will automatically re-encode with</span>
<span class="sd">scaled PCM data in order to eliminate clipping.</span>

<span class="sd">Please read the following articles before using FLACManager!</span>

<span class="sd">http://mzipay.github.io/FLACManager/prerequisites.html</span>
<span class="sd">http://mzipay.github.io/FLACManager/whats-new.html</span>
<span class="sd">http://mzipay.github.io/FLACManager/usage.html</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Matthew Zipay &lt;mattz@ninthtest.info&gt;&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.8.1&quot;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">FLAC Manager -- audio metadata aggregator and FLAC+MP3 encoder</span>
<span class="s2">http://ninthtest.info/flac-mp3-audio-manager/</span>

<span class="s2">Copyright (c) 2013-2017 Matthew Zipay. All rights reserved.</span>

<span class="s2">Permission is hereby granted, free of charge, to any person</span>
<span class="s2">obtaining a copy of this software and associated documentation</span>
<span class="s2">files (the &quot;Software&quot;), to deal in the Software without</span>
<span class="s2">restriction, including without limitation the rights to use,</span>
<span class="s2">copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="s2">copies of the Software, and to permit persons to whom the</span>
<span class="s2">Software is furnished to do so, subject to the following</span>
<span class="s2">conditions:</span>

<span class="s2">The above copyright notice and this permission notice shall be</span>
<span class="s2">included in all copies or substantial portions of the Software.</span>

<span class="s2">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="s2">EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES</span>
<span class="s2">OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="s2">NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT</span>
<span class="s2">HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,</span>
<span class="s2">WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<span class="s2">FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="s2">OTHER DEALINGS IN THE SOFTWARE.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">ast</span> <span class="k">import</span> <span class="n">literal_eval</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">cgi</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">configparser</span> <span class="k">import</span> <span class="n">ConfigParser</span><span class="p">,</span> <span class="n">ExtendedInterpolation</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">ctypes</span> <span class="k">as</span> <span class="nn">C</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">lru_cache</span><span class="p">,</span> <span class="n">partial</span><span class="p">,</span> <span class="n">total_ordering</span>
<span class="kn">from</span> <span class="nn">http.client</span> <span class="k">import</span> <span class="n">HTTPConnection</span><span class="p">,</span> <span class="n">HTTPMessage</span><span class="p">,</span> <span class="n">HTTPSConnection</span>
<span class="kn">import</span> <span class="nn">imghdr</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">BytesIO</span><span class="p">,</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">plistlib</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">ssl</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="k">import</span> <span class="n">mkstemp</span><span class="p">,</span> <span class="n">TemporaryDirectory</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">tkinter</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">tkinter.ttk</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">tkinter.filedialog</span> <span class="k">as</span> <span class="nn">filedialog</span>
<span class="kn">import</span> <span class="nn">tkinter.messagebox</span> <span class="k">as</span> <span class="nn">messagebox</span>
<span class="kn">import</span> <span class="nn">tkinter.scrolledtext</span> <span class="k">as</span> <span class="nn">scrolledtext</span>
<span class="kn">import</span> <span class="nn">tkinter.simpledialog</span> <span class="k">as</span> <span class="nn">simpledialog</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="k">import</span> <span class="n">urlparse</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="k">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">urlopen</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;TOC&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get_config&quot;</span><span class="p">,</span>
    <span class="s2">&quot;save_config&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FLACManagerError&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FLACManager&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MetadataError&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MetadataCollector&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GracenoteCDDBMetadataCollector&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MusicBrainzMetadataCollector&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MetadataPersistence&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MetadataAggregator&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1">#: A custom tracing log level, lower in severity than</span>
<span class="c1">#: :attr:`logging.DEBUG`.</span>
<span class="n">TRACE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">logging</span><span class="o">.</span><span class="n">addLevelName</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s2">&quot;TRACE&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_TracingLogger</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLoggerClass</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;A logger with tracing capability.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log entry into a callable with severity :attr:`TRACE`.</span>

<span class="sd">        :arg tuple args: the positional arguments to the callable</span>
<span class="sd">        :arg dict kwargs: the keyword arguments to the callable</span>

<span class="sd">        .. note::</span>
<span class="sd">           The positional and keyword arguments to this method are</span>
<span class="sd">           **not** interpreted as for :meth:`logging.Logger.log`; they</span>
<span class="sd">           should be argument-for-argument identical values as passed</span>
<span class="sd">           to the callable being traced.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">TRACE</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s2">&quot;CALL *</span><span class="si">%r</span><span class="s2"> **</span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log &#39;msg % args&#39; with severity :attr:`TRACE`.</span>

<span class="sd">        Positional and keyword arguments are interpreted as for</span>
<span class="sd">        :meth:`logging.Logger.log`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;MARK&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log *marker* with severity :attr:`TRACE`.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="n">marker</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">return_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log return from a callable with severity :attr:`TRACE`.</span>

<span class="sd">        :keyword value: the value returned from the callable</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">TRACE</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s2">&quot;RETURN </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,))</span>


<span class="n">logging</span><span class="o">.</span><span class="n">setLoggerClass</span><span class="p">(</span><span class="n">_TracingLogger</span><span class="p">)</span>

<span class="c1">#: The module-level logger.</span>
<span class="n">_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">logged</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorate *cls* to provide a logger.</span>

<span class="sd">    :arg type cls: a class (type) object</span>
<span class="sd">    :return: *cls* with a provided ``__log`` member</span>
<span class="sd">    :rtype: :obj:`type`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">setattr</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">__log&quot;</span> <span class="o">%</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^_+&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>

    <span class="k">return</span> <span class="bp">cls</span>


<span class="c1">#: The amount of time (in milliseconds) to wait before attempting</span>
<span class="c1">#: another call to any :meth:`queue.Queue.get_nowait` method.</span>
<span class="n">QUEUE_GET_NOWAIT_AFTER</span> <span class="o">=</span> <span class="mi">625</span>


<div class="viewcode-block" id="identify_cdda_device"><a class="viewcode-back" href="../disc-info.html#flacmanager.identify_cdda_device">[docs]</a><span class="k">def</span> <span class="nf">identify_cdda_device</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Locate the file system device for an inserted CD-DA.</span>

<span class="sd">    :return: the CD-DA file system device (&quot;/dev/&lt;device&gt;&quot;)</span>
<span class="sd">    :rtype: :obj:`str`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># do not trace; called repeatedly by a the DiscCheck thread</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;diskutil&quot;</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span><span class="p">],</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">())</span>

    <span class="n">is_cd_partition_scheme</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_cd_da</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/dev/&quot;</span><span class="p">):</span>
            <span class="n">device</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="s2">&quot;CD_partition_scheme&quot;</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;candidate </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="n">is_cd_partition_scheme</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="s2">&quot;CD_DA&quot;</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="n">is_cd_da</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">is_cd_partition_scheme</span> <span class="ow">and</span> <span class="n">is_cd_da</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">device</span></div>


<div class="viewcode-block" id="identify_cdda_mount_point"><a class="viewcode-back" href="../disc-info.html#flacmanager.identify_cdda_mount_point">[docs]</a><span class="k">def</span> <span class="nf">identify_cdda_mount_point</span><span class="p">(</span><span class="n">device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Locate the file system mount point for the CD-DA *device*.</span>

<span class="sd">    :arg str device: the CD-DA device (&quot;/dev/&lt;device&gt;&quot;)</span>
<span class="sd">    :return: the *device* mount point</span>
<span class="sd">    :rtype: :obj:`str`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># do not trace; called repeatedly by a the DiscCheck thread</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;diskutil&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">],</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+Mount Point:\s+(.*?)$&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>


<span class="c1">#: The number of seconds to wait between querying ``diskutil`` for the</span>
<span class="c1">#: inserted CD-DA device.</span>
<span class="n">_CDDA_DEVICE_IDENT_WAIT</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="c1">#: The number of seconds to wait between querying ``diskutil`` for the</span>
<span class="c1">#: inserted CD-DA device&#39;s mount point.</span>
<span class="n">_CDDA_MOUNT_POINT_IDENT_WAIT</span> <span class="o">=</span> <span class="mf">1.5</span>

<span class="c1">#: Used to pass data between a :class:`DiscCheck` thread and the main</span>
<span class="c1">#: thread.</span>
<span class="n">_DISC_QUEUE</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="nd">@logged</span>
<div class="viewcode-block" id="DiscCheck"><a class="viewcode-back" href="../disc-info.html#flacmanager.DiscCheck">[docs]</a><span class="k">class</span> <span class="nc">DiscCheck</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A thread that checks for the presence of a CD-DA disc.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;``DiscCheck`` threads are daemonized so that they are killed</span>
<span class="sd">        automatically if the program exits.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="DiscCheck.run"><a class="viewcode-back" href="../disc-info.html#flacmanager.DiscCheck.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Poll for a mounted CD-DA disk device until one is found or an</span>
<span class="sd">        exception occurs.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="n">device</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">mount_point</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">device</span> <span class="o">=</span> <span class="n">identify_cdda_device</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">_CDDA_DEVICE_IDENT_WAIT</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;identified CD-DA device </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">mount_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># sleep first here to give the device time to mount</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">_CDDA_MOUNT_POINT_IDENT_WAIT</span><span class="p">)</span>
                <span class="n">mount_point</span> <span class="o">=</span> <span class="n">identify_cdda_mount_point</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;identified CD-DA mount point </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mount_point</span><span class="p">)</span>

            <span class="n">disc_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">mount_point</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">_DISC_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">disc_info</span><span class="p">)</span>
            <span class="n">_DISC_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">disc_info</span><span class="p">)</span></div></div>


<span class="c1">#: Represents a disc table-of-contents (TOC), as read from a</span>
<span class="c1">#: *.TOC.plist* file.</span>
<span class="n">TOC</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s2">&quot;TOC&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;first_track_number&quot;</span><span class="p">,</span> <span class="s2">&quot;last_track_number&quot;</span><span class="p">,</span> <span class="s2">&quot;track_offsets&quot;</span><span class="p">,</span>
        <span class="s2">&quot;leadout_track_offset&quot;</span><span class="p">])</span>


<div class="viewcode-block" id="read_disc_toc"><a class="viewcode-back" href="../disc-info.html#flacmanager.read_disc_toc">[docs]</a><span class="k">def</span> <span class="nf">read_disc_toc</span><span class="p">(</span><span class="n">mountpoint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the :obj:`TOC` for the currently mounted disc.</span>

<span class="sd">    :arg str mountpoint: the mount point of an inserted CD-DA disc</span>
<span class="sd">    :return: a populated TOC for the inserted CD-DA disc</span>
<span class="sd">    :rtype: :obj:`TOC`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mountpoint</span><span class="p">)</span>

    <span class="n">toc_plist_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mountpoint</span><span class="p">,</span> <span class="s2">&quot;.TOC.plist&quot;</span><span class="p">)</span>
    <span class="n">toc_plist</span> <span class="o">=</span> <span class="n">plistlib</span><span class="o">.</span><span class="n">readPlist</span><span class="p">(</span><span class="n">toc_plist_filename</span><span class="p">)</span>

    <span class="n">first_track_number</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">last_track_number</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">track_offsets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">leadout_track_offset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">toc_plist</span><span class="p">[</span><span class="s2">&quot;Sessions&quot;</span><span class="p">]:</span>
        <span class="c1"># Session Type 0 is CD-DA</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;Session Type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">first_track_number</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;First Track&quot;</span><span class="p">]</span>
            <span class="n">last_track_number</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;Last Track&quot;</span><span class="p">]</span>
            <span class="n">leadout_track_offset</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;Leadout Block&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;Track Array&quot;</span><span class="p">]:</span>
                <span class="n">track_offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;Start Block&quot;</span><span class="p">])</span>
            <span class="c1"># don&#39;t need to process any more sessions</span>
            <span class="k">break</span>

    <span class="n">toc</span> <span class="o">=</span> <span class="n">TOC</span><span class="p">(</span>
        <span class="n">first_track_number</span><span class="p">,</span> <span class="n">last_track_number</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">track_offsets</span><span class="p">),</span>
        <span class="n">leadout_track_offset</span><span class="p">)</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="n">toc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">toc</span></div>


<span class="c1">#: The global :class:`configparser.ConfigParser` object.</span>
<span class="n">_config</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1">#: Used to synchronize access to the global configuration object.</span>
<span class="n">_CONFIG_LOCK</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>


<div class="viewcode-block" id="get_config"><a class="viewcode-back" href="../miscellaneous.html#flacmanager.get_config">[docs]</a><span class="k">def</span> <span class="nf">get_config</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return the configuration settings.</span>

<span class="sd">    :return: settings read from *flacmanager.ini*</span>
<span class="sd">    :rtype: :class:`configparser.ConfigParser`</span>

<span class="sd">    The configuration is initialized with default/empty values and saved</span>
<span class="sd">    to disk if it does not exist.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

    <span class="k">global</span> <span class="n">_config</span>
    <span class="k">with</span> <span class="n">_CONFIG_LOCK</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;initializing configuration&quot;</span><span class="p">)</span>
            <span class="n">_config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">(</span><span class="n">interpolation</span><span class="o">=</span><span class="n">ExtendedInterpolation</span><span class="p">())</span>
            <span class="n">_config</span><span class="o">.</span><span class="n">optionxform</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">option</span><span class="p">:</span> <span class="n">option</span> <span class="c1"># preserve casing</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">_config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;flacmanager.ini&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="p">[</span><span class="s2">&quot;flacmanager.ini&quot;</span><span class="p">]</span>
                    <span class="ow">or</span> <span class="s2">&quot;FLACManager&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_config</span>
                    <span class="ow">or</span> <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;FLACManager&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__version__&quot;</span><span class="p">)</span> <span class="o">!=</span>
                        <span class="n">__version__</span><span class="p">):</span>
                <span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;flacmanager.ini is missing or outdated; &quot;</span>
                        <span class="s2">&quot;updating to version </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">__version__</span><span class="p">)</span>

                <span class="n">fm</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="s2">&quot;FLACManager&quot;</span> <span class="ow">in</span> <span class="n">_config</span><span class="p">:</span>
                    <span class="n">fm</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;FLACManager&quot;</span><span class="p">])</span>

                <span class="c1"># always make sure this is accurate</span>
                <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;FLACManager&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">__version__</span><span class="o">=</span><span class="n">__version__</span><span class="p">)</span>

                <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;FLACManager $</span><span class="si">{__version__}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">]:</span>
                    <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;FLACManager&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;UI&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_config</span><span class="p">:</span>
                    <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;UI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;UI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;minwidth&quot;</span><span class="p">,</span> <span class="n">fm</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;minwidth&quot;</span><span class="p">,</span> <span class="s2">&quot;1024&quot;</span><span class="p">))</span>
                <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;UI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;minheight&quot;</span><span class="p">,</span> <span class="n">fm</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;minheight&quot;</span><span class="p">,</span> <span class="s2">&quot;768&quot;</span><span class="p">))</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="c1">#(&quot;minwidth&quot;, &quot;1024&quot;),</span>
                        <span class="c1">#(&quot;minheight&quot;, &quot;768&quot;),</span>
                        <span class="p">(</span><span class="s2">&quot;padx&quot;</span><span class="p">,</span> <span class="s2">&quot;7&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;pady&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;disable_editing_excluded_tracks&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;encoding_max_visible_tracks&quot;</span><span class="p">,</span> <span class="s2">&quot;29&quot;</span><span class="p">),</span>
                        <span class="p">]:</span>
                    <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;UI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;Logging&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_config</span><span class="p">:</span>
                    <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;Logging&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="p">(</span><span class="s2">&quot;level&quot;</span><span class="p">,</span> <span class="s2">&quot;WARNING&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="s2">&quot;flacmanager.log&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;filemode&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">,</span> 
                            <span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(levelname)s</span><span class="s2"> [</span><span class="si">%(threadName)s</span><span class="s2"> &quot;</span>
                            <span class="s2">&quot;</span><span class="si">%(name)s</span><span class="s2">.</span><span class="si">%(funcName)s</span><span class="s2">] </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">]:</span>
                    <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;Logging&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span>
                        

                <span class="k">if</span> <span class="s2">&quot;HTTP&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_config</span><span class="p">:</span>
                    <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;HTTP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="p">(</span><span class="s2">&quot;debuglevel&quot;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="s2">&quot;5.0&quot;</span><span class="p">),</span>
                        <span class="p">]:</span>
                    <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;HTTP&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;Gracenote&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_config</span><span class="p">:</span>
                    <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="p">(</span><span class="s2">&quot;client_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                        <span class="p">]:</span>
                    <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;MusicBrainz&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_config</span><span class="p">:</span>
                    <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;MusicBrainz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="p">(</span><span class="s2">&quot;contact_url_or_email&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;libdiscid_location&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                        <span class="p">]:</span>
                    <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;MusicBrainz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span>

                <span class="c1"># TODO: add Discogs for metadata aggregation</span>
                <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                if &quot;Discogs&quot; not in _config:</span>
<span class="sd">                    _config[&quot;Discogs&quot;] = OrderedDict()</span>
<span class="sd">                for (key, default_value) in [</span>
<span class="sd">                        ]:</span>
<span class="sd">                    _config[&quot;Discogs&quot;].setdefault(key, default_value)</span>
<span class="sd">                &#39;&#39;&#39;</span>

                <span class="k">if</span> <span class="s2">&quot;Organize&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_config</span><span class="p">:</span>
                    <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;Organize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="p">(</span><span class="s2">&quot;library_root&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;library_subroot_trie_key&quot;</span><span class="p">,</span> <span class="s2">&quot;album_artist&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;library_subroot_compilation_trie_key&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;album_title&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;library_subroot_trie_level&quot;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;trie_ignore_leading_article&quot;</span><span class="p">,</span> <span class="s2">&quot;a an the&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;album_folder&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{album_artist}</span><span class="s2">/</span><span class="si">{album_title}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;ndisc_album_folder&quot;</span><span class="p">,</span> <span class="s2">&quot;$</span><span class="si">{album_folder}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;compilation_album_folder&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{album_title}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;ndisc_compilation_album_folder&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;$</span><span class="si">{compilation_album_folder}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;track_filename&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{track_number:02d}</span><span class="s2"> </span><span class="si">{track_title}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;ndisc_track_filename&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;</span><span class="si">{album_discnumber:02d}</span><span class="s2">-$</span><span class="si">{track_filename}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;compilation_track_filename&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;$</span><span class="si">{track_filename}</span><span class="s2"> (</span><span class="si">{track_artist}</span><span class="s2">)&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;ndisc_compilation_track_filename&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;</span><span class="si">{album_discnumber:02d}</span><span class="s2">-$</span><span class="si">{compilation_track_filename}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;use_xplatform_safe_names&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;save_cover_image&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">),</span>
                        <span class="p">]:</span>
                    <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;Organize&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;FLAC&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_config</span><span class="p">:</span>
                    <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;FLAC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="p">(</span><span class="s2">&quot;library_root&quot;</span><span class="p">,</span> <span class="s2">&quot;${Organize:library_root}/FLAC&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;library_subroot_trie_key&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:library_subroot_trie_key}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;library_subroot_compilation_trie_key&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:library_subroot_compilation_trie_key}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;library_subroot_trie_level&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:library_subroot_trie_level}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;trie_ignore_leading_article&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:trie_ignore_leading_article}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;album_folder&quot;</span><span class="p">,</span> <span class="s2">&quot;${Organize:album_folder}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;ndisc_album_folder&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:ndisc_album_folder}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;compilation_album_folder&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:compilation_album_folder}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;ndisc_compilation_album_folder&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:ndisc_compilation_album_folder}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;track_filename&quot;</span><span class="p">,</span> <span class="s2">&quot;${Organize:track_filename}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;ndisc_track_filename&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:ndisc_track_filename}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;compilation_track_filename&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:compilation_track_filename}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;ndisc_compilation_track_filename&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:ndisc_compilation_track_filename}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;track_fileext&quot;</span><span class="p">,</span> <span class="s2">&quot;.flac&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;use_xplatform_safe_names&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:use_xplatform_safe_names}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;save_cover_image&quot;</span><span class="p">,</span> <span class="s2">&quot;${Organize:save_cover_image}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;flac_encode_options&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;--force --keep-foreign-metadata --verify&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;flac_decode_options&quot;</span><span class="p">,</span> <span class="s2">&quot;--force&quot;</span><span class="p">),</span>
                        <span class="p">]:</span>
                    <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;FLAC&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;Vorbis&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_config</span><span class="p">:</span>
                    <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;Vorbis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="p">(</span><span class="s2">&quot;ALBUM&quot;</span><span class="p">,</span> <span class="s2">&quot;album_title&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;ALBUMARTIST&quot;</span><span class="p">,</span> <span class="s2">&quot;album_artist&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;ORGANIZATION&quot;</span><span class="p">,</span> <span class="s2">&quot;album_label&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;LABEL&quot;</span><span class="p">,</span> <span class="s2">&quot;$</span><span class="si">{ORGANIZATION}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;DISCNUMBER&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{album_discnumber:d}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;DISCTOTAL&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{album_disctotal:d}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;TRACKNUMBER&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{track_number:d}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;TRACKTOTAL&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{album_tracktotal:d}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;TITLE&quot;</span><span class="p">,</span> <span class="s2">&quot;track_title&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;ARTIST&quot;</span><span class="p">,</span> <span class="s2">&quot;track_artist&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;GENRE&quot;</span><span class="p">,</span> <span class="s2">&quot;track_genre&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="s2">&quot;track_year&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;COMPILATION&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{album_compilation:d}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">]:</span>
                    <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;Vorbis&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;MP3&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_config</span><span class="p">:</span>
                    <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;MP3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="p">(</span><span class="s2">&quot;library_root&quot;</span><span class="p">,</span> <span class="s2">&quot;${Organize:library_root}/MP3&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;library_subroot_trie_key&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:library_subroot_trie_key}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;library_subroot_compilation_trie_key&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:library_subroot_compilation_trie_key}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;library_subroot_trie_level&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:library_subroot_trie_level}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;trie_ignore_leading_article&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:trie_ignore_leading_article}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;album_folder&quot;</span><span class="p">,</span> <span class="s2">&quot;${Organize:album_folder}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;ndisc_album_folder&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:ndisc_album_folder}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;compilation_album_folder&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:compilation_album_folder}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;ndisc_compilation_album_folder&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:ndisc_compilation_album_folder}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;track_filename&quot;</span><span class="p">,</span> <span class="s2">&quot;${Organize:track_filename}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;ndisc_track_filename&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:ndisc_track_filename}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;compilation_track_filename&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:compilation_track_filename}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;ndisc_compilation_track_filename&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:ndisc_compilation_track_filename}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;track_fileext&quot;</span><span class="p">,</span> <span class="s2">&quot;.mp3&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;use_xplatform_safe_names&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;${Organize:use_xplatform_safe_names}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;save_cover_image&quot;</span><span class="p">,</span> <span class="s2">&quot;${Organize:save_cover_image}&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;lame_encode_options&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;--clipdetect -q 2 -V2 -b 224&quot;</span><span class="p">),</span>
                        <span class="p">]:</span>
                    <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;MP3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;ID3v2&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_config</span><span class="p">:</span>
                    <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;ID3v2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="p">(</span><span class="s2">&quot;TALB&quot;</span><span class="p">,</span> <span class="s2">&quot;album_title&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;TPE2&quot;</span><span class="p">,</span> <span class="s2">&quot;album_artist&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;TPUB&quot;</span><span class="p">,</span> <span class="s2">&quot;album_label&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;TPOS&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{album_discnumber:d}</span><span class="s2">/</span><span class="si">{album_disctotal:d}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;TRCK&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{track_number:d}</span><span class="s2">/</span><span class="si">{album_tracktotal:d}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;TIT2&quot;</span><span class="p">,</span> <span class="s2">&quot;track_title&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;TIT1&quot;</span><span class="p">,</span> <span class="s2">&quot;$</span><span class="si">{TPE1}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;TPE1&quot;</span><span class="p">,</span> <span class="s2">&quot;track_artist&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;TCON&quot;</span><span class="p">,</span> <span class="s2">&quot;track_genre&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;TYER&quot;</span><span class="p">,</span> <span class="s2">&quot;track_year&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;TDRC&quot;</span><span class="p">,</span> <span class="s2">&quot;$</span><span class="si">{TYER}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;TCMP&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{album_compilation:d}</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">]:</span>
                    <span class="n">_config</span><span class="p">[</span><span class="s2">&quot;ID3v2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;flacmanager.ini&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">_config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">_log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="n">_config</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_config</span></div>


<div class="viewcode-block" id="save_config"><a class="viewcode-back" href="../miscellaneous.html#flacmanager.save_config">[docs]</a><span class="k">def</span> <span class="nf">save_config</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Write the configuration settings to an INI-style file.&quot;&quot;&quot;</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">_CONFIG_LOCK</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;flacmanager.ini&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="make_tempfile"><a class="viewcode-back" href="../miscellaneous.html#flacmanager.make_tempfile">[docs]</a><span class="k">def</span> <span class="nf">make_tempfile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.tmp&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;fm&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a temporary file.</span>

<span class="sd">    :keyword str suffix: the default file extenstion</span>
<span class="sd">    :keyword str prefix: prepended to the beginning of the filename</span>
<span class="sd">    :return: the temporary file name</span>
<span class="sd">    :rtype: :obj:`str`</span>

<span class="sd">    The temporary file will be deleted automatically when the program</span>
<span class="sd">    exits.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="o">=</span> <span class="n">mkstemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
    <span class="c1"># close the file descriptor; it isn&#39;t inherited by child processes</span>
    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
    <span class="c1"># clean up the temp file when FLACManager exits</span>
    <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;created temp file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filename</span></div>


<div class="viewcode-block" id="FLACManagerError"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManagerError">[docs]</a><span class="k">class</span> <span class="nc">FLACManagerError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The type of exception raised when FLACManager operations fail.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">context_hint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg str message: error message for logging or display</span>
<span class="sd">        :keyword context_hint: describes the error context</span>
<span class="sd">        :keyword Exception cause: the exception that caused this error</span>

<span class="sd">        The optional *context_hint* is not part of the message, and may</span>
<span class="sd">        take any type or form. Exception handlers that catch</span>
<span class="sd">        ``FLACManagerError`` may choose to do something with the context</span>
<span class="sd">        hint, or may ignore it.</span>

<span class="sd">        The optional *cause* is the (caught) exception that caused this</span>
<span class="sd">        ``FLACManagerError``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_hint</span> <span class="o">=</span> <span class="n">context_hint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cause</span> <span class="o">=</span> <span class="n">cause</span></div>


<span class="c1">#: The standard amount of X-axis padding for the FLACManager UI.</span>
<span class="n">_PADX</span> <span class="o">=</span> <span class="mi">7</span>

<span class="c1">#: The standard amount of Y-axis padding for the FLACManager UI.</span>
<span class="n">_PADY</span> <span class="o">=</span> <span class="mi">5</span>


<span class="nd">@logged</span>
<div class="viewcode-block" id="FLACManager"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager">[docs]</a><span class="k">class</span> <span class="nc">FLACManager</span><span class="p">(</span><span class="n">Tk</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The FLACManager GUI application.&quot;&quot;&quot;</span>

    <span class="c1">#: Any HTTP(S) request issued by FLACManager uses this value for the</span>
    <span class="c1">#: HTTP User-Agent header value.</span>
    <span class="n">USER_AGENT</span> <span class="o">=</span> <span class="s2">&quot;FLACManager/</span><span class="si">{v}</span><span class="s2"> Python/</span><span class="si">{vi[0]:d}</span><span class="s2">.</span><span class="si">{vi[1]:d}</span><span class="s2">.</span><span class="si">{vi[2]:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">v</span><span class="o">=</span><span class="n">__version__</span><span class="p">,</span> <span class="n">vi</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;FLACManager&quot;</span><span class="p">][</span><span class="s2">&quot;title&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minsize</span><span class="p">(</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;UI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;minwidth&quot;</span><span class="p">),</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;UI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;minheight&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">menu</span><span class="o">=</span><span class="n">_FMMenu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;menubar&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_disc_frame</span> <span class="o">=</span> <span class="n">_FMDiscFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;disc_frame&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Disc&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_frame</span> <span class="o">=</span> <span class="n">_FMStatusFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;status_frame&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_editor_frame</span> <span class="o">=</span> <span class="n">_FMEditorFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;editor_frame&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoding_status_frame</span> <span class="o">=</span> <span class="n">_FMEncodingStatusFrame</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;encoding_status_frame&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Encoding status&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">disk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The disk device node for the inserted CD-DA disc.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__disk</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mountpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The file system mount point for the inserted CD-DA disc.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mountpoint</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">toc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The CD-DA disc&#39;s :obj:`TOC` (table-of-contents).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__toc</span>

<div class="viewcode-block" id="FLACManager.reset"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(Re)Initialize the FLACManager GUI.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remove</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__disk</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mountpoint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__toc</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># not repacked until user initiates rip+tag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoding_status_frame</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="c1"># not repacked until metadata for an inserted disc has been aggregated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_editor_frame</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_disc_frame</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disc_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">anchor</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_status_frame</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">anchor</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_required_config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_for_disc</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status_frame</span><span class="o">.</span><span class="n">required_configuration_missing</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoding_status_frame</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_editor_frame</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_frame</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disc_frame</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_persistence</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_required_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Whether or not required configuration settings have been</span>
<span class="sd">        specified.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>

        <span class="c1"># the following options MUST be set by the user before FLACManager can</span>
        <span class="c1"># be used</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Organize&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;library_root&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;client_id&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MusicBrainz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;contact_url_or_email&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MusicBrainz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;libdiscid_location&quot;</span><span class="p">)</span>
        <span class="p">)</span>

<div class="viewcode-block" id="FLACManager.edit_required_config"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.edit_required_config">[docs]</a>    <span class="k">def</span> <span class="nf">edit_required_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open a *flacmanager.ini* editor to allow the user to provide</span>
<span class="sd">        required configuration settings.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">EditRequiredConfigurationDialog</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Edit flacmanager.ini (required settings)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_required_config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_for_disc</span><span class="p">()</span></div>

<div class="viewcode-block" id="FLACManager.check_for_disc"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.check_for_disc">[docs]</a>    <span class="k">def</span> <span class="nf">check_for_disc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Spawn the :class:`DiscCheck` thread.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_disc_frame</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">DiscCheck</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_disc_info</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_update_disc_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the UI if a CD-DA disc is present.</span>

<span class="sd">        If a disc is **not** present, set a UI timer to check again.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># do not trace; called indefinitely until a disc is found</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">disc_info</span> <span class="o">=</span> <span class="n">_DISC_QUEUE</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="n">QUEUE_GET_NOWAIT_AFTER</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_disc_info</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_DISC_QUEUE</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">disc_info</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;dequeued </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">disc_info</span><span class="p">)</span>
                <span class="n">show_exception_dialog</span><span class="p">(</span><span class="n">disc_info</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_disc_frame</span><span class="o">.</span><span class="n">disc_check_failed</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;dequeued </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">disc_info</span><span class="p">)</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__disk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mountpoint</span><span class="p">)</span> <span class="o">=</span> <span class="n">disc_info</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disc_frame</span><span class="o">.</span><span class="n">disc_mounted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mountpoint</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__toc</span> <span class="o">=</span> <span class="n">read_disc_toc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mountpoint</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_metadata</span><span class="p">()</span>

<div class="viewcode-block" id="FLACManager.aggregate_metadata"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.aggregate_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">aggregate_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Spawn the :class:`MetadataAggregator` thread.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_status_frame</span><span class="o">.</span><span class="n">aggregating_metadata</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">anchor</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">MetadataAggregator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;failed to start metadata aggregator&quot;</span><span class="p">)</span>
            <span class="n">show_exception_dialog</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_status_frame</span><span class="o">.</span><span class="n">aggregation_failed</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_aggregated_metadata</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_update_aggregated_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the UI if aggregated metadata is ready.</span>

<span class="sd">        If aggregated metadata is **not** ready, set a UI timer to check</span>
<span class="sd">        again.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># don&#39;t log entry into this method - it calls itself recursively until</span>
        <span class="c1"># the aggregated metadata is ready</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">aggregator</span> <span class="o">=</span> <span class="n">_AGGREGATOR_QUEUE</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">after</span><span class="p">(</span>
                <span class="n">QUEUE_GET_NOWAIT_AFTER</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_aggregated_metadata</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;dequeued </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">aggregator</span><span class="p">)</span>
            <span class="n">_AGGREGATOR_QUEUE</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_persistence</span> <span class="o">=</span> <span class="n">aggregator</span><span class="o">.</span><span class="n">persistence</span>
            <span class="c1"># metadata may be &quot;partial&quot; if an error occurred while collecting</span>
            <span class="c1"># or aggregating, but initialize the editor frame regardless</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_editor_frame</span><span class="o">.</span><span class="n">metadata_ready_for_editing</span><span class="p">(</span><span class="n">aggregator</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">aggregator</span><span class="o">.</span><span class="n">exceptions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_edit_metadata</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">show_exception_dialog</span><span class="p">(</span><span class="n">aggregator</span><span class="o">.</span><span class="n">exceptions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_status_frame</span><span class="o">.</span><span class="n">aggregation_failed</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_edit_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Display the metadata editor.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_status_frame</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_editor_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">anchor</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disc_frame</span><span class="o">.</span><span class="n">rip_and_tag_ready</span><span class="p">()</span>

<div class="viewcode-block" id="FLACManager.rip_and_tag"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.rip_and_tag">[docs]</a>    <span class="k">def</span> <span class="nf">rip_and_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create tagged FLAC and MP3 files of all included tracks.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_disc_frame</span><span class="o">.</span><span class="n">ripping_and_tagging</span><span class="p">()</span>

        <span class="c1"># issues/1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">persist_metadata_snapshot</span><span class="p">(</span><span class="n">showinfo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">per_track_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_editor_frame</span><span class="o">.</span><span class="n">flattened_metadata</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">encoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_encoder</span><span class="p">(</span><span class="n">per_track_metadata</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;failed to initialize the encoder&quot;</span><span class="p">)</span>
            <span class="n">show_exception_dialog</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disc_frame</span><span class="o">.</span><span class="n">rip_and_tag_failed</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_encoding_status_frame</span><span class="o">.</span><span class="n">ready_to_encode</span><span class="p">(</span><span class="n">per_track_metadata</span><span class="p">)</span>

            <span class="c1"># at this point, the encoder is ready and the status frame has been</span>
            <span class="c1"># initialized for display</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_editor_frame</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_encoding_status_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
                <span class="n">anchor</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="n">YES</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">)</span>

            <span class="c1"># rock and roll</span>
            <span class="n">encoder</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;encoding has started; monitoring progress...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_encoding_status_frame</span><span class="o">.</span><span class="n">encoding_in_progress</span><span class="p">()</span></div>

<div class="viewcode-block" id="FLACManager.persist_metadata_snapshot"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.persist_metadata_snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">persist_metadata_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">showinfo</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Serialize the current metadata field values to JSON.</span>

<span class="sd">        :keyword bool showinfo:</span>
<span class="sd">           whether or not to display a messagebox with the persisted</span>
<span class="sd">           metadata file path</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_persistence</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_editor_frame</span><span class="o">.</span><span class="n">metadata_snapshot</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">showinfo</span><span class="p">:</span>
            <span class="n">messagebox</span><span class="o">.</span><span class="n">showinfo</span><span class="p">(</span>
                <span class="s2">&quot;Metadata snapshot saved&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_persistence</span><span class="o">.</span><span class="n">metadata_filename</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_prepare_encoder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">per_track_metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a :class:`FLACEncoder` with instructions to encode</span>
<span class="sd">        each **included** track from *per_track_metadata*.</span>

<span class="sd">        :arg list per_track_metadata: metadata mappings for each track</span>
<span class="sd">        :return:</span>
<span class="sd">           an initialized :class:`FLACEncoder`, ready to execute the</span>
<span class="sd">           encoding instructions in a separate thread</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">per_track_metadata</span><span class="p">)</span>

        <span class="n">disc_filenames</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mountpoint</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;.aiff&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;.aif&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;.aifc&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;.cdda&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;.cda&quot;</span><span class="p">]]</span>

        <span class="c1"># sanity checks</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">disc_filenames</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">track_offsets</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">FLACManagerError</span><span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;Disc TOC contains </span><span class="si">%d</span><span class="s2"> tracks, but </span><span class="si">%d</span><span class="s2"> CD-DA files were found &quot;</span>
                        <span class="s2">&quot;under </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">track_offsets</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">disc_filenames</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mountpoint</span><span class="p">),</span>
                <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;FLAC+MP3 encoding&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">disc_filenames</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">per_track_metadata</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">FLACManagerError</span><span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> CD-DA files to encode, but there are </span><span class="si">%d</span><span class="s2"> metadata &quot;</span>
                    <span class="s2">&quot;mappings&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">disc_filenames</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">per_track_metadata</span><span class="p">)),</span>
                <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;FLAC+MP3 encoding&quot;</span><span class="p">)</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>

        <span class="n">flac_library_root</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;FLAC&quot;</span><span class="p">][</span><span class="s2">&quot;library_root&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flac_library_root</span> <span class="o">=</span> <span class="n">resolve_path</span><span class="p">(</span><span class="n">flac_library_root</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FLACManagerError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot use FLAC library root </span><span class="si">%r</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">flac_library_root</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span>
                <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;FLAC encoding&quot;</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>

        <span class="n">mp3_library_root</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MP3&quot;</span><span class="p">][</span><span class="s2">&quot;library_root&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mp3_library_root</span> <span class="o">=</span> <span class="n">resolve_path</span><span class="p">(</span><span class="n">mp3_library_root</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FLACManagerError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot use MP3 library root </span><span class="si">%r</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mp3_library_root</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span>
                <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;MP3 encoding&quot;</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>

        <span class="n">encoder</span> <span class="o">=</span> <span class="n">FLACEncoder</span><span class="p">()</span>
        <span class="n">flac_cover_image_saved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">mp3_cover_image_saved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">per_track_metadata</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_include&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">cdda_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mountpoint</span><span class="p">,</span> <span class="n">disc_filenames</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="n">flac_dirname</span> <span class="o">=</span> <span class="n">generate_flac_dirname</span><span class="p">(</span>
                <span class="n">flac_library_root</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_editor_frame</span><span class="o">.</span><span class="n">is_save_cover_image</span>
                    <span class="ow">and</span> <span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;save_cover_image&quot;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">flac_cover_image_saved</span><span class="p">)):</span>
                <span class="n">flac_cover_image_saved</span> <span class="o">=</span> <span class="n">_save_cover_image</span><span class="p">(</span>
                    <span class="n">flac_dirname</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">])</span>
            <span class="n">flac_basename</span> <span class="o">=</span> <span class="n">generate_flac_basename</span><span class="p">(</span><span class="n">track_metadata</span><span class="p">)</span>
            <span class="n">flac_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flac_dirname</span><span class="p">,</span> <span class="n">flac_basename</span><span class="p">)</span>

            <span class="n">mp3_dirname</span> <span class="o">=</span> <span class="n">generate_mp3_dirname</span><span class="p">(</span>
                <span class="n">mp3_library_root</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_editor_frame</span><span class="o">.</span><span class="n">is_save_cover_image</span>
                    <span class="ow">and</span> <span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;save_cover_image&quot;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">mp3_cover_image_saved</span><span class="p">)):</span>
                <span class="n">mp3_cover_image_saved</span> <span class="o">=</span> <span class="n">_save_cover_image</span><span class="p">(</span>
                    <span class="n">mp3_dirname</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">])</span>
            <span class="n">mp3_basename</span> <span class="o">=</span> <span class="n">generate_mp3_basename</span><span class="p">(</span><span class="n">track_metadata</span><span class="p">)</span>
            <span class="n">mp3_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mp3_dirname</span><span class="p">,</span> <span class="n">mp3_basename</span><span class="p">)</span>

            <span class="n">encoder</span><span class="o">.</span><span class="n">add_instruction</span><span class="p">(</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">cdda_filename</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">,</span> <span class="n">mp3_filename</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;prepared encoding instruction:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">-&gt; </span><span class="si">%s</span><span class="se">\n</span><span class="s2">-&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">cdda_filename</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">,</span> <span class="n">mp3_filename</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="n">encoder</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">encoder</span>

<div class="viewcode-block" id="FLACManager.eject_disc"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.eject_disc">[docs]</a>    <span class="k">def</span> <span class="nf">eject_disc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Eject the current CD-DA disc and update the UI.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;diskutil&quot;</span><span class="p">,</span> <span class="s2">&quot;eject&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disk</span><span class="p">],</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;ejected </span><span class="si">%s</span><span class="s2"> mounted at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mountpoint</span><span class="p">)</span>
            <span class="c1"># resetting will automatically spawn a new DiscCheck thread</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;unable to eject </span><span class="si">%s</span><span class="s2"> mounted at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mountpoint</span><span class="p">)</span>
            <span class="n">messagebox</span><span class="o">.</span><span class="n">showerror</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Disk eject failure&quot;</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Unable to eject </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mountpoint</span><span class="p">)</span></div>

<div class="viewcode-block" id="FLACManager.edit_aggregation_config"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.edit_aggregation_config">[docs]</a>    <span class="k">def</span> <span class="nf">edit_aggregation_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the configuration editor dialog.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="n">EditAggregationConfigurationDialog</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Edit flacmanager.ini (metadata aggregation)&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="FLACManager.edit_organization_config"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.edit_organization_config">[docs]</a>    <span class="k">def</span> <span class="nf">edit_organization_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the configuration editor dialog.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="n">EditOrganizationConfigurationDialog</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Edit flacmanager.ini (default folder and file names)&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="FLACManager.edit_flac_encoding_config"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.edit_flac_encoding_config">[docs]</a>    <span class="k">def</span> <span class="nf">edit_flac_encoding_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the configuration editor dialog.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="n">EditFLACEncodingConfigurationDialog</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Edit flacmanager.ini (FLAC encoding)&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="FLACManager.edit_vorbis_comments_config"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.edit_vorbis_comments_config">[docs]</a>    <span class="k">def</span> <span class="nf">edit_vorbis_comments_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the configuration editor dialog.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="n">EditVorbisCommentsConfigurationDialog</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Edit flacmanager.ini (default FLAC Vorbis comments)&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="FLACManager.edit_flac_organization_config"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.edit_flac_organization_config">[docs]</a>    <span class="k">def</span> <span class="nf">edit_flac_organization_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the configuration editor dialog.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="n">EditFLACOrganizationConfigurationDialog</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Edit flacmanager.ini (FLAC folder and file names)&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="FLACManager.edit_mp3_encoding_config"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.edit_mp3_encoding_config">[docs]</a>    <span class="k">def</span> <span class="nf">edit_mp3_encoding_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the configuration editor dialog.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="n">EditMP3EncodingConfigurationDialog</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Edit flacmanager.ini (MP3 encoding)&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="FLACManager.edit_id3v2_tags_config"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.edit_id3v2_tags_config">[docs]</a>    <span class="k">def</span> <span class="nf">edit_id3v2_tags_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the configuration editor dialog.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="n">EditID3v2TagsConfigurationDialog</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Edit flacmanager.ini (default MP3 ID3v2 tags)&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="FLACManager.edit_mp3_organization_config"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.edit_mp3_organization_config">[docs]</a>    <span class="k">def</span> <span class="nf">edit_mp3_organization_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the configuration editor dialog.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="n">EditMP3OrganizationConfigurationDialog</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Edit flacmanager.ini (MP3 folder and file names)&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="FLACManager.edit_ui_config"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.edit_ui_config">[docs]</a>    <span class="k">def</span> <span class="nf">edit_ui_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the configuration editor dialog.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="n">EditUserInterfaceConfigurationDialog</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Edit flacmanager.ini (UI)&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="FLACManager.edit_logging_config"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.edit_logging_config">[docs]</a>    <span class="k">def</span> <span class="nf">edit_logging_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the configuration editor dialog.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="n">EditLoggingConfigurationDialog</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Edit flacmanager.ini (logging/debug)&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="FLACManager.show_about"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.show_about">[docs]</a>    <span class="k">def</span> <span class="nf">show_about</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the application description dialog.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="n">_TextDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="vm">__doc__</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;About </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">())</span></div>

<div class="viewcode-block" id="FLACManager.show_prerequisites"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.show_prerequisites">[docs]</a>    <span class="k">def</span> <span class="nf">show_prerequisites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the prerequisites information dialog.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="n">_TextDialog</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">_PREREQUISITES_TEXT</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> prerequisites&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">())</span></div>

<div class="viewcode-block" id="FLACManager.show_license"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.show_license">[docs]</a>    <span class="k">def</span> <span class="nf">show_license</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the copyright/license dialog.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="n">_TextDialog</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">__license__</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> copyright and license&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">())</span></div>

<div class="viewcode-block" id="FLACManager.exit"><a class="viewcode-back" href="../user-interface.html#flacmanager.FLACManager.exit">[docs]</a>    <span class="k">def</span> <span class="nf">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Quit the FLACManager application.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">withdraw</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span></div></div>


<span class="nd">@logged</span>
<span class="k">class</span> <span class="nc">_FMMenu</span><span class="p">(</span><span class="n">Menu</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The FLACManager application menu bar.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg tuple args: positional arguments to initialize the menu</span>
<span class="sd">        :arg dict options: ``config`` options to initialize the menu</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

        <span class="n">fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span>

        <span class="n">file_menu</span> <span class="o">=</span> <span class="n">Menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;file_menu&quot;</span><span class="p">,</span> <span class="n">tearoff</span><span class="o">=</span><span class="n">NO</span><span class="p">)</span>
        <span class="c1"># only enabled while the editor frame is packed</span>
        <span class="n">file_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Save metadata&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">persist_metadata_snapshot</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">DISABLED</span><span class="p">)</span>
        <span class="n">file_menu</span><span class="o">.</span><span class="n">add_separator</span><span class="p">()</span>
        <span class="n">file_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Exit&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">exit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_cascade</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;File&quot;</span><span class="p">,</span> <span class="n">menu</span><span class="o">=</span><span class="n">file_menu</span><span class="p">)</span>

        <span class="n">edit_menu</span> <span class="o">=</span> <span class="n">Menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;edit_menu&quot;</span><span class="p">,</span> <span class="n">tearoff</span><span class="o">=</span><span class="n">YES</span><span class="p">)</span>
        <span class="n">edit_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Configure metadata aggregation&quot;</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">edit_aggregation_config</span><span class="p">)</span>
        <span class="n">edit_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Configure default folder and file names&quot;</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">edit_organization_config</span><span class="p">)</span>

        <span class="n">edit_menu</span><span class="o">.</span><span class="n">add_separator</span><span class="p">()</span>

        <span class="n">flac_menu</span> <span class="o">=</span> <span class="n">Menu</span><span class="p">(</span><span class="n">edit_menu</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;flac_menu&quot;</span><span class="p">,</span> <span class="n">tearoff</span><span class="o">=</span><span class="n">NO</span><span class="p">)</span>
        <span class="n">flac_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;FLAC encoding options&quot;</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">edit_flac_encoding_config</span><span class="p">)</span>
        <span class="n">flac_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;FLAC Vorbis comments&quot;</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">edit_vorbis_comments_config</span><span class="p">)</span>
        <span class="n">flac_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;FLAC folder and file names&quot;</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">edit_flac_organization_config</span><span class="p">)</span>
        <span class="n">edit_menu</span><span class="o">.</span><span class="n">add_cascade</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Configure FLAC&quot;</span><span class="p">,</span> <span class="n">menu</span><span class="o">=</span><span class="n">flac_menu</span><span class="p">)</span>

        <span class="n">mp3_menu</span> <span class="o">=</span> <span class="n">Menu</span><span class="p">(</span><span class="n">edit_menu</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mp3_menu&quot;</span><span class="p">,</span> <span class="n">tearoff</span><span class="o">=</span><span class="n">NO</span><span class="p">)</span>
        <span class="n">mp3_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MP3 encoding options&quot;</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">edit_mp3_encoding_config</span><span class="p">)</span>
        <span class="n">mp3_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MP3 ID3v2 tags&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">edit_id3v2_tags_config</span><span class="p">)</span>
        <span class="n">mp3_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MP3 folder and file names&quot;</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">edit_mp3_organization_config</span><span class="p">)</span>
        <span class="n">edit_menu</span><span class="o">.</span><span class="n">add_cascade</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Configure MP3&quot;</span><span class="p">,</span> <span class="n">menu</span><span class="o">=</span><span class="n">mp3_menu</span><span class="p">)</span>

        <span class="n">edit_menu</span><span class="o">.</span><span class="n">add_separator</span><span class="p">()</span>

        <span class="n">edit_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Configure UI&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">edit_ui_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_cascade</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Edit&quot;</span><span class="p">,</span> <span class="n">menu</span><span class="o">=</span><span class="n">edit_menu</span><span class="p">)</span>

        <span class="n">edit_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Configure logging&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">edit_logging_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_cascade</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Edit&quot;</span><span class="p">,</span> <span class="n">menu</span><span class="o">=</span><span class="n">edit_menu</span><span class="p">)</span>

        <span class="n">help_menu</span> <span class="o">=</span> <span class="n">Menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;help_menu&quot;</span><span class="p">,</span> <span class="n">tearoff</span><span class="o">=</span><span class="n">NO</span><span class="p">)</span>
        <span class="n">help_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;About&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">show_about</span><span class="p">)</span>
        <span class="n">help_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Prequisites&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">show_prerequisites</span><span class="p">)</span>
        <span class="n">help_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;License&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">show_license</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_cascade</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Help&quot;</span><span class="p">,</span> <span class="n">menu</span><span class="o">=</span><span class="n">help_menu</span><span class="p">)</span>


<span class="nd">@logged</span>
<span class="k">class</span> <span class="nc">_FMDiscFrame</span><span class="p">(</span><span class="n">LabelFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The disc status/operation frame for FLACManager.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg tuple args: positional arguments to initialize the frame</span>
<span class="sd">        :arg dict options: ``config`` options to initialize the frame</span>

<span class="sd">        All widgets for this frame are initialized, but layout is</span>
<span class="sd">        deferred until methods are called to transition between states.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

        <span class="n">fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_disc_eject_button</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;disc_eject_button&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Eject&quot;</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">eject_disc</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_disc_status_label</span> <span class="o">=</span> <span class="n">Label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;disc_status_label&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_retry_disc_check_button</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;retry_disc_check_button&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Retry disc check&quot;</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">check_for_disc</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rip_and_tag_button</span> <span class="o">=</span> <span class="n">_styled</span><span class="p">(</span>
            <span class="n">Button</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;rip_and_tag_button&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Rip and Tag&quot;</span><span class="p">,</span>
                <span class="n">command</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">rip_and_tag</span><span class="p">),</span>
            <span class="n">foreground</span><span class="o">=</span><span class="s2">&quot;Dark Green&quot;</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="s2">&quot;-weight bold&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grid_columnconfigure</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_status_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s2">&quot;Black&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the disc status label text and color.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="n">fg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disc_status_label</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
        <span class="n">_styled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_disc_status_label</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="n">fg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">disc_mounted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mountpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show the disk mointpoint and a button to eject the disc.</span>

<span class="sd">        :arg str mountpoint: where the CD-DA disc is mounted</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mountpoint</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_remove</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_disc_eject_button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">NORMAL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disc_eject_button</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_status_message</span><span class="p">(</span><span class="n">mountpoint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disc_status_label</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">disc_check_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alert the user that the disc check failed and provide a</span>
<span class="sd">        button to retry.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_retry_disc_check_button</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">E</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rip_and_tag_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provide a button to begin ripping and tagging the tracks.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rip_and_tag_button</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">E</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rip_and_tag_button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">NORMAL</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ripping_and_tagging</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change the state of the disc controls while tracks are being</span>
<span class="sd">        ripped and tagged.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_disc_eject_button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">DISABLED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rip_and_tag_button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">DISABLED</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rip_and_tag_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restore the state of the disc controls after an encoding</span>
<span class="sd">        failure.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_disc_eject_button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">NORMAL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rip_and_tag_button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">NORMAL</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rip_and_tag_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change the state of the disc controls to reflect that a disc</span>
<span class="sd">        has been ripped and tagged.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_disc_eject_button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">NORMAL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rip_and_tag_button</span><span class="o">.</span><span class="n">grid_remove</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate the disc status/operation frame widgets in their</span>
<span class="sd">        default/initial states.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_remove</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_disc_eject_button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">DISABLED</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_status_message</span><span class="p">(</span><span class="s2">&quot;Waiting for a disc to be inserted</span><span class="se">\u2026</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disc_status_label</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all widgets from the current layout.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_disc_eject_button</span><span class="o">.</span><span class="n">grid_remove</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disc_status_label</span><span class="o">.</span><span class="n">grid_remove</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_retry_disc_check_button</span><span class="o">.</span><span class="n">grid_remove</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rip_and_tag_button</span><span class="o">.</span><span class="n">grid_remove</span><span class="p">()</span>


<span class="nd">@logged</span>
<span class="k">class</span> <span class="nc">_FMStatusFrame</span><span class="p">(</span><span class="n">Frame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The application status frame for FLACManager.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg tuple args: positional arguments to initialize the frame</span>
<span class="sd">        :arg dict options: ``config`` options to initialize the frame</span>

<span class="sd">        All widgets for this frame are initialized, but layout is</span>
<span class="sd">        deferred until methods are called to transition between states.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

        <span class="n">fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_status_label</span> <span class="o">=</span> <span class="n">_styled</span><span class="p">(</span>
            <span class="n">Label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;status_label&quot;</span><span class="p">),</span> <span class="n">font</span><span class="o">=</span><span class="s2">&quot;-weight bold&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_retry_aggregation_button</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;retry_aggregation_button&quot;</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Retry metadata aggregation&quot;</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">aggregate_metadata</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_edit_asis_button</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;edit_asis_button&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Edit metadata as-is&quot;</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">_edit_metadata</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_open_req_config_editor_button</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;open_req_config_editor_button&quot;</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Edit flacmanager.ini&quot;</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">edit_required_config</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_rowconfigure</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_columnconfigure</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_status_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s2">&quot;Black&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the status label text and color.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="n">fg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_label</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
        <span class="n">_styled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_status_label</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="n">fg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_show_metadata_status_buttons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Display the buttons that allow the user to choose an action</span>
<span class="sd">        after metadata aggregation has failed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_retry_aggregation_button</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">NE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_edit_asis_button</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">NW</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_hide_metadata_status_buttons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the buttons for handling metadata aggregation</span>
<span class="sd">        failures.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_retry_aggregation_button</span><span class="o">.</span><span class="n">grid_remove</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_edit_asis_button</span><span class="o">.</span><span class="n">grid_remove</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">required_configuration_missing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Let the user know that required configuration settings are</span>
<span class="sd">        not present, and provide a button to open an editor.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_remove</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_status_message</span><span class="p">(</span>
            <span class="s2">&quot;Required configuration is missing!&quot;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s2">&quot;Red&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_label</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">columnspan</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_open_req_config_editor_button</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">columnspan</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">aggregating_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change this frame to reflect that metadata is being</span>
<span class="sd">        aggregated.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_remove</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_status_message</span><span class="p">(</span><span class="s2">&quot;Aggregating metadata</span><span class="se">\u2026</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s2">&quot;Grey&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_label</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">columnspan</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">aggregation_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Message the user that metadata aggregation has failed and</span>
<span class="sd">        provide options for a next action.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_status_message</span><span class="p">(</span>
            <span class="s2">&quot;Aggregation failed. Metadata may be missing or incomplete.&quot;</span><span class="p">,</span>
            <span class="n">fg</span><span class="o">=</span><span class="s2">&quot;Red&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_metadata_status_buttons</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate the status frame widgets in their default/initial</span>
<span class="sd">        states.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_remove</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_status_message</span><span class="p">(</span><span class="s2">&quot;Please insert a disc.&quot;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s2">&quot;Grey&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_label</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">columnspan</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all widgets from the current layout.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_status_label</span><span class="o">.</span><span class="n">grid_remove</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hide_metadata_status_buttons</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_open_req_config_editor_button</span><span class="o">.</span><span class="n">grid_remove</span><span class="p">()</span>


<span class="nd">@logged</span>
<span class="k">class</span> <span class="nc">_FMEditorFrame</span><span class="p">(</span><span class="n">Frame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The metadata editing frame for FLACManager.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg tuple args: positional arguments to initialize the frame</span>
<span class="sd">        :arg dict options: ``config`` options to initialize the frame</span>

<span class="sd">        All widgets for this frame are initialized, but layout is</span>
<span class="sd">        deferred until methods are called to transition between states.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

        <span class="c1"># all editor widgets and vars are referenced through this mapping;</span>
        <span class="c1"># these are never destroyed, only updated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__init_album_editors</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init_track_editors</span><span class="p">()</span>

        <span class="c1"># issues/5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init_naming_editors</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__album_disctotal_observer_name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># issues/5</span>
    <span class="k">def</span> <span class="nf">__init_naming_editors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the entry widgets for album and track naming fields.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">naming_editor_frame</span> <span class="o">=</span> <span class="n">LabelFrame</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;naming_editor_frame&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Folder &amp; File Naming&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__row</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># relative to naming_editor_frame</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_create_naming_editor</span><span class="p">(</span><span class="n">naming_editor_frame</span><span class="p">,</span> <span class="s2">&quot;FLAC&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_naming_editor</span><span class="p">(</span><span class="n">naming_editor_frame</span><span class="p">,</span> <span class="s2">&quot;MP3&quot;</span><span class="p">)</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
        <span class="n">mp3_naming_same_as_flac_var</span> <span class="o">=</span> <span class="n">BooleanVar</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mp3_naming_same_as_flac_var&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="nb">all</span><span class="p">((</span>
                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;FLAC&quot;</span><span class="p">][</span><span class="n">option</span><span class="p">]</span> <span class="o">==</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MP3&quot;</span><span class="p">][</span><span class="n">option</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;album_folder&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ndisc_album_folder&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;compilation_album_folder&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ndisc_compilation_album_folder&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;library_subroot_trie_key&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;library_subroot_compilation_trie_key&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;track_filename&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ndisc_track_filename&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;compilation_track_filename&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ndisc_compilation_track_filename&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)))</span>
        <span class="n">mp3_naming_same_as_flac_checkbutton</span> <span class="o">=</span> <span class="n">Checkbutton</span><span class="p">(</span>
            <span class="n">naming_editor_frame</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mp3_naming_same_as_flac_checkbutton&quot;</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Use the same templates for both FLAC and MP3&quot;</span><span class="p">,</span>
            <span class="n">variable</span><span class="o">=</span><span class="n">mp3_naming_same_as_flac_var</span><span class="p">,</span> <span class="n">onvalue</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">offvalue</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__update_mp3_naming_editor_state</span>
        <span class="p">)</span>
        <span class="n">mp3_naming_same_as_flac_checkbutton</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">columnspan</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span>
            <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mp3_naming_same_as_flac_var</span> <span class="o">=</span> <span class="n">mp3_naming_same_as_flac_var</span>

        <span class="c1"># collapse the labels and allow the entry fields to expand</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">naming_editor_frame</span><span class="o">.</span><span class="n">grid_columnconfigure</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">naming_editor_frame</span><span class="o">.</span><span class="n">grid_columnconfigure</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># trie key</span>
        <span class="n">naming_editor_frame</span><span class="o">.</span><span class="n">grid_columnconfigure</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># album folder</span>
        <span class="n">naming_editor_frame</span><span class="o">.</span><span class="n">grid_columnconfigure</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># track filename</span>

        <span class="k">if</span> <span class="n">mp3_naming_same_as_flac_var</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">editor_name</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;__mp3_subroot_trie&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;__mp3_album_folder&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;__mp3_track_filename&quot;</span><span class="p">,</span>
                    <span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="n">editor_name</span><span class="p">]</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">DISABLED</span><span class="p">)</span>

        <span class="n">naming_editor_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">anchor</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">BOTH</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_naming_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">encoding_section</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create entry widgets for the album folder and track filename</span>
<span class="sd">        templates.</span>

<span class="sd">        :arg parent: parent object of the widgets</span>
<span class="sd">        :arg str encoding_section: either &quot;FLAC&quot; or &quot;MP3&quot;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">trie_field</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_subroot_trie&quot;</span> <span class="o">%</span> <span class="n">encoding_section</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">folder_field</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_album_folder&quot;</span> <span class="o">%</span> <span class="n">encoding_section</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">track_field</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_track_filename&quot;</span> <span class="o">%</span> <span class="n">encoding_section</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">config_section</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()[</span><span class="n">encoding_section</span><span class="p">]</span>

        <span class="n">_styled</span><span class="p">(</span>
            <span class="n">Label</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">encoding_section</span><span class="p">),</span> <span class="n">font</span><span class="o">=</span><span class="s2">&quot;-weight bold&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">E</span><span class="p">)</span>

        <span class="n">Label</span><span class="p">(</span>
            <span class="n">parent</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">config_section</span><span class="p">[</span><span class="s2">&quot;library_root&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">E</span><span class="p">)</span>

        <span class="n">subroot_trie_var</span> <span class="o">=</span> <span class="n">StringVar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">trie_field</span> <span class="o">+</span> <span class="s2">&quot;_var&quot;</span><span class="p">)</span>
        <span class="n">subroot_trie</span> <span class="o">=</span> <span class="n">Entry</span><span class="p">(</span>
            <span class="n">parent</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">trie_field</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="n">subroot_trie_var</span><span class="p">)</span>
        <span class="n">subroot_trie</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">subroot_trie_var</span>
        <span class="n">subroot_trie</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span> <span class="o">+</span> <span class="n">E</span><span class="p">)</span>

        <span class="n">Label</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>

        <span class="n">album_folder_var</span> <span class="o">=</span> <span class="n">StringVar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">folder_field</span> <span class="o">+</span> <span class="s2">&quot;_var&quot;</span><span class="p">)</span>
        <span class="n">album_folder</span> <span class="o">=</span> <span class="n">Entry</span><span class="p">(</span>
            <span class="n">parent</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">folder_field</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="n">album_folder_var</span><span class="p">)</span>
        <span class="n">album_folder</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">album_folder_var</span>
        <span class="n">album_folder</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span> <span class="o">+</span> <span class="n">E</span><span class="p">)</span>

        <span class="n">Label</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>

        <span class="n">track_filename_var</span> <span class="o">=</span> <span class="n">StringVar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">track_field</span> <span class="o">+</span> <span class="s2">&quot;_var&quot;</span><span class="p">)</span>
        <span class="n">track_filename</span> <span class="o">=</span> <span class="n">Entry</span><span class="p">(</span>
            <span class="n">parent</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">track_field</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="n">track_filename_var</span><span class="p">)</span>
        <span class="n">track_filename</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">track_filename_var</span>
        <span class="n">track_filename</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span> <span class="o">+</span> <span class="n">E</span><span class="p">)</span>

        <span class="n">Label</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">config_section</span><span class="p">[</span><span class="s2">&quot;track_fileext&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;__</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">trie_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">subroot_trie</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;__</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">folder_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">album_folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;__</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">track_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">track_filename</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__row</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># issues/5</span>
    <span class="k">def</span> <span class="nf">_apply_naming_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the folder and file name templates based on the</span>
<span class="sd">        current values for ``album_disctotal`` and</span>
<span class="sd">        ``album_compilation``.</span>

<span class="sd">        :arg tuple args:</span>
<span class="sd">           positional arguments (empty except when this method is</span>
<span class="sd">           invoked as the variable trace callback for</span>
<span class="sd">           ``album_disctotal_var``)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metadata_editors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span>

        <span class="c1"># yuck... but when changing the value, we get TWO traces:</span>
        <span class="c1"># 1. the variable value changes from the old value to empty (&quot;&quot;),</span>
        <span class="c1">#    causing `metadata_editors[&quot;album_disctotal&quot;].var.get()` to result</span>
        <span class="c1">#    in TclError since album_disctotal_var is an IntVar</span>
        <span class="c1"># 2. the variable value changes from empty (&quot;&quot;) to the new value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_disctotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">TclError</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">ndisc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;ndisc_&quot;</span> <span class="k">if</span> <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_disctotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">compilation</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;compilation_&quot;</span> <span class="k">if</span> <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_compilation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">default_key_prefix</span> <span class="o">=</span> <span class="n">ndisc</span> <span class="o">+</span> <span class="n">compilation</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">encoding</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;MP3&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">field_suffix</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;subroot_trie&quot;</span><span class="p">,</span> <span class="s2">&quot;album_folder&quot;</span><span class="p">,</span> <span class="s2">&quot;track_filename&quot;</span><span class="p">]:</span>
                <span class="n">default_key</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;library_subroot_</span><span class="si">%s</span><span class="s2">trie_key&quot;</span> <span class="o">%</span> <span class="n">compilation</span>
                    <span class="k">if</span> <span class="n">field_suffix</span> <span class="o">==</span> <span class="s2">&quot;subroot_trie&quot;</span>
                    <span class="k">else</span> <span class="n">default_key_prefix</span> <span class="o">+</span> <span class="n">field_suffix</span><span class="p">)</span>
                <span class="n">custom_key</span> <span class="o">=</span> <span class="s2">&quot;__</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">encoding</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">field_suffix</span><span class="p">)</span>
                <span class="n">metadata_editors</span><span class="p">[</span><span class="n">custom_key</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                    <span class="n">config</span><span class="p">[</span><span class="n">encoding</span><span class="p">][</span><span class="n">default_key</span><span class="p">])</span>

    <span class="c1"># issues/5</span>
    <span class="k">def</span> <span class="nf">__update_mp3_naming_editor_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enable or disable the MP3 naming entry widgets.&quot;&quot;&quot;</span>
        <span class="n">state</span> <span class="o">=</span> \
            <span class="n">DISABLED</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mp3_naming_same_as_flac_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">else</span> <span class="n">NORMAL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;__mp3_subroot_trie&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;__mp3_album_folder&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;__mp3_track_filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init_album_editors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the entry/selection widgets for album metadata fields.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">album_editor_frame</span> <span class="o">=</span> <span class="n">LabelFrame</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;album_editor_frame&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Album&quot;</span><span class="p">)</span>

        <span class="n">create_album_choices_editor</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_choices_editor</span><span class="p">,</span> <span class="n">album_editor_frame</span><span class="p">,</span> <span class="s2">&quot;album&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__row</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># relative to album_editor_frame</span>

        <span class="n">create_album_choices_editor</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">tracks_apply</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_album_disc_editor</span><span class="p">(</span><span class="n">album_editor_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_album_compilation_editor</span><span class="p">(</span><span class="n">album_editor_frame</span><span class="p">)</span>
        <span class="n">create_album_choices_editor</span><span class="p">(</span><span class="s2">&quot;artist&quot;</span><span class="p">)</span>
        <span class="n">create_album_choices_editor</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">tracks_apply</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">create_album_choices_editor</span><span class="p">(</span><span class="s2">&quot;genre&quot;</span><span class="p">)</span>
        <span class="n">create_album_choices_editor</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_album_cover_editor</span><span class="p">(</span><span class="n">album_editor_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_album_custom_metadata_editor</span><span class="p">(</span><span class="n">album_editor_frame</span><span class="p">)</span>

        <span class="n">album_editor_frame</span><span class="o">.</span><span class="n">grid_columnconfigure</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">album_editor_frame</span><span class="o">.</span><span class="n">grid_columnconfigure</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">album_editor_frame</span><span class="o">.</span><span class="n">grid_columnconfigure</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">album_editor_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">anchor</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">BOTH</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init_track_editors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the entry/selection widgets for track metadata fields.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">track_editor_frame</span> <span class="o">=</span> <span class="n">LabelFrame</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;track_editor_frame&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Tracks&quot;</span><span class="p">)</span>

        <span class="n">create_track_choices_editor</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_choices_editor</span><span class="p">,</span> <span class="n">track_editor_frame</span><span class="p">,</span> <span class="s2">&quot;track&quot;</span><span class="p">,</span>
            <span class="n">tracks_apply</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__row</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># relative to track_editor_frame</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_create_track_control_editors</span><span class="p">(</span><span class="n">track_editor_frame</span><span class="p">)</span>
        <span class="n">create_track_choices_editor</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span>
        <span class="n">create_track_choices_editor</span><span class="p">(</span><span class="s2">&quot;artist&quot;</span><span class="p">)</span>
        <span class="n">create_track_choices_editor</span><span class="p">(</span><span class="s2">&quot;genre&quot;</span><span class="p">)</span>
        <span class="n">create_track_choices_editor</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_track_custom_metadata_editor</span><span class="p">(</span><span class="n">track_editor_frame</span><span class="p">)</span>

        <span class="n">track_editor_frame</span><span class="o">.</span><span class="n">grid_columnconfigure</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">track_editor_frame</span><span class="o">.</span><span class="n">grid_columnconfigure</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">track_editor_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">anchor</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">BOTH</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_choices_editor</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">editor_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">tracks_apply</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">VarType</span><span class="o">=</span><span class="n">StringVar</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an entry/selection widget for a metadata field that</span>
<span class="sd">        may have multiple aggregated values.</span>

<span class="sd">        :arg parent: parent object of the editor</span>
<span class="sd">        :arg str editor_name: either &quot;album&quot; or &quot;track&quot;</span>
<span class="sd">        :arg str field_name: the metadata field name</span>
<span class="sd">        :keyword bool tracks_apply:</span>
<span class="sd">           whether or not to create an &quot;Apply to all tracks&quot; button that</span>
<span class="sd">           corresponds to *field_name*</span>
<span class="sd">        :keyword VarType:</span>
<span class="sd">           the :mod:`tkinter` variable type that will hold the value of</span>
<span class="sd">           the metadata field</span>
<span class="sd">        :return: the metadata field entry/selection widget</span>
<span class="sd">        :rtype: :class:`tkinter.ttk.Combobox`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">parent</span><span class="p">,</span> <span class="n">editor_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">tracks_apply</span><span class="o">=</span><span class="n">tracks_apply</span><span class="p">,</span>
            <span class="n">VarType</span><span class="o">=</span><span class="n">VarType</span><span class="p">)</span>

        <span class="n">Label</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">field_name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">E</span><span class="p">)</span>

        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">editor_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>

        <span class="c1"># NOTE: for track editors, the variable will be re-*configured* on a</span>
        <span class="c1"># per-track basis as the tracks spinbox is manipulated; however, the</span>
        <span class="c1"># var *property* of a track editor is never re-assigned</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">VarType</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_var&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">combobox</span> <span class="o">=</span> <span class="n">Combobox</span><span class="p">(</span>
            <span class="n">parent</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_combobox&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="n">var</span>
        <span class="p">)</span>
        <span class="c1"># attach the variable to the Combobox for easy access</span>
        <span class="n">combobox</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">var</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="o">!=</span> <span class="s2">&quot;year&quot;</span><span class="p">:</span>
            <span class="n">sticky</span> <span class="o">=</span> <span class="n">W</span> <span class="o">+</span> <span class="n">E</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">combobox</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
            <span class="n">sticky</span> <span class="o">=</span> <span class="n">W</span>
        <span class="n">combobox</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">sticky</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">combobox</span>

        <span class="k">if</span> <span class="n">tracks_apply</span><span class="p">:</span>
            <span class="n">Button</span><span class="p">(</span>
                <span class="n">parent</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_apply_button&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Apply </span><span class="si">%s</span><span class="s2"> to all tracks&quot;</span> <span class="o">%</span> <span class="n">field_name</span><span class="p">,</span>
                <span class="n">command</span><span class="o">=</span><span class="k">lambda</span>
                        <span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata_name</span><span class="o">=</span><span class="s2">&quot;track_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">field_name</span><span class="p">,</span>
                        <span class="n">var</span><span class="o">=</span><span class="n">var</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__apply_to_all_tracks</span><span class="p">(</span><span class="n">metadata_name</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
            <span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
                <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="o">+</span><span class="n">E</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__row</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">combobox</span>

    <span class="k">def</span> <span class="nf">__apply_to_all_tracks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set **all** track variables for *field_name* to *value*.</span>

<span class="sd">        :arg str field_name: the metadata field name</span>
<span class="sd">        :arg value:</span>
<span class="sd">           the variable value to set (type varies by metadata field)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">track_vars</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__track_vars</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">track_vars</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_album_disc_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create entry widgets for the album disc number/total fields.</span>

<span class="sd">        :arg parent: parent object of the entry widgets</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

        <span class="n">Label</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Disc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">E</span><span class="p">)</span>

        <span class="n">frame</span> <span class="o">=</span> <span class="n">Frame</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

        <span class="n">number_var</span> <span class="o">=</span> <span class="n">IntVar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;album_discnumber_var&quot;</span><span class="p">)</span>
        <span class="n">album_discnumber</span> <span class="o">=</span> <span class="n">Entry</span><span class="p">(</span>
            <span class="n">frame</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;album_discnumber_entry&quot;</span><span class="p">,</span> <span class="n">exportselection</span><span class="o">=</span><span class="n">NO</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">textvariable</span><span class="o">=</span><span class="n">number_var</span><span class="p">)</span>
        <span class="n">album_discnumber</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">number_var</span>
        <span class="n">album_discnumber</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_discnumber&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">album_discnumber</span>

        <span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;of&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">)</span>

        <span class="n">total_var</span> <span class="o">=</span> <span class="n">IntVar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;album_disctotal_var&quot;</span><span class="p">)</span>
        <span class="n">album_disctotal</span> <span class="o">=</span> <span class="n">Entry</span><span class="p">(</span>
            <span class="n">frame</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;album_disctotal_entry&quot;</span><span class="p">,</span> <span class="n">exportselection</span><span class="o">=</span><span class="n">NO</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">textvariable</span><span class="o">=</span><span class="n">total_var</span><span class="p">)</span>
        <span class="n">album_disctotal</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">total_var</span>
        <span class="n">album_disctotal</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_disctotal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">album_disctotal</span>

        <span class="n">frame</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">columnspan</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span>
            <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__row</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_create_album_compilation_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the toggle widget for the album compilation field.</span>

<span class="sd">        :arg parent: parent object of the toggle widget</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

        <span class="n">Label</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Compilation&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">E</span><span class="p">)</span>

        <span class="n">var</span> <span class="o">=</span> <span class="n">BooleanVar</span><span class="p">()</span>
        <span class="n">album_compilation</span> <span class="o">=</span> <span class="n">Checkbutton</span><span class="p">(</span>
            <span class="n">parent</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;album_compilation_checkbutton&quot;</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
            <span class="n">onvalue</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">offvalue</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_apply_naming_defaults</span><span class="p">)</span> <span class="c1"># issues/5</span>
        <span class="n">album_compilation</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">var</span>
        <span class="n">album_compilation</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">columnspan</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span>
            <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_compilation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">album_compilation</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__row</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_create_album_cover_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create selection widget and import buttons for the album</span>
<span class="sd">        cover field.</span>

<span class="sd">        :arg parent:</span>
<span class="sd">           parent object of the frame that will contain the selection</span>
<span class="sd">           widget and buttons</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

        <span class="n">Label</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Cover&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">E</span><span class="p">)</span>

        <span class="n">frame</span> <span class="o">=</span> <span class="n">Frame</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

        <span class="n">var</span> <span class="o">=</span> <span class="n">StringVar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;album_cover_var&quot;</span><span class="p">)</span>
        <span class="n">album_cover</span> <span class="o">=</span> <span class="n">OptionMenu</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
        <span class="n">album_cover</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">var</span>
        <span class="n">album_cover</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">DISABLED</span><span class="p">)</span>
        <span class="n">album_cover</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">album_cover</span>

        <span class="n">Button</span><span class="p">(</span>
            <span class="n">frame</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;album_cover_add_url_button&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Add URL&quot;</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_add_album_cover_from_url</span>
        <span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">)</span>

        <span class="n">Button</span><span class="p">(</span>
            <span class="n">frame</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;album_cover_add_file_button&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Add file&quot;</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_add_album_cover_from_file</span>
        <span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">)</span>

        <span class="n">save_cover_var</span> <span class="o">=</span> <span class="n">BooleanVar</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;album_save_cover_var&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">&quot;Organize&quot;</span><span class="p">,</span> <span class="s2">&quot;save_cover_image&quot;</span><span class="p">))</span>
        <span class="n">Checkbutton</span><span class="p">(</span>
            <span class="n">frame</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;album_cover_save_checkbutton&quot;</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Save to file?&quot;</span><span class="p">,</span>
            <span class="n">variable</span><span class="o">=</span><span class="n">save_cover_var</span><span class="p">,</span> <span class="n">onvalue</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">offvalue</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">RIGHT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">)</span>
        <span class="n">album_cover</span><span class="o">.</span><span class="n">save_cover_var</span> <span class="o">=</span> <span class="n">save_cover_var</span>

        <span class="n">frame</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">columnspan</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span>
            <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__row</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">choose_album_cover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select and preview a cover image.</span>

<span class="sd">        :arg str label: the cover image display label</span>

<span class="sd">        .. note::</span>
<span class="sd">           The Mac OS X &quot;Preview&quot; app is used to open the album cover</span>
<span class="sd">           image identified by *label*.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__album_covers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> not found in album covers&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="n">messagebox</span><span class="o">.</span><span class="n">showerror</span><span class="p">(</span>
                <span class="s2">&quot;Album cover preview failure&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Album cover </span><span class="si">%r</span><span class="s2"> was not found!&quot;</span> <span class="o">%</span> <span class="n">label</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s2">&quot;open&quot;</span><span class="p">,</span> <span class="s2">&quot;-a&quot;</span><span class="p">,</span> <span class="s2">&quot;Preview&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;exit status </span><span class="si">%d</span><span class="s2"> attempting to preview </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="n">status</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_album_cover_from_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Download a cover image from a user-provided URL and open in</span>
<span class="sd">        Mac OS X Preview.</span>

<span class="sd">        The downloaded cover image is made available in the cover image</span>
<span class="sd">        dropdown.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="n">album_cover</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]</span>

        <span class="n">album_cover</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">DISABLED</span><span class="p">)</span>

        <span class="c1"># leave initialvalue empty (paste-over doesn&#39;t work in XQuartz)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">simpledialog</span><span class="o">.</span><span class="n">askstring</span><span class="p">(</span>
            <span class="s2">&quot;Add a cover image from a URL&quot;</span><span class="p">,</span> <span class="s2">&quot;Enter the image URL:&quot;</span><span class="p">,</span>
            <span class="n">initialvalue</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">album_cover</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">NORMAL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">return_</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;url = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;HTTP&quot;</span><span class="p">,</span> <span class="s2">&quot;timeout&quot;</span><span class="p">))</span>
            <span class="n">image_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;HTTP </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>

            <span class="n">image_type</span> <span class="o">=</span> <span class="n">imghdr</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="s2">&quot;_ignored_&quot;</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">image_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">image_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span>
                    <span class="s2">&quot;Unrecognized image type.&quot;</span><span class="p">,</span>
                    <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;Add cover image from URL&quot;</span><span class="p">)</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="n">make_tempfile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">image_type</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;wrote </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;failed to obtain image from </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
            <span class="n">messagebox</span><span class="o">.</span><span class="n">showerror</span><span class="p">(</span>
                <span class="s2">&quot;Image download failure&quot;</span><span class="p">,</span>
                <span class="s2">&quot;An unexpected error occurred while &quot;</span>
                    <span class="s2">&quot;downloading the image from </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__add_album_cover_option</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">album_cover</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">NORMAL</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">choose_album_cover</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_album_cover_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open a user-defined cover image in Mac OS X Preview.</span>

<span class="sd">        The cover image is made available in the cover image dropdown.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="n">album_cover</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]</span>

        <span class="n">album_cover</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">DISABLED</span><span class="p">)</span>

        <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filedialog</span><span class="o">.</span><span class="n">askopenfilename</span><span class="p">(</span>
            <span class="n">defaultextension</span><span class="o">=</span><span class="s2">&quot;.jpg&quot;</span><span class="p">,</span>
            <span class="n">filetypes</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;JPEG&quot;</span><span class="p">,</span> <span class="s2">&quot;*.jpg&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;JPEG&quot;</span><span class="p">,</span> <span class="s2">&quot;*.jpeg&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;PNG&quot;</span><span class="p">,</span> <span class="s2">&quot;*.png&quot;</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">initialdir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/Pictures&quot;</span><span class="p">),</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Choose a JPEG or PNG file&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">album_cover</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">NORMAL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">return_</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;file not found: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">messagebox</span><span class="o">.</span><span class="n">showerror</span><span class="p">(</span>
                <span class="s2">&quot;File not found&quot;</span><span class="p">,</span> <span class="s2">&quot;File not found: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">return_</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;filename = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">image_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

            <span class="n">image_type</span> <span class="o">=</span> <span class="n">imghdr</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="s2">&quot;_ignored_&quot;</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">image_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">image_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span>
                    <span class="s2">&quot;Unrecognized image type.&quot;</span><span class="p">,</span>
                    <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;Add cover image from file&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;failed to identify image from </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">messagebox</span><span class="o">.</span><span class="n">showerror</span><span class="p">(</span>
                <span class="s2">&quot;Image add failure&quot;</span><span class="p">,</span>
                <span class="s2">&quot;An unexpected error occurred while &quot;</span>
                    <span class="s2">&quot;processing the image from </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__add_album_cover_option</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">album_cover</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">NORMAL</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">choose_album_cover</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__add_album_cover_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">showinfo</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add an entry for *filename* to the album cover dropdown.</span>

<span class="sd">        :arg str filename: absolute path to an album cover image file</span>
<span class="sd">        :keyword bool showinfo:</span>
<span class="sd">           whether or not to open a dialog confirming the addition of</span>
<span class="sd">           *filename*</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">showinfo</span><span class="o">=</span><span class="n">showinfo</span><span class="p">)</span>

        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%02d</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__album_covers</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__album_covers</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">][</span><span class="s2">&quot;menu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span>
                <span class="k">lambda</span> <span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">choose_album_cover</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">showinfo</span><span class="p">:</span>
            <span class="n">messagebox</span><span class="o">.</span><span class="n">showinfo</span><span class="p">(</span>
                <span class="s2">&quot;Cover image added&quot;</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> has been added to the list of available covers.&quot;</span> <span class="o">%</span> <span class="n">label</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">label</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_save_cover_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">save_cover_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_create_album_custom_metadata_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the UI editing controls for editing custom metadata</span>
<span class="sd">        for *all* tracks.</span>

<span class="sd">        :arg parent: parent object of the editor</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

        <span class="n">album_custom_tagging_button</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span>
            <span class="n">parent</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;album_custom_tagging_button&quot;</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Edit custom Vorbis/ID3v2 tagging for ALL tracks&quot;</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span>
                <span class="k">lambda</span> <span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">:</span>
                    <span class="n">EditAlbumCustomMetadataTaggingDialog</span><span class="p">(</span>
                        <span class="n">parent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__aggregated_metadata</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__aggregated_metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">],</span>
                        <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="n">album_custom_tagging_button</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">columnspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span>
            <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="o">+</span><span class="n">E</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_custom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">album_custom_tagging_button</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__row</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_create_track_control_editors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the widgets used to navigate and include/exclude</span>
<span class="sd">        individual tracks.</span>

<span class="sd">        :arg parent:</span>
<span class="sd">           parent object of the frames that contain the control widgets</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

        <span class="n">Label</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Track&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">E</span><span class="p">)</span>

        <span class="n">nav_frame</span> <span class="o">=</span> <span class="n">Frame</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;track_nav_frame&quot;</span><span class="p">)</span>

        <span class="n">number_var</span> <span class="o">=</span> <span class="n">IntVar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;track_number_var&quot;</span><span class="p">)</span>
        <span class="n">track_number</span> <span class="o">=</span> <span class="n">Spinbox</span><span class="p">(</span>
            <span class="n">nav_frame</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;track_number_spinbox&quot;</span><span class="p">,</span>
            <span class="n">from_</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="n">number_var</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="s2">&quot;readonly&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_refresh_track_editors</span>
        <span class="p">)</span>
        <span class="n">track_number</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">number_var</span>
        <span class="n">track_number</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">)</span>

        <span class="n">of_label</span> <span class="o">=</span> <span class="n">Label</span><span class="p">(</span><span class="n">nav_frame</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;of_label&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;of&quot;</span><span class="p">)</span>
        <span class="n">of_label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="n">track_number</span><span class="o">.</span><span class="n">of_label</span> <span class="o">=</span> <span class="n">of_label</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;track_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">track_number</span>

        <span class="n">nav_frame</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__row</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">include_label</span> <span class="o">=</span> <span class="n">Label</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Include&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">E</span><span class="p">)</span>

        <span class="n">include_var</span> <span class="o">=</span> <span class="n">BooleanVar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;track_include_var&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">track_include</span> <span class="o">=</span> <span class="n">Checkbutton</span><span class="p">(</span>
            <span class="n">parent</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;track_include_checkbutton&quot;</span><span class="p">,</span>
            <span class="n">variable</span><span class="o">=</span><span class="n">include_var</span><span class="p">,</span> <span class="n">onvalue</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">offvalue</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__update_track_include_state</span><span class="p">)</span>
        <span class="n">track_include</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">include_var</span>
        <span class="n">track_include</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>

        <span class="n">apply_include_button</span> <span class="o">=</span> <span class="n">_styled</span><span class="p">(</span>
            <span class="n">Button</span><span class="p">(</span>
                <span class="n">parent</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;track_include_apply_button&quot;</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Include all tracks&quot;</span><span class="p">,</span>
                <span class="n">command</span><span class="o">=</span><span class="k">lambda</span> <span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__apply_to_all_tracks</span><span class="p">(</span>
                        <span class="s2">&quot;track_include&quot;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;track_include&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">())),</span>
            <span class="n">foreground</span><span class="o">=</span><span class="s2">&quot;Blue&quot;</span><span class="p">)</span>
        <span class="n">apply_include_button</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>
        <span class="n">track_include</span><span class="o">.</span><span class="n">apply_button</span> <span class="o">=</span> <span class="n">apply_include_button</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;track_include&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">track_include</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__row</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_create_track_custom_metadata_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the UI editing controls for editing custom metadata</span>
<span class="sd">        for a single track.</span>

<span class="sd">        :arg parent: parent object of the editor</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

        <span class="n">track_custom_tagging_button</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span>
            <span class="n">parent</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;track_custom_tagging_button&quot;</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Edit custom Vorbis/ID3v2 tagging for this track&quot;</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span>
                <span class="k">lambda</span> <span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">:</span>
                    <span class="n">EditCustomMetadataTaggingDialog</span><span class="p">(</span>
                        <span class="n">parent</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__aggregated_metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">][</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">current_track_number</span><span class="p">],</span>
                        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">. </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">current_track_number</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__track_vars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_track_number</span><span class="p">][</span>
                                <span class="s2">&quot;track_title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()))</span>
        <span class="p">)</span>
        <span class="n">track_custom_tagging_button</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">columnspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span>
            <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="o">+</span><span class="n">E</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;track_custom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">track_custom_tagging_button</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__row</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_track_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of the track currently being edited.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;track_number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">metadata_ready_for_editing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregated_metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(Re)Configure the entry/selection widgets with values from</span>
<span class="sd">        *aggregated_metadata*.</span>

<span class="sd">        :arg dict aggregated_metadata:</span>
<span class="sd">           the aggregated metadata field values for the current album</span>
<span class="sd">           and each of its tracks</span>

<span class="sd">        Separate variables will be created to store the entered/selected</span>
<span class="sd">        values for each track.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">aggregated_metadata</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="n">metadata_editors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span>

        <span class="k">for</span> <span class="n">album_field_name</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;album_title&quot;</span><span class="p">,</span>
                <span class="s2">&quot;album_artist&quot;</span><span class="p">,</span>
                <span class="s2">&quot;album_label&quot;</span><span class="p">,</span>
                <span class="s2">&quot;album_genre&quot;</span><span class="p">,</span>
                <span class="s2">&quot;album_year&quot;</span><span class="p">,</span>
                <span class="p">]:</span>
            <span class="n">widget</span> <span class="o">=</span> <span class="n">metadata_editors</span><span class="p">[</span><span class="n">album_field_name</span><span class="p">]</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">aggregated_metadata</span><span class="p">[</span><span class="n">album_field_name</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">aggregated_metadata</span><span class="p">[</span><span class="n">album_field_name</span><span class="p">]:</span>
                <span class="n">widget</span><span class="o">.</span><span class="n">current</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_discnumber&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">aggregated_metadata</span><span class="p">[</span><span class="s2">&quot;album_discnumber&quot;</span><span class="p">])</span>
        <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_disctotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">aggregated_metadata</span><span class="p">[</span><span class="s2">&quot;album_disctotal&quot;</span><span class="p">])</span>

        <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_compilation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">aggregated_metadata</span><span class="p">[</span><span class="s2">&quot;album_compilation&quot;</span><span class="p">])</span>

        <span class="n">album_cover_editor</span> <span class="o">=</span> <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]</span>
        <span class="n">album_cover_editor</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">DISABLED</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">aggregated_metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">aggregated_metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__add_album_cover_option</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">showinfo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">album_cover_editor</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">NORMAL</span><span class="p">)</span>

        <span class="c1"># issues/5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_naming_defaults</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">encoding</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;flac&quot;</span><span class="p">,</span> <span class="s2">&quot;mp3&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">field_suffix</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;subroot_trie&quot;</span><span class="p">,</span> <span class="s2">&quot;album_folder&quot;</span><span class="p">,</span> <span class="s2">&quot;track_filename&quot;</span><span class="p">]:</span>
                <span class="n">custom_key</span> <span class="o">=</span> <span class="s2">&quot;__</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">field_suffix</span><span class="p">)</span>
                <span class="n">custom_spec</span> <span class="o">=</span> <span class="n">aggregated_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">custom_key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">custom_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">metadata_editors</span><span class="p">[</span><span class="n">custom_key</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">custom_spec</span><span class="p">)</span>

        <span class="c1"># issues/5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__album_disctotal_observer_name</span> <span class="o">=</span> \
            <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_disctotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
                <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_naming_defaults</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__aggregated_metadata</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">aggregated_metadata</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_track_vars</span><span class="p">()</span>

        <span class="c1"># if persisted data was restored, manually select the cover image so</span>
        <span class="c1"># that it opens in Preview automatically</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span>
        <span class="k">if</span> <span class="n">fm</span><span class="o">.</span><span class="n">_persistence</span><span class="o">.</span><span class="n">restored</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__album_covers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">choose_album_cover</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__album_covers</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">pack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Display the editor frame.</span>

<span class="sd">        :arg tuple args: positional arguments to pack the editor frame</span>
<span class="sd">        :arg dict kwargs: keyword argument to pack the editor frame</span>

<span class="sd">        Showing the editor frame *enables* the **File | Save metadata**</span>
<span class="sd">        menu command.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span>

        <span class="c1"># Enable the &quot;Save metadata&quot; command in the File menu</span>
        <span class="n">file_menu</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">nametowidget</span><span class="p">(</span><span class="s2">&quot;.menubar.file_menu&quot;</span><span class="p">)</span>
        <span class="n">file_menu</span><span class="o">.</span><span class="n">entryconfig</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">NORMAL</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pack_forget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Hide the editor frame.</span>

<span class="sd">        Hiding the editor frame *disables* the **File | Save metadata**</span>
<span class="sd">        menu command.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>

        <span class="n">fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span>

        <span class="c1"># Disable the &quot;Save metadata&quot; command in the File menu</span>
        <span class="n">file_menu</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">nametowidget</span><span class="p">(</span><span class="s2">&quot;.menubar.file_menu&quot;</span><span class="p">)</span>
        <span class="n">file_menu</span><span class="o">.</span><span class="n">entryconfig</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">DISABLED</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The complete (album and tracks) metadata mapping as currently</span>
<span class="sd">        represented by all editor widgets and variables.</span>

<span class="sd">        :rtype: :class:`collections.OrderedDict`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="n">metadata_editors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span>

        <span class="n">snapshot</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">album_field_name</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;album_title&quot;</span><span class="p">,</span>
                <span class="s2">&quot;album_discnumber&quot;</span><span class="p">,</span>
                <span class="s2">&quot;album_disctotal&quot;</span><span class="p">,</span>
                <span class="s2">&quot;album_compilation&quot;</span><span class="p">,</span>
                <span class="s2">&quot;album_artist&quot;</span><span class="p">,</span>
                <span class="s2">&quot;album_label&quot;</span><span class="p">,</span>
                <span class="s2">&quot;album_genre&quot;</span><span class="p">,</span>
                <span class="s2">&quot;album_year&quot;</span><span class="p">,</span>
                <span class="p">]:</span>
            <span class="n">snapshot</span><span class="p">[</span><span class="n">album_field_name</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">metadata_editors</span><span class="p">[</span><span class="n">album_field_name</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="c1"># use the actual temp filename for the snapshot</span>
        <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">__album_covers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

        <span class="n">track_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__track_vars</span>
        <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;album_tracktotal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">track_vars</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># for the metadata snapshot, the custom fields must be preserved at</span>
        <span class="c1"># both the album and track level so that a disc whose persisted</span>
        <span class="c1"># metadata is re-read will still have its custom metadata editable as</span>
        <span class="c1"># expected</span>
        <span class="n">aggregated_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__aggregated_metadata</span>
        <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggregated_metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># issues/5</span>
        <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;__flac_subroot_trie&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;__flac_subroot_trie&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;__flac_album_folder&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;__flac_album_folder&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;__flac_track_filename&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;__flac_track_filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mp3_naming_same_as_flac_var</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;__mp3_subroot_trie&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;__flac_subroot_trie&quot;</span><span class="p">]</span>
            <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;__mp3_album_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;__flac_album_folder&quot;</span><span class="p">]</span>
            <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;__mp3_track_filename&quot;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;__flac_track_filename&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;__mp3_subroot_trie&quot;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;__mp3_subroot_trie&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;__mp3_album_folder&quot;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;__mp3_album_folder&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;__mp3_track_filename&quot;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;__mp3_track_filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">track_vars</span><span class="p">)):</span>
            <span class="n">track_metadata</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

            <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
            <span class="k">for</span> <span class="n">track_field_name</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;track_include&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;track_title&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;track_artist&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;track_genre&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;track_year&quot;</span><span class="p">,</span>
                    <span class="p">]:</span>
                <span class="n">track_metadata</span><span class="p">[</span><span class="n">track_field_name</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">track_vars</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">track_field_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

            <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">aggregated_metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="s2">&quot;__custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">track_metadata</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">snapshot</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">flattened_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The complete per-track metadata, including album metadata</span>
<span class="sd">        values shared by all tracks.</span>

<span class="sd">        :rtype: :obj:`list` of :class:`collections.OrderedDict`</span>

<span class="sd">        .. note::</span>
<span class="sd">           The list returned by this property uses zero-based indexing.</span>
<span class="sd">           (This differs from most other internal representations of</span>
<span class="sd">           per-track metadata, which use 1-based indexing to maintain</span>
<span class="sd">           consistency with respect to track numbers.)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="n">snapshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_snapshot</span>
        <span class="n">snapshot</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;__custom&quot;</span><span class="p">)</span> <span class="c1"># already incorporated into each track</span>

        <span class="c1"># to &quot;flatten&quot; the metadata, just add the album metadata to each track</span>
        <span class="n">flattened</span> <span class="o">=</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;__tracks&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>    <span class="c1"># zero-based indexing here</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flattened</span><span class="p">)):</span>
            <span class="n">flattened</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="n">flattened</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flattened</span>

    <span class="k">def</span> <span class="nf">_initialize_track_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create (and set the initial values of) variables for metadata</span>
<span class="sd">        fields for each track.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="n">track_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__track_vars</span> <span class="o">=</span> <span class="p">[</span>
            <span class="kc">None</span><span class="p">,</span>   <span class="c1"># track vars use 1-based indexing</span>
        <span class="p">]</span>

        <span class="n">aggregated_tracks_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__aggregated_metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">]</span>
        <span class="n">last_track</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">aggregated_tracks_metadata</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c1"># from_ will still be 0 here, and that&#39;s intended - it means that when</span>
        <span class="c1"># we invoke &quot;buttonup&quot; for the first time, it will increment the track</span>
        <span class="c1"># spinbox to 1, triggering a refresh of track 1&#39;s metadata</span>
        <span class="n">track_number_editor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;track_number&quot;</span><span class="p">]</span>
        <span class="n">track_number_editor</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">last_track</span><span class="p">)</span>
        <span class="n">track_number_editor</span><span class="o">.</span><span class="n">of_label</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;of </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">last_track</span><span class="p">)</span>

        <span class="c1"># tracks metadata also uses 1-based indexing</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">aggregated_tracks_metadata</span><span class="p">)):</span>
            <span class="n">track_metadata</span> <span class="o">=</span> <span class="n">aggregated_tracks_metadata</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>

            <span class="c1"># first initialize the individual track vars...</span>
            <span class="n">varmap</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;track_include&quot;</span><span class="p">:</span> <span class="n">BooleanVar</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;track_</span><span class="si">%d</span><span class="s2">_include&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="p">,</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_include&quot;</span><span class="p">]),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;title&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;artist&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;genre&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;year&quot;</span><span class="p">,</span>
                    <span class="p">]:</span>
                <span class="n">metadata_name</span> <span class="o">=</span> <span class="s2">&quot;track_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">field</span>
                <span class="n">varmap</span><span class="p">[</span><span class="n">metadata_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">StringVar</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;track_</span><span class="si">%d</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">field</span><span class="p">),</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">track_metadata</span><span class="p">[</span><span class="n">metadata_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">track_metadata</span><span class="p">[</span><span class="n">metadata_name</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="n">track_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varmap</span><span class="p">)</span>

            <span class="c1"># ...then initialize the editors and editor vars by using the track</span>
            <span class="c1"># spinbox to trigger refreshes (but make sure this method is called</span>
            <span class="c1"># BEFORE the metadata editor is packed, otherwise the user will be</span>
            <span class="c1"># very disoriented and confused)</span>
            <span class="n">track_number_editor</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&quot;buttonup&quot;</span><span class="p">)</span>

        <span class="c1"># now update the from_ to 1 and initialize the spinner to track #1 by</span>
        <span class="c1"># &quot;wrapping around&quot;</span>
        <span class="n">track_number_editor</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">from_</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">track_number_editor</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&quot;buttonup&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_refresh_track_editors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate track editors with metadata for the current track.</span>

<span class="sd">        This method is called when navigating to another track. If</span>
<span class="sd">        navigation is at either end of the track list already (i.e.</span>
<span class="sd">        navigating down from track 1 or up from the last track), then</span>
<span class="sd">        the spinner &quot;wraps around.&quot;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="n">track_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_track_number</span>
        <span class="n">track_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__track_vars</span><span class="p">[</span><span class="n">track_number</span><span class="p">]</span>
        <span class="n">track_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__aggregated_metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span>

        <span class="n">metadata_editors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span>
        <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;track_include&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">track_vars</span><span class="p">[</span><span class="s2">&quot;track_include&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__update_track_include_state</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">track_field_name</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;track_title&quot;</span><span class="p">,</span>
                <span class="s2">&quot;track_artist&quot;</span><span class="p">,</span>
                <span class="s2">&quot;track_genre&quot;</span><span class="p">,</span>
                <span class="s2">&quot;track_year&quot;</span><span class="p">,</span>
                <span class="p">]:</span>
            <span class="n">widget</span> <span class="o">=</span> <span class="n">metadata_editors</span><span class="p">[</span><span class="n">track_field_name</span><span class="p">]</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
                <span class="n">values</span><span class="o">=</span><span class="n">track_metadata</span><span class="p">[</span><span class="n">track_field_name</span><span class="p">],</span>
                <span class="n">textvariable</span><span class="o">=</span><span class="n">track_vars</span><span class="p">[</span><span class="n">track_field_name</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__update_track_include_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the widgets for the current track based on whether or</span>
<span class="sd">        not it is included.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="n">track_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_track_number</span>
        <span class="n">track_include_editor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="s2">&quot;track_include&quot;</span><span class="p">]</span>

        <span class="n">track_included</span> <span class="o">=</span> <span class="n">track_include_editor</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__track_vars</span><span class="p">[</span><span class="n">track_number</span><span class="p">][</span><span class="s2">&quot;track_include&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">track_included</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">track_included</span><span class="p">:</span>
            <span class="n">track_include_editor</span><span class="o">.</span><span class="n">apply_button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Include all tracks&quot;</span><span class="p">)</span>
            <span class="n">_styled</span><span class="p">(</span><span class="n">track_include_editor</span><span class="o">.</span><span class="n">apply_button</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s2">&quot;Blue&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">track_include_editor</span><span class="o">.</span><span class="n">apply_button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Exclude all tracks&quot;</span><span class="p">)</span>
            <span class="n">_styled</span><span class="p">(</span><span class="n">track_include_editor</span><span class="o">.</span><span class="n">apply_button</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s2">&quot;Red&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">get_config</span><span class="p">()[</span><span class="s2">&quot;UI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">&quot;disable_editing_excluded_tracks&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">track_field_name</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;track_title&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;track_artist&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;track_genre&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;track_year&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;track_custom&quot;</span><span class="p">,</span>
                    <span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span><span class="p">[</span><span class="n">track_field_name</span><span class="p">]</span><span class="o">.</span><span class="n">config</span><span class="p">(</span>
                    <span class="n">state</span><span class="o">=</span><span class="n">NORMAL</span> <span class="k">if</span> <span class="n">track_included</span> <span class="k">else</span> <span class="n">DISABLED</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate widgets in their default/initial states.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_remove</span><span class="p">()</span>

        <span class="n">metadata_editors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metadata_editors</span>

        <span class="c1"># reset all track editor vars to default</span>
        <span class="c1"># (the .var property of track editors serves as the default)</span>
        <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;track_include&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">track_field_name</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;track_title&quot;</span><span class="p">,</span>
                <span class="s2">&quot;track_artist&quot;</span><span class="p">,</span>
                <span class="s2">&quot;track_genre&quot;</span><span class="p">,</span>
                <span class="s2">&quot;track_year&quot;</span><span class="p">,</span>
                <span class="p">]:</span>
            <span class="n">metadata_editors</span><span class="p">[</span><span class="n">track_field_name</span><span class="p">]</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
                <span class="n">textvariable</span><span class="o">=</span><span class="n">metadata_editors</span><span class="p">[</span><span class="n">track_field_name</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">)</span>

        <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_discnumber&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># issues/5</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__album_disctotal_observer_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_disctotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">trace_vdelete</span><span class="p">(</span>
                <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__album_disctotal_observer_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__album_disctotal_observer_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_disctotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_compilation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;album_title&quot;</span><span class="p">,</span>
                <span class="s2">&quot;album_artist&quot;</span><span class="p">,</span>
                <span class="s2">&quot;album_label&quot;</span><span class="p">,</span>
                <span class="s2">&quot;album_genre&quot;</span><span class="p">,</span>
                <span class="s2">&quot;album_year&quot;</span><span class="p">,</span>
                <span class="s2">&quot;track_title&quot;</span><span class="p">,</span>
                <span class="s2">&quot;track_artist&quot;</span><span class="p">,</span>
                <span class="s2">&quot;track_genre&quot;</span><span class="p">,</span>
                <span class="s2">&quot;track_year&quot;</span><span class="p">,</span>
                <span class="p">]:</span>
            <span class="n">widget</span> <span class="o">=</span> <span class="n">metadata_editors</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="p">[])</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">album_cover_editor</span> <span class="o">=</span> <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]</span>
        <span class="n">album_cover_editor</span><span class="p">[</span><span class="s2">&quot;menu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
        <span class="n">album_cover_editor</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">album_cover_editor</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">DISABLED</span><span class="p">)</span>

        <span class="n">album_cover_editor</span><span class="o">.</span><span class="n">save_cover_var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">&quot;Organize&quot;</span><span class="p">,</span> <span class="s2">&quot;save_cover_image&quot;</span><span class="p">))</span>

        <span class="n">track_number_editor</span> <span class="o">=</span> <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;track_number&quot;</span><span class="p">]</span>
        <span class="n">track_number_editor</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">from_</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">track_number_editor</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">track_include_editor</span> <span class="o">=</span> <span class="n">metadata_editors</span><span class="p">[</span><span class="s2">&quot;track_include&quot;</span><span class="p">]</span>
        <span class="c1"># tracks are always included by default</span>
        <span class="n">track_include_editor</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">track_include_editor</span><span class="o">.</span><span class="n">apply_button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Include all tracks&quot;</span><span class="p">)</span>
        <span class="n">_styled</span><span class="p">(</span><span class="n">track_include_editor</span><span class="o">.</span><span class="n">apply_button</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s2">&quot;Blue&quot;</span><span class="p">)</span>

        <span class="c1"># issues/5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_naming_defaults</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mp3_naming_same_as_flac_var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># finally clear all cached data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__aggregated_metadata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__album_covers</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__track_vars</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove widgets from the current layout.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="c1"># entry widgets are NOT removed - just the editor frame itself</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>


<span class="nd">@logged</span>
<span class="k">class</span> <span class="nc">_FMEncodingStatusFrame</span><span class="p">(</span><span class="n">LabelFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The encoding status (monitoring) frame for FLACManager.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg tuple args: positional arguments to initialize the frame</span>
<span class="sd">        :arg dict options: ``config`` options to initialize the frame</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

        <span class="n">list_frame</span> <span class="o">=</span> <span class="n">Frame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">vscrollbar</span> <span class="o">=</span> <span class="n">Scrollbar</span><span class="p">(</span><span class="n">list_frame</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="n">vscrollbar</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">RIGHT</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">Y</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_track_encoding_status_list</span> <span class="o">=</span> <span class="n">Listbox</span><span class="p">(</span>
            <span class="n">list_frame</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;track_encoding_status_listbox&quot;</span><span class="p">,</span>
            <span class="n">exportselection</span><span class="o">=</span><span class="n">NO</span><span class="p">,</span> <span class="n">activestyle</span><span class="o">=</span><span class="n">NONE</span><span class="p">,</span> <span class="n">selectmode</span><span class="o">=</span><span class="n">SINGLE</span><span class="p">,</span>
            <span class="n">borderwidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">yscrollcommand</span><span class="o">=</span><span class="n">vscrollbar</span><span class="o">.</span><span class="n">set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_encoding_status_list</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">vscrollbar</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_track_encoding_status_list</span><span class="o">.</span><span class="n">yview</span><span class="p">)</span>

        <span class="n">list_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ready_to_encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">per_track_metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(Re)Initialize the encoding status list to monitor encoding</span>
<span class="sd">        of tracks from *per_track_metadata*.</span>

<span class="sd">        :arg list per_track_metadata:</span>
<span class="sd">           metadata field mappings for each track</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">track_encoding_statuses</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">TrackEncodingStatus</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{track_number:02d}</span><span class="s2"> </span><span class="si">{track_title}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">track_metadata</span><span class="p">),</span>
                <span class="n">pending</span><span class="o">=</span><span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_include&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">track_metadata</span> <span class="ow">in</span> <span class="n">per_track_metadata</span><span class="p">]</span>

        <span class="c1"># determine how many tracks are visible at once</span>
        <span class="n">number_of_tracks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">per_track_metadata</span><span class="p">)</span>
        <span class="n">max_visible_tracks</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()[</span><span class="s2">&quot;UI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span>
            <span class="s2">&quot;encoding_max_visible_tracks&quot;</span><span class="p">)</span>
        <span class="n">visible_tracks</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">number_of_tracks</span> <span class="k">if</span> <span class="n">number_of_tracks</span> <span class="o">&lt;</span> <span class="n">max_visible_tracks</span>
            <span class="k">else</span> <span class="n">max_visible_tracks</span><span class="p">)</span>

        <span class="n">items_spec</span> <span class="o">=</span> <span class="n">StringVar</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="n">track_encoding_status</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">track_encoding_status</span> <span class="ow">in</span> <span class="n">track_encoding_statuses</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_encoding_status_list</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
            <span class="n">height</span><span class="o">=</span><span class="n">visible_tracks</span><span class="p">,</span> <span class="n">listvariable</span><span class="o">=</span><span class="n">items_spec</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_tracks</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">per_track_metadata</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;track_include&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_track_encoding_status_list</span><span class="o">.</span><span class="n">itemconfig</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;fg&quot;</span><span class="p">:</span> <span class="s2">&quot;gray79&quot;</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_track_encoding_statuses</span> <span class="o">=</span> <span class="n">track_encoding_statuses</span>

    <span class="k">def</span> <span class="nf">encoding_in_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the UI as tracks are ripped.&quot;&quot;&quot;</span>
        <span class="c1"># don&#39;t log entry into this method - it is called repeatedly until all</span>
        <span class="c1"># tracks are ripped</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span> <span class="o">=</span> <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="n">QUEUE_GET_NOWAIT_AFTER</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding_in_progress</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;dequeued </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>

            <span class="p">(</span><span class="n">track_index</span><span class="p">,</span> <span class="n">cdda_fn</span><span class="p">,</span> <span class="n">flac_fn</span><span class="p">,</span> <span class="n">stdout_fn</span><span class="p">,</span> <span class="n">target_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">status</span>
            <span class="k">if</span> <span class="n">target_state</span> <span class="o">==</span> <span class="s2">&quot;FINISHED&quot;</span><span class="p">:</span>
                <span class="c1"># all tracks have been processed</span>
                <span class="k">while</span> <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;finished; discarding </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">())</span>
                    <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

                <span class="n">fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span>
                <span class="n">fm</span><span class="o">.</span><span class="n">_disc_frame</span><span class="o">.</span><span class="n">rip_and_tag_finished</span><span class="p">()</span>
                <span class="n">fm</span><span class="o">.</span><span class="n">bell</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;exit the monitoring loop&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">track_encoding_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_encoding_statuses</span><span class="p">[</span><span class="n">track_index</span><span class="p">]</span>

            <span class="c1"># only process &quot;expected&quot; state transitions</span>
            <span class="k">if</span> <span class="n">track_encoding_status</span><span class="o">.</span><span class="n">transition_to</span><span class="p">(</span><span class="n">target_state</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">track_encoding_status</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">TRACK_FAILED</span><span class="p">:</span>
                    <span class="n">status_message</span> <span class="o">=</span> <span class="n">track_encoding_status</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">target_state</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">target_state</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_state</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">item_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fg&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">}</span>
                <span class="k">elif</span> <span class="n">track_encoding_status</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">TRACK_ENCODING_FLAC</span><span class="p">:</span>
                    <span class="c1"># ensure that the currently-ripping track is always visible</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_track_encoding_status_list</span><span class="o">.</span><span class="n">see</span><span class="p">(</span><span class="n">track_index</span><span class="p">)</span>
                    <span class="c1"># read encoding interval status from flac&#39;s stdout</span>
                    <span class="n">cdda_basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cdda_fn</span><span class="p">)</span>
                    <span class="n">stdout_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_current_status</span><span class="p">(</span>
                        <span class="n">cdda_basename</span><span class="p">,</span> <span class="n">stdout_fn</span><span class="p">)</span>
                    <span class="n">status_message</span> <span class="o">=</span> <span class="n">track_encoding_status</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="n">stdout_message</span> <span class="k">if</span> <span class="n">stdout_message</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">item_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fg&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">}</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">track_encoding_status</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">[</span>
                            <span class="n">TRACK_DECODING_WAV</span><span class="p">,</span>
                            <span class="n">TRACK_ENCODING_MP3</span><span class="p">]</span>
                        <span class="ow">or</span> <span class="n">track_encoding_status</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span>
                            <span class="s2">&quot;REENCODING_MP3&quot;</span><span class="p">):</span>
                    <span class="n">status_message</span> <span class="o">=</span> <span class="n">track_encoding_status</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
                    <span class="n">item_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fg&quot;</span><span class="p">:</span> <span class="s2">&quot;dark violet&quot;</span><span class="p">}</span>
                <span class="k">elif</span> <span class="n">track_encoding_status</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">TRACK_COMPLETE</span><span class="p">:</span>
                    <span class="n">status_message</span> <span class="o">=</span> <span class="n">flac_fn</span>
                    <span class="n">item_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fg&quot;</span><span class="p">:</span> <span class="s2">&quot;dark green&quot;</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>   <span class="c1"># unexpected state</span>
                    <span class="n">status_message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (unexpected target state </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">track_encoding_status</span><span class="o">.</span><span class="n">describe</span><span class="p">(),</span> <span class="n">target_state</span><span class="p">)</span>
                    <span class="n">item_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fg&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">}</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_track_encoding_status_list</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">track_index</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_track_encoding_status_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                    <span class="n">track_index</span><span class="p">,</span> <span class="n">status_message</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_track_encoding_status_list</span><span class="o">.</span><span class="n">itemconfig</span><span class="p">(</span>
                    <span class="n">track_index</span><span class="p">,</span> <span class="n">item_config</span><span class="p">)</span>

                <span class="c1"># ensure that last track is always visible after delete/insert</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">track_index</span> <span class="o">==</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_track_encoding_status_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">END</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_track_encoding_status_list</span><span class="o">.</span><span class="n">see</span><span class="p">(</span><span class="n">track_index</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="n">QUEUE_GET_NOWAIT_AFTER</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding_in_progress</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_read_current_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cdda_basename</span><span class="p">,</span> <span class="n">stdout_fn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract the most recent FLAC encoding update from</span>
<span class="sd">        *stdout_fn*.</span>

<span class="sd">        :arg str cdda_basename: a grep pattern for *stdout_fn*</span>
<span class="sd">        :arg str stdout_fn:</span>
<span class="sd">           filename to which stdout has been redirected</span>
<span class="sd">        :return: a line of update text from *stdout_fn*</span>
<span class="sd">        :rtype: :obj:`str`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># do not trace; called from a recursive method</span>
        <span class="n">status_line</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: &quot;</span> <span class="o">%</span> <span class="n">cdda_basename</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">stdout_fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                    <span class="c1"># remove the prefix, then split on ASCII BS (Backspace) and</span>
                    <span class="c1"># take the last component</span>
                    <span class="c1">#</span>
                    <span class="c1"># output line looks like this:</span>
                    <span class="c1">#   ${prefix}${status1}(BS)+${status2}(BS)+..${statusN}</span>
                    <span class="n">status_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x08</span><span class="s1">&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">status_line</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate widgets in their default/initial states.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_remove</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_track_encoding_status_list</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_encoding_status_list</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">listvariable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_track_encoding_statuses</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove widgets from the current layout.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="c1"># widgets are NOT removed - just the frame itself</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pack_forget</span><span class="p">()</span>


<span class="nd">@total_ordering</span>
<div class="viewcode-block" id="TrackState"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.TrackState">[docs]</a><span class="k">class</span> <span class="nc">TrackState</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents the state of a single track at any given time during</span>
<span class="sd">    the rip-and-tag operation.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ordinal</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg int ordinal: this state&#39;s relative value</span>
<span class="sd">        :arg str key: uniquely identifies this state</span>
<span class="sd">        :arg str text: a short description of this state</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ordinal</span> <span class="o">=</span> <span class="n">ordinal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_text</span> <span class="o">=</span> <span class="n">text</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The unique identifier for this state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The track-independent short description of this state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text</span>

    <span class="k">def</span> <span class="nf">__int__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the relative (ordinal) value of this state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ordinal</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the unique identifier for this state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string that is unique for this track state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%d</span><span class="s2">, </span><span class="si">%r</span><span class="s2">, </span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ordinal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return ``True`` if this state&#39;s ordinal value is less than</span>
<span class="sd">        *other* state&#39;s ordinal value, otherwise ``False``.</span>

<span class="sd">        :arg flacmanager.TrackState other: the state being compared</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return ``True`` if this state&#39;s ordinal value and key are</span>
<span class="sd">        equal to *other* state&#39;s ordinal value and key, otherwise</span>
<span class="sd">        ``False``.</span>

<span class="sd">        :arg flacmanager.TrackState other: the state being compared</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ordinal</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_ordinal</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>


<span class="c1">#: Indicates that a track is excluded from the rip-and-tag operation.</span>
<span class="n">TRACK_EXCLUDED</span> <span class="o">=</span> <span class="n">TrackState</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;EXCLUDED&quot;</span><span class="p">,</span> <span class="s2">&quot;excluded&quot;</span><span class="p">)</span>

<span class="c1">#: Indicates that the rip-and-tag process has not yet begun for a track.</span>
<span class="n">TRACK_PENDING</span> <span class="o">=</span> <span class="n">TrackState</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;PENDING&quot;</span><span class="p">,</span> <span class="s2">&quot;pending</span><span class="se">\u2026</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1">#: Indicates that a track is being encoded from CDDA to FLAC format.</span>
<span class="n">TRACK_ENCODING_FLAC</span> <span class="o">=</span> <span class="n">TrackState</span><span class="p">(</span>
    <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;ENCODING_FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;encoding CDDA to FLAC</span><span class="se">\u2026</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1">#: Indicates that a track is being decoded from FLAC to WAV format.</span>
<span class="n">TRACK_DECODING_WAV</span> <span class="o">=</span> <span class="n">TrackState</span><span class="p">(</span>
    <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;DECODING_WAV&quot;</span><span class="p">,</span> <span class="s2">&quot;decoding FLAC to WAV</span><span class="se">\u2026</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1">#: Indicates that a track is being encoded from WAV to MP3 format.</span>
<span class="n">TRACK_ENCODING_MP3</span> <span class="o">=</span> <span class="n">TrackState</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;ENCODING_MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;encoding WAV to MP3</span><span class="se">\u2026</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1">#: Indicates that a track is being re-encoded from WAV to MP3 format</span>
<span class="c1">#: after clipping was detected in a prior encoding operation.</span>
<span class="n">TRACK_REENCODING_MP3</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">scale</span><span class="p">:</span> <span class="n">TrackState</span><span class="p">(</span>
        <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;REENCODING_MP3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;re-encoding MP3 at </span><span class="si">{:.2f}</span><span class="s2"> scale (clipping detected)</span><span class="se">\u2026</span><span class="s2">&quot;</span><span class="o">.</span>
            <span class="nb">format</span><span class="p">(</span><span class="n">scale</span><span class="p">)))</span>

<span class="c1">#: Indicates that an error occurred while processing a track.</span>
<span class="n">TRACK_FAILED</span> <span class="o">=</span> <span class="n">TrackState</span><span class="p">(</span><span class="mi">99</span><span class="p">,</span> <span class="s2">&quot;FAILED&quot;</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">)</span>

<span class="c1">#: Indicates that the rip-and-tag process has finished for a track.</span>
<span class="n">TRACK_COMPLETE</span> <span class="o">=</span> <span class="n">TrackState</span><span class="p">(</span><span class="mi">99</span><span class="p">,</span> <span class="s2">&quot;COMPLETE&quot;</span><span class="p">,</span> <span class="s2">&quot;complete&quot;</span><span class="p">)</span>


<span class="nd">@logged</span>
<div class="viewcode-block" id="TrackEncodingStatus"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.TrackEncodingStatus">[docs]</a><span class="k">class</span> <span class="nc">TrackEncodingStatus</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A simple state machine for a single track&#39;s encoding status.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">track_label</span><span class="p">,</span> <span class="n">pending</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg str track_label: the track&#39;s display label</span>
<span class="sd">        :keyword bool pending:</span>
<span class="sd">           the default ``True`` initializes status as</span>
<span class="sd">           :data:`TRACK_PENDING`; set to ``False`` to initialize status</span>
<span class="sd">           as :data:`TRACK_EXCLUDED`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">track_label</span><span class="p">,</span> <span class="n">pending</span><span class="o">=</span><span class="n">pending</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">track_label</span> <span class="o">=</span> <span class="n">track_label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__state</span> <span class="o">=</span> <span class="n">TRACK_PENDING</span> <span class="k">if</span> <span class="n">pending</span> <span class="k">else</span> <span class="n">TRACK_EXCLUDED</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The current state of encoding for this track.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__state</span>

<div class="viewcode-block" id="TrackEncodingStatus.transition_to"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.TrackEncodingStatus.transition_to">[docs]</a>    <span class="k">def</span> <span class="nf">transition_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Advance this track&#39;s encoding state from its current state to</span>
<span class="sd">        *to_state*, if permitted.</span>

<span class="sd">        :arg to_state:</span>
<span class="sd">           the target encoding state, or any :class:`Exception` to</span>
<span class="sd">           transition to :data:`TRACK_FAILED`</span>
<span class="sd">        :return:</span>
<span class="sd">           ``True`` if the transition is successful, otherwise ``False``</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">to_state</span><span class="p">)</span>

        <span class="n">from_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__state</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_state</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
            <span class="n">to_state</span> <span class="o">=</span> <span class="n">TRACK_FAILED</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">from_state</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="n">TRACK_EXCLUDED</span><span class="p">,</span>
                    <span class="n">TRACK_FAILED</span><span class="p">,</span>
                    <span class="n">TRACK_COMPLETE</span><span class="p">]</span>
                <span class="ow">or</span> <span class="n">to_state</span> <span class="o">&lt;</span> <span class="n">from_state</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: illegal transition from </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">track_label</span><span class="p">,</span> <span class="n">from_state</span><span class="p">,</span> <span class="n">to_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__state</span> <span class="o">=</span> <span class="n">to_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="TrackEncodingStatus.describe"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.TrackEncodingStatus.describe">[docs]</a>    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a short display string for this track and its current</span>
<span class="sd">        status.</span>

<span class="sd">        :arg str message:</span>
<span class="sd">           short piece of text to use with the track label (instead of</span>
<span class="sd">           the default message for the current state)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">track_label</span><span class="p">,</span>
            <span class="n">message</span> <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">__state</span><span class="o">.</span><span class="n">text</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="generate_flac_dirname"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.generate_flac_dirname">[docs]</a><span class="k">def</span> <span class="nf">generate_flac_dirname</span><span class="p">(</span><span class="n">library_root</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build the directory for a track&#39;s FLAC file.</span>

<span class="sd">    :arg str library_root: the FLAC library directory</span>
<span class="sd">    :arg dict metadata: the finalized metadata for a single track</span>
<span class="sd">    :return: an absolute directory path</span>
<span class="sd">    :rtype: :obj:`str`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">library_root</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_generate_dirname</span><span class="p">(</span><span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="n">library_root</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span></div>


<div class="viewcode-block" id="generate_flac_basename"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.generate_flac_basename">[docs]</a><span class="k">def</span> <span class="nf">generate_flac_basename</span><span class="p">(</span><span class="n">metadata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build the filename for a track&#39;s FLAC file.</span>

<span class="sd">    :arg dict metadata: the finalized metadata for a single track</span>
<span class="sd">    :return: a relative file name</span>
<span class="sd">    :rtype: :obj:`str`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_generate_basename</span><span class="p">(</span><span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span></div>


<div class="viewcode-block" id="generate_mp3_dirname"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.generate_mp3_dirname">[docs]</a><span class="k">def</span> <span class="nf">generate_mp3_dirname</span><span class="p">(</span><span class="n">library_root</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build the directory for a track&#39;s MP3 file.</span>

<span class="sd">    :arg str library_root: the MP3 library directory</span>
<span class="sd">    :arg dict metadata: the finalized metadata for a single track</span>
<span class="sd">    :return: an absolute directory path</span>
<span class="sd">    :rtype: :obj:`str`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">library_root</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_generate_dirname</span><span class="p">(</span><span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="n">library_root</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span></div>


<div class="viewcode-block" id="generate_mp3_basename"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.generate_mp3_basename">[docs]</a><span class="k">def</span> <span class="nf">generate_mp3_basename</span><span class="p">(</span><span class="n">metadata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build the filename for a track&#39;s MP3 file.</span>

<span class="sd">    :arg dict metadata: the finalized metadata for a single track</span>
<span class="sd">    :return: a relative file name</span>
<span class="sd">    :rtype: :obj:`str`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_generate_basename</span><span class="p">(</span><span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_generate_dirname</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">library_root</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build the directory for a track&#39;s FLAC or MP3 file.</span>

<span class="sd">    :arg str section: &quot;FLAC&quot; or &quot;MP3&quot;</span>
<span class="sd">    :arg str library_root: the MP3 library directory</span>
<span class="sd">    :arg dict metadata: the finalized metadata for a single track</span>
<span class="sd">    :return: an absolute directory path</span>
<span class="sd">    :rtype: :obj:`str`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">library_root</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>

    <span class="c1"># issues/5</span>
    <span class="n">folder_format_spec</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__</span><span class="si">%s</span><span class="s2">_album_folder&quot;</span> <span class="o">%</span> <span class="n">section</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;using template </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">folder_format_spec</span><span class="p">)</span>

    <span class="n">folder_names</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">name_format_spec</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name_format_spec</span> <span class="ow">in</span> <span class="n">folder_format_spec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)]</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;raw folder names </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">folder_names</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">&quot;use_xplatform_safe_names&quot;</span><span class="p">):</span>
        <span class="c1"># paranoid-safe and compact, but less readable</span>
        <span class="n">folder_names</span> <span class="o">=</span> <span class="n">_xplatform_safe</span><span class="p">(</span><span class="n">folder_names</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># as close to format spec as possible, but still relatively safe</span>
        <span class="n">folder_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^0-9a-zA-Z-.,_() ]&quot;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">folder_names</span><span class="p">]</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;final folder names </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">folder_names</span><span class="p">)</span>

    <span class="n">album_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">library_root</span><span class="p">,</span> <span class="o">*</span><span class="n">_subroot_trie</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">metadata</span><span class="p">),</span> <span class="o">*</span><span class="n">folder_names</span><span class="p">)</span>

    <span class="c1"># doesn&#39;t work as expected for external media</span>
    <span class="c1">#os.makedirs(album_folder, exist_ok=True)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s2">&quot;mkdir&quot;</span><span class="p">,</span> <span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="n">album_folder</span><span class="p">])</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;using album folder </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">album_folder</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">album_folder</span>


<span class="k">def</span> <span class="nf">_generate_basename</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build the filename for a track&#39;s FLAC or MP3 file.</span>

<span class="sd">    :arg str section: &quot;FLAC&quot; or &quot;MP3&quot;</span>
<span class="sd">    :arg dict metadata: the finalized metadata for a single track</span>
<span class="sd">    :return: a relative file name</span>
<span class="sd">    :rtype: :obj:`str`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>

    <span class="c1"># issues/5</span>
    <span class="n">track_format_spec</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__</span><span class="si">%s</span><span class="s2">_track_filename&quot;</span> <span class="o">%</span> <span class="n">section</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;using template </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">track_format_spec</span><span class="p">)</span>

    <span class="n">basename</span> <span class="o">=</span> <span class="n">track_format_spec</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;raw basename </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">basename</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">&quot;use_xplatform_safe_names&quot;</span><span class="p">):</span>
        <span class="c1"># paranoid-safe and compact, but less readable</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">_xplatform_safe</span><span class="p">(</span>
            <span class="n">basename</span><span class="p">,</span> <span class="n">fileext</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="s2">&quot;track_fileext&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># as close to format spec as possible, but still relatively safe</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^0-9a-zA-Z-.,_() ]&quot;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">basename</span><span class="p">)</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;final basename </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">basename</span><span class="p">)</span>

    <span class="n">track_filename</span> <span class="o">=</span> <span class="n">basename</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="s2">&quot;track_fileext&quot;</span><span class="p">]</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;using track filename </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">track_filename</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">track_filename</span>


<span class="k">def</span> <span class="nf">_xplatform_safe</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">fileext</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transform *path* so that it is safe to use across platforms.</span>

<span class="sd">    :arg path:</span>
<span class="sd">       a :obj:`list` of folder names, or a file basename</span>
<span class="sd">    :keyword str fileext:</span>
<span class="sd">       if *path* is a file basename, this is the file extension that</span>
<span class="sd">       will be appended to form the complete file name</span>
<span class="sd">    :return: the transformed *path*</span>
<span class="sd">    :rtype: the same type as *path* (:obj:`list` or :obj:`str`)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">fileext</span><span class="o">=</span><span class="n">fileext</span><span class="p">)</span>

    <span class="n">safe_names</span> <span class="o">=</span> <span class="n">path</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="k">else</span> <span class="p">[</span><span class="n">path</span><span class="p">]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">replacement</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">),</span> <span class="c1"># contiguous ws to &#39;-&#39;</span>
            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^0-9a-zA-Z-.,_]+&quot;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">),</span> <span class="c1"># contiguous special to &#39;_&#39;</span>
            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[^0-9a-zA-Z_]&quot;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">),</span> <span class="c1"># non-alphanum/underscore at [0] to &#39;_&#39;</span>
            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;([-.,_]){2,}&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\1&#39;</span><span class="p">)</span> <span class="c1"># 2+ contiguous special/replacement to \1</span>
            <span class="p">]:</span>
        <span class="n">safe_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">replacement</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">safe_names</span><span class="p">]</span>

    <span class="c1"># can&#39;t know the target file system ahead of time, so assume 255 UTF-8</span>
    <span class="c1"># bytes as the &quot;least common denominator&quot; limit for all path components</span>
    <span class="n">safe_names</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">()[:</span><span class="mi">255</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">fileext</span><span class="p">)]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">safe_names</span><span class="p">]</span>

    <span class="n">transformed</span> <span class="o">=</span> <span class="n">safe_names</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">safe_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> -&gt; </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">transformed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">transformed</span>


<span class="k">def</span> <span class="nf">_subroot_trie</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build zero or more subdirectories below the library root to form</span>
<span class="sd">    an easily navigable &quot;trie&quot; structure for audio files.</span>

<span class="sd">    :arg str section: &quot;FLAC&quot; or &quot;MP3&quot;</span>
<span class="sd">    :arg dict metadata: the finalized metadata for a single track</span>
<span class="sd">    :return:</span>
<span class="sd">       a list (possibly empty) of directory names that form a trie</span>
<span class="sd">       structure for organizing audio files</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>

    <span class="c1"># issues/5</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__</span><span class="si">%s</span><span class="s2">_subroot_trie&quot;</span> <span class="o">%</span> <span class="n">section</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="n">level</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;library_subroot_trie_level&quot;</span><span class="p">)</span>

    <span class="c1"># to skip building a directory trie structure, the key can be left empty or</span>
    <span class="c1"># the level can be set to zero (0)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;RETURN []&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">term</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="c1"># issues/3</span>
    <span class="n">trie_ignore_leading_article</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;trie_ignore_leading_article&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">trie_ignore_leading_article</span><span class="p">:</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">trie_ignore_leading_article</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">articles</span><span class="p">:</span>
            <span class="c1"># do not simply join on space; remaining white space may be</span>
            <span class="c1"># significant (e.g. NIN &quot;THE S L  I   P&quot; -&gt; &quot;S L  I   P&quot;)</span>
            <span class="n">term</span> <span class="o">=</span> <span class="n">term</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]):]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>

    <span class="n">term</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^0-9a-zA-Z]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="c1"># use len(term) - 1 so trie prefixes never include the full term</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">term</span><span class="p">[:</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))]</span>
    <span class="c1"># edge case - any non-alphanumeric key falls into the special &#39;_&#39; node</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="p">]</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nodes</span>


<span class="k">def</span> <span class="nf">_save_cover_image</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save the cover image to the album folder.</span>

<span class="sd">    :arg str dirname: the album folder name</span>
<span class="sd">    :arg str filename: the cover image file name</span>
<span class="sd">    :return: ``True`` if the cover image was saved, otherwise ``False``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">image_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">image_ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;.jpeg&quot;</span><span class="p">]:</span>
        <span class="n">cover_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="s2">&quot;cover.jpg&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">image_ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;.png&quot;</span><span class="p">:</span>
        <span class="n">cover_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="s2">&quot;cover.png&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;not saving cover image </span><span class="si">%r</span><span class="s2"> (not a JPEG or PNG)!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">status</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s2">&quot;cp&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">cover_filename</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;copied </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">cover_filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;unable to copy </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2"> (error code </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">cover_filename</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_styled</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply `Ttk Styling</span>
<span class="sd">    &lt;https://docs.python.org/3/library/tkinter.ttk.html#ttkstyling&gt;`_ to</span>
<span class="sd">    *widget*.</span>

<span class="sd">    :arg widget: any Ttk widget</span>
<span class="sd">    :arg dict options: the styling options for *widget*</span>
<span class="sd">    :return: *widget* with styling applied</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">style_id</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%x</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">widget</span><span class="p">),</span> <span class="n">widget</span><span class="o">.</span><span class="n">winfo_class</span><span class="p">())</span>
    <span class="n">Style</span><span class="p">()</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">style_id</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="n">style_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">widget</span>


<span class="c1">#: The text content of the dialog that explains FLACManager&#39;s</span>
<span class="c1">#: prerequisites.</span>
<span class="n">_PREREQUISITES_TEXT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">FLACManager runs on Python 3.3+ compiled against Tk 8.5+.</span>

<span class="s2">The following EXTERNAL software components are also required:</span>

<span class="s2">* libdiscid (http://musicbrainz.org/doc/libdiscid)</span>
<span class="s2">* flac (http://flac.sourceforge.net/)</span>
<span class="s2">* lame (http://lame.sourceforge.net/)</span>
<span class="s2">* diskutil (Mac OS X command line utility)</span>
<span class="s2">* open (Mac OS X command line utility)</span>
<span class="s2">* mkdir (Mac OS X command line utility)</span>

<span class="s2">The flac and lame command line binaries must be available on</span>
<span class="s2">your $PATH, and the location of the libdiscid library must be</span>
<span class="s2">specified in the flacmanager.ini configuration file.</span>

<span class="s2">The libdiscid, flac and lame components can be easily installed</span>
<span class="s2">from MacPorts (http://www.macports.org/).</span>

<span class="s2">Finally, You MUST register for a Gracenote developer account in</span>
<span class="s2">order for FLACManager&#39;s metadata aggregation to work properly:</span>

<span class="s2">1. Create your Gracenote developer account at</span>
<span class="s2">   https://developer.gracenote.com/.</span>
<span class="s2">2. Create an app named &quot;FLACManager&quot;.</span>
<span class="s2">3. Save your Gracenote Client ID in the flacmanager.ini</span>
<span class="s2">   configuration file.</span>

<span class="s2">(FLACManager will automatically obtain and store your Gracenote</span>
<span class="s2">User ID in the flacmanager.ini file.)&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">_TextDialog</span><span class="p">(</span><span class="n">simpledialog</span><span class="o">.</span><span class="n">Dialog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dialog that presents a simple formatted text message.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg master: the parent object of the dialog</span>
<span class="sd">        :arg str text: the text to display in the dialog</span>
<span class="sd">        :arg dict options: configuration options for the dialog</span>

<span class="sd">        *text* should contain line breaks at positions desirable for</span>
<span class="sd">        on-screen display. The total number of lines will determine the</span>
<span class="sd">        height of the text widget,</span>

<span class="sd">        *options* are passed directly to the parent</span>
<span class="sd">        :class:`tkinter.simpledialog.Dialog` class initializer.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_text</span> <span class="o">=</span> <span class="n">text</span> <span class="c1"># must be set BEFORE calling super __init__!</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the content of the dialog.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">StringIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">Text</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">bd</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">relief</span><span class="o">=</span><span class="n">FLAT</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="n">wrap</span><span class="o">=</span><span class="n">WORD</span><span class="p">)</span>
        <span class="n">text</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">END</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
        <span class="n">text</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">DISABLED</span><span class="p">)</span>
        <span class="n">text</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">buttonbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the button to dismiss the dialog.&quot;&quot;&quot;</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">Frame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">Button</span><span class="p">(</span>
            <span class="n">box</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">ACTIVE</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Return&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">)</span>
        <span class="n">box</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_EditConfigurationDialog</span><span class="p">(</span><span class="n">simpledialog</span><span class="o">.</span><span class="n">Dialog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for dialogs that allow the user to edit the</span>
<span class="sd">    *flacmanager.ini* configuration file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the content of the dialog.</span>

<span class="sd">        :arg Frame frame: the frame that contains the body content</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_row</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># &quot;Section&quot; -&gt; { &quot;option&quot; -&gt; tk-variable }</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_populate</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">get_config</span><span class="p">())</span>

        <span class="n">frame</span><span class="o">.</span><span class="n">grid_columnconfigure</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">section_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a section header to the body of the dialog.</span>

<span class="sd">        :arg parent: the parent object of the section header</span>
<span class="sd">        :arg str section_name: the name of the configuration section</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">section_label</span> <span class="o">=</span> <span class="n">_styled</span><span class="p">(</span>
            <span class="n">Label</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">section_name</span><span class="p">),</span> <span class="n">font</span><span class="o">=</span><span class="s2">&quot;-size 13 -weight bold&quot;</span><span class="p">)</span>
        <span class="n">section_label</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="p">,</span> <span class="n">columnspan</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_row</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">option</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">section_name</span><span class="p">,</span> <span class="n">option_name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">67</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add an editable option to the body of the dialog.</span>

<span class="sd">        :arg parent: the parent object of the section header</span>
<span class="sd">        :arg str section_name: the name of the configuration section</span>
<span class="sd">        :arg str option_name: the name of the configuration option</span>
<span class="sd">        :arg value: the default/initial value of the option</span>
<span class="sd">        :keyword int width:</span>
<span class="sd">           the display width of the entry box for this option&#39;s value</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Label</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">option_name</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">E</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">IntVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">BooleanVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">DoubleVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">StringVar</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">widget</span> <span class="o">=</span> <span class="n">OptionMenu</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span> <span class="ow">is</span> <span class="n">BooleanVar</span><span class="p">:</span>
            <span class="n">widget</span> <span class="o">=</span> <span class="n">Checkbutton</span><span class="p">(</span>
                <span class="n">parent</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span> <span class="n">onvalue</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">offvalue</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">widget</span> <span class="o">=</span> <span class="n">Entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
        <span class="n">widget</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_row</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># track the variable; see apply()</span>
        <span class="k">if</span> <span class="n">section_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">[</span><span class="n">section_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">[</span><span class="n">section_name</span><span class="p">][</span><span class="n">option_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span>

    <span class="k">def</span> <span class="nf">buttonbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the buttons to save and/or dismiss the dialog.&quot;&quot;&quot;</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">Frame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">Button</span><span class="p">(</span>
            <span class="n">box</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Save&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">ACTIVE</span>
            <span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">)</span>

        <span class="n">Button</span><span class="p">(</span>
            <span class="n">box</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Cancel&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cancel</span>
            <span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Return&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Escape&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancel</span><span class="p">)</span>

        <span class="n">box</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save changes to the *flacmanager.ini* file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">_CONFIG_LOCK</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">optvar</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">variable</span><span class="p">)</span> <span class="ow">in</span> <span class="n">optvar</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># values MUST be strings!</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">BooleanVar</span><span class="p">:</span>
                        <span class="n">config</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">option</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">config</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">option</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="s2">&quot;yes&quot;</span> <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;no&quot;</span>

            <span class="n">save_config</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">EditRequiredConfigurationDialog</span><span class="p">(</span><span class="n">_EditConfigurationDialog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dialog that allows the user to edit **required** options from</span>
<span class="sd">    the *flacmanager.ini* configuration file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_populate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the content of the dialog.&quot;&quot;&quot;</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="n">option</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="n">section</span><span class="p">(</span><span class="s2">&quot;Organize&quot;</span><span class="p">)</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;Organize&quot;</span><span class="p">,</span> <span class="s2">&quot;library_root&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Organize&quot;</span><span class="p">][</span><span class="s2">&quot;library_root&quot;</span><span class="p">])</span>

        <span class="n">section</span><span class="p">(</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">)</span>
        <span class="n">option</span><span class="p">(</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">,</span> <span class="s2">&quot;client_id&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">][</span><span class="s2">&quot;client_id&quot;</span><span class="p">])</span>

        <span class="n">section</span><span class="p">(</span><span class="s2">&quot;MusicBrainz&quot;</span><span class="p">)</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;MusicBrainz&quot;</span><span class="p">,</span> <span class="s2">&quot;contact_url_or_email&quot;</span><span class="p">,</span> 
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MusicBrainz&quot;</span><span class="p">][</span><span class="s2">&quot;contact_url_or_email&quot;</span><span class="p">])</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;MusicBrainz&quot;</span><span class="p">,</span> <span class="s2">&quot;libdiscid_location&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MusicBrainz&quot;</span><span class="p">][</span><span class="s2">&quot;libdiscid_location&quot;</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">EditAggregationConfigurationDialog</span><span class="p">(</span><span class="n">_EditConfigurationDialog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dialog that allows the user to edit metadata aggregation</span>
<span class="sd">    options from the *flacmanager.ini* configuration file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_populate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the content of the dialog.&quot;&quot;&quot;</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="n">option</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="n">section</span><span class="p">(</span><span class="s2">&quot;HTTP&quot;</span><span class="p">)</span>
        <span class="n">option</span><span class="p">(</span><span class="s2">&quot;HTTP&quot;</span><span class="p">,</span> <span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;HTTP&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

        <span class="n">section</span><span class="p">(</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">)</span>
        <span class="n">option</span><span class="p">(</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">,</span> <span class="s2">&quot;client_id&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">][</span><span class="s2">&quot;client_id&quot;</span><span class="p">])</span>
        <span class="n">option</span><span class="p">(</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">][</span><span class="s2">&quot;user_id&quot;</span><span class="p">])</span>

        <span class="n">section</span><span class="p">(</span><span class="s2">&quot;MusicBrainz&quot;</span><span class="p">)</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;MusicBrainz&quot;</span><span class="p">,</span> <span class="s2">&quot;contact_url_or_email&quot;</span><span class="p">,</span> 
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MusicBrainz&quot;</span><span class="p">][</span><span class="s2">&quot;contact_url_or_email&quot;</span><span class="p">])</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;MusicBrainz&quot;</span><span class="p">,</span> <span class="s2">&quot;libdiscid_location&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MusicBrainz&quot;</span><span class="p">][</span><span class="s2">&quot;libdiscid_location&quot;</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">EditOrganizationConfigurationDialog</span><span class="p">(</span><span class="n">_EditConfigurationDialog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dialog that allows the user to edit library folder/file</span>
<span class="sd">    organization options from the *flacmanager.ini* configuration file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_populate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the content of the dialog.&quot;&quot;&quot;</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="n">option</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="n">section</span><span class="p">(</span><span class="s2">&quot;Organize&quot;</span><span class="p">)</span>
        <span class="n">option</span><span class="p">(</span><span class="s2">&quot;Organize&quot;</span><span class="p">,</span> <span class="s2">&quot;library_root&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Organize&quot;</span><span class="p">][</span><span class="s2">&quot;library_root&quot;</span><span class="p">])</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;Organize&quot;</span><span class="p">,</span> <span class="s2">&quot;library_subroot_trie_key&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Organize&quot;</span><span class="p">][</span><span class="s2">&quot;library_subroot_trie_key&quot;</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="mi">29</span><span class="p">)</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;Organize&quot;</span><span class="p">,</span> <span class="s2">&quot;library_subroot_trie_level&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Organize&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;library_subroot_trie_level&quot;</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;Organize&quot;</span><span class="p">,</span> <span class="s2">&quot;album_folder&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Organize&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;album_folder&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;Organize&quot;</span><span class="p">,</span> <span class="s2">&quot;ndisc_album_folder&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Organize&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ndisc_album_folder&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;Organize&quot;</span><span class="p">,</span> <span class="s2">&quot;compilation_album_folder&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Organize&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compilation_album_folder&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;Organize&quot;</span><span class="p">,</span> <span class="s2">&quot;ndisc_compilation_album_folder&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Organize&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ndisc_compilation_album_folder&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;Organize&quot;</span><span class="p">,</span> <span class="s2">&quot;track_filename&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Organize&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;track_filename&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;Organize&quot;</span><span class="p">,</span> <span class="s2">&quot;ndisc_track_filename&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Organize&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ndisc_track_filename&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;Organize&quot;</span><span class="p">,</span> <span class="s2">&quot;compilation_track_filename&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Organize&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compilation_track_filename&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;Organize&quot;</span><span class="p">,</span> <span class="s2">&quot;ndisc_compilation_track_filename&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Organize&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ndisc_compilation_track_filename&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;Organize&quot;</span><span class="p">,</span> <span class="s2">&quot;use_xplatform_safe_names&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Organize&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">&quot;use_xplatform_safe_names&quot;</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;Organize&quot;</span><span class="p">,</span> <span class="s2">&quot;save_cover_image&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Organize&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">&quot;save_cover_image&quot;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">EditFLACEncodingConfigurationDialog</span><span class="p">(</span><span class="n">_EditConfigurationDialog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dialog that allows the user to edit FLAC encoding options from</span>
<span class="sd">    the *flacmanager.ini* configuration file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_populate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the content of the dialog.&quot;&quot;&quot;</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="n">option</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="n">section</span><span class="p">(</span><span class="s2">&quot;FLAC&quot;</span><span class="p">)</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;flac_encode_options&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;FLAC&quot;</span><span class="p">][</span><span class="s2">&quot;flac_encode_options&quot;</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">EditVorbisCommentsConfigurationDialog</span><span class="p">(</span><span class="n">_EditConfigurationDialog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dialog that allows the user to edit default FLAC Vorbis comment</span>
<span class="sd">    options from the *flacmanager.ini* configuration file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_populate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the content of the dialog.&quot;&quot;&quot;</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="n">option</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">29</span><span class="p">)</span>

        <span class="n">section</span><span class="p">(</span><span class="s2">&quot;Vorbis&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Vorbis&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">option</span><span class="p">(</span><span class="s2">&quot;Vorbis&quot;</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Vorbis&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">EditFLACOrganizationConfigurationDialog</span><span class="p">(</span><span class="n">_EditConfigurationDialog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dialog that allows the user to edit FLAC folder/file</span>
<span class="sd">    organization options from the *flacmanager.ini* configuration file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_populate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the content of the dialog.&quot;&quot;&quot;</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="n">option</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="n">section</span><span class="p">(</span><span class="s2">&quot;FLAC&quot;</span><span class="p">)</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;library_root&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;FLAC&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;library_root&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;library_subroot_trie_key&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;FLAC&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;library_subroot_trie_key&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mi">29</span><span class="p">)</span>

        <span class="c1"># there won&#39;t be any validation if this is set to a non-interpolated,</span>
        <span class="c1"># non-int value!</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;library_subroot_trie_level&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;FLAC&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;library_subroot_trie_level&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">Label</span><span class="p">(</span>
            <span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;${Organize:library_subroot_trie_level} or a number&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_row</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;album_folder&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;FLAC&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;album_folder&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;ndisc_album_folder&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;FLAC&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ndisc_album_folder&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;compilation_album_folder&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;FLAC&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compilation_album_folder&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;ndisc_compilation_album_folder&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;FLAC&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ndisc_compilation_album_folder&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;track_filename&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;FLAC&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;track_filename&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;ndisc_track_filename&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;FLAC&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ndisc_track_filename&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;compilation_track_filename&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;FLAC&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compilation_track_filename&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;ndisc_compilation_track_filename&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;FLAC&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ndisc_compilation_track_filename&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="c1"># there won&#39;t be any validation if this is set to a non-interpolated,</span>
        <span class="c1"># non-boolean (&quot;yes&quot;/&quot;no&quot;) value!</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;use_xplatform_safe_names&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;FLAC&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_xplatform_safe_names&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">Label</span><span class="p">(</span>
            <span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;${Organize:use_xplatform_safe_names}, yes, or no&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_row</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># there won&#39;t be any validation if this is set to a non-interpolated,</span>
        <span class="c1"># non-boolean (&quot;yes&quot;/&quot;no&quot;) value!</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;save_cover_image&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;FLAC&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">&quot;save_cover_image&quot;</span><span class="p">))</span>
        <span class="n">Label</span><span class="p">(</span>
            <span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;${Organize:save_cover_image}, yes, or no&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_row</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="k">class</span> <span class="nc">EditMP3EncodingConfigurationDialog</span><span class="p">(</span><span class="n">_EditConfigurationDialog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dialog that allows the user to edit MP3 encoding options from</span>
<span class="sd">    the *flacmanager.ini* configuration file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_populate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the content of the dialog.&quot;&quot;&quot;</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="n">option</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="n">section</span><span class="p">(</span><span class="s2">&quot;MP3&quot;</span><span class="p">)</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;lame_encode_options&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MP3&quot;</span><span class="p">][</span><span class="s2">&quot;lame_encode_options&quot;</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">EditID3v2TagsConfigurationDialog</span><span class="p">(</span><span class="n">_EditConfigurationDialog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dialog that allows the user to edit default MP3 ID3v2 tag</span>
<span class="sd">    options from the *flacmanager.ini* configuration file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_populate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the content of the dialog.&quot;&quot;&quot;</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="n">option</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">29</span><span class="p">)</span>

        <span class="n">section</span><span class="p">(</span><span class="s2">&quot;ID3v2&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;ID3v2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">option</span><span class="p">(</span><span class="s2">&quot;ID3v2&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;ID3v2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">EditMP3OrganizationConfigurationDialog</span><span class="p">(</span><span class="n">_EditConfigurationDialog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dialog that allows the user to edit MP3 folder/file</span>
<span class="sd">    organization options from the *flacmanager.ini* configuration file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_populate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the content of the dialog.&quot;&quot;&quot;</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="n">option</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="n">section</span><span class="p">(</span><span class="s2">&quot;MP3&quot;</span><span class="p">)</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;library_root&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MP3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;library_root&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;library_subroot_trie_key&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MP3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;library_subroot_trie_key&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mi">29</span><span class="p">)</span>

        <span class="c1"># there won&#39;t be any validation if this is set to a non-interpolated,</span>
        <span class="c1"># non-int value!</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;library_subroot_trie_level&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MP3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;library_subroot_trie_level&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">Label</span><span class="p">(</span>
            <span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;${Organize:library_subroot_trie_level} or a number&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_row</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;album_folder&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MP3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;album_folder&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;ndisc_album_folder&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MP3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ndisc_album_folder&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;compilation_album_folder&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MP3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compilation_album_folder&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;ndisc_compilation_album_folder&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MP3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ndisc_compilation_album_folder&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;track_filename&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MP3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;track_filename&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;ndisc_track_filename&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MP3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ndisc_track_filename&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;compilation_track_filename&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MP3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compilation_track_filename&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;ndisc_compilation_track_filename&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MP3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ndisc_compilation_track_filename&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="c1"># there won&#39;t be any validation if this is set to a non-interpolated,</span>
        <span class="c1"># non-boolean (&quot;yes&quot;/&quot;no&quot;) value!</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;use_xplatform_safe_names&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MP3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_xplatform_safe_names&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">Label</span><span class="p">(</span>
            <span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;${Organize:use_xplatform_safe_names}, yes, or no&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_row</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># there won&#39;t be any validation if this is set to a non-interpolated,</span>
        <span class="c1"># non-boolean (&quot;yes&quot;/&quot;no&quot;) value!</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;save_cover_image&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;MP3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">&quot;save_cover_image&quot;</span><span class="p">))</span>
        <span class="n">Label</span><span class="p">(</span>
            <span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;${Organize:save_cover_image}, yes, or no&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_row</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="k">class</span> <span class="nc">EditUserInterfaceConfigurationDialog</span><span class="p">(</span><span class="n">_EditConfigurationDialog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dialog that allows the user to edit user interface settings</span>
<span class="sd">    from the *flacmanager.ini* file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_populate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the content of the dialog.&quot;&quot;&quot;</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="n">option</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="n">section</span><span class="p">(</span><span class="s2">&quot;UI&quot;</span><span class="p">)</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;UI&quot;</span><span class="p">,</span> <span class="s2">&quot;minwidth&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;UI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;minwidth&quot;</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;UI&quot;</span><span class="p">,</span> <span class="s2">&quot;minheight&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;UI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;minheight&quot;</span><span class="p">,</span> <span class="mi">768</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">option</span><span class="p">(</span><span class="s2">&quot;UI&quot;</span><span class="p">,</span> <span class="s2">&quot;padx&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;UI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;padx&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">option</span><span class="p">(</span><span class="s2">&quot;UI&quot;</span><span class="p">,</span> <span class="s2">&quot;pady&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;UI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;pady&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;UI&quot;</span><span class="p">,</span> <span class="s2">&quot;encoding_max_visible_tracks&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;UI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;encoding_max_visible_tracks&quot;</span><span class="p">,</span> <span class="mi">29</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">EditLoggingConfigurationDialog</span><span class="p">(</span><span class="n">_EditConfigurationDialog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dialog that allows the user to edit logging and debug settings</span>
<span class="sd">    from the *flacmanager.ini* file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_populate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the content of the dialog.&quot;&quot;&quot;</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="n">option</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="n">section</span><span class="p">(</span><span class="s2">&quot;Logging&quot;</span><span class="p">)</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;TRACE&quot;</span><span class="p">,</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span> <span class="s2">&quot;WARNING&quot;</span><span class="p">,</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">,</span> <span class="s2">&quot;CRITICAL&quot;</span><span class="p">]</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Logging&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;level&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;Logging&quot;</span><span class="p">,</span> <span class="s2">&quot;level&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="n">level</span> <span class="k">if</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">levels</span> <span class="k">else</span> <span class="s2">&quot;INFO&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">levels</span><span class="p">)</span>
        <span class="n">option</span><span class="p">(</span><span class="s2">&quot;Logging&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Logging&quot;</span><span class="p">][</span><span class="s2">&quot;filename&quot;</span><span class="p">])</span>
        <span class="n">option</span><span class="p">(</span><span class="s2">&quot;Logging&quot;</span><span class="p">,</span> <span class="s2">&quot;filemode&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Logging&quot;</span><span class="p">][</span><span class="s2">&quot;filemode&quot;</span><span class="p">])</span>
        <span class="n">option</span><span class="p">(</span><span class="s2">&quot;Logging&quot;</span><span class="p">,</span> <span class="s2">&quot;format&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Logging&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="n">section</span><span class="p">(</span><span class="s2">&quot;HTTP&quot;</span><span class="p">)</span>
        <span class="n">option</span><span class="p">(</span>
            <span class="s2">&quot;HTTP&quot;</span><span class="p">,</span> <span class="s2">&quot;debuglevel&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;HTTP&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;debuglevel&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>


<span class="c1">#: A list of recommended and proposed Vorbis comment names.</span>
<span class="n">_VORBIS_COMMENTLIST</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># https://xiph.org/vorbis/doc/v-comment.html</span>
    <span class="c1"># [1] https://wiki.xiph.org/Field_names</span>
    <span class="c1"># [2] http://age.hobba.nl/audio/mirroredpages/ogg-tagging.html</span>
    <span class="c1"># [3] http://reallylongword.org/vorbiscomment/</span>
    <span class="s2">&quot;ALBUM (collection name)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ARRANGER (who arranged the piece)&quot;</span><span class="p">,</span> <span class="c1"># [2]</span>
    <span class="s2">&quot;ARTIST (artist responsible for the work)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AUTHOR (author of spoken work)&quot;</span><span class="p">,</span> <span class="c1"># [2]</span>
    <span class="s2">&quot;CATALOGNUMBER (producer/label catalog number)&quot;</span><span class="p">,</span> <span class="c1"># [3]</span>
    <span class="s2">&quot;COMMENT (user comment)&quot;</span><span class="p">,</span> <span class="c1"># [2]</span>
    <span class="s2">&quot;COMPOSER (composer of the work)&quot;</span><span class="p">,</span> <span class="c1"># [1]</span>
    <span class="s2">&quot;CONDUCTOR (conductor of the work)&quot;</span><span class="p">,</span> <span class="c1"># [2]</span>
    <span class="s2">&quot;CONTACT (creator/distributor contact info)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;COPYRIGHT (Copyright attribution)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DATE (recording date)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DESCRIPTION (description of contents)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DISCNUMBER (multi-disc number)&quot;</span><span class="p">,</span> <span class="c1"># [1]</span>
    <span class="s2">&quot;DISCTOTAL (number of discs)&quot;</span><span class="p">,</span> <span class="c1"># [1]</span>
    <span class="c1">#&quot;ENCODER (user application name)&quot;, # [1]</span>
    <span class="s2">&quot;ENCODING (quality/bitrate settings)&quot;</span><span class="p">,</span> <span class="c1"># [2]</span>
    <span class="s2">&quot;ENGINEER (who produced the master)&quot;</span><span class="p">,</span> <span class="c1"># [3]</span>
    <span class="s2">&quot;ENSEMBLE (group playing the piece)&quot;</span><span class="p">,</span> <span class="c1"># [2]</span>
    <span class="s2">&quot;GENRE (music genre)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GUESTARTIST (collaborative artist)&quot;</span><span class="p">,</span> <span class="c1"># [3]</span>
    <span class="s2">&quot;ISRC (International Standard Recording Code)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LABEL (record label or imprint)&quot;</span><span class="p">,</span> <span class="c1"># [2]</span>
    <span class="s2">&quot;LICENSE (License information)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LOCATION (recording location)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LYRICIST (who wrote the lyrics)&quot;</span><span class="p">,</span> <span class="c1"># [2]</span>
    <span class="s2">&quot;OPUS (number of the work)&quot;</span><span class="p">,</span> <span class="c1"># [2]</span>
    <span class="s2">&quot;ORGANIZATION (production organization)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PART (division within a work)&quot;</span><span class="p">,</span> <span class="c1"># [2]</span>
    <span class="s2">&quot;PARTNUMBER (number of the division/part)&quot;</span><span class="p">,</span> <span class="c1"># [2]</span>
    <span class="s2">&quot;PERFORMER (artist(s) who performed the work)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PRODUCER (producer of the work)&quot;</span><span class="p">,</span> <span class="c1"># [3]</span>
    <span class="s2">&quot;PRODUCTNUMBER (UPC, EAN, JAN, etc.)&quot;</span><span class="p">,</span> <span class="c1"># [1]</span>
    <span class="s2">&quot;PUBLISHER (who published the disc)&quot;</span><span class="p">,</span> <span class="c1"># [2]</span>
    <span class="s2">&quot;REMIXER (who remixed the work)&quot;</span><span class="p">,</span> <span class="c1"># [3]</span>
    <span class="s2">&quot;SOURCEARTIST (original artist of performed work)&quot;</span><span class="p">,</span> <span class="c1"># [3]</span>
    <span class="s2">&quot;SOURCEMEDIA (recording media type)&quot;</span><span class="p">,</span> <span class="c1"># [1]</span>
    <span class="s2">&quot;TITLE (Track/Work name)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRACKNUMBER (number of this piece)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRACKTOTAL (number of tracks)&quot;</span><span class="p">,</span> <span class="c1"># [1]</span>
    <span class="s2">&quot;VERSION (differentiate multiple versions)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;VOLUME (multi-volume work)&quot;</span><span class="p">,</span> <span class="c1"># [3]</span>
<span class="p">]</span>


<span class="c1">#: A list of standard and common non-standard ID3v2 frames.</span>
<span class="n">_ID3V2_TAGLIST</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># http://id3.org/id3v2.3.0 (unless otherwise noted)</span>
    <span class="s2">&quot;AENC (Audio encryption)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;APIC (Attached picture)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;COMM (Comments)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;COMR (Commercial frame)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ENCR (Encryption method registration)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;EQUA (Equalization)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ETCO (Event timing codes)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GEOB (General encapsulated object)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GRID (Group identification registration)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;IPLS (Involved people list)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LINK (Linked information)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MCDI (Music CD identifier)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MLLT (MPEG location lookup table)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OWNE (Ownership frame)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PRIV (Private frame)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PCNT (Play counter)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;POPM (Popularimeter)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;POSS (Position synchronisation frame)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RBUF (Recommended buffer size)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RVAD (Relative volume adjustment)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RVRB (Reverb)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SYLT (Synchronized lyric/text)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SYTC (Synchronized tempo codes)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TALB (Album/Movie/Show title)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TBPM (BPM (beats per minute))&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TCMP (iTunes Compilation Flag)&quot;</span><span class="p">,</span> <span class="c1"># http://id3.org/iTunes Compilation Flag</span>
    <span class="s2">&quot;TCOM (Composer)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TCON (Content type)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TCOP (Copyright message)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TDAT (Date)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TDLY (Playlist delay)&quot;</span><span class="p">,</span>
    <span class="c1">#&quot;TENC (Encoded by)&quot;,</span>
    <span class="s2">&quot;TEXT (Lyricist/Text writer)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TFLT (File type)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TIME (Time)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TIT1 (Content group description)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TIT2 (Title/songname/content description)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TIT3 (Subtitle/Description refinement)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TKEY (Initial key)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TLAN (Language(s))&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TLEN (Length)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TMED (Media type)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TOAL (Original album/movie/show title)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TOFN (Original filename)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TOLY (Original lyricist(s)/text writer(s))&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TOPE (Original artist(s)/performer(s))&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TORY (Original release year)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TOWN (File owner/licensee)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TPE1 (Lead performer(s)/Soloist(s))&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TPE2 (Band/orchestra/accompaniment)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TPE3 (Conductor/performer refinement)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TPE4 (Interpreted, remixed, or otherwise modified by)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TPOS (Part of a set)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TPUB (Publisher)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRCK (Track number/Position in set)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRDA (Recording dates)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRSN (Internet radio station name)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRSO (Internet radio station owner)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TSIZ (Size)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TSOT (iTunes Title Sort)&quot;</span><span class="p">,</span> <span class="c1"># http://id3.org/iTunes</span>
    <span class="s2">&quot;TSOP (iTunes Artist Sort)&quot;</span><span class="p">,</span> <span class="c1"># http://id3.org/iTunes</span>
    <span class="s2">&quot;TSOA (iTunes Album Sort)&quot;</span><span class="p">,</span> <span class="c1"># http://id3.org/iTunes</span>
    <span class="s2">&quot;TSO2 (iTunes Album Artist Sort)&quot;</span><span class="p">,</span> <span class="c1"># http://id3.org/iTunes</span>
    <span class="s2">&quot;TSOC (iTunes Composer Sort)&quot;</span><span class="p">,</span> <span class="c1"># http://id3.org/iTunes</span>
    <span class="s2">&quot;TSRC (ISRC (international standard recording code))&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TSSE (Software/Hardware and settings used for encoding)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TYER (Year)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TXXX (User defined text information frame)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;UFID (Unique file identifier)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;USER (Terms of use)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;USLT (Unsychronized lyric/text transcription)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WCOM (Commercial information)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WCOP (Copyright/Legal information)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WOAF (Official audio file webpage)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WOAR (Official artist/performer webpage)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WOAS (Official audio source webpage)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WORS (Official internet radio station homepage)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WPAY (Payment)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WPUB (Publishers official webpage)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WXXX (User defined URL link frame)&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="nd">@logged</span>
<span class="k">class</span> <span class="nc">EditCustomMetadataTaggingDialog</span><span class="p">(</span><span class="n">simpledialog</span><span class="o">.</span><span class="n">Dialog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base dialog that allows the user to add/change/remove custom</span>
<span class="sd">    metadata fields for Vorbis/ID3v2 tagging.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">_TaggingHelp</span><span class="p">(</span><span class="n">simpledialog</span><span class="o">.</span><span class="n">Dialog</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dialog that displays a list of known and recommended Vorbis</span>
<span class="sd">        comment names **or** standard and common non-standard ID3v2</span>
<span class="sd">        frames.</span>

<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="n">_VORBIS_HELP_TEXT</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">_ID3V2_HELP_TEXT</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="nd">@classmethod</span>
        <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_helptext</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Format the list of Vorbis comments or ID3v2 frames.</span>

<span class="sd">            :arg str type_:</span>
<span class="sd">               either &quot;Vorbis comment&quot; or &quot;ID3v2 tag&quot;</span>
<span class="sd">            :return: a text listing of Vorbis comments or ID3v2 frames</span>
<span class="sd">            :rtype: :obj:`str`</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">type_</span> <span class="o">==</span> <span class="s2">&quot;Vorbis comment&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_VORBIS_HELP_TEXT</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">_VORBIS_HELP_TEXT</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_VORBIS_COMMENTLIST</span><span class="p">)</span>
                <span class="n">text</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_VORBIS_HELP_TEXT</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># ID3v2 tag</span>
                <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_ID3V2_HELP_TEXT</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">_ID3V2_HELP_TEXT</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_ID3V2_TAGLIST</span><span class="p">)</span>
                <span class="n">text</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_ID3V2_HELP_TEXT</span>

            <span class="k">return</span> <span class="n">text</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            :arg master: the parent object of this dialog</span>
<span class="sd">            :arg str type_:</span>
<span class="sd">               either &quot;Vorbis comment&quot; or &quot;ID3v2 tag&quot;</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">type_</span> <span class="c1"># must be set BEFORE calling super __init__!</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> help&quot;</span> <span class="o">%</span> <span class="n">type_</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Populate this dialog.&quot;&quot;&quot;</span>
            <span class="n">help_list</span> <span class="o">=</span> <span class="n">scrolledtext</span><span class="o">.</span><span class="n">ScrolledText</span><span class="p">(</span>
                <span class="n">frame</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">bd</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">relief</span><span class="o">=</span><span class="n">FLAT</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="n">NONE</span><span class="p">)</span>
            <span class="n">help_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">END</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helptext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">))</span>
            <span class="n">help_list</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">DISABLED</span><span class="p">)</span>
            <span class="n">help_list</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
                <span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="n">YES</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the dialog.</span>

<span class="sd">        :arg master: the parent object of this dialog</span>
<span class="sd">        :arg metadata: the album or track metadata</span>
<span class="sd">        :arg dict keywords:</span>
<span class="sd">           *name=value* keywords used to configure this dialog</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># (vorbis_var, id3v2_var, value_var)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_widgets</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># (button, vorbis_entry, id3v2_entry, value_entry)</span>
        <span class="c1"># must come last, as it will call body(frame) before returning!</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the content of the dialog.</span>

<span class="sd">        :arg Frame frame: the frame that contains the body content</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_row</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_instructions_var</span> <span class="o">=</span> <span class="n">StringVar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_body_instructions</span><span class="p">()</span>

        <span class="n">Label</span><span class="p">(</span>
            <span class="n">frame</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_instructions_var</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="n">NW</span>
        <span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="p">,</span> <span class="n">columnspan</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_row</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">add_button</span> <span class="o">=</span> <span class="n">_styled</span><span class="p">(</span>
            <span class="n">Button</span><span class="p">(</span>
                <span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Add&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">ACTIVE</span><span class="p">,</span>
                <span class="n">command</span><span class="o">=</span><span class="k">lambda</span> <span class="n">f</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_add_field</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">frame</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">p</span><span class="p">)),</span>
            <span class="n">foreground</span><span class="o">=</span><span class="s2">&quot;Blue&quot;</span><span class="p">)</span>
        <span class="n">add_button</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>

        <span class="n">vorbis_frame</span> <span class="o">=</span> <span class="n">Frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="n">vorbis_label</span> <span class="o">=</span> <span class="n">_styled</span><span class="p">(</span>
            <span class="n">Label</span><span class="p">(</span><span class="n">vorbis_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Vorbis&quot;</span><span class="p">),</span> <span class="n">font</span><span class="o">=</span><span class="s2">&quot;-weight bold&quot;</span><span class="p">)</span>
        <span class="n">vorbis_label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">)</span>

        <span class="n">vorbis_help_button</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span>
            <span class="n">vorbis_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span>
                <span class="k">lambda</span> <span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_TaggingHelp</span><span class="p">(</span><span class="n">vorbis_frame</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="s2">&quot;Vorbis comment&quot;</span><span class="p">))</span>
        <span class="n">vorbis_help_button</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">)</span>

        <span class="n">vorbis_frame</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>

        <span class="n">id3v2_frame</span> <span class="o">=</span> <span class="n">Frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="n">id3v2_label</span> <span class="o">=</span> <span class="n">_styled</span><span class="p">(</span>
            <span class="n">Label</span><span class="p">(</span><span class="n">id3v2_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;ID3v2&quot;</span><span class="p">),</span> <span class="n">font</span><span class="o">=</span><span class="s2">&quot;-weight bold&quot;</span><span class="p">)</span>
        <span class="n">id3v2_label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">)</span>

        <span class="n">id3v2_help_button</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span>
            <span class="n">id3v2_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span>
                <span class="k">lambda</span> <span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_TaggingHelp</span><span class="p">(</span><span class="n">id3v2_frame</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="s2">&quot;ID3v2 tag&quot;</span><span class="p">))</span>
        <span class="n">id3v2_help_button</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">)</span>

        <span class="n">id3v2_frame</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>

        <span class="n">value_label</span> <span class="o">=</span> <span class="n">_styled</span><span class="p">(</span><span class="n">Label</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Value&quot;</span><span class="p">),</span> <span class="n">font</span><span class="o">=</span><span class="s2">&quot;-weight bold&quot;</span><span class="p">)</span>
        <span class="n">value_label</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_row</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="p">((</span><span class="n">vorbis_comment</span><span class="p">,</span> <span class="n">id3v2_tag</span><span class="p">),</span> <span class="n">values</span><span class="p">)</span> \
                <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__custom&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_field</span><span class="p">(</span>
                <span class="n">frame</span><span class="p">,</span> <span class="n">vorbis_comment</span><span class="o">=</span><span class="n">vorbis_comment</span><span class="p">,</span> <span class="n">id3v2_tag</span><span class="o">=</span><span class="n">id3v2_tag</span><span class="p">,</span>
                <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_body_instructions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate text instructions for the dialog.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instructions_var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="s2">&quot;Specify a Vorbis comment and/or ID3v2 tag name, and a value.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Changes to metadata are not saved unless the [Save] button is &quot;</span>
            <span class="s2">&quot;clicked.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Fields with empty comment/tag names, or an empty value, are NOT &quot;</span>
            <span class="s2">&quot;saved.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Specify multiple values by adding multiple fields with the same &quot;</span>
            <span class="s2">&quot;comment and/or tag and a different value.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">vorbis_comment</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">id3v2_tag</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Render a custom field in the dialog body.</span>

<span class="sd">        :arg parent: the object that contains the field controls</span>
<span class="sd">        :keyword str vorbis_comment: the custom Vorbis comment</span>
<span class="sd">        :keyword str id3v2_tag: the custom ID3v2 tag</span>
<span class="sd">        :keyword list values: the value(s) for the custom comment/tag</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">parent</span><span class="p">,</span> <span class="n">vorbis_comment</span><span class="o">=</span><span class="n">vorbis_comment</span><span class="p">,</span> <span class="n">id3v2_tag</span><span class="o">=</span><span class="n">id3v2_tag</span><span class="p">,</span>
            <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="c1"># len(self._fields) will be the index where references to the</span>
            <span class="c1"># variables are stored</span>
            <span class="n">fields_ix</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span>

            <span class="n">clear_button</span> <span class="o">=</span> <span class="n">_styled</span><span class="p">(</span>
                <span class="n">Button</span><span class="p">(</span>
                    <span class="n">parent</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\u00d7</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">command</span><span class="o">=</span><span class="k">lambda</span> <span class="n">f</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_clear_field</span><span class="p">,</span> <span class="n">ix</span><span class="o">=</span><span class="n">fields_ix</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">ix</span><span class="p">)),</span>
                <span class="n">foreground</span><span class="o">=</span><span class="s2">&quot;Red&quot;</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="s2">&quot;-weight bold&quot;</span><span class="p">)</span>
            <span class="n">clear_button</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">vorbis_var</span> <span class="o">=</span> <span class="n">StringVar</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">vorbis_comment</span><span class="p">)</span>
            <span class="n">vorbis_entry</span> <span class="o">=</span> <span class="n">Entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="n">vorbis_var</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>
            <span class="n">vorbis_entry</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>

            <span class="n">id3v2_var</span> <span class="o">=</span> <span class="n">StringVar</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">id3v2_tag</span><span class="p">)</span>
            <span class="n">id3v2_entry</span> <span class="o">=</span> <span class="n">Entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="n">id3v2_var</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
            <span class="n">id3v2_entry</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>

            <span class="n">value_var</span> <span class="o">=</span> <span class="n">StringVar</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
            <span class="n">value_entry</span> <span class="o">=</span> <span class="n">Entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="n">value_var</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">59</span><span class="p">)</span>
            <span class="n">value_entry</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">vorbis_var</span><span class="p">,</span> <span class="n">id3v2_var</span><span class="p">,</span> <span class="n">value_var</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_widgets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">clear_button</span><span class="p">,</span> <span class="n">vorbis_entry</span><span class="p">,</span> <span class="n">id3v2_entry</span><span class="p">,</span> <span class="n">value_entry</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_row</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_clear_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear (effectively removing) the *index* -th field.</span>

<span class="sd">        :arg int index: index into the *fields* list of variables</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
            <span class="n">var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_widgets</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
            

    <span class="k">def</span> <span class="nf">buttonbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the buttons to save and/or dismiss the dialog.&quot;&quot;&quot;</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">Frame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">Button</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Save&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
            <span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">)</span>

        <span class="n">Button</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Cancel&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cancel</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
            <span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="n">_PADX</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="n">_PADY</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Return&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Escape&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancel</span><span class="p">)</span>

        <span class="n">box</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save changes to *metadata*.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="n">custom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">vorbis_var</span><span class="p">,</span> <span class="n">id3v2_var</span><span class="p">,</span> <span class="n">value_var</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="n">vorbis_comment</span> <span class="o">=</span> <span class="n">vorbis_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">id3v2_tag</span> <span class="o">=</span> <span class="n">id3v2_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="p">(</span><span class="n">vorbis_comment</span> <span class="ow">or</span> <span class="n">id3v2_tag</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">vorbis_comment</span><span class="p">,</span> <span class="n">id3v2_tag</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">custom</span><span class="p">:</span>
                    <span class="n">custom</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">custom</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;saved custom </span><span class="si">%r</span><span class="s2"> = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">vorbis_comment</span> <span class="ow">or</span> <span class="n">id3v2_tag</span> <span class="ow">or</span> <span class="n">value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;ignoring (</span><span class="si">%r</span><span class="s2">, </span><span class="si">%r</span><span class="s2">) = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">vorbis_comment</span><span class="p">,</span> <span class="n">id3v2_tag</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="nd">@logged</span>
<span class="k">class</span> <span class="nc">EditAlbumCustomMetadataTaggingDialog</span><span class="p">(</span><span class="n">EditCustomMetadataTaggingDialog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dialog that allows the user to add/change/remove custom metadata</span>
<span class="sd">    fields for *all tracks* (i.e. the album) at once for Vorbis/ID3v2</span>
<span class="sd">    tagging.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master</span><span class="p">,</span> <span class="n">album_metadata</span><span class="p">,</span> <span class="n">tracks_metadata</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the dialog.</span>

<span class="sd">        :arg master: the parent object of this dialog</span>
<span class="sd">        :arg album_metadata: the album metadata</span>
<span class="sd">        :arg tracks_metadata: the track metadata</span>
<span class="sd">        :arg dict keywords:</span>
<span class="sd">           *name=value* keywords used to configure this dialog</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">album_metadata</span><span class="p">,</span> <span class="n">tracks_metadata</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tracks_metadata</span> <span class="o">=</span> <span class="n">tracks_metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleared</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="c1"># must come last, as it will call body(frame) before returning!</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">album_metadata</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_body_instructions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate text instructions for the dialog.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_body_instructions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instructions_var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instructions_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
            <span class="s2">&quot;Changes applied (saved) to custom metadata tagging fields at the &quot;</span>
            <span class="s2">&quot;album level are applied to ALL tracks.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">vorbis_comment</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">id3v2_tag</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Render a custom field in the dialog body.</span>

<span class="sd">        :arg parent: the object that contains the field controls</span>
<span class="sd">        :keyword str vorbis_comment: the custom Vorbis comment</span>
<span class="sd">        :keyword str id3v2_tag: the custom ID3v2 tag</span>
<span class="sd">        :keyword list values: the value(s) for the custom comment/tag</span>

<span class="sd">        If adding an already-populated field, the entry widgets will be</span>
<span class="sd">        disabled. This is a bit ugly, but it greatly simplifies change</span>
<span class="sd">        tracking - modify is modeled as a remove-then-add operation</span>
<span class="sd">        instead of having to keep track of old and new values.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">parent</span><span class="p">,</span> <span class="n">vorbis_comment</span><span class="o">=</span><span class="n">vorbis_comment</span><span class="p">,</span> <span class="n">id3v2_tag</span><span class="o">=</span><span class="n">id3v2_tag</span><span class="p">,</span>
            <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_add_field</span><span class="p">(</span>
            <span class="n">parent</span><span class="p">,</span> <span class="n">vorbis_comment</span><span class="o">=</span><span class="n">vorbis_comment</span><span class="p">,</span> <span class="n">id3v2_tag</span><span class="o">=</span><span class="n">id3v2_tag</span><span class="p">,</span>
            <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">vorbis_comment</span> <span class="ow">or</span> <span class="n">id3v2_tag</span><span class="p">)</span> <span class="ow">and</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">added</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_widgets</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">):]:</span>
                <span class="k">for</span> <span class="n">widget</span> <span class="ow">in</span> <span class="n">added</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">DISABLED</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clear_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear (effectively removing) the *index* -th field.</span>

<span class="sd">        :arg int index: index into the *fields* list of variables</span>

<span class="sd">        This method keeps track of which fields have been cleared so</span>
<span class="sd">        that the changes can be &quot;replayed&quot; for each track.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="c1"># Vorbis comment</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="c1"># ID3v2 tag</span>
        <span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="c1"># value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleared</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_clear_field</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save changes to the album metadata.</span>

<span class="sd">        The changes will also be applied to all tracks.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>

        <span class="n">album_custom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tracks_metadata</span><span class="p">)):</span>
            <span class="n">track_custom</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_tracks_metadata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;__custom&quot;</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_replay_clear</span><span class="p">(</span><span class="n">track_custom</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="n">album_custom</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">track_custom</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;applied custom </span><span class="si">%r</span><span class="s2"> = </span><span class="si">%r</span><span class="s2"> to track </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_replay_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">track_custom</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear the same fields in each track that were cleared in the</span>
<span class="sd">        album.</span>

<span class="sd">        :arg dict track_custom:</span>
<span class="sd">           the custom metadata tagging fields for track *i*</span>
<span class="sd">        :arg int i:</span>
<span class="sd">           the track number</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">track_custom</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleared</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;clearing </span><span class="si">%r</span><span class="s2"> from track </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleared</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleared</span><span class="p">:</span>
            <span class="n">track_values</span> <span class="o">=</span> <span class="n">track_custom</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">track_values</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">track_values</span><span class="p">:</span>
                <span class="n">track_values</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">track_values</span> <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">value</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;cleared </span><span class="si">%r</span><span class="s2"> = </span><span class="si">%r</span><span class="s2"> from track </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">track_values</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="k">del</span> <span class="n">track_custom</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">resolve_path</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Evaluate all variables in *spec* and make sure it&#39;s absolute.</span>

<span class="sd">    :arg str spec: a directory or file path template</span>
<span class="sd">    :return: a valid, absolute file system path</span>
<span class="sd">    :rtype: :obj:`str`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

    <span class="n">resolved_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">spec</span><span class="p">))))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">resolved_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;not a valid path: &quot;</span> <span class="o">+</span> <span class="n">resolved_path</span><span class="p">)</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="n">resolved_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resolved_path</span>


<div class="viewcode-block" id="encode_flac"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.encode_flac">[docs]</a><span class="k">def</span> <span class="nf">encode_flac</span><span class="p">(</span>
        <span class="n">cdda_filename</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">,</span> <span class="n">stdout_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rip a CDDA file to a tagged FLAC file.</span>

<span class="sd">    :arg str cdda_filename: absolute CD-DA file name</span>
<span class="sd">    :arg str flac_filename: absolute *.flac* file name</span>
<span class="sd">    :arg dict track_metadata: tagging fields for this track</span>
<span class="sd">    :keyword str stdout_filename:</span>
<span class="sd">       absolute file name for redirected stdout</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
        <span class="n">cdda_filename</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">,</span>
        <span class="n">stdout_filename</span><span class="o">=</span><span class="n">stdout_filename</span><span class="p">)</span>

    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;flac&quot;</span><span class="p">]</span>
    <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;flac_encode_options&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]:</span>
        <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--picture=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">])</span>

    <span class="n">vorbis_comments</span> <span class="o">=</span> <span class="n">make_vorbis_comments</span><span class="p">(</span><span class="n">track_metadata</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="n">vorbis_comments</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--tag=</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">])</span>

    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--output-name=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">flac_filename</span><span class="p">)</span>
    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cdda_filename</span><span class="p">)</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;command = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stdout_filename</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">stdout_filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span>
                <span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;finished </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="decode_wav"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.decode_wav">[docs]</a><span class="k">def</span> <span class="nf">decode_wav</span><span class="p">(</span><span class="n">flac_filename</span><span class="p">,</span> <span class="n">wav_filename</span><span class="p">,</span> <span class="n">stdout_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a FLAC file to a WAV file.</span>

<span class="sd">    :arg str flac_filename: absolute *.flac* file name</span>
<span class="sd">    :arg str wav_filename: absolute *.wav* file name</span>
<span class="sd">    :keyword str stdout_filename:</span>
<span class="sd">       absolute file name for redirected stdout</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">flac_filename</span><span class="p">,</span> <span class="n">wav_filename</span><span class="p">,</span> <span class="n">stdout_filename</span><span class="o">=</span><span class="n">stdout_filename</span><span class="p">)</span>

    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;flac&quot;</span><span class="p">,</span> <span class="s2">&quot;--decode&quot;</span><span class="p">]</span>
    <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;flac_decode_options&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--output-name=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">wav_filename</span><span class="p">)</span>
    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flac_filename</span><span class="p">)</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;command = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stdout_filename</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">stdout_filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span>
                <span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;finished </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">wav_filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="encode_mp3"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.encode_mp3">[docs]</a><span class="k">def</span> <span class="nf">encode_mp3</span><span class="p">(</span>
        <span class="n">wav_filename</span><span class="p">,</span> <span class="n">mp3_filename</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">stdout_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a WAV file to an MP3 file.</span>

<span class="sd">    :arg str wav_filename: absolute *.wav* file name</span>
<span class="sd">    :arg str mp3_filename: absolute *.mp3* file name</span>
<span class="sd">    :arg dict track_metadata: tagging fields for this track</span>
<span class="sd">    :keyword float scale:</span>
<span class="sd">      multiply PCM data by this factor</span>
<span class="sd">    :keyword str stdout_filename:</span>
<span class="sd">       absolute file name for redirected stdout</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
        <span class="n">wav_filename</span><span class="p">,</span> <span class="n">mp3_filename</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
        <span class="n">stdout_filename</span><span class="o">=</span><span class="n">stdout_filename</span><span class="p">)</span>

    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lame&quot;</span><span class="p">]</span>
    <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_config</span><span class="p">()[</span><span class="s2">&quot;MP3&quot;</span><span class="p">][</span><span class="s2">&quot;lame_encode_options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--scale&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">scale</span><span class="p">])</span>
    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--id3v2-only&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]:</span>
        <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--ti&quot;</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]])</span>

    <span class="n">id3v2_tags</span> <span class="o">=</span> <span class="n">make_id3v2_tags</span><span class="p">(</span><span class="n">track_metadata</span><span class="p">)</span>
    <span class="n">id3v2_utf16_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="n">id3v2_tags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># ID3v2 spec calls for &#39;/&#39; separator, but iTunes only handles &#39;,&#39;</span>
        <span class="c1"># separator correctly</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">tag</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
            <span class="n">id3v2_utf16_tags</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--tv&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--tv&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">])</span>

    <span class="c1"># add any UTF-16 tags</span>
    <span class="k">if</span> <span class="n">id3v2_utf16_tags</span><span class="p">:</span>
        <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--id3v2-utf16&quot;</span><span class="p">)</span>
        <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">id3v2_utf16_tags</span><span class="p">)</span>

    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wav_filename</span><span class="p">)</span>
    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mp3_filename</span><span class="p">)</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;command = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stdout_filename</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">stdout_filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span>
                <span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;finished </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mp3_filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="make_vorbis_comments"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.make_vorbis_comments">[docs]</a><span class="k">def</span> <span class="nf">make_vorbis_comments</span><span class="p">(</span><span class="n">metadata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create Vorbis comments for tagging from *metadata*.</span>

<span class="sd">    :arg dict metadata: the metadata for a single track</span>
<span class="sd">    :return: Vorbis comment name/value pairs</span>
<span class="sd">    :rtype: :obj:`dict`</span>

<span class="sd">    .. seealso::</span>

<span class="sd">       `Ogg Vorbis I format specification: comment field and header specification &lt;https://xiph.org/vorbis/doc/v-comment.html&gt;`_</span>
<span class="sd">          The only (?) &quot;official recommendation&quot; for Vorbis comments</span>

<span class="sd">       `Xiph Wiki: VorbisComment &lt;https://wiki.xiph.org/VorbisComment&gt;`_</span>
<span class="sd">          a (very) basic metadata format</span>

<span class="sd">       `Xiph Wiki: Field_names &lt;https://wiki.xiph.org/Field_names&gt;`_</span>
<span class="sd">          official (?) proposed updates to the VorbisComment recommendations</span>

<span class="sd">       `Ogg Vorbis Comment Field Recommendations &lt;http://age.hobba.nl/audio/mirroredpages/ogg-tagging.html&gt;`_</span>
<span class="sd">          Just a proposal, but linked directly from Xiph Wiki</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

    <span class="n">comments</span> <span class="o">=</span> <span class="n">_make_tagging_map</span><span class="p">(</span><span class="s2">&quot;Vorbis&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

    <span class="c1"># only use COMPILATION=1</span>
    <span class="k">if</span> <span class="n">comments</span><span class="p">[</span><span class="s2">&quot;COMPILATION&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">]:</span>
        <span class="k">del</span> <span class="n">comments</span><span class="p">[</span><span class="s2">&quot;COMPILATION&quot;</span><span class="p">]</span>

    <span class="c1"># flac automatically includes a vendor string to identify itself</span>
    <span class="n">comments</span><span class="p">[</span><span class="s2">&quot;ENCODER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;http://ninthtest.info/flac-mp3-audio-manager/ </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">__version__</span><span class="p">]</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">comments</span></div>


<div class="viewcode-block" id="make_id3v2_tags"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.make_id3v2_tags">[docs]</a><span class="k">def</span> <span class="nf">make_id3v2_tags</span><span class="p">(</span><span class="n">metadata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create ID3v2 frames for tagging from *metadata*.</span>

<span class="sd">    :arg dict metadata: the metadata for a single track</span>
<span class="sd">    :return: ID3v2 frame name/value pairs</span>
<span class="sd">    :rtype: :obj:`dict`</span>

<span class="sd">    .. seealso::</span>

<span class="sd">       `ID3 tag version 2.3.0 &lt;http://id3.org/id3v2.3.0&gt;`_</span>
<span class="sd">          The most compatible standard for ID3 tagging</span>

<span class="sd">       http://id3.org/iTunes</span>
<span class="sd">          ID3 tagging idiosyncracies in Apple iTunes</span>

<span class="sd">       `MusicBrainz Picard &lt;http://picard.musicbrainz.org/&gt;`_</span>
<span class="sd">          FLACManager does its best to get the tagging right the first</span>
<span class="sd">          time, but Picard is a fantastic post-encoding fixer-upper.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

    <span class="n">tags</span> <span class="o">=</span> <span class="n">_make_tagging_map</span><span class="p">(</span><span class="s2">&quot;ID3v2&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

    <span class="c1"># only use TCMP=1</span>
    <span class="k">if</span> <span class="n">tags</span><span class="p">[</span><span class="s2">&quot;TCMP&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">]:</span>
        <span class="k">del</span> <span class="n">tags</span><span class="p">[</span><span class="s2">&quot;TCMP&quot;</span><span class="p">]</span>

    <span class="c1"># lame automatically includes TSSE to identify itself</span>
    <span class="n">tags</span><span class="p">[</span><span class="s2">&quot;TENC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;http://ninthtest.info/flac-mp3-audio-manager/&quot;</span><span class="p">]</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tags</span></div>


<span class="k">def</span> <span class="nf">_make_tagging_map</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create Vorbis comments or ID3v2 frames for tagging from</span>
<span class="sd">    *metadata*.</span>

<span class="sd">    :arg str type_:</span>
<span class="sd">       &quot;Vorbis&quot; or &quot;ID3v2&quot; (corresponds to a tagging section in the</span>
<span class="sd">       flacmanager.ini configuration file)</span>
<span class="sd">    :arg dict metadata: the metadata for a single track</span>
<span class="sd">    :return: Vorbis commen or ID3v2 frame name/value pairs</span>
<span class="sd">    :rtype: :obj:`dict`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>

    <span class="n">tags</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="n">type_</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span> <span class="k">if</span> <span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;{&#39;</span> <span class="c1"># format specification</span>
            <span class="k">else</span> <span class="n">metadata</span><span class="p">[</span><span class="n">spec</span><span class="p">])</span> <span class="c1"># direct key lookup</span>

        <span class="c1"># only include truthy values</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">tags</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="k">else</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>

    <span class="n">_update_custom_tagging</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tags</span>


<span class="k">def</span> <span class="nf">_update_custom_tagging</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update *tags* with any custom Vorbis comments or ID3v2 tags from</span>
<span class="sd">    *metadata[&quot;__custom&quot;]* (if defined).</span>

<span class="sd">    :arg dict tags: the tagging map for a track</span>
<span class="sd">    :arg str type_: &quot;Vorbis&quot; or &quot;ID3v2&quot;</span>
<span class="sd">    :arg dict metadata: the metadata for a single track</span>

<span class="sd">    *tags* is updated in place.</span>
<span class="sd">    </span>
<span class="sd">    .. note::</span>
<span class="sd">       Custom tags with the same name as a preconfigured tag will</span>
<span class="sd">       **replace** the preconfigured tag.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;__custom&quot;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
        <span class="n">custom_tagpairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">((</span><span class="n">vorbis_comment</span><span class="p">,</span> <span class="n">id3v2_tag</span><span class="p">),</span> <span class="n">values</span><span class="p">)</span> \
                <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">type_</span> <span class="o">==</span> <span class="s2">&quot;Vorbis&quot;</span> <span class="ow">and</span> <span class="n">vorbis_comment</span><span class="p">:</span>
                <span class="n">custom_tagpairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">vorbis_comment</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">type_</span> <span class="o">==</span> <span class="s2">&quot;ID3v2&quot;</span> <span class="ow">and</span> <span class="n">id3v2_tag</span><span class="p">:</span>
                <span class="n">custom_tagpairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">id3v2_tag</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;skipping custom (</span><span class="si">%r</span><span class="s2">, </span><span class="si">%r</span><span class="s2">) = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">vorbis_comment</span><span class="p">,</span> <span class="n">id3v2_tag</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;custom tag pairs (before formatting):</span><span class="se">\n</span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">custom_tagpairs</span><span class="p">)</span>

        <span class="n">custom_tags</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="n">custom_tagpairs</span><span class="p">:</span>
            <span class="c1"># custom values are always formatted, but only keep if non-empty</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">value</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">values</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">custom_tags</span><span class="p">:</span>
                    <span class="n">custom_tags</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">custom_tags</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

                <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;custom </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">custom_tags</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;custom </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> evaluated to an empty list&quot;</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">custom_tags</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;updating tagging map with </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">custom_tags</span><span class="p">)</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">custom_tags</span><span class="p">)</span>


<span class="c1">#: Used to pass data between a :class:`FLACEncoder` thread and the main</span>
<span class="c1">#: thread.</span>
<span class="n">_ENCODING_QUEUE</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">PriorityQueue</span><span class="p">()</span>

<span class="c1">#: The number of seconds to wait between enqueuing a FLAC encoding</span>
<span class="c1">#: status.</span>
<span class="n">FLAC_ENCODING_STATUS_WAIT</span> <span class="o">=</span> <span class="mf">1.25</span>


<span class="nd">@logged</span>
<div class="viewcode-block" id="FLACEncoder"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.FLACEncoder">[docs]</a><span class="k">class</span> <span class="nc">FLACEncoder</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A thread that rips CD-DA tracks to FLAC.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;``FLACEncoder`` threads are daemonized so that they are</span>
<span class="sd">        killed automatically if the program exits.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_instructions</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="FLACEncoder.add_instruction"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.FLACEncoder.add_instruction">[docs]</a>    <span class="k">def</span> <span class="nf">add_instruction</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">track_index</span><span class="p">,</span> <span class="n">cdda_filename</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">,</span> <span class="n">mp3_filename</span><span class="p">,</span>
            <span class="n">track_metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Schedule a track for FLAC encoding.</span>

<span class="sd">        :arg int track_index: index (not ordinal) of the track</span>
<span class="sd">        :arg str cdda_filename: absolute CD-DA file name</span>
<span class="sd">        :arg str flac_filename: absolute *.flac* file name</span>
<span class="sd">        :arg str mp3_filename: absolute *.mp3* file name</span>
<span class="sd">        :arg dict track_metadata: tagging fields for this track</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">track_index</span><span class="p">,</span> <span class="n">cdda_filename</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">,</span> <span class="n">mp3_filename</span><span class="p">,</span>
            <span class="n">track_metadata</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_instructions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="n">track_index</span><span class="p">,</span> <span class="n">cdda_filename</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">,</span> <span class="n">mp3_filename</span><span class="p">,</span>
                <span class="n">track_metadata</span><span class="p">))</span></div>

<div class="viewcode-block" id="FLACEncoder.run"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.FLACEncoder.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rip CD-DA tracks to FLAC.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="n">mp3_encoder_threads</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">cdda_fn</span><span class="p">,</span> <span class="n">flac_fn</span><span class="p">,</span> <span class="n">mp3_fn</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instructions</span><span class="p">:</span>
            <span class="n">stdout_fn</span> <span class="o">=</span> <span class="n">make_tempfile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.out&quot;</span><span class="p">)</span>

            <span class="c1"># the FLAC encoding must block because it needs exclusive access to</span>
            <span class="c1"># the drive; so run the status updates in a separate thread</span>
            <span class="n">status_interval_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_enqueue_status_interval</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">cdda_fn</span><span class="p">,</span> <span class="n">flac_fn</span><span class="p">,</span> <span class="n">stdout_fn</span><span class="p">),</span>
                <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">status_interval_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="n">flac_encoding_error</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">encode_flac</span><span class="p">(</span>
                    <span class="n">cdda_fn</span><span class="p">,</span> <span class="n">flac_fn</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">stdout_filename</span><span class="o">=</span><span class="n">stdout_fn</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;FLAC encoding failed&quot;</span><span class="p">)</span>
                <span class="n">flac_encoding_error</span> <span class="o">=</span> <span class="n">e</span>

            <span class="c1"># touch the done file; see _enqueue_status_interval</span>
            <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.done&quot;</span> <span class="o">%</span> <span class="n">stdout_fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># block until the status updates thread exits</span>
            <span class="n">status_interval_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">flac_encoding_error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># run the MP3 encoding in a separate thread so we can move on</span>
                <span class="c1"># to the next CD-DA -&gt; FLAC encoding; the MP3 encoder will</span>
                <span class="c1"># enqueue the &quot;TRACK_COMPLETE&quot; state when it&#39;s finished</span>
                <span class="n">mp3_encoder</span> <span class="o">=</span> <span class="n">MP3Encoder</span><span class="p">(</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">cdda_fn</span><span class="p">,</span> <span class="n">flac_fn</span><span class="p">,</span> <span class="n">mp3_fn</span><span class="p">,</span> <span class="n">stdout_fn</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
                <span class="n">mp3_encoder</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">mp3_encoder_threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mp3_encoder</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">cdda_fn</span><span class="p">,</span> <span class="n">flac_fn</span><span class="p">,</span> <span class="n">stdout_fn</span><span class="p">,</span> <span class="n">flac_encoding_error</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
                <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>

        <span class="c1"># make sure all MP3 encoders are done before enqueueing &quot;FINISHED&quot;</span>
        <span class="k">for</span> <span class="n">mp3_encoder_thread</span> <span class="ow">in</span> <span class="n">mp3_encoder_threads</span><span class="p">:</span>
            <span class="n">mp3_encoder_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">cdda_fn</span><span class="p">,</span> <span class="n">flac_fn</span><span class="p">,</span> <span class="n">stdout_fn</span><span class="p">,</span> <span class="s2">&quot;FINISHED&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="mi">13</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>

        <span class="c1"># do not terminate until &quot;FINISHED&quot; status has been processed</span>
        <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;thread is exiting&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_enqueue_status_interval</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">track_index</span><span class="p">,</span> <span class="n">cdda_filename</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">,</span>
            <span class="n">stdout_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enqueue a status update notification on an interval.</span>

<span class="sd">        :arg int track_index: index (**not** ordinal) of the track</span>
<span class="sd">        :arg str cdda_filename: absolute CD-DA file name</span>
<span class="sd">        :arg str flac_filename: absolute .flac file name</span>
<span class="sd">        :keyword str stdout_filename:</span>
<span class="sd">           absolute file name for redirected stdout</span>

<span class="sd">        .. note::</span>
<span class="sd">           This method is run in a separate thread (see :meth:`run`).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># enqueueing this status causes UI to read latest status line from the</span>
        <span class="c1"># stdout file</span>
        <span class="n">status</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">track_index</span><span class="p">,</span> <span class="n">cdda_filename</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">,</span> <span class="n">stdout_filename</span><span class="p">,</span>
            <span class="n">TRACK_ENCODING_FLAC</span><span class="p">)</span>

        <span class="c1"># when the FLAC encoding is complete, this file will be created whether</span>
        <span class="c1"># an error occurred or not</span>
        <span class="n">done_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.done&quot;</span> <span class="o">%</span> <span class="n">stdout_filename</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2"> every </span><span class="si">%s</span><span class="s2"> seconds...&quot;</span><span class="p">,</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">FLAC_ENCODING_STATUS_WAIT</span><span class="p">)</span>

        <span class="c1"># as long as the &quot;.done&quot; file doesn&#39;t exist, keep telling the UI to</span>
        <span class="c1"># read a status update from the stdout file</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">done_filename</span><span class="p">):</span>
            <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="mi">7</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">FLAC_ENCODING_STATUS_WAIT</span><span class="p">)</span></div>


<span class="nd">@logged</span>
<div class="viewcode-block" id="MP3Encoder"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.MP3Encoder">[docs]</a><span class="k">class</span> <span class="nc">MP3Encoder</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A thread that converts WAV files to MP3 files.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">track_index</span><span class="p">,</span> <span class="n">cdda_filename</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">,</span> <span class="n">mp3_filename</span><span class="p">,</span>
            <span class="n">stdout_filename</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg int track_index: index (not ordinal) of the track</span>
<span class="sd">        :arg str cdda_filename: absolute CD-DA file name</span>
<span class="sd">        :arg str flac_filename: absolute *.flac* file name</span>
<span class="sd">        :arg str stdout_filename:</span>
<span class="sd">           absolute file name for redirected stdout</span>
<span class="sd">        :arg dict track_metadata: tagging fields for this track</span>

<span class="sd">        ``MP3Encoder`` threads are daemonized so that they are killed</span>
<span class="sd">        automatically if the program exits.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">track_index</span><span class="p">,</span> <span class="n">cdda_filename</span><span class="p">,</span> <span class="n">flac_filename</span><span class="p">,</span> <span class="n">mp3_filename</span><span class="p">,</span>
            <span class="n">stdout_filename</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">track_index</span> <span class="o">=</span> <span class="n">track_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cdda_filename</span> <span class="o">=</span> <span class="n">cdda_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flac_filename</span> <span class="o">=</span> <span class="n">flac_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mp3_filename</span> <span class="o">=</span> <span class="n">mp3_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout_filename</span> <span class="o">=</span> <span class="n">stdout_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_metadata</span> <span class="o">=</span> <span class="n">track_metadata</span>

<div class="viewcode-block" id="MP3Encoder.run"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.MP3Encoder.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Decode FLAC to WAV, then encode WAV to MP3.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="n">flac_basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flac_filename</span><span class="p">)</span>
        <span class="n">wav_tempdir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;fm&quot;</span><span class="p">)</span>
        <span class="n">wav_basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">flac_basename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.wav&quot;</span>
        <span class="n">wav_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wav_tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">wav_basename</span><span class="p">)</span>

        <span class="c1"># make sure the UI gets a status update for decoding FLAC to WAV</span>
        <span class="n">status</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">track_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdda_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flac_filename</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout_filename</span><span class="p">,</span> <span class="n">TRACK_DECODING_WAV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">decode_wav</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flac_filename</span><span class="p">,</span> <span class="n">wav_filename</span><span class="p">,</span>
                <span class="n">stdout_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout_filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;WAV decoding failed&quot;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">wav_tempdir</span>
            <span class="n">status</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">track_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdda_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flac_filename</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stdout_filename</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
            <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># make sure the UI gets a status update for encoding WAV to MP3</span>
        <span class="n">status</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">track_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdda_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flac_filename</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout_filename</span><span class="p">,</span> <span class="n">TRACK_ENCODING_MP3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_encode_mp3</span><span class="p">(</span><span class="n">wav_filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;MP3 encoding failed&quot;</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">track_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdda_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flac_filename</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stdout_filename</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
            <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">track_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdda_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flac_filename</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stdout_filename</span><span class="p">,</span> <span class="n">TRACK_COMPLETE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
            <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="mi">11</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">wav_tempdir</span></div>

    <span class="k">def</span> <span class="nf">_encode_mp3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wav_filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Encode *wav_filename* to MP3 format.</span>

<span class="sd">        :arg str wav_filename:</span>
<span class="sd">           absolute path to a (temporary) WAV file</span>

<span class="sd">        If clipping is detected in the encoded MP3 file, *wav_filename*</span>
<span class="sd">        will be **re-encoded** with scaled PCM data until there is no</span>
<span class="sd">        clipping detected.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">encode_mp3</span><span class="p">(</span>
            <span class="n">wav_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp3_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_metadata</span><span class="p">,</span>
            <span class="n">stdout_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout_filename</span><span class="p">)</span>

        <span class="c1"># check for clipping</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read_stdout</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;WARNING: clipping occurs at the current gain.&quot;</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">:</span>
            <span class="n">clipping_occurs</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="sa">r</span><span class="s2">&quot;encode\s+again\s+using\s+\-\-scale\s+(\d+\.\d+)&quot;</span><span class="p">,</span> <span class="n">stdout</span><span class="p">)</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mf">0.99</span>

            <span class="c1"># re-encode, scaling the PCM data, until there is no clipping</span>
            <span class="k">while</span> <span class="n">clipping_occurs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;detected clipping in </span><span class="si">%s</span><span class="s2">; re-encoding at </span><span class="si">%.2f</span><span class="s2"> scale...&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mp3_filename</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">track_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdda_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flac_filename</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stdout_filename</span><span class="p">,</span> <span class="n">TRACK_REENCODING_MP3</span><span class="p">(</span><span class="n">scale</span><span class="p">))</span>
                <span class="n">_ENCODING_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>

                <span class="n">encode_mp3</span><span class="p">(</span>
                    <span class="n">wav_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp3_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_metadata</span><span class="p">,</span>
                    <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">stdout_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout_filename</span><span class="p">)</span>

                <span class="n">clipping_occurs</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;WARNING: clipping occurs at the current gain.&quot;</span>
                    <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read_stdout</span><span class="p">())</span>
                <span class="n">scale</span> <span class="o">-=</span> <span class="mf">0.01</span>

    <span class="k">def</span> <span class="nf">__read_stdout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the MP3 encoder&#39;s *stdout*.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>


<div class="viewcode-block" id="MetadataError"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataError">[docs]</a><span class="k">class</span> <span class="nc">MetadataError</span><span class="p">(</span><span class="n">FLACManagerError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The type of exception raised when metadata operations fail.&quot;&quot;&quot;</span></div>


<span class="nd">@logged</span>
<div class="viewcode-block" id="MetadataCollector"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataCollector">[docs]</a><span class="k">class</span> <span class="nc">MetadataCollector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class for collecting album and track metadata.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg flacmanager.TOC toc: a disc&#39;s table of contents</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">toc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toc</span> <span class="o">=</span> <span class="n">toc</span>

<div class="viewcode-block" id="MetadataCollector.reset"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataCollector.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize all collection fields to default (empty).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="n">number_of_tracks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">track_offsets</span><span class="p">)</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;album_title&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;album_discnumber&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;album_disctotal&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;album_compilation&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;album_artist&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;album_label&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;album_genre&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;album_year&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;album_cover&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;album_tracktotal&quot;</span><span class="p">:</span> <span class="n">number_of_tracks</span><span class="p">,</span>
            <span class="s2">&quot;__tracks&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span>  <span class="c1"># 1-based indexing</span>
            <span class="s2">&quot;__custom&quot;</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_tracks</span><span class="p">):</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;track_number&quot;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;track_include&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;track_title&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;track_artist&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;track_genre&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;track_year&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;__custom&quot;</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">(),</span>
            <span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span></div>

<div class="viewcode-block" id="MetadataCollector.collect"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataCollector.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch metadata from a service.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span></div></div>


<span class="nd">@logged</span>
<span class="k">class</span> <span class="nc">_HTTPMetadataCollector</span><span class="p">(</span><span class="n">MetadataCollector</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for HTTP/S metadata API clients.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toc</span><span class="p">,</span> <span class="n">api_host</span><span class="p">,</span> <span class="n">use_ssl</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg flacmanager.TOC toc: a disc&#39;s table of contents</span>
<span class="sd">        :arg str api_host: the API host name</span>
<span class="sd">        :keyword bool use_ssl: whether or not to use an SSL connection</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">toc</span><span class="p">,</span> <span class="n">api_host</span><span class="p">,</span> <span class="n">use_ssl</span><span class="o">=</span><span class="n">use_ssl</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">toc</span><span class="p">)</span>

        <span class="c1"># provide reasonable defaults (also see the `_ssl_context&#39; property)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_agent</span> <span class="o">=</span> <span class="n">FLACManager</span><span class="o">.</span><span class="n">USER_AGENT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;HTTP&quot;</span><span class="p">,</span> <span class="s2">&quot;timeout&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">api_host</span> <span class="o">=</span> <span class="n">api_host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_ssl</span> <span class="o">=</span> <span class="n">use_ssl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_connection</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_prepare_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize an HTTP(S) connection to a metadata API host.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ssl</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_api_conx</span> <span class="o">=</span> <span class="n">HTTPSConnection</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">api_host</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ssl_context</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_api_conx</span> <span class="o">=</span> <span class="n">HTTPConnection</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">api_host</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_ssl_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The SSL context for communicating securely with a metadata</span>
<span class="sd">        API host.</span>

<span class="sd">        :rtype: :class:`ssl.SSLContext`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span>
        <span class="n">context</span><span class="o">.</span><span class="n">set_default_verify_paths</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">context</span>

    <span class="k">def</span> <span class="nf">_api_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_headers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make an HTTP GET or POST API request.</span>

<span class="sd">        :arg str path: the request path and optional query string</span>
<span class="sd">        :keyword body: the HTTP request body</span>
<span class="sd">        :type body: :obj:`str` or :obj:`bytes`</span>
<span class="sd">        :keyword additional_headers:</span>
<span class="sd">           additional request headers (User-Agent is default)</span>
<span class="sd">        :type additional_headers:</span>
<span class="sd">           :obj:`dict` or :class:`http.client.HTTPMessage`</span>
<span class="sd">        :return:</span>
<span class="sd">           a 2-tuple containing the **closed**</span>
<span class="sd">           :class:`http.client.HTTPResponse` object and the response</span>
<span class="sd">           :obj:`bytes` (body)</span>

<span class="sd">        If *body* is not ``None``, the request will be an HTTP POST;</span>
<span class="sd">        otherwise the request will be an HTTP GET.</span>

<span class="sd">        This method handles redirects (301, 302, 303, 307 and 308)</span>
<span class="sd">        automatically.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">additional_headers</span><span class="o">=</span><span class="n">additional_headers</span><span class="p">)</span>

        <span class="n">conx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api_conx</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="n">HTTPMessage</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">additional_headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">additional_headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">headers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="s2">&quot;User-Agent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_agent</span>

        <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;POST&quot;</span> <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;GET&quot;</span>
        <span class="n">conx</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">conx</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">301</span><span class="p">,</span> <span class="mi">302</span><span class="p">,</span> <span class="mi">303</span><span class="p">,</span> <span class="mi">307</span><span class="p">,</span> <span class="mi">308</span><span class="p">]:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> is being </span><span class="si">%d</span><span class="s2">-redirected to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">conx</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span>
                <span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">])</span>

            <span class="n">url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">netloc</span> <span class="o">!=</span> <span class="n">conx</span><span class="o">.</span><span class="n">host</span>
                    <span class="ow">or</span> <span class="n">url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">!=</span>
                        <span class="p">(</span><span class="s2">&quot;https&quot;</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">conx</span><span class="p">)</span> <span class="ow">is</span> <span class="n">HTTPSConnection</span> <span class="k">else</span> <span class="s2">&quot;http&quot;</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;Connection&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;close&quot;</span><span class="p">):</span>
                <span class="n">conx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span><span class="p">:</span>
                    <span class="n">conx</span> <span class="o">=</span> <span class="n">HTTPSConnection</span><span class="p">(</span>
                        <span class="n">url</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ssl_context</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">conx</span> <span class="o">=</span> <span class="n">HTTPConnection</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>

            <span class="n">path</span> <span class="o">=</span> \
                <span class="n">url</span><span class="o">.</span><span class="n">path</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">query</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">?</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">url</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">303</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;GET&quot;</span>
                <span class="n">body</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">conx</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">conx</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;close&quot;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Connection&quot;</span><span class="p">],</span> <span class="n">response</span><span class="o">.</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;Connection&quot;</span><span class="p">]]:</span>
            <span class="n">conx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">conx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api_conx</span><span class="p">:</span>
            <span class="n">conx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_connection</span><span class="p">()</span>

        <span class="n">rv</span> <span class="o">=</span> <span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">def</span> <span class="nf">_download_album_art_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;GET an album art image over HTTP/S.</span>

<span class="sd">        :arg str url: the full URL for an album art image</span>
<span class="sd">        :return: the raw image :obj:`bytes` data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="n">request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_agent</span><span class="p">})</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ssl_context</span> <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;https:&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">geturl</span><span class="p">()</span> <span class="o">!=</span> <span class="n">url</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">geturl</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;GET </span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">getheaders</span><span class="p">())</span>
            <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>


<span class="nd">@logged</span>
<div class="viewcode-block" id="GracenoteCDDBMetadataCollector"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.GracenoteCDDBMetadataCollector">[docs]</a><span class="k">class</span> <span class="nc">GracenoteCDDBMetadataCollector</span><span class="p">(</span><span class="n">_HTTPMetadataCollector</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A Gracenote CDDB client that populates album and track metadata</span>
<span class="sd">    choices for a disc identified by its offsets.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: Host name format string for Gracenote.</span>
    <span class="n">API_HOST_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;c</span><span class="si">%s</span><span class="s2">.web.cddbp.net&quot;</span>

    <span class="c1">#: Request path for Gracenote service calls.</span>
    <span class="n">API_PATH</span> <span class="o">=</span> <span class="s2">&quot;/webapi/xml/1.0/&quot;</span>

    <span class="c1">#: Request body for a Gracenote User ID.</span>
    <span class="n">REGISTER_XML</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;&lt;QUERIES&gt;&#39;</span>
            <span class="s1">&#39;&lt;QUERY CMD=&quot;REGISTER&quot;&gt;&#39;</span>
                <span class="s1">&#39;&lt;CLIENT&gt;</span><span class="si">%s</span><span class="s1">&lt;/CLIENT&gt;&#39;</span>
            <span class="s1">&#39;&lt;/QUERY&gt;&#39;</span>
        <span class="s1">&#39;&lt;/QUERIES&gt;&#39;</span>
    <span class="p">)</span>

    <span class="c1">#: Request body for Gracenote Album summary metadata.</span>
    <span class="n">ALBUM_TOC_XML</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;&lt;QUERIES&gt;&#39;</span>
            <span class="s1">&#39;&lt;AUTH&gt;&#39;</span>
                <span class="s1">&#39;&lt;CLIENT&gt;</span><span class="si">%s</span><span class="s1">&lt;/CLIENT&gt;&#39;</span>
                <span class="s1">&#39;&lt;USER&gt;</span><span class="si">%s</span><span class="s1">&lt;/USER&gt;&#39;</span>
            <span class="s1">&#39;&lt;/AUTH&gt;&#39;</span>
            <span class="s1">&#39;&lt;LANG&gt;eng&lt;/LANG&gt;&#39;</span>
            <span class="s1">&#39;&lt;COUNTRY&gt;usa&lt;/COUNTRY&gt;&#39;</span>
            <span class="s1">&#39;&lt;QUERY CMD=&quot;ALBUM_TOC&quot;&gt;&#39;</span>
                <span class="s1">&#39;&lt;TOC&gt;&#39;</span>
                    <span class="s1">&#39;&lt;OFFSETS&gt;</span><span class="si">%s</span><span class="s1">&lt;/OFFSETS&gt;&#39;</span>
                <span class="s1">&#39;&lt;/TOC&gt;&#39;</span>
            <span class="s1">&#39;&lt;/QUERY&gt;&#39;</span>
        <span class="s1">&#39;&lt;/QUERIES&gt;&#39;</span>
    <span class="p">)</span>

    <span class="c1">#: Request body for Gracenote Album and Track detail metadata.</span>
    <span class="n">ALBUM_FETCH_XML</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;&lt;QUERIES&gt;&#39;</span>
            <span class="s1">&#39;&lt;AUTH&gt;&#39;</span>
                <span class="s1">&#39;&lt;CLIENT&gt;</span><span class="si">%s</span><span class="s1">&lt;/CLIENT&gt;&#39;</span>
                <span class="s1">&#39;&lt;USER&gt;</span><span class="si">%s</span><span class="s1">&lt;/USER&gt;&#39;</span>
            <span class="s1">&#39;&lt;/AUTH&gt;&#39;</span>
            <span class="s1">&#39;&lt;LANG&gt;eng&lt;/LANG&gt;&#39;</span>
            <span class="s1">&#39;&lt;COUNTRY&gt;usa&lt;/COUNTRY&gt;&#39;</span>
            <span class="s1">&#39;&lt;QUERY CMD=&quot;ALBUM_FETCH&quot;&gt;&#39;</span>
                <span class="s1">&#39;&lt;GN_ID&gt;</span><span class="si">%s</span><span class="s1">&lt;/GN_ID&gt;&#39;</span>
                <span class="s1">&#39;&lt;OPTION&gt;&#39;</span>
                    <span class="s1">&#39;&lt;PARAMETER&gt;SELECT_EXTENDED&lt;/PARAMETER&gt;&#39;</span>
                    <span class="s1">&#39;&lt;VALUE&gt;COVER&lt;/VALUE&gt;&#39;</span>
                <span class="s1">&#39;&lt;/OPTION&gt;&#39;</span>
                <span class="s1">&#39;&lt;OPTION&gt;&#39;</span>
                    <span class="s1">&#39;&lt;PARAMETER&gt;COVER_SIZE&lt;/PARAMETER&gt;&#39;</span>
                    <span class="s1">&#39;&lt;VALUE&gt;MEDIUM,LARGE,SMALL,THUMBNAIL,XLARGE&lt;/VALUE&gt;&#39;</span>
                <span class="s1">&#39;&lt;/OPTION&gt;&#39;</span>
                <span class="s1">&#39;&lt;OPTION&gt;&#39;</span>
                    <span class="s1">&#39;&lt;PARAMETER&gt;SELECT_DETAIL&lt;/PARAMETER&gt;&#39;</span>
                    <span class="s1">&#39;&lt;VALUE&gt;GENRE:3LEVEL&lt;/VALUE&gt;&#39;</span>
                <span class="s1">&#39;&lt;/OPTION&gt;&#39;</span>
            <span class="s1">&#39;&lt;/QUERY&gt;&#39;</span>
        <span class="s1">&#39;&lt;/QUERIES&gt;&#39;</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg flacmanager.TOC toc: a disc&#39;s table of contents</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">toc</span><span class="p">)</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Gracenote config = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">]))</span>

        <span class="n">client_id</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">,</span> <span class="s2">&quot;client_id&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">client_id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span>
                    <span class="s2">&quot;Gracenote client_id must be defined in flacmanager.ini!&quot;</span><span class="p">,</span>
                    <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;Gracenote configuration&quot;</span><span class="p">)</span>
        <span class="n">api_host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">API_HOST_TEMPLATE</span> <span class="o">%</span> <span class="n">client_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">toc</span><span class="p">,</span> <span class="n">api_host</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_client_id</span> <span class="o">=</span> <span class="n">client_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_register</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register this client with the Gracenote Web API.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="n">gn_queries</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">REGISTER_XML</span><span class="p">)</span>
        <span class="n">gn_queries</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;QUERY/CLIENT&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_id</span>

        <span class="n">gn_responses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_response</span><span class="p">(</span><span class="n">gn_queries</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">gn_responses</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;RESPONSE/USER&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;registered user_id = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span><span class="p">)</span>

        <span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;Gracenote&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span><span class="p">)</span>
        <span class="n">save_config</span><span class="p">()</span>

<div class="viewcode-block" id="GracenoteCDDBMetadataCollector.collect"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.GracenoteCDDBMetadataCollector.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate all Gracenote album metadata choices.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_register</span><span class="p">()</span>

        <span class="n">gn_queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_gn_queries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ALBUM_TOC_XML</span><span class="p">)</span>
        <span class="n">toc_offsets</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">track_offsets</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">leadout_track_offset</span><span class="p">)</span>
        <span class="n">gn_queries</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;QUERY/TOC/OFFSETS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">toc_offsets</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">gn_responses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_response</span><span class="p">(</span><span class="n">gn_queries</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MetadataError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;NO_MATCH&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;album not recognized by Gracenote&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">raise</span>

        <span class="n">last_album_ord</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">gn_responses</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;RESPONSE/ALBUM[last()]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ORD&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1"># when this equals last_album_ord, we&#39;ll send &quot;Connection: close&quot; in</span>
        <span class="c1"># the HTTP headers</span>
        <span class="n">album_ord</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">gn_album_summary</span> <span class="ow">in</span> <span class="n">gn_responses</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;RESPONSE/ALBUM&quot;</span><span class="p">):</span>
            <span class="n">gn_id</span> <span class="o">=</span> <span class="n">gn_album_summary</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;GN_ID&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="n">gn_album_detail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_album</span><span class="p">(</span>
                <span class="n">gn_id</span><span class="p">,</span> <span class="n">album_ord</span> <span class="o">==</span> <span class="n">last_album_ord</span><span class="p">)</span>

            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span>

            <span class="n">num_tracks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gn_album_detail</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;TRACK_COUNT&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_tracks</span> <span class="o">!=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_tracktotal&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;discarding </span><span class="si">%r</span><span class="s2">; expected </span><span class="si">%d</span><span class="s2"> tracks but found </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">gn_id</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_tracktotal&quot;</span><span class="p">],</span> <span class="n">num_tracks</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">title</span> <span class="o">=</span> <span class="n">gn_album_detail</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;TITLE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="k">if</span> <span class="n">title</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_title&quot;</span><span class="p">]:</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

            <span class="n">artist</span> <span class="o">=</span> <span class="n">gn_album_detail</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ARTIST&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="k">if</span> <span class="n">artist</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_artist&quot;</span><span class="p">]:</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_artist&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">artist</span><span class="p">)</span>

            <span class="n">gn_date</span> <span class="o">=</span> <span class="n">gn_album_detail</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;DATE&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">gn_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">gn_date</span><span class="o">.</span><span class="n">text</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_year&quot;</span><span class="p">]):</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gn_date</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">gn_genre</span> <span class="ow">in</span> <span class="n">gn_album_detail</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;GENRE&quot;</span><span class="p">):</span>
                <span class="n">genre</span> <span class="o">=</span> <span class="n">gn_genre</span><span class="o">.</span><span class="n">text</span>
                <span class="k">if</span> <span class="n">genre</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_genre&quot;</span><span class="p">]:</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_genre&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">genre</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">gn_url_coverart</span> <span class="ow">in</span> <span class="n">gn_album_detail</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
                    <span class="s2">&quot;URL[@TYPE=&#39;COVERART&#39;]&quot;</span><span class="p">):</span>
                <span class="n">cover_art</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_album_art_image</span><span class="p">(</span>
                    <span class="n">gn_url_coverart</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cover_art</span> <span class="ow">and</span> <span class="n">cover_art</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]:</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cover_art</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">gn_track</span> <span class="ow">in</span> <span class="n">gn_album_detail</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;TRACK&quot;</span><span class="p">):</span>
                <span class="n">track_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gn_track</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;TRACK_NUM&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

                <span class="n">track_metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span>

                <span class="c1"># sanity check:</span>
                <span class="c1"># there are cases where the ordinality of hidden tracks</span>
                <span class="c1"># preceded or interspersed by empty tracks are misnumbered as</span>
                <span class="c1"># though the empty tracks did not exist</span>
                <span class="c1"># (e.g. on the single-disc re-release of Nine Inch Nails&#39; 1992</span>
                <span class="c1"># EP &quot;Broken,&quot; the hidden tracks &quot;Physical&quot; and &quot;Suck&quot; SHOULD</span>
                <span class="c1"># be numbered 98/99, respectively, NOT 7/8 or 8/9!!!)</span>
                <span class="k">assert</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_number&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">track_number</span>

                <span class="n">title</span> <span class="o">=</span> <span class="n">gn_track</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;TITLE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
                <span class="k">if</span> <span class="n">title</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_title&quot;</span><span class="p">]:</span>
                    <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

                <span class="n">gn_artist</span> <span class="o">=</span> <span class="n">gn_track</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ARTIST&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">gn_artist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="n">gn_artist</span><span class="o">.</span><span class="n">text</span> <span class="ow">not</span> <span class="ow">in</span>
                            <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_artist&quot;</span><span class="p">]):</span>
                    <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_artist&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gn_artist</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">gn_genre</span> <span class="ow">in</span> <span class="n">gn_track</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;GENRE&quot;</span><span class="p">):</span>
                    <span class="n">genre</span> <span class="o">=</span> <span class="n">gn_genre</span><span class="o">.</span><span class="n">text</span>
                    <span class="k">if</span> <span class="n">genre</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_genre&quot;</span><span class="p">]:</span>
                        <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_genre&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">genre</span><span class="p">)</span>

            <span class="n">album_ord</span> <span class="o">+=</span> <span class="mi">1</span></div>

    <span class="k">def</span> <span class="nf">_fetch_album</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gn_id</span><span class="p">,</span> <span class="n">is_last_album</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a Gracenote &#39;ALBUM_FETCH&#39; request.</span>

<span class="sd">        :arg str gn_id: the Gracenote ID of an album</span>
<span class="sd">        :keyword bool is_last_album:</span>
<span class="sd">           whether or not this is the last album to fetch</span>
<span class="sd">        :return: a Gracenote &lt;ALBUM&gt;</span>
<span class="sd">        :rtype: :class:`xml.etree.ElementTree.Element`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">gn_id</span><span class="p">,</span> <span class="n">is_last_album</span><span class="o">=</span><span class="n">is_last_album</span><span class="p">)</span>

        <span class="n">gn_queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_gn_queries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ALBUM_FETCH_XML</span><span class="p">)</span>
        <span class="n">gn_queries</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;QUERY/GN_ID&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">gn_id</span>

        <span class="n">gn_responses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_response</span><span class="p">(</span>
            <span class="n">gn_queries</span><span class="p">,</span> <span class="n">http_keep_alive</span><span class="o">=</span><span class="n">is_last_album</span><span class="p">)</span>
        <span class="n">gn_album</span> <span class="o">=</span> <span class="n">gn_responses</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;RESPONSE/ALBUM&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="n">gn_album</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gn_album</span>

    <span class="k">def</span> <span class="nf">_prepare_gn_queries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a request object with authentication.</span>

<span class="sd">        :arg str xml:</span>
<span class="sd">           an XML template string for a Gracenote &lt;QUERIES&gt; document</span>
<span class="sd">        :return: the prepared Gracenote &lt;QUERIES&gt; document</span>
<span class="sd">        :rtype: :class:`xml.etree.ElementTree.Element`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>

        <span class="n">gn_queries</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
        <span class="n">gn_queries</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;AUTH/CLIENT&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_id</span>
        <span class="n">gn_queries</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;AUTH/USER&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="n">gn_queries</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gn_queries</span>

    <span class="k">def</span> <span class="nf">_get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gn_queries</span><span class="p">,</span> <span class="n">http_keep_alive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;POST a Gracenote request and return the response.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element gn_queries:</span>
<span class="sd">           a Gracenote &lt;QUERIES&gt; document</span>
<span class="sd">        :keyword bool http_keep_alive:</span>
<span class="sd">           whether or not to keep the Gracenote HTTP connection alive</span>
<span class="sd">        :return: a Gracenote &lt;RESPONSES&gt; document</span>
<span class="sd">        :rtype: :class:`xml.etree.ElementTree.Element`</span>
<span class="sd">        :raises MetadataError:</span>
<span class="sd">           if the Gracenote request is unsuccessful</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">gn_queries</span><span class="p">,</span> <span class="n">http_keep_alive</span><span class="o">=</span><span class="n">http_keep_alive</span><span class="p">)</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">ET</span><span class="o">.</span><span class="n">ElementTree</span><span class="p">(</span><span class="n">gn_queries</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">buf</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">gn_queries_bytes</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;gn_queries_bytes = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">gn_queries_bytes</span><span class="p">)</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;text/xml; charset=UTF-8&quot;</span><span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">http_keep_alive</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Connection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;close&quot;</span>
        <span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">response_body</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api_request</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">API_PATH</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">gn_queries_bytes</span><span class="p">,</span> <span class="n">additional_headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">gn_queries</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;QUERY&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CMD&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span>
                <span class="s2">&quot;HTTP </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">),</span>
                <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;Gracenote </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>

        <span class="n">gn_responses</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">response_body</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">))</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">gn_responses</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;RESPONSE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;STATUS&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;OK&quot;</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">gn_queries</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;QUERY&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CMD&quot;</span><span class="p">)</span>
            <span class="n">gn_message</span> <span class="o">=</span> <span class="n">gn_responses</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;MESSAGE&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gn_message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">gn_message</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">status</span>
            <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;Gracenote </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="n">gn_responses</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gn_responses</span></div>


<span class="nd">@logged</span>
<div class="viewcode-block" id="MusicBrainzMetadataCollector"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MusicBrainzMetadataCollector">[docs]</a><span class="k">class</span> <span class="nc">MusicBrainzMetadataCollector</span><span class="p">(</span><span class="n">_HTTPMetadataCollector</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A MusicBrainz client that populates album and track metadata</span>
<span class="sd">    choices for a disc identified by its MusicBrainz ID.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: Host name for all MusicBrainz service calls.</span>
    <span class="n">API_HOST</span> <span class="o">=</span> <span class="s2">&quot;musicbrainz.org&quot;</span>

    <span class="c1">#: Request path prefix for all MusicBrainz service calls.</span>
    <span class="n">API_PATH_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;/ws/2&quot;</span>

    <span class="c1">#: URL format string for cover image requests.</span>
    <span class="n">COVERART_URL_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;http://coverartarchive.org/release/</span><span class="si">%s</span><span class="s2">/front-500&quot;</span>

    <span class="c1">#: HTTP User-Agent format string for MusicBrainz requests.</span>
    <span class="n">USER_AGENT_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> ( </span><span class="si">%%</span><span class="s2">s )&quot;</span> <span class="o">%</span> <span class="n">FLACManager</span><span class="o">.</span><span class="n">USER_AGENT</span>

    <span class="c1">#: XML namespace mapping for parsing MusicBrainz responses.</span>
    <span class="n">NAMESPACES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;mb&quot;</span><span class="p">:</span> <span class="s2">&quot;http://musicbrainz.org/ns/mmd-2.0#&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1">#: A reference to the ``libdiscid`` shared library.</span>
    <span class="n">_LIBDISCID</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="MusicBrainzMetadataCollector.initialize_libdiscid"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MusicBrainzMetadataCollector.initialize_libdiscid">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_libdiscid</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load the ``libdiscid`` shared library.&quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">libdiscid_location</span> <span class="o">=</span> <span class="n">resolve_path</span><span class="p">(</span>
                <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MusicBrainz&quot;</span><span class="p">,</span> <span class="s2">&quot;libdiscid_location&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span>
                <span class="s2">&quot;MusicBrainz libdiscid_location is not valid in &quot;</span>
                    <span class="s2">&quot;flacmanager.ini&quot;</span><span class="p">,</span>
                <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;MusicBrainz configuration&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># http://jonnyjd.github.com/libdiscid/discid_8h.html</span>
            <span class="n">libdiscid</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="n">libdiscid_location</span><span class="p">)</span>

            <span class="c1"># Return a handle for a new DiscId object.</span>
            <span class="n">libdiscid</span><span class="o">.</span><span class="n">discid_new</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">()</span>
            <span class="n">libdiscid</span><span class="o">.</span><span class="n">discid_new</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">c_void_p</span>

            <span class="c1"># Provides the TOC of a known CD.</span>
            <span class="n">libdiscid</span><span class="o">.</span><span class="n">discid_put</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">C</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">)</span>
            <span class="n">libdiscid</span><span class="o">.</span><span class="n">discid_put</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">c_int</span>

            <span class="c1"># Return a MusicBrainz DiscID.</span>
            <span class="n">libdiscid</span><span class="o">.</span><span class="n">discid_get_id</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,)</span>
            <span class="n">libdiscid</span><span class="o">.</span><span class="n">discid_get_id</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">c_char_p</span>

            <span class="c1"># Release the memory allocated for the DiscId object.</span>
            <span class="n">libdiscid</span><span class="o">.</span><span class="n">discid_free</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,)</span>
            <span class="n">libdiscid</span><span class="o">.</span><span class="n">discid_free</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">cls</span><span class="o">.</span><span class="n">_LIBDISCID</span> <span class="o">=</span> <span class="n">libdiscid</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;libdiscid initialization&quot;</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="MusicBrainzMetadataCollector.calculate_disc_id"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MusicBrainzMetadataCollector.calculate_disc_id">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_disc_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">toc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the MusicBrainz Disc ID for the disc *toc*.</span>

<span class="sd">        :arg flacmanager.TOC toc: a disc&#39;s table of contents</span>
<span class="sd">        :return: a MusicBrainz Disc ID for *toc*</span>
<span class="sd">        :rtype: :obj:`str`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">toc</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_LIBDISCID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">initialize_libdiscid</span><span class="p">()</span>

        <span class="n">handle</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_LIBDISCID</span><span class="o">.</span><span class="n">discid_new</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to create a new libdiscid DiscId handle!&quot;</span><span class="p">,</span>
                    <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;MusicBrainz libdiscid&quot;</span><span class="p">)</span>

            <span class="n">offsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">toc</span><span class="o">.</span><span class="n">leadout_track_offset</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">toc</span><span class="o">.</span><span class="n">track_offsets</span><span class="p">)</span>
            <span class="n">c_int_array</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">c_int</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span>
            <span class="n">c_offsets</span> <span class="o">=</span> <span class="n">c_int_array</span><span class="p">(</span><span class="o">*</span><span class="n">offsets</span><span class="p">)</span>

            <span class="n">res</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_LIBDISCID</span><span class="o">.</span><span class="n">discid_put</span><span class="p">(</span>
                <span class="n">handle</span><span class="p">,</span>
                <span class="n">toc</span><span class="o">.</span><span class="n">first_track_number</span><span class="p">,</span> <span class="n">toc</span><span class="o">.</span><span class="n">last_track_number</span><span class="p">,</span> <span class="n">c_offsets</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> return from libdiscid.discid_put(handle, </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">, </span><span class="si">%r</span><span class="s2">)&quot;</span><span class="p">,</span>
                    <span class="n">res</span><span class="p">,</span> <span class="n">toc</span><span class="o">.</span><span class="n">first_track_number</span><span class="p">,</span> <span class="n">toc</span><span class="o">.</span><span class="n">last_track_number</span><span class="p">,</span>
                    <span class="n">offsets</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span>
                    <span class="s2">&quot;libdiscid.discid_put returned </span><span class="si">%d</span><span class="s2"> (expected 1)&quot;</span> <span class="o">%</span> <span class="n">res</span><span class="p">,</span>
                    <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;MusicBrainz libdiscid&quot;</span><span class="p">)</span>

            <span class="n">disc_id</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_LIBDISCID</span><span class="o">.</span><span class="n">discid_get_id</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;us-ascii&quot;</span><span class="p">)</span>

            <span class="bp">cls</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="n">disc_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">disc_id</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_LIBDISCID</span><span class="o">.</span><span class="n">discid_free</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
                <span class="n">handle</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">del</span> <span class="n">handle</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg flacmanager.TOC toc: a disc&#39;s table of contents</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">toc</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">toc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">API_HOST</span><span class="p">)</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;MusicBrainz config = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;MusicBrainz&quot;</span><span class="p">]))</span>

        <span class="n">contact_url_or_email</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;MusicBrainz&quot;</span><span class="p">,</span> <span class="s2">&quot;contact_url_or_email&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">contact_url_or_email</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span>
                <span class="s2">&quot;MusicBrainz contact_url_or_email must be defined in &quot;</span>
                    <span class="s2">&quot;flacmanager.ini!&quot;</span><span class="p">,</span>
                <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;MusicBrainz configuration&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">USER_AGENT_TEMPLATE</span> <span class="o">%</span> <span class="n">contact_url_or_email</span>

<div class="viewcode-block" id="MusicBrainzMetadataCollector.collect"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MusicBrainzMetadataCollector.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate all MusicBrainz album metadata choices.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="n">nsmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAMESPACES</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;using namespace map </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nsmap</span><span class="p">)</span>

        <span class="n">disc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_disc_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="p">)</span>
        <span class="n">discid_request_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_discid_request</span><span class="p">(</span><span class="n">disc_id</span><span class="p">)</span>
        <span class="n">mb_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_response</span><span class="p">(</span>
            <span class="n">discid_request_path</span><span class="p">,</span> <span class="n">nsmap</span><span class="p">,</span> <span class="n">http_keep_alive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># If there was an exact disc ID match, then the root element is &lt;disc&gt;.</span>
        <span class="c1"># Otherwise, if there was a &quot;fuzzy&quot; TOC match, then the root element is</span>
        <span class="c1"># &lt;release-list&gt;.</span>
        <span class="n">mb_release_list</span> <span class="o">=</span> <span class="n">mb_metadata</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
            <span class="s2">&quot;mb:disc/mb:release-list&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mb_release_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mb_release_list</span> <span class="o">=</span> <span class="n">mb_metadata</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                <span class="s2">&quot;mb:release-list&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mb_release_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span>
                    <span class="s2">&quot;No release list for disc ID </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">disc_id</span><span class="p">,</span>
                    <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;MusicBrainz API&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;fuzzy TOC match for disc_id </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">disc_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;exact match for disc_id </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">disc_id</span><span class="p">)</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span>
        <span class="k">for</span> <span class="n">mb_release</span> <span class="ow">in</span> <span class="n">mb_release_list</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
                <span class="s2">&quot;mb:release&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">):</span>
            <span class="c1"># ElementTree does not use QNames for attributes in the default</span>
            <span class="c1"># namespace. This is fortunate, albeit incorrect, because there&#39;s</span>
            <span class="c1"># no way to pass the namespaces map to get(), and subbing in the</span>
            <span class="c1"># default namespace URI for every attribute get would be a PITA.</span>
            <span class="n">release_mbid</span> <span class="o">=</span> <span class="n">mb_release</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;processing release </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">release_mbid</span><span class="p">)</span>

            <span class="n">title</span> <span class="o">=</span> <span class="n">mb_release</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;mb:title&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="k">if</span> <span class="n">title</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_title&quot;</span><span class="p">]:</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

            <span class="n">mb_name</span> <span class="o">=</span> <span class="n">mb_release</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                <span class="s2">&quot;mb:artist-credit/mb:name-credit/mb:artist/mb:name&quot;</span><span class="p">,</span>
                 <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mb_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">mb_name</span><span class="o">.</span><span class="n">text</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_artist&quot;</span><span class="p">]):</span>
                <span class="n">album_artist</span> <span class="o">=</span> <span class="n">mb_name</span><span class="o">.</span><span class="n">text</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_artist&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">album_artist</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">album_artist</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">mb_date</span> <span class="o">=</span> <span class="n">mb_release</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;mb:date&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mb_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">year</span> <span class="o">=</span> <span class="n">mb_date</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">year</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_year&quot;</span><span class="p">]:</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>

            <span class="c1"># NOTE: MusicBrainz does not support genre information.</span>

            <span class="n">barcode_node</span> <span class="o">=</span> <span class="n">mb_release</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;mb:barcode&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>
            <span class="c1"># issues/2</span>
            <span class="n">barcode</span> <span class="o">=</span> <span class="n">barcode_node</span><span class="o">.</span><span class="n">text</span> <span class="k">if</span> <span class="n">barcode_node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">barcode</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;BARCODE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">normalized_barcode</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^\d]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">barcode</span><span class="p">)</span>
                <span class="n">normalized_barcodes</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^\d]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">normalized_barcode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">normalized_barcodes</span><span class="p">:</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">barcode</span><span class="p">)</span>

            <span class="n">cover_art_front</span> <span class="o">=</span> <span class="n">mb_release</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                <span class="s2">&quot;mb:cover-art-archive/mb:front&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="k">if</span> <span class="n">cover_art_front</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
                <span class="n">cover_art</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_album_art_image</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">COVERART_URL_TEMPLATE</span> <span class="o">%</span> <span class="n">release_mbid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cover_art</span> <span class="ow">and</span> <span class="n">cover_art</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]:</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cover_art</span><span class="p">)</span>

            <span class="c1"># For a multi-CD release (e.g. any Global Underground), MusicBrainz</span>
            <span class="c1"># returns both discs (and track lists) in &lt;metadata&gt;. So when we</span>
            <span class="c1"># encounter any &lt;medium-list&gt; with @count &gt; 1, match the disc ID</span>
            <span class="c1"># in the &lt;disc-list&gt; explicitly, and only use the associated</span>
            <span class="c1"># &lt;track-list&gt;.</span>
            <span class="c1"># This only works when &lt;metadata&gt; is the result of an exact disc ID</span>
            <span class="c1"># match. If &lt;metadata&gt; is the result of a fuzzy TOC match, then any</span>
            <span class="c1"># release with medium-list/@count &gt; 1 won&#39;t have its track list</span>
            <span class="c1"># processed.</span>
            <span class="n">mb_medium_list</span> <span class="o">=</span> <span class="n">mb_release</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                <span class="s2">&quot;mb:medium-list&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>
            <span class="n">medium_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mb_medium_list</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">))</span>
            <span class="n">mb_track_list</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">medium_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mb_track_list</span> <span class="o">=</span> <span class="n">mb_medium_list</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                    <span class="s2">&quot;mb:medium/mb:track-list&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_disctotal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">medium_count</span>
                <span class="n">disc_path</span> <span class="o">=</span> \
                    <span class="s2">&quot;mb:medium/mb:disc-list/mb:disc[@id=&#39;</span><span class="si">%s</span><span class="s2">&#39;]&quot;</span> <span class="o">%</span> <span class="n">disc_id</span>
                <span class="n">mb_disc</span> <span class="o">=</span> <span class="n">mb_medium_list</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">disc_path</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mb_disc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">mb_position</span> <span class="o">=</span> <span class="n">mb_medium_list</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                        <span class="n">disc_path</span> <span class="o">+</span> <span class="s2">&quot;/../../mb:position&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_discnumber&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mb_position</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                    <span class="n">mb_track_list</span> <span class="o">=</span> <span class="n">mb_medium_list</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                            <span class="n">disc_path</span> <span class="o">+</span> <span class="s2">&quot;/../../mb:track-list&quot;</span><span class="p">,</span>
                            <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">mb_track_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;unable to find a suitable track list for release </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">release_mbid</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">track_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mb_track_list</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">track_count</span> <span class="o">!=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_tracktotal&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;skipping track list (expected </span><span class="si">%d</span><span class="s2"> tracks, found </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_tracktotal&quot;</span><span class="p">],</span> <span class="n">track_count</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">mb_track</span> <span class="ow">in</span> <span class="n">mb_track_list</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
                    <span class="s2">&quot;mb:track&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">):</span>
                <span class="n">track_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                    <span class="n">mb_track</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;mb:number&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

                <span class="n">track_metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">][</span><span class="n">track_number</span><span class="p">]</span>

                <span class="c1"># sanity check:</span>
                <span class="c1"># there are cases where the ordinality of hidden tracks</span>
                <span class="c1"># preceded or interspersed by empty tracks are misnumbered as</span>
                <span class="c1"># though the empty tracks did not exist</span>
                <span class="c1"># (e.g. on the single-disc re-release of Nine Inch Nails&#39; 1992</span>
                <span class="c1"># EP &quot;Broken,&quot; the hidden tracks &quot;Physical&quot; and &quot;Suck&quot; SHOULD</span>
                <span class="c1"># be numbered 98/99, respectively, NOT 7/8 or 8/9!!!)</span>
                <span class="k">assert</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_number&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">track_number</span>

                <span class="n">title</span> <span class="o">=</span> <span class="n">mb_track</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                    <span class="s2">&quot;mb:recording/mb:title&quot;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
                <span class="k">if</span> <span class="n">title</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_title&quot;</span><span class="p">]:</span>
                    <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

                <span class="n">mb_name</span> <span class="o">=</span> <span class="n">mb_track</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                    <span class="s2">&quot;mb:recording/mb:artist-credit/mb:name-credit/mb:artist/&quot;</span>
                        <span class="s2">&quot;mb:name&quot;</span><span class="p">,</span>
                    <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>
                <span class="c1"># MusicBrainz doesn&#39;t suppress the artist name even if it&#39;s the</span>
                <span class="c1"># same as the release&#39;s artist name</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mb_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="n">mb_name</span><span class="o">.</span><span class="n">text</span> <span class="o">!=</span> <span class="n">album_artist</span>
                        <span class="ow">and</span> <span class="n">mb_name</span><span class="o">.</span><span class="n">text</span> <span class="ow">not</span> <span class="ow">in</span>
                            <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_artist&quot;</span><span class="p">]):</span>
                    <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_artist&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mb_name</span><span class="o">.</span><span class="n">text</span><span class="p">)</span></div>

                <span class="c1"># NOTE: MusicBrainz does not support genre information.</span>

    <span class="k">def</span> <span class="nf">_prepare_discid_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">disc_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build a full MusicBrainz &#39;/discid&#39; request path.</span>

<span class="sd">        :arg str disc_id: a MusicBrainz Disc ID</span>
<span class="sd">        :return: the full MusicBrainz request path</span>
<span class="sd">        :rtype: :obj:`str`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">disc_id</span><span class="p">)</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/discid/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">API_PATH_PREFIX</span><span class="p">,</span> <span class="n">disc_id</span><span class="p">))</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s2">&quot;?toc=</span><span class="si">%d</span><span class="s2">+</span><span class="si">%d</span><span class="s2">+</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">first_track_number</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">track_offsets</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">leadout_track_offset</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">track_offset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">track_offsets</span><span class="p">:</span>
            <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;+</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">track_offset</span><span class="p">)</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&amp;cdstubs=no&amp;inc=artist-credits+recordings&quot;</span><span class="p">)</span>
        <span class="n">request_path</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="n">request_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request_path</span>

    <span class="k">def</span> <span class="nf">_get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_path</span><span class="p">,</span> <span class="n">nsmap</span><span class="p">,</span> <span class="n">http_keep_alive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;GET the *request_path* and return the response.</span>

<span class="sd">        :arg str request_path: a MusicBrainz HTTP request path</span>
<span class="sd">        :arg dict nsmap: namespace prefixes to URIs</span>
<span class="sd">        :keyword bool http_keep_alive:</span>
<span class="sd">           whether or not to keep the MusicBrainz HTTP connection alive</span>
<span class="sd">        :return: the MusicBrainz &lt;metadata&gt; response document</span>
<span class="sd">        :rtype: :class:`xml.etree.ElementTree.Element`</span>

<span class="sd">        If this method returns, then /metadata is guaranteed to exist;</span>
<span class="sd">        otherwise, a ``MetadataError`` with an appropriate message is</span>
<span class="sd">        rasied.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">request_path</span><span class="p">,</span> <span class="n">nsmap</span><span class="p">,</span> <span class="n">http_keep_alive</span><span class="o">=</span><span class="n">http_keep_alive</span><span class="p">)</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_agent</span><span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">http_keep_alive</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Connection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;close&quot;</span>

        <span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">response_body</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api_request</span><span class="p">(</span>
            <span class="n">request_path</span><span class="p">,</span> <span class="n">additional_headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span>
                <span class="s2">&quot;HTTP </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">),</span>
                <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;MusicBrainz API&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;Content-Type&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">parse_header</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">])</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;charset&quot;</span><span class="p">,</span> <span class="s2">&quot;ISO-8859-1&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="s2">&quot;ISO-8859-1&quot;</span>

        <span class="n">mb_response</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">response_body</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mb_response</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span>
                <span class="ow">or</span> <span class="n">mb_response</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}metadata&quot;</span> <span class="o">%</span> <span class="n">nsmap</span><span class="p">[</span><span class="s2">&quot;mb&quot;</span><span class="p">]):</span>
            <span class="n">mb_text</span> <span class="o">=</span> <span class="n">mb_response</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mb_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">mb_text</span><span class="o">.</span><span class="n">text</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> \
                    <span class="s2">&quot;Unexpected response root element &lt;</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="n">mb_response</span><span class="o">.</span><span class="n">tag</span>
            <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;MusicBrainz API&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="n">mb_response</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mb_response</span></div>


<span class="nd">@logged</span>
<div class="viewcode-block" id="MetadataPersistence"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataPersistence">[docs]</a><span class="k">class</span> <span class="nc">MetadataPersistence</span><span class="p">(</span><span class="n">MetadataCollector</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A pseudo-client that populates **persisted** album and track</span>
<span class="sd">    metadata choices for a disc.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg flacmanager.TOC toc: a disc&#39;s table of contents</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">toc</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">toc</span><span class="p">)</span>

        <span class="n">library_root</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()[</span><span class="s2">&quot;Organize&quot;</span><span class="p">][</span><span class="s2">&quot;library_root&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">library_root</span> <span class="o">=</span> <span class="n">resolve_path</span><span class="p">(</span><span class="n">library_root</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MetadataError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot use library root </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">library_root</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span>
                <span class="n">context_hint</span><span class="o">=</span><span class="s2">&quot;Metadata persistence&quot;</span><span class="p">,</span>
                <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_persistence_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">library_root</span><span class="p">,</span> <span class="s2">&quot;.metadata&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disc_id</span> <span class="o">=</span> <span class="n">MusicBrainzMetadataCollector</span><span class="o">.</span><span class="n">calculate_disc_id</span><span class="p">(</span><span class="n">toc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.json&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata_persistence_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_filename</span><span class="p">)</span>

<div class="viewcode-block" id="MetadataPersistence.reset"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataPersistence.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize all collection fields to default (empty).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restored</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># handled differently as of 0.8.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converted</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="MetadataPersistence.collect"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataPersistence.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate metadata choices from persisted data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;found </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">disc_metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">object_pairs_hook</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess</span><span class="p">(</span><span class="n">disc_metadata</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">disc_metadata</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;restored metadata </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">restored</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;did not find </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_postprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">disc_metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify *metadata* in place after deserializing from JSON.</span>

<span class="sd">        :arg dict disc_metadata: the metadata for a disc</span>

<span class="sd">        .. note::</span>
<span class="sd">           Part of post-processing is converting the deserialized JSON</span>
<span class="sd">           object from a mapping of *key* -&gt; *value* into a mapping of</span>
<span class="sd">           *key* -&gt; *list-of-values*, even though each such list will</span>
<span class="sd">           be of length one (at most). This is to maintain consistency</span>
<span class="sd">           with the regular (API client) collectors, which commonly find</span>
<span class="sd">           multiple values for each metadata field.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;__persisted&quot;</span> <span class="ow">in</span> <span class="n">disc_metadata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restored</span> <span class="o">=</span> <span class="n">disc_metadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;__persisted&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restored</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span>
                <span class="c1"># not present in persisted metadata in versions &lt;= 0.7.2</span>
                <span class="p">(</span><span class="s2">&quot;__version__&quot;</span><span class="p">,</span> <span class="n">disc_metadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;__version__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
                <span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="n">disc_metadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)),</span>
                <span class="p">(</span><span class="s2">&quot;TOC&quot;</span><span class="p">,</span> <span class="n">disc_metadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;TOC&quot;</span><span class="p">)),</span>
                <span class="c1"># not present in persisted metadata in versions &lt; 0.8.0</span>
                <span class="p">(</span><span class="s2">&quot;disc_id&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc_id</span><span class="p">),</span>
            <span class="p">])</span>

        <span class="c1"># the format of the persisted metadata is different as of 0.8.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__convert_restored_metadata</span><span class="p">(</span><span class="n">disc_metadata</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># convert album cover to byte string (raw image data) by encoding</span>
            <span class="c1"># the string to &quot;Latin-1&quot;</span>
            <span class="c1"># (see the `_convert_to_json_serializable(obj)&#39; method)</span>
            <span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="p">[</span><span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;Latin-1&quot;</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;album_title&quot;</span><span class="p">,</span>
                <span class="s2">&quot;album_artist&quot;</span><span class="p">,</span>
                <span class="s2">&quot;album_label&quot;</span><span class="p">,</span>
                <span class="s2">&quot;album_genre&quot;</span><span class="p">,</span>
                <span class="s2">&quot;album_year&quot;</span><span class="p">,</span>
                <span class="p">]:</span>
            <span class="n">disc_metadata</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> \
                <span class="p">[</span><span class="n">disc_metadata</span><span class="p">[</span><span class="n">field</span><span class="p">]]</span> <span class="k">if</span> <span class="n">disc_metadata</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="c1"># sanity check</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;album_tracktotal&quot;</span><span class="p">]</span> <span class="o">==</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">track_offsets</span><span class="p">)</span> <span class="o">==</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">track_metadata</span> <span class="ow">in</span> <span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">][</span><span class="n">t</span><span class="p">:]:</span>
            <span class="c1"># sanity check</span>
            <span class="k">assert</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_number&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">t</span>

            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;track_title&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;track_artist&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;track_genre&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;track_year&quot;</span><span class="p">,</span>
                    <span class="p">]:</span>
                <span class="n">track_metadata</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="p">[</span><span class="n">track_metadata</span><span class="p">[</span><span class="n">field</span><span class="p">]]</span> <span class="k">if</span> <span class="n">track_metadata</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="k">else</span> <span class="p">[]</span>

            <span class="n">t</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_xform_custom_keys</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">,</span> <span class="n">disc_metadata</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">track_metadata</span> <span class="ow">in</span> <span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xform_custom_keys</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__convert_restored_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">disc_metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the structure and property names of *disc_metadata* to</span>
<span class="sd">        the current FLACManager version.</span>

<span class="sd">        :arg dict disc_metadata:</span>
<span class="sd">           metadata mapping as deserialized from JSON</span>

<span class="sd">        .. note::</span>
<span class="sd">           The *disc_metadata* mapping is modified **in place**.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">disc_metadata</span><span class="p">)</span>

        <span class="n">converted</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># if data is in pre-0.8.0 structure, convert it</span>
        <span class="n">tracks_metadata</span> <span class="o">=</span> <span class="n">disc_metadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;tracks&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tracks_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;converting pre-0.8.0 persisted metadata for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">)</span>
            <span class="n">album_metadata</span> <span class="o">=</span> <span class="n">disc_metadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;album&quot;</span><span class="p">)</span>
            <span class="n">disc_metadata</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">disc_metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">album_metadata</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">album_metadata</span>
            <span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tracks_metadata</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">old_key</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;album_title&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;disc_number&quot;</span><span class="p">,</span> <span class="s2">&quot;album_discnumber&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;disc_total&quot;</span><span class="p">,</span> <span class="s2">&quot;album_disctotal&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;is_compilation&quot;</span><span class="p">,</span> <span class="s2">&quot;album_compilation&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;artist&quot;</span><span class="p">,</span> <span class="s2">&quot;album_artist&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;record_label&quot;</span><span class="p">,</span> <span class="s2">&quot;album_label&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;genre&quot;</span><span class="p">,</span> <span class="s2">&quot;album_genre&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;album_year&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;cover&quot;</span><span class="p">,</span> <span class="s2">&quot;album_cover&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;number_of_tracks&quot;</span><span class="p">,</span> <span class="s2">&quot;album_tracktotal&quot;</span><span class="p">),</span>
                    <span class="p">]:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">disc_metadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">disc_metadata</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">value</span>

            <span class="c1"># issues/4</span>
            <span class="k">if</span> <span class="s2">&quot;__custom&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">disc_metadata</span><span class="p">:</span>
                <span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

            <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">track_metadata</span> <span class="ow">in</span> <span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">][</span><span class="n">t</span><span class="p">:]:</span>
                <span class="c1"># sanity check</span>
                <span class="k">assert</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">t</span>

                <span class="k">for</span> <span class="p">(</span><span class="n">old_key</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="s2">&quot;track_number&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;include&quot;</span><span class="p">,</span> <span class="s2">&quot;track_include&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;track_title&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;artist&quot;</span><span class="p">,</span> <span class="s2">&quot;track_artist&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;genre&quot;</span><span class="p">,</span> <span class="s2">&quot;track_genre&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;track_year&quot;</span><span class="p">),</span>
                        <span class="p">]:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">track_metadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">track_metadata</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">value</span>

                    <span class="c1"># issues/4</span>
                    <span class="k">if</span> <span class="s2">&quot;__custom&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">track_metadata</span><span class="p">:</span>
                        <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

                <span class="n">t</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">converted</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;converted pre-0.8.0 persisted metadata for </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2"> structure&quot;</span>
                    <span class="s2">&quot; and format&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">,</span> <span class="n">__version__</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="n">converted</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">converted</span>

<div class="viewcode-block" id="MetadataPersistence.store"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataPersistence.store">[docs]</a>    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Persist a disc&#39;s metadata field values.</span>

<span class="sd">        :arg dict metadata: the finalized metadata for a disc</span>

<span class="sd">        Persisting the metadata field values allows for easy error</span>
<span class="sd">        recovery in the event that ripping/encoding fails (i.e. the user</span>
<span class="sd">        will not need to re-choose and/or re-enter values).</span>

<span class="sd">        .. note::</span>
<span class="sd">           The presence of persisted metadata for a disc does *not*</span>
<span class="sd">           prevent metadata aggregation. Metadata is still aggregated,</span>
<span class="sd">           but any persisted values take precedence.</span>

<span class="sd">        .. warning::</span>
<span class="sd">           Only the **first** value (i.e. the **entered** or</span>
<span class="sd">           **selected** value) for each metadata field is persisted.</span>
<span class="sd">           This value is assumed to be the preferred/intended value for</span>
<span class="sd">           the field.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_persistence_root</span><span class="p">):</span>
            <span class="c1"># doesn&#39;t work as expected for external media</span>
            <span class="c1">#os.makedirs(metadata_persistence_root, exist_ok=True)</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;mkdir&quot;</span><span class="p">,</span> <span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_persistence_root</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;created </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_persistence_root</span><span class="p">)</span>

        <span class="n">ordered_metadata</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">ordered_metadata</span><span class="p">[</span><span class="s2">&quot;__persisted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([</span>
            <span class="p">(</span><span class="s2">&quot;__version__&quot;</span><span class="p">,</span> <span class="n">__version__</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()),</span>
            <span class="p">(</span><span class="s2">&quot;TOC&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;disc_id&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc_id</span><span class="p">),</span>
        <span class="p">])</span>
        <span class="n">ordered_metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess</span><span class="p">(</span><span class="n">ordered_metadata</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
                <span class="n">ordered_metadata</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">),</span>
                <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_json_serializable</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;wrote </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">disc_metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify *metadata* in place before serializing as JSON.</span>

<span class="sd">        :arg dict disc_metadata: the metadata for a disc</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># replace temporary cover filename with raw image data (bytes)</span>
        <span class="k">if</span> <span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">],</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_xform_custom_keys</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="n">disc_metadata</span><span class="p">)</span>

        <span class="c1"># issues/5</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
        <span class="n">ndisc</span> <span class="o">=</span> <span class="s2">&quot;ndisc_&quot;</span> <span class="k">if</span> <span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;album_disctotal&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">compilation</span> <span class="o">=</span> \
            <span class="s2">&quot;compilation_&quot;</span> <span class="k">if</span> <span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;album_compilation&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">default_key_prefix</span> <span class="o">=</span> <span class="n">ndisc</span> <span class="o">+</span> <span class="n">compilation</span>
        <span class="c1"># only persist the specs if they differ from the defaults; that way,</span>
        <span class="c1"># changing the defaults will take effect for any reinserted disc</span>
        <span class="k">for</span> <span class="n">encoding</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;FLAC&quot;</span><span class="p">,</span> <span class="s2">&quot;MP3&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">field_suffix</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;subroot_trie&quot;</span><span class="p">,</span> <span class="s2">&quot;album_folder&quot;</span><span class="p">,</span> <span class="s2">&quot;track_filename&quot;</span><span class="p">]:</span>
                <span class="n">default_key</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;library_subroot_</span><span class="si">%s</span><span class="s2">trie_key&quot;</span> <span class="o">%</span> <span class="n">compilation</span>
                    <span class="k">if</span> <span class="n">field_suffix</span> <span class="o">==</span> <span class="s2">&quot;subroot_trie&quot;</span>
                    <span class="k">else</span> <span class="n">default_key_prefix</span> <span class="o">+</span> <span class="n">field_suffix</span><span class="p">)</span>
                <span class="n">default_spec</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">encoding</span><span class="p">][</span><span class="n">default_key</span><span class="p">]</span>
                <span class="n">custom_key</span> <span class="o">=</span> <span class="s2">&quot;__</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">encoding</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">field_suffix</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">disc_metadata</span><span class="p">[</span><span class="n">custom_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">default_spec</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">disc_metadata</span><span class="p">[</span><span class="n">custom_key</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">track_metadata</span> <span class="ow">in</span> <span class="n">disc_metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xform_custom_keys</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="n">track_metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_xform_custom_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert ``key`` to ``func(key)`` for each key in</span>
<span class="sd">        *metadata[&quot;__custom&quot;]*.</span>

<span class="sd">        :arg func: the key conversion function</span>
<span class="sd">        :arg dict metadata: an album or track metadata mapping</span>

<span class="sd">        Conversion is necessary because keys in JSON objects *must* be</span>
<span class="sd">        strings, but FLACManager prefers to work with 2-tuple</span>
<span class="sd">        ``(vorbis_comment, id3v2_tag)`` keys.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;__custom&quot;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">func</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">items</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;transformed __custom keys using </span><span class="si">%r</span><span class="s2">:</span><span class="se">\n</span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">func</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_convert_to_json_serializable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a JSON-serializable representation of `obj`.</span>

<span class="sd">        :arg obj:</span>
<span class="sd">           an object to be converted into a serializable JSON value</span>
<span class="sd">        :return: a JSON-serializable representation of *obj*</span>
<span class="sd">        :rtype: :obj:`str`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bytes</span><span class="p">:</span>
            <span class="c1"># JSON does not directly support binary data, so instead use the</span>
            <span class="c1"># Latin-1-decoded value, which will be properly converted to use</span>
            <span class="c1"># Unicode escape sequences by the json library.</span>
            <span class="c1"># (Unicode code points 0-255 are identical to the Latin-1 values.)</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;Latin-1&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> is not JSON serializable&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span></div>


<span class="c1">#: Used to pass data between a :class:`MetadataAggregator` thread and</span>
<span class="c1">#: the main thread.</span>
<span class="n">_AGGREGATOR_QUEUE</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="nd">@logged</span>
<div class="viewcode-block" id="MetadataAggregator"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataAggregator">[docs]</a><span class="k">class</span> <span class="nc">MetadataAggregator</span><span class="p">(</span><span class="n">MetadataCollector</span><span class="p">,</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The thread that aggregates metadata from multiple sources.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg flacmanager.TOC toc: a disc&#39;s table of contents</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">toc</span><span class="p">)</span>

        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">MetadataCollector</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toc</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span> <span class="o">=</span> <span class="n">MetadataPersistence</span><span class="p">(</span><span class="n">toc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collectors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span><span class="p">,</span> <span class="c1"># should be first</span>
            <span class="n">GracenoteCDDBMetadataCollector</span><span class="p">(</span><span class="n">toc</span><span class="p">),</span>
            <span class="n">MusicBrainzMetadataCollector</span><span class="p">(</span><span class="n">toc</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="MetadataAggregator.run"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataAggregator.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the :meth:`collect` method in another thread.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;enqueueing </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">_AGGREGATOR_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="MetadataAggregator.collect"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataAggregator.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Collect metadata from all music databases.</span>

<span class="sd">        .. note::</span>
<span class="sd">           Persisted metadata, if it exists, is also collected by this</span>
<span class="sd">           method.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="c1"># feature/toc-and-mbdiscid-tagging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">][(</span><span class="s2">&quot;MUSICBRAINZ_DISCID&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">disc_id</span><span class="p">]</span>
        <span class="c1">#TODO: self.metadata[&quot;__custom&quot;][(&quot;&quot;, &quot;MCDI&quot;)] = []</span>

        <span class="k">for</span> <span class="n">collector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collectors</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">collector</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;metadata collection error&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>

<div class="viewcode-block" id="MetadataAggregator.aggregate"><a class="viewcode-back" href="../metadata-aggregation.html#flacmanager.MetadataAggregator.aggregate">[docs]</a>    <span class="k">def</span> <span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Combine metadata from all music databases into a single</span>
<span class="sd">        mapping.</span>

<span class="sd">        .. note::</span>
<span class="sd">           If persisted metadata was collected, the persisted value for</span>
<span class="sd">           each metadata field will take precedence over any other</span>
<span class="sd">           collected values.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">collector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collectors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_merge_metadata</span><span class="p">(</span>
                <span class="n">collector</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
                <span class="n">keys</span><span class="o">=</span><span class="p">[</span>
                    <span class="s2">&quot;album_title&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;album_artist&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;album_label&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;album_genre&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;album_year&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;album_cover&quot;</span><span class="p">,</span>
                <span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_merge_metadata</span><span class="p">(</span>
                <span class="n">collector</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">],</span>
                <span class="n">keys</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">collector</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">]])</span>

            <span class="c1"># not terribly useful, but not sure what else could possibly be</span>
            <span class="c1"># done here if there are discrepancies; best to just leave it up to</span>
            <span class="c1"># the user to edit these fields appropriately</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;album_discnumber&quot;</span><span class="p">,</span> <span class="s2">&quot;album_disctotal&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">collector</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">collector</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>

            <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">track_metadata</span> <span class="ow">in</span> <span class="n">collector</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_merge_metadata</span><span class="p">(</span>
                    <span class="n">track_metadata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">][</span><span class="n">t</span><span class="p">],</span>
                    <span class="n">keys</span><span class="o">=</span><span class="p">[</span>
                        <span class="s2">&quot;track_title&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;track_artist&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;track_genre&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;track_year&quot;</span><span class="p">,</span>
                    <span class="p">])</span>

                <span class="c1"># it is possible for collectors to not find track artist and/or</span>
                <span class="c1"># genre, so make sure those fields have value(s)</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;artist&quot;</span><span class="p">,</span> <span class="s2">&quot;genre&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="s2">&quot;track_&quot;</span> <span class="o">+</span> <span class="n">field</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="s2">&quot;track_&quot;</span> <span class="o">+</span> <span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_&quot;</span> <span class="o">+</span> <span class="n">field</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_merge_metadata</span><span class="p">(</span>
                    <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="s2">&quot;__custom&quot;</span><span class="p">],</span>
                    <span class="n">keys</span><span class="o">=</span><span class="p">[</span>
                        <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="s2">&quot;__custom&quot;</span><span class="p">]])</span>

                <span class="n">t</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">track_metadata</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">]:</span>
                    <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;__custom&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># add LAME genres to album and track metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_lame_genres</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_genre&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">track_metadata</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__add_lame_genres</span><span class="p">(</span><span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_genre&quot;</span><span class="p">])</span>

        <span class="c1"># currently, neither Gracenote nor MusicBrainz provide &quot;year&quot; metadata</span>
        <span class="c1"># on a per-track basis; so if &quot;track_year&quot; is empty after aggregation,</span>
        <span class="c1"># default it to the same options as &quot;album_year&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">album_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_year&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">track_metadata</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">][</span><span class="n">t</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_year&quot;</span><span class="p">]:</span>
                <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">album_year</span><span class="p">)</span> <span class="c1"># use a copy</span>

        <span class="c1"># write album cover image data to temporary files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__save_album_covers</span><span class="p">()</span>

        <span class="c1"># persisted metadata takes precedence and provides some values not</span>
        <span class="c1"># collected by regular collectors</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">restored</span><span class="p">:</span>
            <span class="c1"># I trust myself more than the music databases :)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_discnumber&quot;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_discnumber&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_disctotal&quot;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_disctotal&quot;</span><span class="p">]</span>

            <span class="c1"># regular collectors do not track the following fields</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_compilation&quot;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_compilation&quot;</span><span class="p">]</span>
            <span class="c1"># issues/5</span>
            <span class="k">for</span> <span class="n">naming_field</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;__flac_subroot_trie&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;__flac_album_folder&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;__flac_track_filename&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;__mp3_subroot_trie&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;__mp3_album_folder&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;__mp3_track_filename&quot;</span><span class="p">,</span>
                    <span class="p">]:</span>
                <span class="k">if</span> <span class="n">naming_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">naming_field</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">naming_field</span><span class="p">]</span>

            <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">track_metadata</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">][</span><span class="n">t</span><span class="p">:]:</span>
                <span class="c1"># sanity check</span>
                <span class="k">assert</span> <span class="p">(</span>
                    <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_number&quot;</span><span class="p">]</span> <span class="o">==</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="s2">&quot;track_number&quot;</span><span class="p">]</span> <span class="o">==</span>
                    <span class="n">t</span><span class="p">)</span>

                <span class="c1"># regular collectors do not store the &quot;track_include&quot; flag</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;__tracks&quot;</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="s2">&quot;track_include&quot;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">track_metadata</span><span class="p">[</span><span class="s2">&quot;track_include&quot;</span><span class="p">]</span>

                <span class="n">t</span> <span class="o">+=</span> <span class="mi">1</span></div>

    <span class="k">def</span> <span class="nf">_merge_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Merge *source[field]* values into *target[field]*.</span>

<span class="sd">        :arg dict source: metadata being merged from</span>
<span class="sd">        :arg dict target: metadata being merged into</span>
<span class="sd">        :keyword list keys:</span>
<span class="sd">           specific keys to merge (if not specified, **all** keys from</span>
<span class="sd">           *source* are merged into *target*)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target</span><span class="p">:</span>
                <span class="n">target</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                        <span class="n">target</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                <span class="n">target</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__add_lame_genres</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">genres</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add &quot;official&quot; LAME genres to *genres*.</span>

<span class="sd">        :arg list genres:</span>
<span class="sd">           the list of aggregated genres for an album or track</span>

<span class="sd">        *genres* is modified **in place**.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">get_lame_genres</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">genre</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">genres</span><span class="p">:</span>
                <span class="n">genres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">genre</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__save_album_covers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the binary image data for each collected album cover</span>
<span class="sd">        image to a temporary file.</span>

<span class="sd">        .. note::</span>
<span class="sd">           This method will **replace** the binary image data with the</span>
<span class="sd">           temporary file name in the aggregated metadata mapping.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="n">album_covers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">image_data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">album_covers</span><span class="p">):</span>
            <span class="n">image_type</span> <span class="o">=</span> <span class="n">imghdr</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="s2">&quot;_ignored_&quot;</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">image_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">image_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;ignoring unrecognized image data [</span><span class="si">%d</span><span class="s2">]: </span><span class="si">%r</span><span class="s2">...&quot;</span><span class="p">,</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">image_data</span><span class="p">[:</span><span class="mi">32</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="n">filepath</span> <span class="o">=</span> <span class="n">make_tempfile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">image_type</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;wrote </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;album_cover&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></div>


<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<div class="viewcode-block" id="get_lame_genres"><a class="viewcode-back" href="../tagging-and-encoding.html#flacmanager.get_lame_genres">[docs]</a><span class="k">def</span> <span class="nf">get_lame_genres</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return the list of genres recognized by LAME.&quot;&quot;&quot;</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

    <span class="n">genres</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># why does lame write the genre list to stderr!? That&#39;s lame (LOL)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;lame&quot;</span><span class="p">,</span> <span class="s2">&quot;--genre-list&quot;</span><span class="p">],</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">())):</span>
        <span class="p">(</span><span class="n">genre_number</span><span class="p">,</span> <span class="n">genre_label</span><span class="p">)</span> <span class="o">=</span> <span class="n">genre</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">genres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">genre_label</span><span class="p">)</span>

    <span class="n">genres</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">genres</span><span class="p">)</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">return_</span><span class="p">(</span><span class="n">genres</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">genres</span></div>


<span class="k">def</span> <span class="nf">show_exception_dialog</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">aborting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Open a dialog to display exception information.</span>

<span class="sd">    :arg Exception e: a caught exception</span>
<span class="sd">    :keyword bool aborting: ``True`` if the application will terminate</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">FLACManagerError</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">context_hint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> error&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">context_hint</span>

        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">cause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n\n</span><span class="s2">(caused by </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">message</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">cause</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">aborting</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">WARNING! FLACManager will abort after this message is &quot;</span>
            <span class="s2">&quot;dismissed!&quot;</span><span class="p">)</span>

    <span class="n">messagebox</span><span class="o">.</span><span class="n">showerror</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">initialize_logging</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Configure the :mod:`logging` and :mod:`http.client` modules.</span>

<span class="sd">    This function uses options from the *flacmanager.ini* ``[Logging]``</span>
<span class="sd">    and ``[HTTP]`` sections to control logging output.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Logging config = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Logging&quot;</span><span class="p">]))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Logging&quot;</span><span class="p">])</span>

    <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;HTTP config = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;HTTP&quot;</span><span class="p">]))</span>
    <span class="n">HTTPConnection</span><span class="o">.</span><span class="n">debuglevel</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;HTTP&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;debuglevel&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;flacmanager.py&quot;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Please run flacmanager.py from within its directory.&quot;</span><span class="p">,</span>
            <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">initialize_logging</span><span class="p">()</span>

    <span class="n">ui</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()[</span><span class="s2">&quot;UI&quot;</span><span class="p">]</span>
    <span class="n">_PADX</span> <span class="o">=</span> <span class="n">ui</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;padx&quot;</span><span class="p">,</span> <span class="n">_PADX</span><span class="p">)</span>
    <span class="n">_PADY</span> <span class="o">=</span> <span class="n">ui</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;pady&quot;</span><span class="p">,</span> <span class="n">_PADY</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">FLACManager</span><span class="p">()</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;aborting&quot;</span><span class="p">)</span>
        <span class="n">show_exception_dialog</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">aborting</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013 - 2017, Matthew Zipay.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.8.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>